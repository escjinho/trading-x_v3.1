<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading-X</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        .title-font { font-family: 'Orbitron', sans-serif; }
        
        :root {
            --bg-primary: #1a1d23;
            --bg-secondary: #25282f;
            --bg-tertiary: #2d3139;
            --text-primary: #ffffff;
            --text-muted: #9ca3af;
            --text-dim: #6b7280;
            --accent-cyan: #00d4ff;
            --accent-cyan-glow: rgba(0, 212, 255, 0.3);
            --buy-color: #00b450;
            --buy-bg: rgba(0, 180, 80, 0.15);
            --sell-color: #dc3246;
            --sell-bg: rgba(220, 50, 70, 0.15);
            --neutral-color: #646473;
            --border-color: #3f4451;
        }
        
        body {
            background: linear-gradient(135deg, #0a0c10 0%, #151821 50%, #0a0c10 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        .header {
            background: var(--bg-secondary);
            padding: 6px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .header-title { font-size: 16px; font-weight: bold; color: var(--accent-cyan); }
        .header-status { display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-cyan); box-shadow: 0 0 8px var(--accent-cyan); animation: pulse 2s infinite; }
        .status-dot.disconnected { background: var(--sell-color); box-shadow: 0 0 8px var(--sell-color); }
        
        .content { flex: 1; overflow-y: auto; padding-bottom: 70px; }
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        
        .card {
            background: #1e2127;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .card-title { font-size: 14px; color: var(--accent-cyan); margin-bottom: 12px; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-muted); font-size: 14px; }
        .info-value { font-weight: 600; font-size: 14px; }
        
        /* 홈 */
        .welcome-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1421 100%);
            border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        .welcome-banner h2 { color: var(--accent-cyan); margin-bottom: 8px; font-size: 18px; }
        .balance-display { font-size: 32px; font-weight: bold; color: var(--buy-color); }
        
        /* 차트 */
        .chart-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--bg-secondary); }
        .symbol-name { font-size: 16px; font-weight: bold; }
        .timeframe-buttons { display: flex; gap: 5px; }
        .tf-btn { background: #1e2127; border: 1px solid var(--border-color); color: var(--text-muted); padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        .tf-btn.active { background: var(--accent-cyan); color: #0d1421; border-color: var(--accent-cyan); }
        #chart-container { width: 100%; height: 720px; background: var(--bg-primary); }
        .price-bar { display: flex; padding: 10px 15px; gap: 10px; }
        
        /* Chart Symbol Selector */
        .chart-symbol-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); position: relative; }
        .chart-symbol-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .chart-symbol-icon { font-size: 24px; }
        .chart-symbol-name { font-size: 22px; font-weight: bold; }
        .chart-symbol-id { font-size: 11px; color: var(--text-muted); }
        .chart-symbol-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 8px; margin-top: 5px; z-index: 50; max-height: 300px; overflow-y: auto; display: none; }
        .chart-symbol-option { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .chart-symbol-option:hover { background: rgba(255,255,255,0.1); }
        .chart-symbol-option:last-child { border-bottom: none; }
        .chart-symbol-option.favorite { background: rgba(0,212,255,0.1); }
        .favorite-star { color: #ffd700; margin-left: auto; }
        
        /* Chart Signal Section */
        .chart-signal-section { padding: 15px; background: var(--bg-primary); }
        .chart-signal-title { font-size: 16px; font-weight: 700; color: var(--accent-cyan); margin-bottom: 15px; letter-spacing: 0.5px; }
        .chart-gauge-container { text-align: center; padding: 10px 0; }
        .chart-gauge-status { font-size: 24px; font-weight: 900; letter-spacing: 2px; margin-top: 5px; transition: color 0.5s ease, text-shadow 0.5s ease; }
        .chart-indicator-summary { display: flex; background: var(--bg-secondary); border-radius: 10px; overflow: hidden; margin-top: 15px; border: 1px solid var(--border-color); }
        .chart-indicator-item { flex: 1; text-align: center; padding: 10px; }
        .chart-indicator-item:not(:last-child) { border-right: 1px solid var(--border-color); }
        .chart-indicator-count { font-size: 24px; font-weight: bold; }
        .chart-indicator-label { font-size: 10px; color: var(--text-muted); }
        .price-box { flex: 1; text-align: center; padding: 10px 15px; border-radius: 8px; }
        .price-box.sell { background: linear-gradient(180deg, #ff5252, #d32f2f); }
        .price-box.buy { background: linear-gradient(180deg, #00c853, #00a844); }
        .price-label { font-size: 10px; opacity: 0.9; }
        .price-value { font-size: 18px; font-weight: bold; }
        
        /* EA 패널 */
        .ea-panel {
            background: var(--bg-primary);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 40px var(--accent-cyan-glow), 0 25px 60px rgba(0,0,0,0.6);
        }
        .ea-header {
            padding: 15px 20px; text-align: center;
            border-bottom: 2px solid var(--accent-cyan);
            position: relative;
        }
        .ea-header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
        }
        .ea-title { font-size: 20px; font-weight: 900; letter-spacing: 3px; text-shadow: 0 0 20px var(--accent-cyan-glow); }
        .ea-content { padding: 15px; }
        .ea-footer { padding: 10px; text-align: center; font-size: 11px; color: var(--text-dim); border-top: 1px solid var(--border-color); background: var(--bg-secondary); }
        
        /* Symbol Row */
        .symbol-row {
            position: relative; display: flex; align-items: center;
            padding: 10px 50px 10px 15px; background: var(--bg-secondary);
            border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border-color);
        }
        .symbol-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .symbol-icon { font-size: 24px; }
        .symbol-text { font-size: 22px; font-weight: bold; }
        .settings-btn { 
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
            background: transparent; border: none; color: var(--text-muted); 
            width: 40px; height: 40px; padding: 0; border-radius: 6px; cursor: pointer; 
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; 
        }
        .settings-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        
        /* Stats Bar */
        .stats-bar { display: flex; background: var(--bg-secondary); border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .stat-item { flex: 1; text-align: center; padding: 12px 8px; }
        .stat-item:not(:last-child) { border-right: 1px solid var(--border-color); }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 16px; font-weight: bold; }
        
        /* Gauge */
        .gauge-container { text-align: center; padding: 10px 0; margin-bottom: 15px; }
        .gauge-status { font-size: 26px; font-weight: 900; letter-spacing: 2px; margin-top: 5px; transition: color 0.5s ease, text-shadow 0.5s ease; }
        
        /* Indicator Summary */
        .indicator-summary { display: flex; background: var(--bg-secondary); border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .indicator-item { flex: 1; text-align: center; padding: 10px; }
        .indicator-item:not(:last-child) { border-right: 1px solid var(--border-color); }
        .indicator-count { font-size: 28px; font-weight: bold; margin-bottom: 2px; }
        .indicator-count.sell { color: var(--sell-color); text-shadow: 0 0 10px rgba(220,50,70,0.5); }
        .indicator-count.neutral { color: var(--neutral-color); }
        .indicator-count.buy { color: var(--buy-color); text-shadow: 0 0 10px rgba(0,180,80,0.5); }
        .indicator-label { font-size: 10px; color: var(--text-muted); }
        
        /* Target Section */
        .target-section { margin-bottom: 15px; }
        .target-label { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .target-display { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .target-btn { width: 44px; height: 40px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 20px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .target-btn:hover { transform: scale(1.05); }
        .target-btn:active { transform: scale(0.95); }
        .target-value { font-size: 36px; font-weight: 300; min-width: 140px; text-align: center; }
        .lot-display { text-align: center; font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
        
        /* Slider */
        .slider-container { margin-bottom: 15px; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; outline: none; cursor: pointer; background: #2d3139; transition: background 0.15s ease-out; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent-cyan); cursor: pointer; box-shadow: 0 0 10px var(--accent-cyan), 0 0 20px rgba(0,212,255,0.5); border: 2px solid white; margin-top: 0px; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text-muted); }
        
        /* Position Info */
        .position-card { border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .position-card.buy-pos { background: var(--buy-bg); border: 1px solid rgba(0,180,80,0.4); }
        .position-card.sell-pos { background: var(--sell-bg); border: 1px solid rgba(220,50,70,0.4); }
        .position-row { display: flex; justify-content: space-between; }
        .position-item { flex: 1; text-align: center; }
        .position-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .position-value { font-size: 18px; font-weight: bold; }
        
        /* P/L Gauge */
        .pl-gauge { margin-bottom: 15px; }
        .pl-labels { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 11px; font-weight: bold; }
        .pl-bar-container { position: relative; height: 12px; background: var(--bg-tertiary); border-radius: 6px; overflow: visible; }
        .pl-bar-center { position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: var(--text-muted); transform: translateX(-50%); z-index: 5; }
        .pl-bar-fill { position: absolute; top: 0; height: 100%; transition: all 0.3s; }
        .pl-diamond { position: absolute; top: 50%; width: 14px; height: 14px; transform: translate(-50%, -50%) rotate(45deg); border-radius: 2px; z-index: 10; transition: all 0.3s; }
        .pl-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .pl-percent { font-size: 16px; font-weight: bold; }
        
        /* Trade Buttons */
        .trade-buttons { display: flex; gap: 12px; }
        .trade-btn { flex: 1; padding: 16px; border: none; border-radius: 10px; font-size: 18px; font-weight: 900; letter-spacing: 2px; cursor: pointer; transition: all 0.2s; }
        .trade-btn:hover { transform: scale(1.02); }
        .trade-btn:active { transform: scale(0.98); }
        .trade-btn.sell-btn { background: linear-gradient(135deg, var(--sell-color) 0%, #a52030 100%); color: white; box-shadow: 0 4px 20px rgba(220,50,70,0.5); }
        .trade-btn.buy-btn { background: linear-gradient(135deg, var(--buy-color) 0%, #008040 100%); color: white; box-shadow: 0 4px 20px rgba(0,180,80,0.5); }
        .trade-btn.close-btn { background: linear-gradient(135deg, #5a9ee0 0%, #4080c0 100%); color: white; box-shadow: 0 4px 20px rgba(74,144,217,0.5); width: 100%; }

        /* Account */
        .account-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .summary-box { background: #1e2127; border-radius: 10px; padding: 15px; text-align: center; border: 1px solid var(--border-color); }
        .summary-box .value { font-size: 20px; font-weight: bold; color: var(--accent-cyan); }
        .summary-box .label { font-size: 11px; color: var(--text-muted); margin-top: 5px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .history-item:last-child { border-bottom: none; }
        .history-symbol { font-weight: 600; }
        .history-time { font-size: 11px; color: var(--text-muted); }
        .history-profit { font-weight: bold; }
        .history-profit.positive { color: var(--buy-color); }
        .history-profit.negative { color: var(--sell-color); }
        
        /* My */
        .profile-header { text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--accent-cyan); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 32px; }
        .profile-name { font-size: 18px; font-weight: bold; }
        .profile-level { font-size: 12px; color: var(--accent-cyan); margin-top: 5px; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1e2127; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 1px solid var(--border-color); }
        .menu-item:hover { background: var(--bg-tertiary); }
        .menu-left { display: flex; align-items: center; gap: 12px; }
        .menu-icon { font-size: 20px; }
        .menu-icon .material-icons-round { font-size: 22px; color: var(--accent-cyan); vertical-align: middle; }
        .menu-arrow { color: var(--text-muted); }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: env(safe-area-inset-bottom, 8px); max-width: 480px; margin: 0 auto; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 15px; cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
        .nav-item.active { color: var(--accent-cyan); }
        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 12px; }
        
        /* Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e2127; padding: 12px 20px; border-radius: 8px; border: 1px solid var(--border-color); display: none; z-index: 1000; max-width: 90%; }
        .toast.success { border-color: var(--buy-color); }
        .toast.error { border-color: var(--sell-color); }
        .toast.show { display: block; }
        
        /* Settings Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-overlay.show { display: flex; }
        .settings-panel { background: #2d3035; border: 2px solid var(--accent-cyan); border-radius: 8px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 40px var(--accent-cyan-glow); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #000; }
        .settings-title { font-size: 14px; font-weight: bold; color: white; }
        .settings-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; }
        .settings-content { padding: 15px; }
        .settings-section { margin-bottom: 15px; }
        .settings-label { font-size: 11px; color: var(--accent-cyan); margin-bottom: 8px; font-weight: bold; }
        .mode-option { padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid transparent; border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
        .mode-option:hover { background: rgba(255,255,255,0.05); }
        .mode-option.selected { background: rgba(0,212,255,0.15); border-color: var(--accent-cyan); }
        .mode-option-header { display: flex; align-items: center; gap: 8px; }
        .mode-radio { color: var(--text-muted); }
        .mode-option.selected .mode-radio { color: var(--accent-cyan); }
        .mode-name { font-weight: bold; font-size: 13px; }
        .mode-desc { font-size: 11px; color: var(--text-muted); }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-label { font-size: 12px; color: white; }
        .input-hint { font-size: 10px; color: var(--text-muted); margin-left: 8px; }
        .input-controls { display: flex; align-items: center; gap: 4px; }
        .input-btn { width: 28px; height: 28px; background: #3f4451; border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .input-btn:hover { background: #4f5461; }
        .input-value { width: 80px; height: 28px; background: #25282f; border: 1px solid #3f4451; border-radius: 4px; color: white; text-align: center; font-size: 13px; font-weight: 600; }
        .settings-divider { border-top: 1px solid var(--border-color); margin: 12px 0; }
        .martin-row { display: flex; align-items: center; gap: 8px; }
        .martin-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .martin-info { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
        .martin-max { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-muted); margin-top: 8px; }
        .martin-max-btn { padding: 2px 8px; background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 4px; color: var(--accent-cyan); font-size: 11px; font-weight: bold; cursor: pointer; }
        .settings-footer { display: flex; gap: 10px; padding: 12px 15px; background: #000; }
        .settings-footer-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .settings-footer-btn.apply { background: var(--buy-color); color: white; }
        .settings-footer-btn.reset { background: var(--sell-color); color: white; }
        
        /* Symbol Dropdown */
        .symbol-dropdown { background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 8px; margin-bottom: 15px; z-index: 50; overflow: hidden; display: none; }
        .symbol-option { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; transition: all 0.2s; }
        .symbol-option:hover { background: rgba(255,255,255,0.1); }
        .symbol-option.selected { background: rgba(0,212,255,0.2); }
        .symbol-option-icon { font-size: 20px; }
        .symbol-option-name { font-weight: bold; font-size: 14px; }
        .symbol-option-check { margin-left: auto; color: var(--accent-cyan); }
        
        /* Mode Badge */
        .mode-badge-demo {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .mode-badge-live {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        /* 종목 목록 (Watchlist) */
        .watchlist-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .watchlist-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .watchlist-search {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
        }
        .watchlist-tabs {
            display: flex;
            gap: 0;
            flex: 1;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .watchlist-tabs::-webkit-scrollbar {
            display: none;
        }
        .watchlist-tab {
            flex: 0 0 auto;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            scroll-snap-align: start;
        }
        .watchlist-tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }
        
        /* 즐겨찾기 아이콘 */
        .watchlist-favorite {
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .watchlist-favorite:hover {
            transform: scale(1.2);
        }
        .watchlist-favorite.active {
            color: #ffd700;
        }
        
        /* 검색 결과 추가 버튼 */
        .search-add-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-cyan);
            border: none;
            color: #000;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--accent-cyan);
        }
        .search-add-btn.added {
            background: #ffd700;
            color: #000;
        }
        .watchlist-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .watchlist-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .watchlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .watchlist-item:active {
            background: rgba(0, 212, 255, 0.1);
        }
        .watchlist-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-right: 12px;
        }
        .watchlist-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .watchlist-symbol {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .watchlist-name {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
        }
        .watchlist-prices {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .watchlist-bid {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .watchlist-change {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .watchlist-change.up {
            color: var(--buy-color);
            background: rgba(0, 180, 80, 0.15);
        }
        .watchlist-change.down {
            color: var(--sell-color);
            background: rgba(220, 50, 70, 0.15);
        }
        
        /* Bid-Ask 연결 박스 스타일 */
        .watchlist-price-row {
            display: flex;
            align-items: stretch;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .watchlist-bid-box,
        .watchlist-ask-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 8px;
            min-width: 70px;
        }
        .watchlist-bid-box {
            background: var(--sell-color);
            color: white;
        }
        .watchlist-ask-box {
            background: var(--buy-color);
            color: white;
        }
        .watchlist-box-label {
            font-size: 9px;
            opacity: 0.9;
            font-weight: 500;
        }
        .watchlist-box-price {
            font-size: 12px;
            font-weight: 700;
        }
        .watchlist-change-center {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            min-width: 55px;
            padding: 0 6px;
            background: var(--bg-tertiary);
        }
        .watchlist-change-center.up {
            color: var(--buy-color);
        }
        .watchlist-change-center.down {
            color: var(--sell-color);
        }
        
        .chart-detail-container {
            display: none;
        }
        
        /* 종목 검색 모달 */
        .search-category-btn {
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .search-category-btn.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: #000;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .search-result-item:active {
            background: rgba(0, 212, 255, 0.1);
        }
        .search-result-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-right: 12px;
        }
        .search-result-info {
            flex: 1;
        }
        .search-result-symbol {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .search-result-name {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .search-result-category {
            font-size: 10px;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
        }

        /* 공지 배너 */
        .notice-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1f33 100%);
            border: 1px solid var(--accent-cyan);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notice-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notice-icon {
            font-size: 18px;
        }
        .notice-text {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }
        .notice-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
        }
        .notice-close:hover {
            color: var(--text-primary);
        }
        
        /* 인사 섹션 */
        .greeting-section {
            margin-bottom: 15px;
        }
        .greeting-text {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 4px;
        }
        .greeting-sub {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Today/Week 수익 */
        .profit-summary {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .profit-box {
            text-align: center;
        }
        .profit-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--buy-color);
        }
        .profit-value.negative {
            color: var(--sell-color);
        }
        .profit-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .profit-divider {
            width: 1px;
            height: 30px;
            background: var(--border-color);
        }
        
        /* 오늘 거래 요약 */
        .today-summary {
            margin-top: 12px;
            padding: 8px 15px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-muted);
            display: inline-block;
        }
        
        /* 프로모션 슬라이더 */
        .promo-slider-container {
            margin-bottom: 15px;
            position: relative;
        }
        .promo-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 12px;
            padding: 5px 2px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .promo-slider::-webkit-scrollbar {
            display: none;
        }
        .promo-card {
            min-width: 100%;
            scroll-snap-align: start;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .promo-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        .promo-content {
            flex: 1;
        }
        .promo-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .promo-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.3;
        }
        .promo-action {
            flex-shrink: 0;
        }
        .promo-btn {
            padding: 8px 14px;
            background: var(--buy-color);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: transform 0.2s, opacity 0.2s;
        }
        .promo-btn:hover {
            transform: scale(1.05);
        }
        .promo-btn:active {
            transform: scale(0.95);
        }
        
        /* 슬라이드 인디케이터 */
        .promo-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .promo-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        .promo-dot.active {
            background: var(--accent-cyan);
            width: 20px;
            border-radius: 4px;
        }
        
        /* Trading Mode 선택 */
        .trading-mode-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        .mode-select-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .mode-select-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .mode-select-btn.active {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }
        .mode-select-btn.active.live-active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        .mode-select-icon {
            font-size: 24px;
        }
        .mode-select-info {
            text-align: left;
        }
        .mode-select-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .mode-select-desc {
            font-size: 11px;
            color: var(--text-muted);
        }
        .mode-select-check {
            position: absolute;
            top: 8px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: var(--accent-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #000;
        }
        .mode-select-btn.live-active .mode-select-check {
            background: #00ff88;
        }
        .mode-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .mode-status.live {
            background: rgba(0, 255, 136, 0.1);
        }
        .mode-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .mode-status-dot.demo {
            background: var(--accent-cyan);
            box-shadow: 0 0 8px var(--accent-cyan);
        }
        .mode-status-dot.live {
            background: #00ff88;
            box-shadow: 0 0 8px #00ff88;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* MT5 Account 섹션 */
        .mt5-not-connected {
            text-align: center;
            padding: 20px 10px;
        }
        .mt5-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.7;
        }
        .mt5-empty-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        .mt5-empty-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .mt5-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mt5-connect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mt5-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }
        .mt5-guide-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mt5-guide-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
        
        /* MT5 연결됨 상태 */
        .mt5-connected {
            padding: 10px 0;
        }
        .mt5-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 15px;
        }
        .mt5-status-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            box-shadow: 0 0 8px #00ff88;
            animation: pulse 2s infinite;
        }
        .mt5-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        .mt5-info-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
        }
        .mt5-info-label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .mt5-info-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .mt5-disconnect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--sell-color);
            border-radius: 8px;
            color: var(--sell-color);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mt5-disconnect-btn:hover {
            background: rgba(220, 50, 70, 0.1);
        }
        
        /* ========== 서브메뉴 (바텀시트) ========== */
        .submenu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .submenu-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .submenu-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 0 0 env(safe-area-inset-bottom, 20px) 0;
            z-index: 151;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 480px;
            margin: 0 auto;
        }
        .submenu-overlay.show .submenu-sheet {
            transform: translateY(0);
        }
        
        .submenu-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 12px auto;
        }
        
        .submenu-title {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0 20px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .submenu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        .submenu-item:last-child {
            border-bottom: none;
        }
        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .submenu-item:active {
            background: rgba(0, 212, 255, 0.1);
        }
        
        .submenu-item-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 22px;
        }
        
        .submenu-item-content {
            flex: 1;
        }
        .submenu-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .submenu-item-hint {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .submenu-item-badge {
            position: absolute;
            top: 12px;
            right: 15px;
            background: var(--accent-cyan);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .submenu-item-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent-cyan);
            width: 0%;
            transition: width 0.5s linear;
        }
        .submenu-item.pressing .submenu-item-progress {
            width: 100%;
        }
        
        .submenu-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 15px 20px;
            z-index: 200;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            max-width: 320px;
            width: 90%;
        }
        .submenu-toast.show {
            opacity: 1;
            visibility: visible;
        }
        .submenu-toast-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .submenu-toast-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }
        .submenu-toast-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .nav-item.long-pressing {
            transform: scale(0.95);
            opacity: 0.7;
        }
        .nav-item {
            transition: transform 0.2s, opacity 0.2s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* ========== Quick & Easy 패널 ========== */
        .quick-panel {
            display: none;
            padding: 15px;
        }
        .quick-panel.active {
            display: block;
        }
        
        .quick-header {
            background: var(--bg-primary);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 40px var(--accent-cyan-glow), 0 25px 60px rgba(0,0,0,0.6);
        }
        
        .quick-title-bar {
            padding: 15px 20px;
            text-align: center;
            border-bottom: 2px solid var(--accent-cyan);
            position: relative;
        }
        .quick-title-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
        }
        .quick-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-shadow: 0 0 20px var(--accent-cyan-glow);
        }
        
        .quick-content {
            padding: 15px;
        }
        
        /* 주문 섹션 */
        .quick-section {
            margin-bottom: 15px;
        }
        .quick-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .quick-section-title .material-icons-round {
            font-size: 18px;
        }
        
        /* 매수/매도 버튼 */
        .quick-order-buttons {
            display: flex;
            gap: 12px;
        }
        .quick-order-btn {
            flex: 1;
            padding: 20px 15px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .quick-order-btn:hover {
            transform: scale(1.02);
        }
        .quick-order-btn:active {
            transform: scale(0.98);
        }
        .quick-order-btn.buy {
            background: linear-gradient(135deg, var(--buy-color) 0%, #008040 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 180, 80, 0.5);
        }
        .quick-order-btn.sell {
            background: linear-gradient(135deg, var(--sell-color) 0%, #a52030 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(220, 50, 70, 0.5);
        }
        .quick-order-price {
            font-size: 14px;
            font-weight: 600;
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 0;
            opacity: 0.9;
        }
        
        /* 청산 버튼 그리드 */
        .quick-close-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .quick-close-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 14px 12px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .quick-close-btn:hover {
            transform: scale(1.02);
            border-color: var(--accent-cyan);
        }
        .quick-close-btn:active {
            transform: scale(0.98);
        }
        .quick-close-btn .material-icons-round {
            font-size: 18px;
        }
        .quick-close-btn.all-close {
            background: linear-gradient(135deg, #ff6b6b 0%, #c0392b 100%);
            border: none;
            color: white;
            box-shadow: 0 2px 10px rgba(220, 50, 70, 0.3);
        }
        .quick-close-btn.symbol-close {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
            border: none;
            color: white;
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
        }
        .quick-close-btn.buy-close {
            background: var(--buy-bg);
            border-color: rgba(0, 180, 80, 0.4);
            color: var(--buy-color);
        }
        .quick-close-btn.sell-close {
            background: var(--sell-bg);
            border-color: rgba(220, 50, 70, 0.4);
            color: var(--sell-color);
        }
        .quick-close-btn.profit-close {
            background: rgba(0, 212, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.4);
            color: var(--accent-cyan);
        }
        .quick-close-btn.loss-close {
            background: rgba(156, 39, 176, 0.1);
            border-color: rgba(156, 39, 176, 0.4);
            color: #ba68c8;
        }
        
        /* SL/TP 설정 */
        .quick-sltp-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .quick-sltp-label {
            width: 80px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
        }
        .quick-sltp-label.sl {
            color: var(--sell-color);
        }
        .quick-sltp-label.tp {
            color: var(--buy-color);
        }
        .quick-sltp-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        .quick-sltp-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        .quick-sltp-unit {
            font-size: 12px;
            color: var(--text-muted);
            width: 40px;
        }
        .quick-sltp-apply {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, #0099cc 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 5px;
        }
        .quick-sltp-apply:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }
        
        /* 포지션 리스트 */
        .quick-position-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .quick-position-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }
        .quick-position-empty .material-icons-round {
            font-size: 40px;
            opacity: 0.5;
            margin-bottom: 10px;
        }
        .quick-position-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }
        .quick-position-item:last-child {
            margin-bottom: 0;
        }
        .quick-position-symbol {
            flex: 1;
        }
        .quick-position-symbol-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .quick-position-symbol-info {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .quick-position-type {
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 12px;
        }
        .quick-position-type.buy {
            background: var(--buy-bg);
            color: var(--buy-color);
        }
        .quick-position-type.sell {
            background: var(--sell-bg);
            color: var(--sell-color);
        }
        .quick-position-profit {
            font-size: 15px;
            font-weight: 700;
            min-width: 70px;
            text-align: right;
        }
        .quick-position-profit.positive {
            color: var(--buy-color);
        }
        .quick-position-profit.negative {
            color: var(--sell-color);
        }
        .quick-position-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--sell-bg);
            border: 1px solid rgba(220, 50, 70, 0.4);
            border-radius: 8px;
            color: var(--sell-color);
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
        }
        .quick-position-close:hover {
            background: var(--sell-color);
            color: white;
        }
        .quick-position-close .material-icons-round {
            font-size: 18px;
        }
        
        .quick-footer {
            padding: 10px;
            text-align: center;
            font-size: 11px;
            color: var(--text-dim);
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        /* Quick 종목 드롭다운 */
        .quick-symbol-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .quick-symbol-option:last-child {
            border-bottom: none;
        }
        .quick-symbol-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .quick-symbol-option:active {
            background: rgba(0, 212, 255, 0.2);
        }
        .quick-symbol-option.selected {
            background: rgba(0, 212, 255, 0.15);
        }
        
        /* Quick 포지션 아이템 개선 */
        .quick-position-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        .quick-position-item:hover {
            border-color: var(--accent-cyan);
        }
        .quick-position-item:last-child {
            margin-bottom: 0;
        }
        .quick-position-item.buy-position {
            border-left: 3px solid var(--buy-color);
        }
        .quick-position-item.sell-position {
            border-left: 3px solid var(--sell-color);
        }
        
        /* 포지션 총 손익 바 */
        .quick-total-pl {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        .quick-total-pl-label {
            font-size: 13px;
            color: var(--text-muted);
        }
        .quick-total-pl-value {
            font-size: 18px;
            font-weight: 700;
        }
        .quick-total-pl-value.positive {
            color: var(--buy-color);
        }
        .quick-total-pl-value.negative {
            color: var(--sell-color);
        }
        
        /* Quick Symbol Selector 호버 효과 */
        #quickSymbolSelector:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- 헤더 -->
        <div class="header">
            <div class="header-title" style="font-size: 23px; font-weight: 700; display: flex; align-items: center; color: #ffffff;">
                <svg width="32" height="23" viewBox="0 0 32 23" style="margin-right: 10px; vertical-align: middle;">
                    <rect x="1" y="1" width="30" height="21" rx="3" fill="none" stroke="#00d4ff" stroke-width="2"/>
                    <text x="16" y="16.5" font-size="14" font-weight="900" fill="#00d4ff" font-family="Arial" text-anchor="middle">TX</text>
                </svg>
                Trading-X
            </div>
            <div class="header-status">
                <span id="modeBadge" style="display: none; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 8px; letter-spacing: 0.5px;"></span>
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="headerStatus">Connecting...</span>
            </div>
        </div>
        
        <!-- 컨텐츠 -->
        <div class="content">
            <!-- ========== 홈 탭 ========== -->
            <div class="page active" id="page-home">
                
                <!-- 긴급 공지 배너 -->
                <div class="notice-banner" id="noticeBanner" style="display: none;">
                    <div class="notice-content">
                        <span class="notice-icon">📢</span>
                        <span class="notice-text" id="noticeText">서버 점검 안내 (1/20 02:00~04:00)</span>
                    </div>
                    <button class="notice-close" onclick="closeNoticeBanner()">✕</button>
                </div>
                
                <div class="welcome-banner">
                    <!-- 시간대별 인사 -->
                    <div class="greeting-section">
                        <div style="text-align: center;">
                            <span class="greeting-text" id="greetingText" style="font-size: 24px; font-weight: 600; white-space: nowrap;">Good Evening, Trader! 🌙</span>
                        </div>
                        <span class="greeting-sub" id="greetingSub" style="font-size: 13px; font-weight: 600;">오늘 하루 수고하셨어요!</span>
                    </div>
                    
                    <!-- 모드 표시 -->
                    <div id="heroModeBadge" style="margin-top: 18px; font-size: 26px; font-weight: 700; color: #e0e0e0; letter-spacing: 3px;">
                        Trading-X Demo
                    </div>
                </div>
                
                <!-- 프로모션 배너 (심플) -->
                <div class="promo-slider-container">
                    <div class="promo-slider" id="promoSlider">
                        <!-- 카드 1: 친구 초대 -->
                        <div class="promo-card" style="background: linear-gradient(135deg, #1e2530 0%, #151a22 100%); border-color: var(--border-color);">
                            <div class="promo-content" style="flex: 1;">
                                <div class="promo-title" style="font-size: 16px; font-weight: 700;">친구 초대하고 $50 받기!</div>
                                <div class="promo-desc" style="font-size: 12px;">추천인 코드를 공유하고 보너스를 받으세요</div>
                            </div>
                            <div class="promo-action">
                                <button class="promo-btn" style="background: linear-gradient(135deg, #00b450 0%, #008040 100%); color: #fff; font-size: 13px; font-weight: 600; padding: 8px 14px;" onclick="showToast('추천 코드: TRADEX2024', 'success')">코드 복사</button>
                            </div>
                        </div>
                        
                        <!-- 카드 2: 신규 가입 이벤트 -->
                        <div class="promo-card" style="background: linear-gradient(135deg, #1e2530 0%, #151a22 100%); border-color: var(--border-color);">
                            <div class="promo-content" style="flex: 1;">
                                <div class="promo-title" style="font-size: 16px; font-weight: 700;">신규 가입 이벤트!</div>
                                <div class="promo-desc" style="font-size: 12px;">첫 입금 시 100% 보너스 지급</div>
                            </div>
                            <div class="promo-action">
                                <button class="promo-btn" style="background: linear-gradient(135deg, #8a2be2 0%, #6a1bb2 100%); color: #fff; font-size: 13px; font-weight: 600; padding: 8px 14px;">자세히 →</button>
                            </div>
                        </div>
                        
                        <!-- 카드 3: VIP 프로그램 -->
                        <div class="promo-card" style="background: linear-gradient(135deg, #1e2530 0%, #151a22 100%); border-color: var(--border-color);">
                            <div class="promo-content" style="flex: 1;">
                                <div class="promo-title" style="font-size: 16px; font-weight: 700;">VIP 프로그램</div>
                                <div class="promo-desc" style="font-size: 12px;">거래량에 따른 특별 혜택을 누리세요</div>
                            </div>
                            <div class="promo-action">
                                <button class="promo-btn" style="background: linear-gradient(135deg, #ffa500 0%, #cc8400 100%); color: #fff; font-size: 13px; font-weight: 600; padding: 8px 14px;">가입하기</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 슬라이드 인디케이터 -->
                    <div class="promo-indicators">
                        <span class="promo-dot active" onclick="scrollToPromo(0)"></span>
                        <span class="promo-dot" onclick="scrollToPromo(1)"></span>
                        <span class="promo-dot" onclick="scrollToPromo(2)"></span>
                    </div>
                </div>
                
                <!-- Trading Mode 전환 -->
                <div class="card">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">sync_alt</span>
                        <span style="position: relative; top: -3px;">Trading Mode</span>
                    </div>
                    <div class="trading-mode-selector">
                        <button class="mode-select-btn active" id="modeDemoBtn" onclick="switchTradingMode('demo')">
                            <div class="mode-select-info" style="text-align: center; width: 100%;">
                                <div class="mode-select-name">DEMO</div>
                                <div class="mode-select-desc">Practice Trading</div>
                            </div>
                            <div class="mode-select-check" id="demoCheck">✓</div>
                        </button>
                        <button class="mode-select-btn" id="modeLiveBtn" onclick="switchTradingMode('live')">
                            <div class="mode-select-info" style="text-align: center; width: 100%;">
                                <div class="mode-select-name">LIVE</div>
                                <div class="mode-select-desc">Real Trading</div>
                            </div>
                            <div class="mode-select-check" id="liveCheck" style="display: none;">✓</div>
                        </button>
                    </div>
                    <div class="mode-status" id="modeStatus">
                        <span class="mode-status-dot demo"></span>
                        <span>Currently in <strong>Demo Mode</strong> - Practice with virtual $10,000</span>
                    </div>
                </div>
                
                <!-- MT5 Account 연결 -->
                <div class="card" id="mt5AccountSection">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">link</span>
                        <span style="position: relative; top: -3px;">MT5 Account</span>
                    </div>
                    
                    <!-- 연결 안 됨 상태 -->
                    <div class="mt5-not-connected" id="mt5NotConnected" style="padding: 15px 10px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px;">
                            <div style="font-size: 36px; opacity: 0.7;">🔗</div>
                            <div style="text-align: left;">
                                <div class="mt5-empty-text" style="font-size: 16px; font-weight: 600; margin-bottom: 2px;">아직 연결된 MT5 계좌가 없습니다</div>
                                <div class="mt5-empty-sub" style="font-size: 12px; margin: 0;">Live 거래를 위해 MT5 계좌를 연결하세요</div>
                            </div>
                        </div>
                        <div class="mt5-buttons">
                            <button class="mt5-connect-btn" onclick="openMT5ConnectModal()">
                                <span class="material-icons-round" style="font-size: 18px;">link</span>
                                MT5 계좌 연결하기
                            </button>
                            <button class="mt5-guide-btn" onclick="openMT5GuideModal()">
                                <span class="material-icons-round" style="font-size: 18px;">help_outline</span>
                                신규 계좌 개설 안내
                            </button>
                        </div>
                    </div>
                    
                    <!-- 연결됨 상태 -->
                    <div class="mt5-connected" id="mt5Connected" style="display: none;">
                        <div class="mt5-status-badge">
                            <span class="mt5-status-dot"></span>
                            Connected
                        </div>
                        <div class="mt5-info-grid">
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Broker</span>
                                <span class="mt5-info-value" id="mt5Broker">-</span>
                            </div>
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Account</span>
                                <span class="mt5-info-value" id="mt5Account">-</span>
                            </div>
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Server</span>
                                <span class="mt5-info-value" id="mt5Server">-</span>
                            </div>
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Leverage</span>
                                <span class="mt5-info-value" id="mt5Leverage">-</span>
                            </div>
                        </div>
                        <button class="mt5-disconnect-btn" onclick="disconnectMT5()">
                            <span class="material-icons-round" style="font-size: 16px;">link_off</span>
                            연결 해제
                        </button>
                    </div>
                </div>
                
                <!-- Account Overview (통합) -->
                <div class="card">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">account_balance</span>
                        <span style="position: relative; top: -3px;">Account Overview</span>
                    </div>
                    
                    <!-- 계정 정보 박스 -->
                    <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px 15px; margin-bottom: 10px;">
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Broker</span><span class="info-value" id="homeBroker">-</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Account</span><span class="info-value" id="homeAccount">-</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Leverage</span><span class="info-value" id="homeLeverage">-</span></div>
                        <div class="info-row" style="border-bottom: none;"><span class="info-label">Server</span><span class="info-value" id="homeServer">-</span></div>
                    </div>
                    
                    <!-- 자산 정보 박스 -->
                    <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px 15px;">
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Balance</span><span class="info-value" id="homeBalance">$0.00</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Equity</span><span class="info-value" id="homeEquity">$0.00</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Free Margin</span><span class="info-value" id="homeFreeMargin">$0.00</span></div>
                        <div class="info-row" style="border-bottom: none;"><span class="info-label">Open Positions</span><span class="info-value" id="homePositions">0</span></div>
                    </div>
                </div>
                
                <!-- Demo 충전 버튼 (Demo 모드에서만 표시) -->
                <div class="card" id="demoControlCard" style="display: none;">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">monetization_on</span><span style="position: relative; top: -3px;">Demo Control</span>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="topupDemo()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #00b450, #00d46a); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <span class="material-icons-round" style="font-size: 18px;">add_card</span> $10,000 충전
                        </button>
                        <button onclick="resetDemo()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #ff6b35, #ff8c42); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <span class="material-icons-round" style="font-size: 18px;">restart_alt</span> 잔고 리셋
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin-top: 10px; text-align: center;">💎 최대 잔고: $100,000</p>
                </div>
            </div>
            
            <!-- ========== 차트 탭 ========== -->
            <div class="page" id="page-chart">
                
                <!-- 종목 목록 (Watchlist) -->
                <div class="watchlist-container" id="watchlistContainer">
                    <div class="watchlist-header">
                        <button class="watchlist-search" onclick="openSymbolSearch()">
                            <span class="material-icons-round" style="font-size: 20px;">search</span>
                        </button>
                        <div class="watchlist-tabs" id="watchlistTabs">
                            <button class="watchlist-tab active" onclick="switchWatchlistTab('popular')" data-tab="popular">Popular</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('favorites')" data-tab="favorites">⭐ Favorites</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('forex')" data-tab="forex">Forex</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('crypto')" data-tab="crypto">Crypto</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('indices')" data-tab="indices">Indices</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('metals')" data-tab="metals">Metals</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('energy')" data-tab="energy">Energy</button>
                        </div>
                    </div>
                    <div class="watchlist-content" id="watchlistContent">
                        <!-- 종목들이 여기에 동적으로 추가됨 -->
                    </div>
                </div>
                
                <!-- 차트 상세 페이지 -->
                <div class="chart-detail-container" id="chartDetailContainer">
                
                <!-- Symbol Row -->
                <div class="chart-symbol-row">
                    <div class="chart-symbol-info" onclick="toggleChartSymbolDropdown()">
                        <span class="chart-symbol-icon" id="chartSymbolIcon" style="color: #f7931a;">₿</span>
                        <div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span class="chart-symbol-name" id="chartSymbolName">Bitcoin</span>
                                <span style="color: var(--text-muted); font-size: 12px;">▼</span>
                            </div>
                            <div class="chart-symbol-id" id="chartSymbolId">BTCUSD</div>
                        </div>
                    </div>
                    <div class="timeframe-buttons">
                        <button class="tf-btn active" data-tf="M1">1m</button>
                        <button class="tf-btn" data-tf="M5">5m</button>
                        <button class="tf-btn" data-tf="M15">15m</button>
                        <button class="tf-btn" data-tf="H1">1H</button>
                    </div>
                    
                    <!-- Symbol Dropdown -->
                    <div class="chart-symbol-dropdown" id="chartSymbolDropdown">
                        <div style="padding: 10px 15px; font-size: 11px; color: var(--accent-cyan); border-bottom: 1px solid var(--border-color);">⭐ 즐겨찾기</div>
                        <div class="chart-symbol-option favorite" data-symbol="BTCUSD" data-name="Bitcoin" data-icon="₿" data-color="#f7931a" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #f7931a;">₿</span>
                            <div><div style="font-weight: bold;">Bitcoin</div><div style="font-size:11px;color:var(--text-muted);">BTCUSD</div></div>
                            <span class="favorite-star">⭐</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="EURUSD.r" data-name="Euro/Dollar" data-icon="€" data-color="#0052cc" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #0052cc;">€</span>
                            <div><div style="font-weight: bold;">Euro/Dollar</div><div style="font-size:11px;color:var(--text-muted);">EURUSD.r</div></div>
                            <span class="favorite-star">⭐</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="USDJPY.r" data-name="Dollar/Yen" data-icon="¥" data-color="#dc143c" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #dc143c;">¥</span>
                            <div><div style="font-weight: bold;">Dollar/Yen</div><div style="font-size:11px;color:var(--text-muted);">USDJPY.r</div></div>
                            <span class="favorite-star">⭐</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="XAUUSD.r" data-name="Gold" data-icon="✦" data-color="#ffd700" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #ffd700;">✦</span>
                            <div><div style="font-weight: bold;">Gold</div><div style="font-size:11px;color:var(--text-muted);">XAUUSD.r</div></div>
                            <span class="favorite-star">⭐</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="US100." data-name="NASDAQ" data-icon="⬡" data-color="#00b450" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #00b450;">⬡</span>
                            <div><div style="font-weight: bold;">NASDAQ</div><div style="font-size:11px;color:var(--text-muted);">US100.</div></div>
                            <span class="favorite-star">⭐</span>
                        </div>
                        <div style="padding: 10px 15px; font-size: 11px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color);">기타 종목</div>
                        <div class="chart-symbol-option" data-symbol="GBPUSD.r" data-name="Pound/Dollar" data-icon="£" data-color="#9c27b0" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #9c27b0;">£</span>
                            <div><div style="font-weight: bold;">Pound/Dollar</div><div style="font-size:11px;color:var(--text-muted);">GBPUSD.r</div></div>
                        </div>
                        <div class="chart-symbol-option" data-symbol="ETHUSD" data-name="Ethereum" data-icon="Ξ" data-color="#627eea" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #627eea;">Ξ</span>
                            <div><div style="font-weight: bold;">Ethereum</div><div style="font-size:11px;color:var(--text-muted);">ETHUSD</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart -->
                <div id="chart-container"></div>
                
                <!-- Price Bar -->
                <div class="price-bar">
                    <div class="price-box sell">
                        <div class="price-label">SELL (Bid)</div>
                        <div class="price-value" id="chartBid">-</div>
                    </div>
                    <div class="price-box buy">
                        <div class="price-label">BUY (Ask)</div>
                        <div class="price-value" id="chartAsk">-</div>
                    </div>
                </div>
                
                <!-- Signal Section -->
                <div class="chart-signal-section">
                    <div class="chart-signal-title">Technical Analysis</div>
                    
                    <!-- Signal Gauge -->
                    <div class="chart-gauge-container">
                        <svg width="280" height="130" viewBox="0 0 280 130">
                            <path id="chartSellArc" d="" fill="none" stroke="#dc3246" stroke-width="8" stroke-linecap="round"/>
                            <path id="chartBuyArc" d="" fill="none" stroke="#00b450" stroke-width="8" stroke-linecap="round"/>
                            <text x="140" y="14" text-anchor="middle" fill="#9ca3af" font-size="13" font-weight="600">Neutral</text>
                            <text x="40" y="45" text-anchor="middle" fill="#dc3246" font-size="16" font-weight="700">Sell</text>
                            <text x="240" y="45" text-anchor="middle" fill="#00b450" font-size="16" font-weight="700">Buy</text>
                            <text x="5" y="100" text-anchor="start" fill="#6b7280" font-size="11">Strong Sell</text>
                            <text x="275" y="100" text-anchor="end" fill="#6b7280" font-size="11">Strong Buy</text>
                            <line id="chartNeedleShadow" x1="141" y1="101" x2="141" y2="46" stroke="rgba(0,0,0,0.3)" stroke-width="5" stroke-linecap="round"/>
                            <line id="chartGaugeNeedle" x1="140" y1="100" x2="140" y2="45" stroke="#00d4ff" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="140" cy="100" r="12" fill="#0a3040" stroke="#00d4ff" stroke-width="2"/>
                            <circle cx="140" cy="100" r="6" fill="#00d4ff"/>
                        </svg>
                        <div class="chart-gauge-status title-font" id="chartGaugeStatus" style="color: #646473;">Neutral</div>
                    </div>
                    
                    <!-- Indicator Summary -->
                    <div class="chart-indicator-summary">
                        <div class="chart-indicator-item">
                            <div class="chart-indicator-count title-font" id="chartIndSell" style="color: #dc3246;">0</div>
                            <div class="chart-indicator-label">Sell</div>
                        </div>
                        <div class="chart-indicator-item">
                            <div class="chart-indicator-count title-font" id="chartIndNeutral" style="color: #646473;">0</div>
                            <div class="chart-indicator-label">Neutral</div>
                        </div>
                        <div class="chart-indicator-item">
                            <div class="chart-indicator-count title-font" id="chartIndBuy" style="color: #00b450;">0</div>
                            <div class="chart-indicator-label">Buy</div>
                        </div>
                    </div>
                </div>
                
                </div><!-- chartDetailContainer 닫기 -->
            </div>
            
            <!-- ========== Trade 탭 ========== -->
            <div class="page" id="page-trade">
                
                <!-- Buy/Sell 패널 (기본) -->
                <div class="buysell-panel" id="buysellPanel">
                <div class="ea-panel">
                    <!-- EA Header -->
                    <div class="ea-header">
                        <div class="ea-title title-font">FUMA Buy/Sell</div>
                    </div>
                    
                    <div class="ea-content">
                        <!-- Symbol Row -->
                        <div class="symbol-row">
                            <div class="symbol-info" onclick="toggleSymbolDropdown()">
                                <span class="symbol-icon" id="tradeSymbolIcon" style="color: #f7931a;">₿</span>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span class="symbol-text" id="tradeSymbolName">Bitcoin</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">▼</span>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted);" id="tradeSymbolId">BTCUSD</div>
                                </div>
                            </div>
                            <button class="settings-btn" onclick="openSettings()">
                                <svg width="20" height="16" viewBox="0 0 20 16" fill="currentColor">
                                    <rect y="0" width="20" height="2" rx="1"/>
                                    <rect y="7" width="20" height="2" rx="1"/>
                                    <rect y="14" width="20" height="2" rx="1"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Symbol Dropdown -->
                        <div class="symbol-dropdown" id="symbolDropdown">
                            <div class="symbol-option selected" data-symbol="BTCUSD" data-name="Bitcoin" data-icon="₿" data-color="#f7931a" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #f7931a;">₿</span>
                                <div><div class="symbol-option-name">Bitcoin</div><div style="font-size:11px;color:var(--text-muted);">BTCUSD</div></div>
                                <span class="symbol-option-check">✓</span>
                            </div>
                            <div class="symbol-option" data-symbol="EURUSD.r" data-name="Euro/Dollar" data-icon="€" data-color="#0052cc" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #0052cc;">€</span>
                                <div><div class="symbol-option-name">Euro/Dollar</div><div style="font-size:11px;color:var(--text-muted);">EURUSD.r</div></div>
                                <span class="symbol-option-check" style="display:none;">✓</span>
                            </div>
                            <div class="symbol-option" data-symbol="USDJPY.r" data-name="Dollar/Yen" data-icon="¥" data-color="#dc143c" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #dc143c;">¥</span>
                                <div><div class="symbol-option-name">Dollar/Yen</div><div style="font-size:11px;color:var(--text-muted);">USDJPY.r</div></div>
                                <span class="symbol-option-check" style="display:none;">✓</span>
                            </div>
                            <div class="symbol-option" data-symbol="XAUUSD.r" data-name="Gold" data-icon="✦" data-color="#ffd700" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #ffd700;">✦</span>
                                <div><div class="symbol-option-name">Gold</div><div style="font-size:11px;color:var(--text-muted);">XAUUSD.r</div></div>
                                <span class="symbol-option-check" style="display:none;">✓</span>
                            </div>
                            <div class="symbol-option" data-symbol="US100." data-name="NASDAQ" data-icon="⬡" data-color="#00b450" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #00b450;">⬡</span>
                                <div><div class="symbol-option-name">NASDAQ</div><div style="font-size:11px;color:var(--text-muted);">US100.</div></div>
                                <span class="symbol-option-check" style="display:none;">✓</span>
                            </div>
                        </div>
                        
                        <!-- Stats Bar -->
                        <div class="stats-bar">
                            <div class="stat-item">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="tradeBalance">$0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Lot Size</div>
                                <div class="stat-value" id="tradeLotSize">0.01</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Today</div>
                                <div class="stat-value" id="tradeTodayPL" style="color: var(--buy-color);">+$0</div>
                            </div>
                        </div>
                        
                        <!-- Signal Gauge -->
                        <div class="gauge-container">
                            <svg width="300" height="140" viewBox="0 0 300 140">
                                <path id="sellArc" d="" fill="none" stroke="#dc3246" stroke-width="8" stroke-linecap="round"/>
                                <path id="buyArc" d="" fill="none" stroke="#00b450" stroke-width="8" stroke-linecap="round"/>
                                <text x="150" y="14" text-anchor="middle" fill="#9ca3af" font-size="15" font-weight="600">Neutral</text>
                                <text x="45" y="48" text-anchor="middle" fill="#dc3246" font-size="19" font-weight="700">Sell</text>
                                <text x="255" y="48" text-anchor="middle" fill="#00b450" font-size="19" font-weight="700">Buy</text>
                                <text x="0" y="110" text-anchor="start" fill="#6b7280" font-size="13" font-weight="700">Strong sell</text>
                                <text x="300" y="110" text-anchor="end" fill="#6b7280" font-size="13" font-weight="700">Strong buy</text>
                                <line id="needleShadow" x1="151" y1="111" x2="151" y2="51" stroke="rgba(0,0,0,0.3)" stroke-width="5" stroke-linecap="round"/>
                                <line id="gaugeNeedle" x1="150" y1="110" x2="150" y2="50" stroke="#00d4ff" stroke-width="4" stroke-linecap="round"/>
                                <circle cx="150" cy="110" r="14" fill="#0a3040" stroke="#00d4ff" stroke-width="2"/>
                                <circle cx="150" cy="110" r="8" fill="#00d4ff"/>
                                <circle cx="148" cy="108" r="3" fill="rgba(255,255,255,0.5)"/>
                            </svg>
                            <div class="gauge-status title-font" id="gaugeStatusText" style="color: var(--neutral-color);">Neutral</div>
                        </div>
                        
                        <!-- Indicator Summary -->
                        <div class="indicator-summary">
                            <div class="indicator-item">
                                <div class="indicator-count sell title-font" id="indSell">0</div>
                                <div class="indicator-label">Sell</div>
                            </div>
                            <div class="indicator-item">
                                <div class="indicator-count neutral title-font" id="indNeutral">0</div>
                                <div class="indicator-label">Neutral</div>
                            </div>
                            <div class="indicator-item">
                                <div class="indicator-count buy title-font" id="indBuy">0</div>
                                <div class="indicator-label">Buy</div>
                            </div>
                        </div>
                        
                        <!-- Target Section (포지션 없을 때) -->
                        <div class="target-section" id="targetSection">
                            <!-- 마틴 모드 UI -->
                            <div id="martinModeUI" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span class="target-label" style="margin: 0;">MARTIN MODE</span>
                                    <span id="martinStepBadge" style="display: none; font-size: 11px; font-weight: bold; padding: 2px 8px; border-radius: 4px; background-color: rgba(220,50,70,0.3); color: #dc3246;"></span>
                                </div>
                                
                                <div class="target-display">
                                    <button class="target-btn" style="opacity: 0.4; cursor: not-allowed;" disabled>−</button>
                                    <div class="target-value title-font" id="martinTargetDisplay">$50</div>
                                    <button class="target-btn" style="opacity: 0.4; cursor: not-allowed;" disabled>+</button>
                                </div>
                                <div class="lot-display" id="martinLotDisplay">0.01 lot</div>
                                
                                <!-- 8단계 표시 점 -->
                                <div id="martinDotsContainer" style="display: flex; justify-content: center; align-items: center; gap: 6px; padding: 10px 0;"></div>
                                
                                <div id="martinStepInfo" style="text-align: center; font-size: 12px; color: var(--text-muted);">
                                    Step <span id="martinCurrentStep" style="color: var(--accent-cyan);">1</span> / <span id="martinMaxStepsDisplay">7</span> | Target: $<span id="martinTargetInfo">50</span>
                                </div>
                            </div>
                            
                            <!-- 기본/무제한 모드 UI -->
                            <div id="normalModeUI">
                                <div class="target-label">Profit Target</div>
                                <div class="target-display">
                                    <button class="target-btn" onclick="adjustTarget(-10)">−</button>
                                    <div class="target-value title-font" id="targetValue">$100</div>
                                    <button class="target-btn" onclick="adjustTarget(10)">+</button>
                                </div>
                                <div class="lot-display" id="lotDisplay">0.50 lot (x5)</div>
                                
                                <div class="slider-container">
                                    <input type="range" id="targetSlider" min="0" max="200" value="100" oninput="updateTargetFromSlider(this.value)">
                                    <div class="slider-labels">
                                        <span>$0</span><span>$50</span><span>$100</span><span>$150</span><span>$200</span>
                                    </div>
                                </div>
                                
                                <div class="target-label" style="margin-top: 15px;">Leverage<span style="float:right;color:var(--accent-cyan);font-weight:bold;" id="leverageDisplay">x5</span></div>
                                <div class="slider-container">
                                    <input type="range" id="leverageSlider" min="1" max="20" value="5" oninput="updateLeverageFromSlider(this.value)">
                                    <div class="slider-labels">
                                        <span>x0</span><span>x5</span><span>x10</span><span>x15</span><span>x20</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Position Section (포지션 있을 때) -->
                        <div id="positionSection" style="display: none;">
                            <div class="position-card" id="positionCard">
                                <div class="position-row">
                                    <div class="position-item">
                                        <div class="position-label">Type</div>
                                        <div class="position-value title-font" id="posType" style="color: var(--buy-color);">BUY</div>
                                    </div>
                                    <div class="position-item">
                                        <div class="position-label">Entry</div>
                                        <div class="position-value" id="posEntry">0.00</div>
                                    </div>
                                    <div class="position-item">
                                        <div class="position-label">Time</div>
                                        <div class="position-value title-font" id="posTime">00:00</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- P/L Gauge -->
                            <div class="pl-gauge">
                                <div class="pl-labels">
                                    <span style="color: var(--sell-color);">&lt;&lt; LOSE</span>
                                    <span style="color: var(--buy-color);">WIN &gt;&gt;</span>
                                </div>
                                <div class="pl-bar-container">
                                    <div class="pl-bar-center"></div>
                                    <div class="pl-bar-fill" id="plBarFill"></div>
                                    <div class="pl-diamond" id="plDiamond"></div>
                                </div>
                                <div class="pl-bottom">
                                    <span style="font-size: 11px; color: var(--text-muted);" id="plMin">-$100</span>
                                    <span class="pl-percent title-font" id="plPercent" style="color: var(--neutral-color);">0%</span>
                                    <span style="font-size: 11px; color: var(--text-muted);" id="plMax">+$100</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trade Buttons -->
                        <div id="tradeButtonsNoPos">
                            <div class="trade-buttons">
                                <button class="trade-btn sell-btn title-font" onclick="placeSell()">SELL</button>
                                <button class="trade-btn buy-btn title-font" onclick="placeBuy()">BUY</button>
                            </div>
                        </div>
                        <div id="tradeButtonsHasPos" style="display: none;">
                            <button class="trade-btn close-btn title-font" onclick="closePosition()">CLOSE TRADE</button>
                        </div>
                    </div>
                    
                    <div class="ea-footer">FUMA Buy/Sell • v3.2</div>
                </div>
                </div><!-- buysellPanel 닫기 -->
                
                <!-- Quick & Easy 패널 -->
                <div class="quick-panel" id="quickPanel">
                    <div class="quick-header">
                        <div class="quick-title-bar">
                            <div class="quick-title">⚡ QUICK & EASY</div>
                        </div>
                        
                        <div class="quick-content">
                            <!-- 계좌 정보 상단 바 -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Balance</div>
                                    <div id="quickBalance" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">$0</div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Equity</div>
                                    <div id="quickEquity" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">$0</div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Margin</div>
                                    <div id="quickMargin" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">$0</div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Today</div>
                                    <div id="quickTodayPL" style="font-size: 13px; font-weight: 700; color: var(--buy-color);">+$0</div>
                                </div>
                            </div>
                            
                            <!-- 종목 + 랏수 선택 -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">currency_exchange</span>
                                    종목 & 랏수 선택
                                </div>
                                <div style="display: flex; gap: 10px; align-items: stretch;">
                                    <!-- 종목 선택 -->
                                    <div style="flex: 1; position: relative;">
                                        <div id="quickSymbolSelector" onclick="toggleQuickSymbolDropdown()" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                            <span id="quickSymbolIcon" style="font-size: 24px; color: #f7931a;">₿</span>
                                            <div style="flex: 1;">
                                                <div id="quickSymbolName" style="font-size: 15px; font-weight: 700;">Bitcoin</div>
                                                <div id="quickSymbolId" style="font-size: 11px; color: var(--text-muted);">BTCUSD</div>
                                            </div>
                                            <span class="material-icons-round" style="color: var(--text-muted); font-size: 20px;">expand_more</span>
                                        </div>
                                        <!-- 종목 드롭다운 -->
                                        <div id="quickSymbolDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 10px; margin-top: 5px; z-index: 60; max-height: 250px; overflow-y: auto;">
                                            <div class="quick-symbol-option" data-symbol="BTCUSD" onclick="selectQuickSymbol('BTCUSD')">
                                                <span style="font-size: 20px; color: #f7931a;">₿</span>
                                                <div><div style="font-weight: 600;">Bitcoin</div><div style="font-size: 11px; color: var(--text-muted);">BTCUSD</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="EURUSD.r" onclick="selectQuickSymbol('EURUSD.r')">
                                                <span style="font-size: 20px; color: #0052cc;">€</span>
                                                <div><div style="font-weight: 600;">Euro/Dollar</div><div style="font-size: 11px; color: var(--text-muted);">EURUSD.r</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="USDJPY.r" onclick="selectQuickSymbol('USDJPY.r')">
                                                <span style="font-size: 20px; color: #dc143c;">¥</span>
                                                <div><div style="font-weight: 600;">Dollar/Yen</div><div style="font-size: 11px; color: var(--text-muted);">USDJPY.r</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="XAUUSD.r" onclick="selectQuickSymbol('XAUUSD.r')">
                                                <span style="font-size: 20px; color: #ffd700;">✦</span>
                                                <div><div style="font-weight: 600;">Gold</div><div style="font-size: 11px; color: var(--text-muted);">XAUUSD.r</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="US100." onclick="selectQuickSymbol('US100.')">
                                                <span style="font-size: 20px; color: #00b450;">⬡</span>
                                                <div><div style="font-weight: 600;">NASDAQ</div><div style="font-size: 11px; color: var(--text-muted);">US100.</div></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 랏수 선택 -->
                                    <div style="width: 110px;">
                                        <div style="display: flex; align-items: center; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; height: 100%;">
                                            <button onclick="adjustQuickLot(-0.01)" style="width: 32px; height: 100%; background: transparent; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer;">−</button>
                                            <input type="text" id="quickLotInput" value="0.01" onclick="this.select()" onchange="validateQuickLot(this)" style="flex: 1; background: transparent; border: none; color: var(--text-primary); text-align: center; font-size: 15px; font-weight: 700; width: 100%;">
                                            <button onclick="adjustQuickLot(0.01)" style="width: 32px; height: 100%; background: transparent; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer;">+</button>
                                        </div>
                                        <div style="text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 4px;">LOT</div>
                                    </div>
                                </div>
                                
                                <!-- 스프레드 표시 -->
                                <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 8px 12px; background: rgba(0, 212, 255, 0.1); border-radius: 8px;">
                                    <span style="font-size: 12px; color: var(--text-muted);">Spread</span>
                                    <span id="quickSpreadValue" style="font-size: 12px; font-weight: 600; color: var(--accent-cyan);">$15.00</span>
                                </div>
                            </div>
                            
                            <!-- 주문 버튼 -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">swap_vert</span>
                                    빠른 주문
                                </div>
                                <div class="quick-order-buttons">
                                    <button class="quick-order-btn sell" onclick="quickSell()">
                                        SELL
                                        <span class="quick-order-price" id="quickBidPrice">104,250.50</span>
                                    </button>
                                    <button class="quick-order-btn buy" onclick="quickBuy()">
                                        BUY
                                        <span class="quick-order-price" id="quickAskPrice">104,265.50</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 청산 버튼 -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">close</span>
                                    청산
                                </div>
                                <div class="quick-close-grid">
                                    <button class="quick-close-btn all-close" onclick="quickCloseAll()">
                                        <span class="material-icons-round">close_fullscreen</span>
                                        일괄청산
                                    </button>
                                    <button class="quick-close-btn symbol-close" onclick="quickCloseSymbol()">
                                        <span class="material-icons-round">cancel</span>
                                        현종목 청산
                                    </button>
                                    <button class="quick-close-btn buy-close" onclick="quickCloseBuy()">
                                        <span class="material-icons-round">arrow_upward</span>
                                        매수만 청산
                                    </button>
                                    <button class="quick-close-btn sell-close" onclick="quickCloseSell()">
                                        <span class="material-icons-round">arrow_downward</span>
                                        매도만 청산
                                    </button>
                                    <button class="quick-close-btn profit-close" onclick="quickCloseProfit()">
                                        <span class="material-icons-round">trending_up</span>
                                        수익만 청산
                                    </button>
                                    <button class="quick-close-btn loss-close" onclick="quickCloseLoss()">
                                        <span class="material-icons-round">trending_down</span>
                                        손실만 청산
                                    </button>
                                </div>
                            </div>
                            
                            <!-- SL/TP 설정 -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">security</span>
                                    SL / TP 설정
                                </div>
                                <div class="quick-sltp-row">
                                    <span class="quick-sltp-label sl">Stop Loss</span>
                                    <input type="number" class="quick-sltp-input" id="quickSLInput" placeholder="0" value="">
                                    <span class="quick-sltp-unit">pips</span>
                                </div>
                                <div class="quick-sltp-row">
                                    <span class="quick-sltp-label tp">Take Profit</span>
                                    <input type="number" class="quick-sltp-input" id="quickTPInput" placeholder="0" value="">
                                    <span class="quick-sltp-unit">pips</span>
                                </div>
                                <button class="quick-sltp-apply" onclick="applyQuickSLTP()">
                                    <span class="material-icons-round" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">check_circle</span>
                                    SL/TP 적용
                                </button>
                            </div>
                            
                            <!-- 포지션 리스트 -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">list_alt</span>
                                    포지션 리스트
                                </div>
                                <div class="quick-position-list" id="quickPositionList">
                                    <div class="quick-position-empty">
                                        <span class="material-icons-round">inbox</span>
                                        <div>열린 포지션이 없습니다</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="quick-footer">Quick & Easy Panel • v1.0</div>
                    </div>
                </div><!-- quickPanel 닫기 -->
                
            </div>
            
            <!-- ========== Account 탭 ========== -->
            <div class="page" id="page-account">
                <div class="account-summary">
                    <div class="summary-box"><div class="value" id="accBalance">$0</div><div class="label">Balance</div></div>
                    <div class="summary-box"><div class="value" id="accEquity">$0</div><div class="label">Equity</div></div>
                    <div class="summary-box"><div class="value" id="accMargin">$0</div><div class="label">Margin</div></div>
                    <div class="summary-box"><div class="value" id="accFree">$0</div><div class="label">Free Margin</div></div>
                    <div class="summary-box"><div class="value" id="accCurrentPL" style="color: var(--text-muted);">$0</div><div class="label">Current P/L</div></div>
                    <div class="summary-box"><div class="value" id="accTodayPL" style="color: var(--text-muted);">$0</div><div class="label">Today P/L</div></div>
                    <div class="summary-box"><div class="value" id="accWinLose" style="color: var(--text-muted);">0 / 0</div><div class="label">Win / Lose</div></div>
                    <div class="summary-box"><div class="value" id="accLeverage">1:500</div><div class="label">Leverage</div></div>
                </div>
                <div class="card">
                    <div class="card-title">
                        <span class="material-icons-round" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">history</span>
                        Trade History
                    </div>
                    <div id="historyList"><p style="color: var(--text-muted); text-align: center; padding: 20px;">Loading...</p></div>
                </div>
            </div>
            
            <!-- ========== My 탭 ========== -->
            <div class="page" id="page-my">
                <div class="profile-header">
                    <div class="profile-avatar"><span class="material-icons-round" style="font-size: 48px;">account_circle</span></div>
                    <div class="profile-name" id="profileName">Trader</div>
                    <div class="profile-level">Standard Member</div>
                </div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">person</span></span><span>My Account</span></div><span class="menu-arrow">›</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">account_balance</span></span><span>Deposit / Withdraw</span></div><span class="menu-arrow">›</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">tune</span></span><span>Trading Settings</span></div><span class="menu-arrow">›</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">security</span></span><span>Security</span></div><span class="menu-arrow">›</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">help_outline</span></span><span>Help & Support</span></div><span class="menu-arrow">›</span></div>
                <div class="menu-item" onclick="logout()" style="margin-top: 20px; border-color: var(--sell-color);">
                    <div class="menu-left">
                        <span class="menu-icon"><span class="material-icons-round" style="color: var(--sell-color);">logout</span></span>
                        <span style="color: var(--sell-color);">Logout</span>
                    </div>
                    <span class="menu-arrow" style="color: var(--sell-color);">›</span>
                </div>
            </div>
        </div>

        <!-- 하단 네비게이션 -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="home"><span class="nav-icon"><span class="material-icons-round">home</span></span><span class="nav-label">Home</span></div>
            <div class="nav-item" data-page="chart"><span class="nav-icon"><span class="material-icons-round">candlestick_chart</span></span><span class="nav-label">Chart</span></div>
            <div class="nav-item" data-page="trade"><span class="nav-icon"><span class="material-icons-round">swap_vert</span></span><span class="nav-label">Trade</span></div>
            <div class="nav-item" data-page="account"><span class="nav-icon"><span class="material-icons-round">account_balance_wallet</span></span><span class="nav-label">Account</span></div>
            <div class="nav-item" data-page="my"><span class="nav-icon"><span class="material-icons-round">person</span></span><span class="nav-label">My</span></div>
        </div>
        
        <!-- 마틴 손실 팝업 -->
        <div id="martinPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 20px; margin: 16px; max-width: 360px; width: 100%;">
                <div style="text-align: center;">
                    <div style="margin-bottom: 12px;">
                        <div style="width: 56px; height: 56px; margin: 0 auto; background: linear-gradient(135deg, #1e3a5f 0%, #0d1f33 100%); border: 2px solid rgba(0,212,255,0.4); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,212,255,0.3);">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M8 22L14 12L20 16L26 8" stroke="#00d4ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 8H26V12" stroke="#00d4ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <rect x="6" y="20" width="4" height="6" rx="1" fill="#dc3246" opacity="0.9"/>
                                <rect x="14" y="17" width="4" height="9" rx="1" fill="#ffa500" opacity="0.9"/>
                                <rect x="22" y="14" width="4" height="12" rx="1" fill="#00b450" opacity="0.9"/>
                            </svg>
                        </div>
                    </div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--accent-cyan); margin-bottom: 4px;">
                        Martin Step <span id="popupCurrentStep">1</span> Loss
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: white; margin-bottom: 16px;">
                        마틴 <span id="popupCurrentStepKr">1</span>단계 손실 발생
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Current Loss / 현재 손실</span>
                            <span id="popupCurrentLoss" style="font-size: 14px; font-weight: bold; color: #dc3246;">-$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Accumulated / 누적 손실</span>
                            <span id="popupAccumulatedLoss" style="font-size: 14px; font-weight: bold; color: #dc3246;">-$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Next Lot Size / 다음 랏수</span>
                            <span id="popupNextLot" style="font-size: 14px; font-weight: bold; color: white;">0.02 lot</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--text-muted);">Recovery Target / 회복 목표</span>
                            <span id="popupRecoveryTarget" style="font-size: 14px; font-weight: bold; color: #00b450;">+$0</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: white; margin-bottom: 4px;">
                        Proceed to next step (<span id="popupNextStep">2</span>)?
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">
                        다음 단계 (<span id="popupNextStepKr">2</span>단계)로 진행하시겠습니까?
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="martinPopupSettings()" style="flex: 1; padding: 10px; border-radius: 8px; font-weight: bold; color: white; background: var(--bg-tertiary); border: 1px solid var(--text-muted); cursor: pointer;">
                            설정 / Settings
                        </button>
                        <button onclick="martinPopupContinue()" style="flex: 1; padding: 10px; border-radius: 8px; font-weight: bold; color: white; background: #00b450; border: none; cursor: pointer;">
                            계속 / Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 마틴 성공 팝업 -->
        <div id="martinSuccessPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); border: 2px solid #00b450; border-radius: 12px; padding: 20px; margin: 16px; max-width: 360px; width: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">🎉</div>
                    <div style="font-size: 18px; font-weight: bold; color: #00b450; margin-bottom: 4px;">
                        Martin Success!
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: white; margin-bottom: 16px;">
                        마틴 모드 성공!
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Total Profit / 총 수익</span>
                            <span id="successPopupProfit" style="font-size: 14px; font-weight: bold; color: #00b450;">+$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--text-muted);">Recovered Loss / 회복 손실</span>
                            <span id="successPopupRecovered" style="font-size: 14px; font-weight: bold; color: #00d4ff;">$0</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: white; margin-bottom: 4px;">
                        What would you like to do next?
                    </div>
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                        다음에 무엇을 하시겠습니까?
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="martinSuccessToSettings()" style="flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; color: white; background: var(--bg-tertiary); border: 1px solid var(--text-muted); cursor: pointer;">
                            ⚙️ 설정으로
                        </button>
                        <button onclick="martinSuccessContinue()" style="flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; color: white; background: #00b450; border: none; cursor: pointer;">
                            🔄 1단계 시작
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 마틴 최대 단계 도달 팝업 -->
        <div id="martinMaxPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); border: 2px solid #dc3246; border-radius: 12px; padding: 20px; margin: 16px; max-width: 360px; width: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">⚠️</div>
                    <div style="font-size: 18px; font-weight: bold; color: #dc3246; margin-bottom: 4px;">
                        Maximum Steps Reached!
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: white; margin-bottom: 16px;">
                        최대 단계에 도달했습니다
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Total Loss / 총 손실</span>
                            <span id="maxPopupTotalLoss" style="font-size: 14px; font-weight: bold; color: #dc3246;">-$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--text-muted);">Steps Used / 사용 단계</span>
                            <span id="maxPopupStepsUsed" style="font-size: 14px; font-weight: bold; color: white;">7 / 7</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">
                        Martin will reset to Step 1.<br>마틴이 1단계로 초기화됩니다.
                    </div>
                    <button onclick="closeMaxPopup()" style="width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; color: white; background: #dc3246; border: none; cursor: pointer;">
                        확인 / OK
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 종목 검색 모달 -->
        <div class="modal-overlay" id="symbolSearchModal">
            <div style="background: var(--bg-secondary); border-radius: 16px; margin: 15px; max-width: 450px; width: 100%; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden;">
                <!-- 검색 헤더 -->
                <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons-round" style="color: var(--text-muted);">search</span>
                        <input type="text" id="symbolSearchInput" placeholder="종목명 또는 심볼 검색..." 
                            style="flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none;"
                            oninput="onSymbolSearch(this.value)" autocomplete="off">
                        <button onclick="closeSymbolSearch()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">✕</button>
                    </div>
                </div>
                
                <!-- 카테고리 필터 -->
                <div style="display: flex; gap: 8px; padding: 10px 15px; border-bottom: 1px solid var(--border-color); overflow-x: auto;">
                    <button class="search-category-btn active" data-category="all" onclick="filterSearchCategory('all')">전체</button>
                    <button class="search-category-btn" data-category="forex" onclick="filterSearchCategory('forex')">Forex</button>
                    <button class="search-category-btn" data-category="crypto" onclick="filterSearchCategory('crypto')">Crypto</button>
                    <button class="search-category-btn" data-category="indices" onclick="filterSearchCategory('indices')">Indices</button>
                    <button class="search-category-btn" data-category="metals" onclick="filterSearchCategory('metals')">Metals</button>
                </div>
                
                <!-- 검색 결과 -->
                <div id="symbolSearchResults" style="flex: 1; overflow-y: auto; padding: 10px 0;">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search</span>
                        <p style="margin-top: 10px;">종목명 또는 심볼을 입력하세요</p>
                    </div>
                </div>
                
                <!-- 로딩 표시 -->
                <div id="symbolSearchLoading" style="display: none; text-align: center; padding: 20px;">
                    <div style="color: var(--accent-cyan);">검색 중...</div>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div class="toast" id="toast"></div>
        
        <!-- 게스트 모드 가입 유도 팝업 -->
        <div class="modal-overlay" id="guestPopup">
            <div style="background: linear-gradient(180deg, #1e2127 0%, #15171c 100%); border: 2px solid #00d4ff; border-radius: 16px; padding: 30px 25px; margin: 20px; max-width: 360px; width: 100%; text-align: center; box-shadow: 0 0 60px rgba(0,212,255,0.3);">
                <div style="font-size: 50px; margin-bottom: 15px;">🚀</div>
                <div style="font-size: 22px; font-weight: bold; color: #00d4ff; margin-bottom: 8px; letter-spacing: 1px;">Ready to Trade?</div>
                <div style="font-size: 15px; color: #9ca3af; margin-bottom: 25px; line-height: 1.6;">
                    실제 거래를 시작하려면<br>계정이 필요합니다
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 15px;">
                    <button onclick="goToRegister()" style="flex: 1; padding: 14px; font-size: 15px; font-weight: bold; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); border: none; border-radius: 10px; color: #000; cursor: pointer;">
                        회원가입
                    </button>
                    <button onclick="goToLoginPage()" style="flex: 1; padding: 14px; font-size: 15px; font-weight: bold; background: transparent; border: 2px solid #00d4ff; border-radius: 10px; color: #00d4ff; cursor: pointer;">
                        로그인
                    </button>
                </div>
                <button onclick="closeGuestPopup()" style="padding: 10px 30px; font-size: 13px; background: transparent; border: none; color: #6b7280; cursor: pointer;">
                    계속 둘러보기
                </button>
            </div>
        </div>
        
        <!-- MT5 연결 모달 -->
        <div class="modal-overlay" id="mt5ConnectModal">
            <div style="background: linear-gradient(180deg, #1e2127 0%, #15171c 100%); border: 2px solid var(--accent-cyan); border-radius: 16px; padding: 0; margin: 10px; max-width: 420px; width: 100%; box-shadow: 0 0 60px rgba(0,212,255,0.2); overflow: hidden;">
                <!-- 헤더 -->
                <div style="background: #000; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 9px;">
                        <span class="material-icons-round" style="color: var(--accent-cyan); font-size: 26px;">link</span>
                        <span style="font-size: 18px; font-weight: bold;">MT5 계좌 연결</span>
                    </div>
                    <button onclick="closeMT5ConnectModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">✕</button>
                </div>
                
                <!-- 선택 화면 -->
                <div id="mt5Step1" style="padding: 15px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 15px; color: var(--text-muted);">계좌 보유 여부를 선택해주세요</div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="showMT5Step2('existing')" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left;">
                            <span class="material-icons-round" style="font-size: 28px; color: var(--accent-cyan);">account_circle</span>
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: white;">이미 HedgeHood 계좌가 있습니다</div>
                                <div style="font-size: 13px; color: var(--text-muted);">기존 계좌 연결하기</div>
                            </div>
                            <span class="material-icons-round" style="margin-left: auto; color: var(--text-muted);">chevron_right</span>
                        </button>
                        
                        <button onclick="showMT5Step2('new')" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left;">
                            <span class="material-icons-round" style="font-size: 28px; color: var(--buy-color);">person_add</span>
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: white;">신규로 계좌를 개설하고 싶습니다</div>
                                <div style="font-size: 13px; color: var(--text-muted);">HedgeHood 가입 안내</div>
                            </div>
                            <span class="material-icons-round" style="margin-left: auto; color: var(--text-muted);">chevron_right</span>
                        </button>
                    </div>
                </div>
                
                <!-- 기존 계좌 연결 폼 -->
                <div id="mt5Step2Existing" style="display: none; padding: 15px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: white; margin-bottom: 6px;">Server (서버)</label>
                        <select id="mt5Server" style="width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 15px;">
                            <option value="HedgeHood-MT5" selected>HedgeHood-MT5</option>
                            <option value="HedgeHood-Live">HedgeHood-Live</option>
                            <option value="HedgeHood-Demo">HedgeHood-Demo</option>
                        </select>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                            <span class="material-icons-round" style="font-size: 16px;">info</span>
                            MT5 상단 타이틀바에서 확인 가능
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: white; margin-bottom: 6px;">Account Number (계좌번호)</label>
                        <input type="text" id="mt5AccountNumber" placeholder="예: 930000024" style="width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 15px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: white; margin-bottom: 6px;">Password (거래계좌 암호)</label>
                        <input type="password" id="mt5Password" placeholder="거래계좌 암호 입력" style="width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 15px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                            <span class="material-icons-round" style="font-size: 16px;">warning</span>
                            MT5 로그인 시 사용하는 암호를 입력하세요
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="showMT5Step1()" style="flex: 1; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer;">
                            이전
                        </button>
                        <button onclick="connectMT5Account()" style="flex: 2; padding: 16px; background: linear-gradient(135deg, var(--accent-cyan) 0%, #0099cc 100%); border: none; border-radius: 10px; color: #000; font-size: 15px; font-weight: 700; cursor: pointer;">
                            연결하기
                        </button>
                    </div>
                </div>
                
                <!-- 신규 계좌 개설 안내 -->
                <div id="mt5Step2New" style="display: none; padding: 18px;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="width: 70px; height: 70px; margin: 0 auto 15px; background: linear-gradient(135deg, rgba(0, 180, 80, 0.2) 0%, rgba(0, 180, 80, 0.05) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons-round" style="font-size: 36px; color: var(--buy-color);">rocket_launch</span>
                        </div>
                        <div style="font-size: 18px; font-weight: 600; color: white; margin-bottom: 5px;">HedgeHood 계좌 개설</div>
                        <div style="font-size: 14px; color: var(--text-muted);">간단한 절차로 거래를 시작하세요</div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 18px; margin-bottom: 22px;">
                        <div style="display: flex; align-items: flex-start; gap: 14px; margin-bottom: 16px;">
                            <div style="width: 28px; height: 28px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #000; flex-shrink: 0;">1</div>
                            <div>
                                <div style="font-size: 15px; font-weight: 600; color: white;">HedgeHood 홈페이지 접속</div>
                                <div style="font-size: 13px; color: var(--text-muted);">hedgehood.com</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 14px; margin-bottom: 16px;">
                            <div style="width: 28px; height: 28px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #000; flex-shrink: 0;">2</div>
                            <div>
                                <div style="font-size: 15px; font-weight: 600; color: white;">회원가입 및 본인인증</div>
                                <div style="font-size: 13px; color: var(--text-muted);">이메일, 신분증 인증</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 14px;">
                            <div style="width: 28px; height: 28px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #000; flex-shrink: 0;">3</div>
                            <div>
                                <div style="font-size: 15px; font-weight: 600; color: white;">계좌 개설 신청</div>
                                <div style="font-size: 13px; color: var(--text-muted);">약 5~10분 소요</div>
                            </div>
                        </div>
                    </div>
                    
                    <a href="https://hedgehood.com" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 16px; background: linear-gradient(135deg, var(--buy-color) 0%, #008040 100%); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; text-decoration: none; margin-bottom: 15px;">
                        <span class="material-icons-round" style="font-size: 20px;">open_in_new</span>
                        HedgeHood.com 바로가기
                    </a>
                    
                    <div style="text-align: center; font-size: 13px; color: var(--text-muted); padding: 12px; background: rgba(0, 212, 255, 0.1); border-radius: 10px;">
                        <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">lightbulb</span>
                        계좌 개설 후 이 화면에서 MT5 계좌를 연결하세요!
                    </div>
                    
                    <button onclick="showMT5Step1()" style="width: 100%; margin-top: 18px; padding: 14px; background: transparent; border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); font-size: 15px; font-weight: 600; cursor: pointer;">
                        이전으로
                    </button>
                </div>
            </div>
        </div>

        <!-- MT5 연결 성공 모달 -->
        <div class="modal-overlay" id="mt5SuccessModal">
            <div style="background: linear-gradient(180deg, #1e2127 0%, #15171c 100%); border: 2px solid var(--buy-color); border-radius: 16px; padding: 18px; margin: 10px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 0 60px rgba(0, 180, 80, 0.3);">
                <div style="width: 70px; height: 70px; margin: 0 auto 15px; background: linear-gradient(135deg, rgba(0, 180, 80, 0.2) 0%, rgba(0, 180, 80, 0.05) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span class="material-icons-round" style="font-size: 36px; color: var(--buy-color);">check_circle</span>
                </div>
                <div style="font-size: 18px; font-weight: bold; color: var(--buy-color); margin-bottom: 5px;">연결 완료!</div>
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">MT5 계좌가 성공적으로 연결되었습니다</div>
                
                <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: left;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted); font-size: 13px;">Broker</span><span style="font-weight: 600; font-size: 13px;" id="successBroker">HedgeHood</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted); font-size: 13px;">Account</span><span style="font-weight: 600; font-size: 13px;" id="successAccount">-</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted); font-size: 13px;">Server</span><span style="font-weight: 600; font-size: 13px;" id="successServer">-</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;"><span style="color: var(--text-muted); font-size: 13px;">Leverage</span><span style="font-weight: 600; font-size: 13px;" id="successLeverage">1:500</span></div>
                </div>
                
                <div style="font-size: 13px; color: var(--accent-cyan); margin-bottom: 15px;">💎 이제 Live 거래를 시작하세요!</div>
                
                <button onclick="closeMT5SuccessModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--buy-color) 0%, #008040 100%); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer;">
                    확인
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="settings-panel">
                <div class="settings-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>⚙️</span>
                        <span class="settings-title">Trading Settings</span>
                    </div>
                    <button class="settings-close" onclick="closeSettings()">✕</button>
                </div>
                
                <div class="settings-content">
                    <!-- Strategy Mode -->
                    <div class="settings-section">
                        <div class="settings-label">STRATEGY MODE</div>
                        
                        <div class="mode-option selected" data-mode="basic" onclick="selectMode(this)">
                            <div class="mode-option-header">
                                <span class="mode-radio">●</span>
                                <span class="mode-name" style="width: 80px;">Basic</span>
                                <span class="mode-desc">- Safe & Steady</span>
                            </div>
                        </div>
                        
                        <div class="mode-option" data-mode="noLimit" onclick="selectMode(this)">
                            <div class="mode-option-header">
                                <span class="mode-radio">○</span>
                                <span class="mode-name" style="width: 80px;">No Limit</span>
                                <span class="mode-desc">- Up to 50%</span>
                            </div>
                        </div>
                        
                        <div class="mode-option" data-mode="martin" onclick="selectMode(this)">
                            <div class="mode-option-header">
                                <span class="mode-radio">○</span>
                                <span class="mode-name" style="width: 80px;">Martin</span>
                                <span class="mode-desc">- High Risk</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trading Settings -->
                    <div class="settings-section">
                        <div class="settings-label">TRADING SETTINGS</div>
                        
                        <!-- Symbol Selector -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 12px; color: white; margin-bottom: 6px;">Select Symbol</div>
                            <div style="position: relative;">
                                <div id="settingsSymbolBtn" style="padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleSettingsSymbol()">
                                    <span id="settingsSymbolText" style="font-weight: bold;">BTCUSD</span>
                                    <span>▼</span>
                                </div>
                                <div id="settingsSymbolDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 6px; margin-top: 4px; z-index: 10;">
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('BTCUSD')">BTCUSD</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('EURUSD.r')">EURUSD.r</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('USDJPY.r')">USDJPY.r</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('XAUUSD.r')">XAUUSD.r</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('US100.')">US100.</div>
                                </div>
                            </div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;" id="settingsSymbolDesc">Bitcoin | Spread: ~$11</div>
                        </div>
                        
                        <!-- Profit Target -->
                        <div class="input-row">
                            <div>
                                <span class="input-label">Profit Target</span>
                                <span class="input-hint" id="targetHint">(Range: $10 ~ $200)</span>
                            </div>
                            <div class="input-controls">
                                <button class="input-btn" onclick="adjustSettingsTarget(-10)">▼</button>
                                <div class="input-value" id="settingsTargetValue">$100</div>
                                <button class="input-btn" onclick="adjustSettingsTarget(10)">▲</button>
                            </div>
                        </div>
                        
                        <!-- Leverage / Lot Size -->
                        <div class="input-row">
                            <div>
                                <span class="input-label" id="leverageLotLabel">Leverage</span>
                                <span class="input-hint" id="leverageLotHint">(Range: x1 ~ x20)</span>
                            </div>
                            <div class="input-controls">
                                <button class="input-btn" onclick="adjustSettingsLeverage(-1)">▼</button>
                                <input type="text" class="input-value" id="settingsLeverageValue" value="x5" 
                                onclick="this.select();" 
                                onchange="updateSettingsLeverageFromInput(this.value);"
                                style="cursor: text;">
                                <button class="input-btn" onclick="adjustSettingsLeverage(1)">▲</button>
                            </div>
                        </div>
                        
                        <div class="settings-divider"></div>
                        
                        <!-- Martin Level -->
                        <div class="input-row" id="martinLevelRow" style="opacity: 0.4;">
                            <div class="martin-row">
                                <input type="checkbox" class="martin-checkbox" id="martinCheckbox" disabled onchange="toggleMartinLevel()">
                                <span class="input-label">Martin Level</span>
                                <span class="input-hint">(Step: ~ 20)</span>
                            </div>
                            <div class="input-controls">
                                <button class="input-btn" id="martinDownBtn" disabled onclick="adjustMartinLevel(-1)">▼</button>
                                <div class="input-value" id="martinLevelValue">3</div>
                                <button class="input-btn" id="martinUpBtn" disabled onclick="adjustMartinLevel(1)">▲</button>
                            </div>
                        </div>
                        
                        <div class="martin-max" id="martinMaxInfo" style="display: none;">
                            <span>Available</span>
                            <button class="martin-max-btn" onclick="setMartinMax()">Max</button>
                            <span>: Step [<span id="martinMaxStep">7</span>] | Required [<span id="martinRequired">$12,700+</span>]</span>
                        </div>
                        
                        <div class="martin-info">Martin Level: Max recovery steps for Martingale mode</div>
                    </div>
                </div>
                
                <div class="settings-footer">
                    <button class="settings-footer-btn apply" onclick="applySettings()">Apply</button>
                    <button class="settings-footer-btn reset" onclick="resetSettings()">Reset</button>
                </div>
            </div>
        </div>
        
        <!-- 차트 서브메뉴 (바텀시트) -->
        <div class="submenu-overlay" id="chartSubmenuOverlay" onclick="closeChartSubmenu()">
            <div class="submenu-sheet" onclick="event.stopPropagation()">
                <div class="submenu-handle"></div>
                <div class="submenu-title">Chart 메뉴 선택</div>
                
                <!-- 종목 목록 -->
                <div class="submenu-item" 
                     onclick="selectSubmenuItem('watchlist')"
                     onmousedown="submenuItemPressStart('watchlist', this)"
                     onmouseup="submenuItemPressEnd()"
                     onmouseleave="submenuItemPressEnd()"
                     ontouchstart="submenuItemPressStart('watchlist', this)"
                     ontouchend="submenuItemPressEnd()"
                     ontouchcancel="submenuItemPressEnd()">
                    <div class="submenu-item-icon">📋</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">종목 목록</div>
                        <div class="submenu-item-hint">길게 눌러 기본 화면으로 등록</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuWatchlistBadge" style="display: none;">기본</div>
                    <div class="submenu-item-progress"></div>
                </div>
                
                <!-- 차트 보기 -->
                <div class="submenu-item" 
                     onclick="selectSubmenuItem('chart')"
                     onmousedown="submenuItemPressStart('chart', this)"
                     onmouseup="submenuItemPressEnd()"
                     onmouseleave="submenuItemPressEnd()"
                     ontouchstart="submenuItemPressStart('chart', this)"
                     ontouchend="submenuItemPressEnd()"
                     ontouchcancel="submenuItemPressEnd()">
                    <div class="submenu-item-icon">📈</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">차트 보기</div>
                        <div class="submenu-item-hint">길게 눌러 기본 화면으로 등록</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuChartBadge" style="display: none;">기본</div>
                    <div class="submenu-item-progress"></div>
                </div>
            </div>
        </div>
        
        <!-- 서브메뉴 등록 토스트 -->
        <div class="submenu-toast" id="submenuToast">
            <div class="submenu-toast-icon">✅</div>
            <div class="submenu-toast-title">"<span id="submenuToastViewName">차트 보기</span>" 등록 완료!</div>
            <div class="submenu-toast-desc">앞으로 해당 탭을 길게 누르면<br>바로 이동합니다 🚀</div>
        </div>
        
        <!-- Trade 서브메뉴 (바텀시트) -->
        <div class="submenu-overlay" id="tradeSubmenuOverlay" onclick="closeTradeSubmenu()">
            <div class="submenu-sheet" onclick="event.stopPropagation()">
                <div class="submenu-handle"></div>
                <div class="submenu-title">Trade 메뉴 선택</div>
                
                <!-- Buy/Sell 패널 -->
                <div class="submenu-item" 
                     onclick="selectTradeSubmenuItem('buysell')"
                     onmousedown="tradeSubmenuItemPressStart('buysell', this)"
                     onmouseup="tradeSubmenuItemPressEnd()"
                     onmouseleave="tradeSubmenuItemPressEnd()"
                     ontouchstart="tradeSubmenuItemPressStart('buysell', this)"
                     ontouchend="tradeSubmenuItemPressEnd()"
                     ontouchcancel="tradeSubmenuItemPressEnd()">
                    <div class="submenu-item-icon">📊</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">Buy/Sell 패널</div>
                        <div class="submenu-item-hint">길게 눌러 기본 화면으로 등록</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuBuysellBadge" style="display: none;">기본</div>
                    <div class="submenu-item-progress"></div>
                </div>
                
                <!-- Quick & Easy 패널 -->
                <div class="submenu-item" 
                     onclick="selectTradeSubmenuItem('quick')"
                     onmousedown="tradeSubmenuItemPressStart('quick', this)"
                     onmouseup="tradeSubmenuItemPressEnd()"
                     onmouseleave="tradeSubmenuItemPressEnd()"
                     ontouchstart="tradeSubmenuItemPressStart('quick', this)"
                     ontouchend="tradeSubmenuItemPressEnd()"
                     ontouchcancel="tradeSubmenuItemPressEnd()">
                    <div class="submenu-item-icon">⚡</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">Quick & Easy 패널</div>
                        <div class="submenu-item-hint">길게 눌러 기본 화면으로 등록</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuQuickBadge" style="display: none;">기본</div>
                    <div class="submenu-item-progress"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Configuration ==========
        const getApiUrl = () => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.') || hostname.startsWith('10.')) {
                return `http://${hostname}:8000/api`;
            }
            return 'http://localhost:8000/api';
        };
        const getWsUrl = (path) => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.') || hostname.startsWith('10.')) {
                return `ws://${hostname}:8000${path}`;
            }
            return `ws://localhost:8000${path}`;
        };
        const API_URL = getApiUrl();

        // ========== Auth Check ==========
        const token = localStorage.getItem('access_token');
        const isGuest = sessionStorage.getItem('guest_mode') === 'true';
        let isDemo = false;  // Demo 모드 여부 (로그인 후 확인)
        
        if (!token && !isGuest) {
            window.location.href = 'login.html';
        }
        
        // ========== 전역 변수 ==========
        let chart = null;
        let candleSeries = null;
        let bbUpperSeries = null;
        let bbMiddleSeries = null;
        let bbLowerSeries = null;
        let lwmaSeries = null;
        let currentTimeframe = 'M1';
        let currentSymbol = 'BTCUSD';
        let chartSymbol = 'BTCUSD';
        let currentMode = 'basic';
        let targetAmount = 100;
        let leverage = 5;
        let lotSize = 0.10;
        let martinLevel = 3;
        let martinEnabled = false;
        let martinStep = 1;
        let martinAccumulatedLoss = 0;
        let hasPosition = false;
        let positionData = null;
        let positionStartTime = null;
        let positionTimer = null;
        let balance = 10000;
        let todayPL = 0;
        let martinHistory = [];
        let pendingLoss = 0;
        let isClosing = false;  // 청산 중복 방지 플래그
        
        // 게이지 애니메이션 변수
        let displayScore = 50;
        let targetScore = 50;
        let baseScore = 50;
        let velocity = 0;
        
        // 차트 게이지 변수
        let chartDisplayScore = 50;
        let chartTargetScore = 50;
        let chartVelocity = 0;
        
        const symbolData = {
            'BTCUSD': { name: 'Bitcoin', icon: '₿', color: '#f7931a', desc: 'Bitcoin | Spread: ~$11' },
            'EURUSD.r': { name: 'Euro/Dollar', icon: '€', color: '#0052cc', desc: 'Euro/Dollar | Spread: ~$2' },
            'USDJPY.r': { name: 'Dollar/Yen', icon: '¥', color: '#dc143c', desc: 'Dollar/Yen | Spread: ~$3' },
            'XAUUSD.r': { name: 'Gold', icon: '✦', color: '#ffd700', desc: 'Gold | Spread: ~$8' },
            'US100.': { name: 'NASDAQ', icon: '⬡', color: '#00b450', desc: 'NASDAQ | Spread: ~$5' }
        };
        
        // ========== API Helper ==========
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // 토큰이 있으면 추가
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }
        
        // ========== 네비게이션 ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const page = item.dataset.page;
                
                // 차트 탭은 서브메뉴로 처리 (별도 이벤트에서 핸들링)
                if (page === 'chart') {
                    return; // setupNavLongPress()에서 처리
                }
                
                // Trade 탭도 서브메뉴로 처리 (별도 이벤트에서 핸들링)
                if (page === 'trade') {
                    return; // setupNavLongPress()에서 처리
                }
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-' + page).classList.add('active');
                
                // 게스트 모드에서 Account/My 탭 제한
                if (isGuest && (page === 'account' || page === 'my')) {
                    showGuestPopup();
                    return;
                }
                
                if (page === 'account') loadHistory();
            });
        });
        
        // ========== 왓치리스트 ==========
        let watchlistPrices = {};
        let currentWatchlistTab = 'popular';
        
        // 즐겨찾기 localStorage에서 불러오기 (종목 정보 전체 저장)
        function loadFavorites() {
            const saved = localStorage.getItem('watchlist_favorites_v2');
            if (saved) {
                return JSON.parse(saved);
            }
            // 기본 즐겨찾기
            return [
                { symbol: 'BTCUSD', name: 'BTCUSD', fullName: 'Bitcoin vs US Dollar', icon: '₿', color: '#f7931a' },
                { symbol: 'XAUUSD.r', name: 'XAUUSD', fullName: 'Gold vs US Dollar', icon: '✦', color: '#ffd700' }
            ];
        }
        
        function saveFavorites(favorites) {
            localStorage.setItem('watchlist_favorites_v2', JSON.stringify(favorites));
        }
        
        let favoriteSymbols = loadFavorites();
        
        // 즐겨찾기 여부 확인
        function isFavorite(symbol) {
            return favoriteSymbols.some(item => item.symbol === symbol);
        }
        
        const watchlistSymbols = {
            popular: [
                { symbol: 'BTCUSD', name: 'BTCUSD', fullName: 'Bitcoin vs US Dollar', icon: '₿', color: '#f7931a' },
                { symbol: 'EURUSD.r', name: 'EURUSD', fullName: 'Euro vs US Dollar', icon: '€', color: '#0052cc' },
                { symbol: 'USDJPY.r', name: 'USDJPY', fullName: 'Dollar vs Japanese Yen', icon: '¥', color: '#dc143c' },
                { symbol: 'XAUUSD.r', name: 'XAUUSD', fullName: 'Gold vs US Dollar', icon: '✦', color: '#ffd700' },
                { symbol: 'US100.', name: 'US100', fullName: 'Nasdaq 100 Index', icon: '⬡', color: '#00b450' }
            ],
            forex: [
                { symbol: 'EURUSD.r', name: 'EURUSD', fullName: 'Euro vs US Dollar', icon: '€', color: '#0052cc' },
                { symbol: 'USDJPY.r', name: 'USDJPY', fullName: 'Dollar vs Japanese Yen', icon: '¥', color: '#dc143c' },
                { symbol: 'GBPUSD.r', name: 'GBPUSD', fullName: 'Pound vs US Dollar', icon: '£', color: '#9c27b0' },
                { symbol: 'AUDUSD.r', name: 'AUDUSD', fullName: 'Australian vs US Dollar', icon: 'A$', color: '#00875a' },
                { symbol: 'USDCAD.r', name: 'USDCAD', fullName: 'US Dollar vs Canadian', icon: 'C$', color: '#ff5722' }
            ],
            crypto: [
                { symbol: 'BTCUSD', name: 'BTCUSD', fullName: 'Bitcoin vs US Dollar', icon: '₿', color: '#f7931a' },
                { symbol: 'ETHUSD', name: 'ETHUSD', fullName: 'Ethereum vs US Dollar', icon: 'Ξ', color: '#627eea' }
            ],
            indices: [
                { symbol: 'US100.', name: 'US100', fullName: 'Nasdaq 100 Index', icon: '⬡', color: '#00b450' },
                { symbol: 'US500.', name: 'US500', fullName: 'S&P 500 Index', icon: '◆', color: '#1976d2' },
                { symbol: 'US30.', name: 'US30', fullName: 'Dow Jones Index', icon: '◈', color: '#ff9800' }
            ],
            metals: [
                { symbol: 'XAUUSD.r', name: 'XAUUSD', fullName: 'Gold vs US Dollar', icon: '✦', color: '#ffd700' },
                { symbol: 'XAGUSD.r', name: 'XAGUSD', fullName: 'Silver vs US Dollar', icon: '✦', color: '#c0c0c0' }
            ],
            energy: [
                { symbol: 'XBRUSD', name: 'BRENT', fullName: 'Brent Crude Oil', icon: '🛢', color: '#795548' },
                { symbol: 'XTIUSD', name: 'WTI', fullName: 'WTI Crude Oil', icon: '🛢', color: '#5d4037' }
            ]
        };
        
        // 즐겨찾기 목록 - 저장된 전체 정보 반환
        function getFavoritesWatchlist() {
            return favoriteSymbols;
        }
        
        // 즐겨찾기 토글 (왓치리스트에서)
        function toggleFavorite(symbol, event) {
            event.stopPropagation();
            
            const index = favoriteSymbols.findIndex(item => item.symbol === symbol);
            if (index > -1) {
                // 제거
                favoriteSymbols.splice(index, 1);
                showToast(`${symbol} 즐겨찾기에서 제거됨`, '');
            } else {
                // 추가 - watchlistSymbols에서 정보 찾기
                const allSymbols = [
                    ...watchlistSymbols.popular,
                    ...watchlistSymbols.forex,
                    ...watchlistSymbols.crypto,
                    ...watchlistSymbols.indices,
                    ...watchlistSymbols.metals,
                    ...watchlistSymbols.energy
                ];
                const found = allSymbols.find(item => item.symbol === symbol);
                if (found) {
                    favoriteSymbols.push(found);
                    showToast(`⭐ ${symbol} 즐겨찾기 추가!`, 'success');
                }
            }
            
            saveFavorites(favoriteSymbols);
            renderWatchlist();
        }
        
        // 검색에서 즐겨찾기 추가 (종목 정보 전체 저장)
        function addToFavorites(symbol, name, icon, color, event) {
            event.stopPropagation();
            
            if (!isFavorite(symbol)) {
                // 종목 정보 전체 저장
                favoriteSymbols.push({
                    symbol: symbol,
                    name: symbol.replace('.r', '').replace('.', ''),
                    fullName: name,
                    icon: icon,
                    color: color
                });
                saveFavorites(favoriteSymbols);
                showToast(`⭐ ${symbol} 즐겨찾기 추가!`, 'success');
                
                // 버튼 상태 변경
                const btn = event.target.closest('.search-add-btn');
                if (btn) {
                    btn.classList.add('added');
                    btn.textContent = '✓';
                }
            } else {
                showToast(`${symbol}은(는) 이미 즐겨찾기에 있습니다`, '');
            }
        }
        
        // 임시 시세 데이터 (API 연동 전)
        const demoQuotes = {
            'BTCUSD': { bid: 104250.50, ask: 104265.50, change: 2.35 },
            'EURUSD.r': { bid: 1.08542, ask: 1.08562, change: -0.12 },
            'USDJPY.r': { bid: 157.852, ask: 157.872, change: 0.45 },
            'XAUUSD.r': { bid: 2658.50, ask: 2659.00, change: 1.28 },
            'US100.': { bid: 21542.50, ask: 21545.50, change: 0.85 }
        };
        
        function showWatchlist() {
            document.getElementById('watchlistContainer').style.display = 'flex';
            document.getElementById('chartDetailContainer').style.display = 'none';
        }
        
        function showChartDetail() {
            document.getElementById('watchlistContainer').style.display = 'none';
            document.getElementById('chartDetailContainer').style.display = 'block';
        }
        
        function switchWatchlistTab(tab) {
            currentWatchlistTab = tab;
            
            // 모든 탭 비활성화 후 선택된 탭만 활성화
            document.querySelectorAll('.watchlist-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            
            renderWatchlist();
        }
        
        function renderWatchlist() {
            const container = document.getElementById('watchlistContent');
            if (!container) return;
            
            // favorites 탭은 동적으로 생성
            const symbols = currentWatchlistTab === 'favorites' 
                ? getFavoritesWatchlist() 
                : (watchlistSymbols[currentWatchlistTab] || []);
            
            if (symbols.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">star_border</span>
                        <p style="margin-top: 10px;">${currentWatchlistTab === 'favorites' ? '즐겨찾기가 비어있습니다' : '종목이 없습니다'}</p>
                        <p style="font-size: 12px; margin-top: 5px;">🔍 검색에서 종목을 추가해보세요</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            symbols.forEach(item => {
                const prices = watchlistPrices[item.symbol] || demoQuotes[item.symbol] || { bid: 0, ask: 0, change: 0 };
                const decimals = getDecimalsForSymbol(item.symbol);
                const changeClass = prices.change >= 0 ? 'up' : 'down';
                const changeSign = prices.change >= 0 ? '+' : '';
                const isFav = isFavorite(item.symbol);
                const starClass = isFav ? 'active' : '';
                const starIcon = isFav ? '⭐' : '☆';
                
                html += `
                    <div class="watchlist-item" onclick="openChartFromWatchlist('${item.symbol}', '${item.name}', '${item.icon}', '${item.color}')">
                        <div class="watchlist-icon" style="color: ${item.color};">${item.icon}</div>
                        <div class="watchlist-info">
                            <div class="watchlist-symbol">${item.name}</div>
                            <div class="watchlist-name">${item.fullName}</div>
                        </div>
                        <button class="watchlist-favorite ${starClass}" onclick="toggleFavorite('${item.symbol}', event)">${starIcon}</button>
                        <div class="watchlist-price-row">
                            <div class="watchlist-bid-box">
                                <span class="watchlist-box-label">매도</span>
                                <span class="watchlist-box-price">${prices.bid.toFixed(decimals)}</span>
                            </div>
                            <span class="watchlist-change-center ${changeClass}">${changeSign}${prices.change.toFixed(2)}%</span>
                            <div class="watchlist-ask-box">
                                <span class="watchlist-box-label">매수</span>
                                <span class="watchlist-box-price">${prices.ask.toFixed(decimals)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function openChartFromWatchlist(symbol, name, icon, color) {
            chartSymbol = symbol;
            
            document.getElementById('chartSymbolIcon').textContent = icon;
            document.getElementById('chartSymbolIcon').style.color = color;
            document.getElementById('chartSymbolName').textContent = name;
            document.getElementById('chartSymbolId').textContent = symbol;
            
            showChartDetail();
            
            // 히스토리에 상태 추가 (브라우저 뒤로가기 지원)
            history.pushState({ view: 'chart-detail', symbol: symbol }, '', `#chart/${symbol}`);
            
            if (chart) {
                chart.remove();
                chart = null;
            }
            initChart();
            loadCandles();
        }
        
        function backToWatchlist() {
            showWatchlist();
            renderWatchlist();
        }
        
        // 브라우저 뒤로가기 지원
        window.addEventListener('popstate', function(event) {
            const chartDetail = document.getElementById('chartDetailContainer');
            if (chartDetail && chartDetail.style.display !== 'none') {
                backToWatchlist();
            }
        });
        
        // ========== 종목 검색 ==========
        let searchResults = [];
        let searchCategory = 'all';
        let searchTimeout = null;
        
        function openSymbolSearch() {
            document.getElementById('symbolSearchModal').classList.add('show');
            document.getElementById('symbolSearchInput').value = '';
            document.getElementById('symbolSearchInput').focus();
            
            // 초기 상태 표시
            document.getElementById('symbolSearchResults').innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search</span>
                    <p style="margin-top: 10px;">종목명 또는 심볼을 입력하세요</p>
                </div>
            `;
        }
        
        function closeSymbolSearch() {
            document.getElementById('symbolSearchModal').classList.remove('show');
        }
        
        function onSymbolSearch(query) {
            // 디바운스 처리 (300ms)
            clearTimeout(searchTimeout);
            
            if (query.length < 1) {
                document.getElementById('symbolSearchResults').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search</span>
                        <p style="margin-top: 10px;">종목명 또는 심볼을 입력하세요</p>
                    </div>
                `;
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performSymbolSearch(query);
            }, 300);
        }
        
        async function performSymbolSearch(query) {
            document.getElementById('symbolSearchLoading').style.display = 'block';
            document.getElementById('symbolSearchResults').innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/mt5/symbols/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                document.getElementById('symbolSearchLoading').style.display = 'none';
                
                if (data.success && data.symbols.length > 0) {
                    searchResults = data.symbols;
                    renderSearchResults();
                } else {
                    document.getElementById('symbolSearchResults').innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                            <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search_off</span>
                            <p style="margin-top: 10px;">"${query}"에 대한 검색 결과가 없습니다</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('symbolSearchLoading').style.display = 'none';
                document.getElementById('symbolSearchResults').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sell-color);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">error</span>
                        <p style="margin-top: 10px;">검색 중 오류가 발생했습니다</p>
                    </div>
                `;
            }
        }
        
        function filterSearchCategory(category) {
            searchCategory = category;
            
            // 버튼 활성화 상태 변경
            document.querySelectorAll('.search-category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            
            renderSearchResults();
        }
        
        function renderSearchResults() {
            const container = document.getElementById('symbolSearchResults');
            
            // 카테고리 필터링
            let filtered = searchResults;
            if (searchCategory !== 'all') {
                filtered = searchResults.filter(item => item.category === searchCategory);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <p>해당 카테고리에 검색 결과가 없습니다</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filtered.forEach(item => {
                const isFav = isFavorite(item.symbol);
                const btnClass = isFav ? 'added' : '';
                const btnText = isFav ? '✓' : '+';
                
                html += `
                    <div class="search-result-item" onclick="selectSearchSymbol('${item.symbol}', '${item.name}', '${item.icon}', '${item.color}')">
                        <div class="search-result-icon" style="color: ${item.color};">${item.icon}</div>
                        <div class="search-result-info">
                            <div class="search-result-symbol">${item.symbol}</div>
                            <div class="search-result-name">${item.name}</div>
                        </div>
                        <span class="search-result-category">${item.category}</span>
                        <button class="search-add-btn ${btnClass}" onclick="addToFavorites('${item.symbol}', '${item.name}', '${item.icon}', '${item.color}', event)">${btnText}</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function selectSearchSymbol(symbol, name, icon, color) {
            // 검색 모달 닫기
            closeSymbolSearch();
            
            // 심볼 정보 업데이트
            chartSymbol = symbol;
            document.getElementById('chartSymbolIcon').textContent = icon;
            document.getElementById('chartSymbolIcon').style.color = color;
            document.getElementById('chartSymbolName').textContent = name.split(' ')[0] || symbol;
            document.getElementById('chartSymbolId').textContent = symbol;
            
            // 차트 화면으로 이동
            showChartDetail();
            
            // 히스토리에 상태 추가
            history.pushState({ view: 'chart-detail', symbol: symbol }, '', `#chart/${symbol}`);
            
            // 차트 로드
            if (chart) {
                chart.remove();
                chart = null;
            }
            initChart();
            loadCandles();
            
            showToast(`${symbol} 차트를 로드합니다`, 'success');
        }
        
        // 왓치리스트 실시간 시세 업데이트
        function updateWatchlistPricesFromData(allPrices) {
            if (!allPrices) return;
            
            Object.keys(allPrices).forEach(symbol => {
                const price = allPrices[symbol];
                if (price) {
                    const prevPrice = watchlistPrices[symbol]?.bid || price.bid;
                    const change = prevPrice > 0 ? ((price.bid - prevPrice) / prevPrice) * 100 : 0;
                    watchlistPrices[symbol] = {
                        bid: price.bid,
                        ask: price.ask,
                        change: change
                    };
                }
            });
            
            // 왓치리스트가 보이면 다시 렌더링
            const watchlistContainer = document.getElementById('watchlistContainer');
            if (watchlistContainer && watchlistContainer.style.display !== 'none') {
                renderWatchlist();
            }
        }
        
        // 10초마다 시세 업데이트
        setInterval(() => {
            const watchlistContainer = document.getElementById('watchlistContainer');
            if (watchlistContainer && watchlistContainer.style.display !== 'none') {
                // 랜덤 변동 시뮬레이션 (실제 API 연동 전)
                Object.keys(demoQuotes).forEach(symbol => {
                    const quote = demoQuotes[symbol];
                    const variation = (Math.random() - 0.5) * 0.001;
                    quote.bid = quote.bid * (1 + variation);
                    quote.ask = quote.bid + (quote.ask - quote.bid);
                    quote.change = quote.change + (Math.random() - 0.5) * 0.1;
                });
                renderWatchlist();
            }
        }, 10000);

        // ========== 차트 ==========
        function initChart() {
            const container = document.getElementById('chart-container');
            const decimals = getDecimalsForSymbol(chartSymbol);
            
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 720,
                layout: { background: { color: '#0d1421' }, textColor: '#8899a6' },
                grid: { vertLines: { color: '#1e2d3d' }, horzLines: { color: '#1e2d3d' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { 
                    borderColor: '#2d3f50', 
                    autoScale: true,
                    visible: true,
                    scaleMargins: { top: 0.1, bottom: 0.1 },
                },
                timeScale: { borderColor: '#2d3f50', timeVisible: true },
                localization: {
                    priceFormatter: (price) => price.toFixed(getDecimalsForSymbol(chartSymbol)),
                },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#00c853', downColor: '#ff5252',
                borderUpColor: '#00c853', borderDownColor: '#ff5252',
                wickUpColor: '#00c853', wickDownColor: '#ff5252',
                priceFormat: {
                    type: 'price',
                    precision: decimals,
                    minMove: decimals === 5 ? 0.00001 : decimals === 3 ? 0.001 : 0.01,
                },
            });
            
            bbUpperSeries = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
            bbMiddleSeries = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: false });
            bbLowerSeries = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
            lwmaSeries = chart.addLineSeries({ color: '#ffff00', lineWidth: 2, priceLineVisible: false, lastValueVisible: false });
            
            window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth }));
        }
        
        async function loadCandles() {
            try {
                const data = await apiCall(`/mt5/candles/${chartSymbol}?timeframe=${currentTimeframe}&count=200`);
                
                if (candleSeries && data && data.candles && data.candles.length > 0) {
                    candleSeries.setData(data.candles);
                    
                    if (data.indicators) {
                        if (data.indicators.bb_upper) bbUpperSeries.setData(data.indicators.bb_upper);
                        if (data.indicators.bb_middle) bbMiddleSeries.setData(data.indicators.bb_middle);
                        if (data.indicators.bb_lower) bbLowerSeries.setData(data.indicators.bb_lower);
                        if (data.indicators.lwma) lwmaSeries.setData(data.indicators.lwma);
                    }
                    
                    const visibleBars = 50;
                    if (data.candles.length > visibleBars) {
                        const from = data.candles[data.candles.length - visibleBars].time;
                        const to = data.candles[data.candles.length - 1].time;
                        chart.timeScale().setVisibleRange({ from, to });
                    }
                    
                    if (data.candles.length > 0) {
                        updateChartPrice(data.candles[data.candles.length - 1].close);
                    }
                }
            } catch (e) { console.error('캔들 로드 실패:', e); }
        }
        
        function getDecimalsForSymbol(symbol) {
            if (symbol === 'BTCUSD' || symbol === 'ETHUSD') return 2;
            if (symbol === 'XAUUSD.r') return 2;
            if (symbol === 'US100.') return 2;
            if (symbol.includes('JPY')) return 3;
            if (symbol === 'EURUSD.r' || symbol === 'GBPUSD.r' || symbol === 'AUDUSD.r' || symbol === 'USDCAD.r') return 5;
            return 2;
        }
        
        function updateChartPrice(price) {
            let decimals = getDecimalsForSymbol(chartSymbol);
            let spread = chartSymbol === 'BTCUSD' ? 15 : chartSymbol === 'XAUUSD.r' ? 0.50 : 0.00020;
            
            document.getElementById('chartBid').textContent = price.toFixed(decimals);
            document.getElementById('chartAsk').textContent = (price + spread).toFixed(decimals);
        }
        
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTimeframe = btn.dataset.tf;
                loadCandles();
            });
        });
        
        // ========== 게이지 Arc ==========
        function createArcPath(centerX, centerY, radius, startAngle, endAngle) {
            const startX = centerX + Math.cos(startAngle) * radius;
            const startY = centerY - Math.sin(startAngle) * radius;
            const endX = centerX + Math.cos(endAngle) * radius;
            const endY = centerY - Math.sin(endAngle) * radius;
            const largeArc = Math.abs(endAngle - startAngle) > Math.PI ? 1 : 0;
            return `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`;
        }
        
        function initGaugeArcs() {
            const centerX = 150, centerY = 110, radius = 80;
            document.getElementById('sellArc').setAttribute('d', createArcPath(centerX, centerY, radius, Math.PI, Math.PI * 0.5));
            document.getElementById('buyArc').setAttribute('d', createArcPath(centerX, centerY, radius, Math.PI * 0.5, 0));
        }
        
        function initChartGaugeArcs() {
            const centerX = 140, centerY = 100, radius = 70;
            const sellArc = createArcPath(centerX, centerY, radius, Math.PI, Math.PI * 0.5);
            const buyArc = createArcPath(centerX, centerY, radius, Math.PI * 0.5, 0);
            
            const chartSellArc = document.getElementById('chartSellArc');
            const chartBuyArc = document.getElementById('chartBuyArc');
            if (chartSellArc) chartSellArc.setAttribute('d', sellArc);
            if (chartBuyArc) chartBuyArc.setAttribute('d', buyArc);
        }
        
        initGaugeArcs();
        initChartGaugeArcs();
        
        // ========== 랜덤 워크 ==========
        function calcRandomWalk() {
            const currentDiff = baseScore - targetScore;
            const pullStrength = 0.4;
            const noiseScale = 30.0;
            
            const pullToBase = currentDiff * pullStrength;
            const noise = (Math.random() - 0.5) * noiseScale;
            
            let extraNoise = 0;
            if (Math.random() < 0.15) {
                extraNoise = (Math.random() - 0.5) * 20.0;
            }
            
            targetScore = targetScore + pullToBase + noise + extraNoise;
            targetScore = Math.max(5, Math.min(95, targetScore));
        }
        
        setInterval(() => calcRandomWalk(), 2000 + Math.random() * 1000);
        
        // ========== 게이지 애니메이션 ==========
        function updateGauge() {
            if (Math.abs(baseScore - targetScore) > 30) {
                targetScore = baseScore;
            }
            
            const diff = targetScore - displayScore;
            if (Math.abs(diff) < 0.3 && Math.abs(velocity) < 0.1) {
                displayScore = targetScore;
                velocity = 0;
            } else {
                const springK = 0.1;
                const dampingK = 0.25;
                const springForce = diff * springK;
                velocity = velocity * (1 - dampingK) + springForce;
                displayScore = Math.max(0, Math.min(100, displayScore + velocity));
            }
            
            const angleRad = Math.PI - (displayScore / 100) * Math.PI;
            const needleLength = 60;
            const cx = 150, cy = 110;
            const nx = cx + Math.cos(angleRad) * needleLength;
            const ny = cy - Math.sin(angleRad) * needleLength;
            
            const needle = document.getElementById('gaugeNeedle');
            const shadow = document.getElementById('needleShadow');
            if (needle) { needle.setAttribute('x2', nx); needle.setAttribute('y2', ny); }
            if (shadow) { shadow.setAttribute('x2', nx + 1); shadow.setAttribute('y2', ny + 1); }
            
            const statusEl = document.getElementById('gaugeStatusText');
            let statusText = 'Neutral';
            let statusColor = '#646473';
            
            if (displayScore < 20) { statusText = 'Strong Sell'; statusColor = '#dc3246'; }
            else if (displayScore < 40) { statusText = 'Sell'; statusColor = '#dc3246'; }
            else if (displayScore < 60) { statusText = 'Neutral'; statusColor = '#646473'; }
            else if (displayScore < 80) { statusText = 'Buy'; statusColor = '#00b450'; }
            else { statusText = 'Strong Buy'; statusColor = '#00b450'; }
            
            if (statusEl) {
                statusEl.textContent = statusText;
                statusEl.style.color = statusColor;
                statusEl.style.textShadow = '0 0 15px ' + statusColor;
            }
            
            requestAnimationFrame(updateGauge);
        }
        updateGauge();
        
        function updateChartGauge() {
            const diff = chartTargetScore - chartDisplayScore;
            if (Math.abs(diff) < 0.3 && Math.abs(chartVelocity) < 0.1) {
                chartDisplayScore = chartTargetScore;
                chartVelocity = 0;
            } else {
                const springK = 0.1;
                const dampingK = 0.25;
                const springForce = diff * springK;
                chartVelocity = chartVelocity * (1 - dampingK) + springForce;
                chartDisplayScore = Math.max(0, Math.min(100, chartDisplayScore + chartVelocity));
            }
            
            const angleRad = Math.PI - (chartDisplayScore / 100) * Math.PI;
            const needleLength = 55;
            const cx = 140, cy = 100;
            const nx = cx + Math.cos(angleRad) * needleLength;
            const ny = cy - Math.sin(angleRad) * needleLength;
            
            const needle = document.getElementById('chartGaugeNeedle');
            const shadow = document.getElementById('chartNeedleShadow');
            if (needle) { needle.setAttribute('x2', nx); needle.setAttribute('y2', ny); }
            if (shadow) { shadow.setAttribute('x2', nx + 1); shadow.setAttribute('y2', ny + 1); }
            
            const statusEl = document.getElementById('chartGaugeStatus');
            let statusText = 'Neutral';
            let statusColor = '#646473';
            
            if (chartDisplayScore < 20) { statusText = 'Strong Sell'; statusColor = '#dc3246'; }
            else if (chartDisplayScore < 40) { statusText = 'Sell'; statusColor = '#dc3246'; }
            else if (chartDisplayScore < 60) { statusText = 'Neutral'; statusColor = '#646473'; }
            else if (chartDisplayScore < 80) { statusText = 'Buy'; statusColor = '#00b450'; }
            else { statusText = 'Strong Buy'; statusColor = '#00b450'; }
            
            if (statusEl) {
                statusEl.textContent = statusText;
                statusEl.style.color = statusColor;
                statusEl.style.textShadow = '0 0 15px ' + statusColor;
            }
            
            requestAnimationFrame(updateChartGauge);
        }
        updateChartGauge();
        
        // ========== 슬라이더 ==========
        function updateSliderBackground(slider, value, max) {
            const percent = (value / max) * 100;
            slider.style.background = `linear-gradient(to right, #00d4ff 0%, #00d4ff ${percent}%, #2d3139 ${percent}%, #2d3139 100%)`;
        }
        
        function updateTargetUI() {
            const targetSlider = document.getElementById('targetSlider');
            const leverageSlider = document.getElementById('leverageSlider');
            
            let targetMax = 200;
            let leverageMax = 20;
            
            if (currentMode === 'noLimit') {
                targetMax = Math.floor(balance * 0.5);
                leverageMax = 50;
            }
            
            // 슬라이더 max 값 업데이트
            targetSlider.max = targetMax;
            leverageSlider.max = leverageMax;
            
            document.getElementById('targetValue').textContent = '$' + targetAmount;
            targetSlider.value = targetAmount;
            updateSliderBackground(targetSlider, targetAmount, targetMax);
            
            document.getElementById('leverageDisplay').textContent = 'x' + leverage;
            leverageSlider.value = leverage;
            updateSliderBackground(leverageSlider, leverage, leverageMax);
            
            let calculatedLot = currentMode === 'martin' ? lotSize : leverage * 0.1;
            calculatedLot = Math.round(calculatedLot * 100) / 100;
            document.getElementById('lotDisplay').textContent = calculatedLot.toFixed(2) + ' lot (x' + leverage + ')';
            document.getElementById('tradeLotSize').textContent = calculatedLot.toFixed(2);
        }
        
        function adjustTarget(delta) {
            targetAmount = Math.max(0, Math.min(200, targetAmount + delta));
            updateTargetUI();
        }
        
        function updateTargetFromSlider(value) {
            targetAmount = parseInt(value);
            updateTargetUI();
        }
        
        function updateLeverageFromSlider(value) {
            leverage = parseInt(value);
            updateTargetUI();
        }
        
        updateTargetUI();
        
        // ========== Symbol 선택 ==========
        function toggleSymbolDropdown() {
            const dropdown = document.getElementById('symbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function selectSymbol(el) {
            currentSymbol = el.dataset.symbol;
            document.getElementById('tradeSymbolIcon').textContent = el.dataset.icon;
            document.getElementById('tradeSymbolIcon').style.color = el.dataset.color;
            document.getElementById('tradeSymbolName').textContent = el.dataset.name;
            document.getElementById('tradeSymbolId').textContent = el.dataset.symbol;
            
            document.querySelectorAll('#symbolDropdown .symbol-option').forEach(opt => {
                opt.classList.remove('selected');
                const check = opt.querySelector('.symbol-option-check');
                if (check) check.style.display = 'none';
            });
            el.classList.add('selected');
            const check = el.querySelector('.symbol-option-check');
            if (check) check.style.display = 'block';
            document.getElementById('symbolDropdown').style.display = 'none';
        }
        
        function toggleChartSymbolDropdown() {
            const dropdown = document.getElementById('chartSymbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function selectChartSymbol(el) {
            chartSymbol = el.dataset.symbol;
            document.getElementById('chartSymbolIcon').textContent = el.dataset.icon;
            document.getElementById('chartSymbolIcon').style.color = el.dataset.color;
            document.getElementById('chartSymbolName').textContent = el.dataset.name;
            document.getElementById('chartSymbolId').textContent = el.dataset.symbol;
            document.getElementById('chartSymbolDropdown').style.display = 'none';
            
            if (chart) {
                chart.remove();
                chart = null;
                initChart();
                loadCandles();
            }
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.symbol-row')) {
                document.getElementById('symbolDropdown').style.display = 'none';
            }
            if (!e.target.closest('.chart-symbol-row')) {
                document.getElementById('chartSymbolDropdown').style.display = 'none';
            }
        });
        
        // ========== Settings Modal ==========
        let settingsSymbol = 'BTCUSD';
        let settingsTarget = 100;
        let settingsLeverage = 5;
        let settingsLotSize = 0.10;
        let settingsMode = 'basic';
        let settingsMartinLevel = 3;
        let settingsMartinEnabled = false;
        
        function openSettings() {
            settingsSymbol = currentSymbol;
            settingsTarget = targetAmount;
            settingsLeverage = leverage;
            settingsLotSize = lotSize;
            settingsMode = currentMode;
            settingsMartinLevel = martinLevel;
            settingsMartinEnabled = martinEnabled;
            
            updateSettingsUI();
            document.getElementById('settingsModal').classList.add('show');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        function updateSettingsUI() {
            document.getElementById('settingsSymbolText').textContent = settingsSymbol;
            document.getElementById('settingsSymbolDesc').textContent = symbolData[settingsSymbol]?.desc || '';
            
            document.querySelectorAll('.mode-option').forEach(opt => {
                const isSelected = opt.dataset.mode === settingsMode;
                opt.classList.toggle('selected', isSelected);
                opt.querySelector('.mode-radio').textContent = isSelected ? '●' : '○';
            });
            
            if (settingsMode === 'martin') {
                document.getElementById('settingsTargetValue').textContent = '$' + settingsTarget;
                document.getElementById('leverageLotLabel').textContent = 'Lot Size';
                document.getElementById('leverageLotHint').textContent = '(Range: 0.01 ~ 10.00)';
                document.getElementById('settingsLeverageValue').value = settingsLotSize.toFixed(2);
            } else if (settingsMode === 'noLimit') {
                const percent = Math.round((settingsTarget / balance) * 100);
                document.getElementById('settingsTargetValue').textContent = percent + '%';
                document.getElementById('targetHint').textContent = '(Range: 1% ~ 50%)';
                document.getElementById('leverageLotLabel').textContent = 'Leverage';
                document.getElementById('leverageLotHint').textContent = '(Range: x1 ~ x50)';
                document.getElementById('settingsLeverageValue').value = 'x' + settingsLeverage;
            } else {
                document.getElementById('settingsTargetValue').textContent = '$' + settingsTarget;
                document.getElementById('targetHint').textContent = '(Range: $10 ~ $200)';
                document.getElementById('leverageLotLabel').textContent = 'Leverage';
                document.getElementById('leverageLotHint').textContent = '(Range: x1 ~ x20)';
                document.getElementById('settingsLeverageValue').value = 'x' + settingsLeverage;
            }
            
            const martinRow = document.getElementById('martinLevelRow');
            const martinCheckbox = document.getElementById('martinCheckbox');
            const martinMaxInfo = document.getElementById('martinMaxInfo');
            
            if (settingsMode === 'martin') {
                martinRow.style.opacity = '1';
                martinCheckbox.disabled = false;
                martinCheckbox.checked = settingsMartinEnabled;
                
                if (settingsMartinEnabled) {
                    document.getElementById('martinDownBtn').disabled = false;
                    document.getElementById('martinUpBtn').disabled = false;
                    martinMaxInfo.style.display = 'flex';
                    updateMartinMaxInfo();
                } else {
                    document.getElementById('martinDownBtn').disabled = true;
                    document.getElementById('martinUpBtn').disabled = true;
                    martinMaxInfo.style.display = 'none';
                }
            } else {
                martinRow.style.opacity = '0.4';
                martinCheckbox.disabled = true;
                martinCheckbox.checked = false;
                document.getElementById('martinDownBtn').disabled = true;
                document.getElementById('martinUpBtn').disabled = true;
                martinMaxInfo.style.display = 'none';
            }
            
            document.getElementById('martinLevelValue').textContent = settingsMartinLevel;
        }
        
        function selectMode(el) {
            settingsMode = el.dataset.mode;
            
            if (settingsMode === 'basic') {
                settingsTarget = 100;
                settingsLeverage = 5;
            } else if (settingsMode === 'noLimit') {
                settingsTarget = Math.floor(balance * 0.1);
                settingsLeverage = 5;
            } else if (settingsMode === 'martin') {
                // Martin 모드 기본값
                settingsTarget = 50;
                settingsLotSize = 0.01;
                settingsMartinLevel = 5;
                settingsMartinEnabled = false;
            }
            
            updateSettingsUI();
        }
        
        function toggleSettingsSymbol() {
            const dropdown = document.getElementById('settingsSymbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function setSettingsSymbol(symbol) {
            settingsSymbol = symbol;
            document.getElementById('settingsSymbolText').textContent = symbol;
            document.getElementById('settingsSymbolDesc').textContent = symbolData[symbol]?.desc || '';
            document.getElementById('settingsSymbolDropdown').style.display = 'none';
        }
        
        function adjustSettingsTarget(delta) {
            if (settingsMode === 'noLimit') {
                const onePercent = balance * 0.01;
                settingsTarget = Math.max(onePercent, Math.min(balance * 0.5, settingsTarget + (delta > 0 ? onePercent : -onePercent)));
            } else {
                settingsTarget = Math.max(10, Math.min(200, settingsTarget + delta));
            }
            updateSettingsUI();
        }
        
        // 마틴 모드 랏수 직접 입력
        function updateSettingsLotFromInput(value) {
            const num = parseFloat(value);
            if (!isNaN(num) && num >= 0.01 && num <= 10) {
                settingsLotSize = Math.round(num * 100) / 100;
                updateSettingsUI();
            } else {
                showToast('0.01 ~ 10 범위로 입력하세요', 'error');
                updateSettingsUI();
            }
        }
        
        // 레버리지/랏수 직접 입력 (통합)
        function updateSettingsLeverageFromInput(value) {
            if (settingsMode === 'martin') {
                // 마틴 모드: 랏수 입력
                updateSettingsLotFromInput(value);
            } else {
                // Basic/NoLimit 모드: 레버리지 입력
                const num = parseInt(value.replace(/[^0-9]/g, ''));
                const max = settingsMode === 'noLimit' ? 50 : 20;
                
                if (!isNaN(num) && num >= 1 && num <= max) {
                    settingsLeverage = num;
                    updateSettingsUI();
                } else {
                    showToast(`1 ~ ${max} 범위로 입력하세요`, 'error');
                    updateSettingsUI();
                }
            }
        }

        // ============ 여기에 추가 ============
        // 레버리지/랏수 버튼 조절
        function adjustSettingsLeverage(delta) {
            if (settingsMode === 'martin') {
                // 마틴 모드: 랏수 조절 (0.01 단위)
                settingsLotSize = Math.max(0.01, Math.min(10, Math.round((settingsLotSize + delta * 0.01) * 100) / 100));
            } else {
                // Basic/NoLimit 모드: 레버리지 조절
                const max = settingsMode === 'noLimit' ? 50 : 20;
                settingsLeverage = Math.max(1, Math.min(max, settingsLeverage + delta));
            }
            updateSettingsUI();
        }
        // ============ 여기까지 ============
        

        function toggleMartinLevel() {
            settingsMartinEnabled = document.getElementById('martinCheckbox').checked;
            updateSettingsUI();
        }
        
        function adjustMartinLevel(delta) {
            const maxAvailable = calculateMartinMax();
            settingsMartinLevel = Math.max(1, Math.min(Math.min(20, maxAvailable), settingsMartinLevel + delta));
            updateSettingsUI();
        }
        
        function calculateMartinMax() {
            for (let n = 20; n >= 1; n--) {
                const required = settingsLotSize * settingsTarget * (Math.pow(2, n) - 1);
                if (balance >= required) return n;
            }
            return 1;
        }
        
        function updateMartinMaxInfo() {
            const maxStep = calculateMartinMax();
            const required = settingsLotSize * settingsTarget * (Math.pow(2, maxStep) - 1);
            document.getElementById('martinMaxStep').textContent = maxStep;
            document.getElementById('martinRequired').textContent = '$' + Math.round(required).toLocaleString() + '+';
        }
        
        function setMartinMax() {
            settingsMartinLevel = calculateMartinMax();
            updateSettingsUI();
        }
        
        async function applySettings() {
            if (settingsMode === 'martin' && !settingsMartinEnabled) {
                showToast('Martin Level 체크박스를 활성화하세요!', 'error');
                return;
            }
            
            currentSymbol = settingsSymbol;
            currentMode = settingsMode;
            targetAmount = settingsTarget;
            leverage = settingsLeverage;
            lotSize = settingsLotSize;
            martinLevel = settingsMartinLevel;
            martinEnabled = settingsMartinEnabled;
            
            if (currentMode === 'martin' && martinEnabled) {
                if (isDemo) {
                    await apiCall(`/demo/martin/enable?base_lot=${lotSize}&max_steps=${martinLevel}`, 'POST');
                } else {
                    await apiCall(`/mt5/martin/enable?base_lot=${lotSize}&target=${targetAmount}&max_steps=${martinLevel}`, 'POST');
                }
            } else {
                if (isDemo) {
                    await apiCall('/demo/martin/disable', 'POST');
                } else {
                    await apiCall('/mt5/martin/disable', 'POST');
                }
            }
            
            const sData = symbolData[currentSymbol];
            document.getElementById('tradeSymbolIcon').textContent = sData.icon;
            document.getElementById('tradeSymbolIcon').style.color = sData.color;
            document.getElementById('tradeSymbolName').textContent = sData.name;
            document.getElementById('tradeSymbolId').textContent = currentSymbol;
            
            updateMainPanelForMode();
            updateTargetUI();
            closeSettings();
            showToast('Settings applied!', 'success');
        }
        
        function resetSettings() {
            if (settingsMode === 'basic') {
                // Basic 모드 기본값
                settingsTarget = 100;
                settingsLeverage = 5;
            } else if (settingsMode === 'noLimit') {
                // No Limit 모드 기본값
                settingsTarget = Math.floor(balance * 0.1);
                settingsLeverage = 5;
            } else if (settingsMode === 'martin') {
                settingsTarget = 50;
                settingsLotSize = 0.01;
                settingsMartinLevel = 5;
                settingsMartinEnabled = false;
            }
            
            // UI 업데이트
            updateSettingsUI();
            showToast('기본값으로 초기화됨', 'success');
        }
        
        // ========== 모드별 패널 UI ==========
        function updateMainPanelForMode() {
            const martinModeUI = document.getElementById('martinModeUI');
            const normalModeUI = document.getElementById('normalModeUI');
            const targetSlider = document.getElementById('targetSlider');
            const leverageSlider = document.getElementById('leverageSlider');
            const targetLabelsDiv = targetSlider.parentElement.querySelector('.slider-labels');
            const levLabelsDiv = leverageSlider.parentElement.querySelector('.slider-labels');
            
            if (currentMode === 'martin' && martinEnabled) {
                martinModeUI.style.display = 'block';
                normalModeUI.style.display = 'none';
                updateMartinUI();
            } else {
                martinModeUI.style.display = 'none';
                normalModeUI.style.display = 'block';
                
                if (currentMode === 'basic') {
                    targetSlider.max = 200;
                    targetSlider.min = 0;
                    leverageSlider.max = 20;
                    leverageSlider.min = 0;
                    
                    if (targetLabelsDiv) {
                        targetLabelsDiv.innerHTML = '<span>$0</span><span>$50</span><span>$100</span><span>$150</span><span>$200</span>';
                    }
                    if (levLabelsDiv) {
                        levLabelsDiv.innerHTML = '<span>x0</span><span>x5</span><span>x10</span><span>x15</span><span>x20</span>';
                    }
                } else if (currentMode === 'noLimit') {
                    const maxTarget = Math.floor(balance * 0.5);
                    targetSlider.max = maxTarget;
                    targetSlider.min = 0;
                    leverageSlider.max = 50;
                    leverageSlider.min = 0;
                    
                    if (targetLabelsDiv) {
                        targetLabelsDiv.innerHTML = '<span>0%</span><span>10%</span><span>25%</span><span>40%</span><span>50%</span>';
                    }
                    if (levLabelsDiv) {
                        levLabelsDiv.innerHTML = '<span>x0</span><span>x10</span><span>x25</span><span>x40</span><span>x50</span>';
                    }
                }
                
                targetSlider.value = targetAmount;
                leverageSlider.value = leverage;
            }
        }
        
        function updateMartinUI() {
            // 마틴 타겟 계산: 단계별 2배 + 누적손실 회복
            let displayTarget = targetAmount;  // 기본 목표
            
            if (martinStep > 1) {
                // 단계 진행 시: 기본목표 × 2^(step-1) + 누적손실
                displayTarget = targetAmount * Math.pow(2, martinStep - 1) + martinAccumulatedLoss;
            } else if (martinAccumulatedLoss > 0) {
                // 1단계인데 누적손실이 있는 경우 (중간 청산 후)
                displayTarget = targetAmount + martinAccumulatedLoss;
            }
            
            displayTarget = Math.ceil(displayTarget);
            
            document.getElementById('martinTargetDisplay').textContent = '$' + displayTarget;
            document.getElementById('martinTargetInfo').textContent = displayTarget;
            
            const currentLot = lotSize * Math.pow(2, martinStep - 1);
            let lotText = currentLot.toFixed(2) + ' lot';
            if (martinStep > 1) {
                lotText += ' <span style="color: var(--accent-cyan);">(x' + Math.pow(2, martinStep - 1) + ')</span>';
            }
            document.getElementById('martinLotDisplay').innerHTML = lotText;
            
            document.getElementById('martinCurrentStep').textContent = martinStep;
            document.getElementById('martinMaxStepsDisplay').textContent = martinLevel;
            
            const badge = document.getElementById('martinStepBadge');
            if (martinStep > 1) {
                badge.style.display = 'inline';
                badge.textContent = 'Step ' + martinStep + ' / 누적손실: -$' + martinAccumulatedLoss.toFixed(0);
            } else {
                badge.style.display = 'none';
            }
            
            renderMartinDots();
        }
        
        function renderMartinDots() {
            const container = document.getElementById('martinDotsContainer');
            const displaySteps = 8;
            const hasMoreSteps = martinLevel > displaySteps;
            
            let html = '';
            
            for (let i = 0; i < displaySteps; i++) {
                const stepNum = i + 1;
                const isCurrent = stepNum === martinStep;
                const isPast = stepNum < martinStep;
                const isActive = stepNum <= martinLevel;
                
                let bgColor = '#2d3139';
                let content = '';
                let opacity = isActive ? 1 : 0.25;
                let boxShadow = 'none';
                
                if (isActive) {
                    if (isPast) {
                    // 마틴은 손실 후 다음 단계로 가니까, 이전 단계는 모두 손실!
                    bgColor = '#dc3246';
                    content = '✗';
                    boxShadow = '0 0 8px #dc3246';
                    } else if (isCurrent) {
                        bgColor = '#00d4ff';
                        content = stepNum;
                        boxShadow = '0 0 10px #00d4ff';
                    } else {
                        bgColor = '#646473';
                    }
                }
                
                html += `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">`;
                html += `<div style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; background-color: ${bgColor}; opacity: ${opacity}; box-shadow: ${boxShadow};">${content}</div>`;
                html += isActive ? `<span style="font-size: 8px; color: #9ca3af;">L${stepNum}</span>` : `<span style="font-size: 8px; color: transparent;">L${stepNum}</span>`;
                html += '</div>';
            }
            
            if (hasMoreSteps) {
                html += `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px; margin-left: 4px;">`;
                html += `<div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #00d4ff; font-size: 14px;">▶</div>`;
                html += `<span style="font-size: 8px; color: #9ca3af;">+${martinLevel - displaySteps}</span>`;
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        

        // ========== 마틴 팝업 ==========
        function showMartinPopup(currentLoss) {
            pendingLoss = Math.abs(currentLoss);
            const nextStep = martinStep + 1;
            const nextLot = lotSize * Math.pow(2, martinStep);
            const accumulated = martinAccumulatedLoss + pendingLoss;
            const recoveryTarget = Math.ceil((accumulated + 11 + targetAmount) / 10) * 10;
            
            document.getElementById('popupCurrentStep').textContent = martinStep;
            document.getElementById('popupCurrentStepKr').textContent = martinStep;
            document.getElementById('popupCurrentLoss').textContent = '-$' + pendingLoss.toFixed(2);
            document.getElementById('popupAccumulatedLoss').textContent = '-$' + accumulated.toFixed(2);
            document.getElementById('popupNextLot').textContent = nextLot.toFixed(2) + ' lot';
            document.getElementById('popupRecoveryTarget').textContent = '+$' + recoveryTarget;
            document.getElementById('popupNextStep').textContent = nextStep;
            document.getElementById('popupNextStepKr').textContent = nextStep;
            
            document.getElementById('martinPopup').style.display = 'flex';
        }
        
        function hideMartinPopup() {
            document.getElementById('martinPopup').style.display = 'none';
        }
        
        function martinPopupSettings() {
            document.getElementById('martinPopup').style.display = 'none';
            martinStep = 1;
            martinAccumulatedLoss = 0;
            martinHistory = [];
            openSettings();
        }
        
        async function martinPopupContinue() {
            martinHistory[martinStep - 1] = -1;
            
            const result = await apiCall(`/mt5/martin/update?profit=${-pendingLoss}`, 'POST');
            
            if (result && result.success && result.action === 'next_step') {
                martinStep = result.state.step;
                martinAccumulatedLoss = result.state.accumulated_loss;
                
                const newTarget = Math.ceil((martinAccumulatedLoss + 11 + 50) / 10) * 10;
                targetAmount = newTarget;
                
                updateMartinUI();
                showToast('Step ' + martinStep + '으로 이동 (Lot: ' + (lotSize * Math.pow(2, martinStep - 1)).toFixed(2) + ')', 'error');
            }
            
            hideMartinPopup();
        }
        
        function showMaxPopup(totalLoss) {
            document.getElementById('maxPopupTotalLoss').textContent = '-$' + totalLoss.toFixed(2);
            document.getElementById('maxPopupStepsUsed').textContent = martinLevel + ' / ' + martinLevel;
            document.getElementById('martinMaxPopup').style.display = 'flex';
        }
        
        function closeMaxPopup() {
            document.getElementById('martinMaxPopup').style.display = 'none';
            
            // 마틴 리셋
            martinStep = 1;
            martinAccumulatedLoss = 0;
            martinHistory = [];
            updateMartinUI();
            
            showToast('마틴이 1단계로 초기화되었습니다', '');
        }
        
        // ========== 마틴 성공 팝업 ==========
        function showMartinSuccessPopup(profit) {
            const recovered = martinAccumulatedLoss;
            
            document.getElementById('successPopupProfit').textContent = '+$' + profit.toFixed(2);
            document.getElementById('successPopupRecovered').textContent = '$' + recovered.toFixed(2);
            
            document.getElementById('martinSuccessPopup').style.display = 'flex';
        }
        
        function martinSuccessToSettings() {
            document.getElementById('martinSuccessPopup').style.display = 'none';
            openSettings();
        }
        
        function martinSuccessContinue() {
            document.getElementById('martinSuccessPopup').style.display = 'none';
            
            // 1단계로 리셋 (이미 백엔드에서 처리됨)
            martinStep = 1;
            martinAccumulatedLoss = 0;
            martinHistory = [];
            targetAmount = 50;  // 기본 목표로 리셋
            
            updateMartinUI();
            showToast('🚀 1단계로 다시 시작합니다!', 'success');
        }
        
        // ========== Today P/L ==========
        function updateTodayPL(profit) {
            todayPL += profit;
            const el = document.getElementById('tradeTodayPL');
            if (todayPL >= 0) {
                el.textContent = '+$' + Math.abs(todayPL).toFixed(0);
                el.style.color = 'var(--buy-color)';
            } else {
                el.textContent = '-$' + Math.abs(todayPL).toFixed(0);
                el.style.color = 'var(--sell-color)';
            }
        }
        
        // ========== P/L Gauge ==========
        function updatePLGauge(currentPL, target = null) {
            const actualTarget = target || targetAmount;
            const plPercent = Math.min(1, Math.max(-1, currentPL / actualTarget));
            const plPercentDisplay = Math.round(Math.abs(plPercent) * 100);
            
            const fill = document.getElementById('plBarFill');
            const diamond = document.getElementById('plDiamond');
            const percentText = document.getElementById('plPercent');
            
            const isProfit = currentPL >= 0;
            const color = isProfit ? '#00b450' : '#dc3246';
            
            if (fill) {
                fill.style.background = isProfit 
                    ? 'linear-gradient(to right, rgba(0,180,80,0.5), #00b450)'
                    : 'linear-gradient(to left, rgba(220,50,70,0.5), #dc3246)';
                fill.style.left = isProfit ? '50%' : (50 + plPercent * 50) + '%';
                fill.style.width = Math.abs(plPercent) * 50 + '%';
                fill.style.borderRadius = isProfit ? '0 6px 6px 0' : '6px 0 0 6px';
                fill.style.boxShadow = '0 0 10px ' + color + '80';
            }
            
            if (diamond) {
                diamond.style.left = (50 + plPercent * 50) + '%';
                diamond.style.background = color;
                diamond.style.boxShadow = '0 0 8px ' + color;
            }
            
            if (percentText) {
                percentText.textContent = plPercentDisplay + '%';
                percentText.style.color = color;
            }
        }
        
        // ========== 포지션 UI ==========
        function updatePositionUI(hasPos, posData) {
            hasPosition = hasPos;
            positionData = posData;
            
            if (hasPos && posData) {
                document.getElementById('targetSection').style.display = 'none';
                document.getElementById('positionSection').style.display = 'block';
                document.getElementById('tradeButtonsNoPos').style.display = 'none';
                document.getElementById('tradeButtonsHasPos').style.display = 'block';
                
                const isBuy = posData.type === 'BUY';
                const posCard = document.getElementById('positionCard');
                posCard.className = isBuy ? 'position-card buy-pos' : 'position-card sell-pos';
                
                document.getElementById('posType').textContent = posData.type;
                document.getElementById('posType').style.color = isBuy ? '#00b450' : '#dc3246';
                document.getElementById('posType').style.textShadow = '0 0 10px ' + (isBuy ? 'rgba(0,180,80,0.5)' : 'rgba(220,50,70,0.5)');
                document.getElementById('posEntry').textContent = posData.entry.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                if (!positionStartTime) {
                    positionStartTime = Date.now();
                    startPositionTimer();
                }
                
                const actualTarget = posData.target || targetAmount;
                updatePLGauge(posData.profit, actualTarget);
                
                document.getElementById('plMin').textContent = '-$' + actualTarget;
                document.getElementById('plMax').textContent = '+$' + actualTarget;
            } else {
                document.getElementById('targetSection').style.display = 'block';
                document.getElementById('positionSection').style.display = 'none';
                document.getElementById('tradeButtonsNoPos').style.display = 'block';
                document.getElementById('tradeButtonsHasPos').style.display = 'none';
                
                stopPositionTimer();
            }
        }
        
        function startPositionTimer() {
            if (positionTimer) return;
            
            positionTimer = setInterval(() => {
                if (!positionStartTime) return;
                
                const elapsed = Math.floor((Date.now() - positionStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const mins = Math.floor((elapsed % 3600) / 60);
                const secs = elapsed % 60;
                
                if (hours > 0) {
                    document.getElementById('posTime').textContent = hours + ':' + mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
                } else {
                    document.getElementById('posTime').textContent = mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
                }
            }, 1000);
        }
        
        function stopPositionTimer() {
            if (positionTimer) {
                clearInterval(positionTimer);
                positionTimer = null;
            }
            positionStartTime = null;
            document.getElementById('posTime').textContent = '00:00';
        }
        
        // ========== 사운드 ==========
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'buy') { oscillator.frequency.value = 880; oscillator.type = 'sine'; }
                else if (type === 'sell') { oscillator.frequency.value = 660; oscillator.type = 'sine'; }
                else if (type === 'close') { oscillator.frequency.value = 440; oscillator.type = 'triangle'; }
                else { oscillator.frequency.value = 220; oscillator.type = 'sawtooth'; }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }
        
        // ========== 거래 함수 ==========
        function calculateLot() {
            if (currentMode === 'martin') return lotSize;
            let lot = leverage * 0.1;
            return Math.round(lot * 100) / 100;  // 0.01 단위로 반올림
        }
        
        async function placeBuy() {
            if (!checkGuestAction('trade')) return;
            
            // Demo 모드면 Demo API 사용
            if (isDemo) {
                placeDemoOrder('BUY');
                return;
            }
            
            showToast('Processing...', '');
            try {
                let result;
                if (currentMode === 'martin' && martinEnabled) {
                    result = await apiCall(`/mt5/martin/buy?symbol=${currentSymbol}`, 'POST');
                } else {
                    const lot = calculateLot();
                    result = await apiCall(`/mt5/order?symbol=${currentSymbol}&order_type=BUY&volume=${lot}&target=${targetAmount}`, 'POST');
                }
                showToast(result?.message || 'Error', result?.success ? 'success' : 'error');
                if (result?.success) playSound('buy');
            } catch (e) { showToast('Network error', 'error'); }
        }
        
        async function placeSell() {
            if (!checkGuestAction('trade')) return;
            
            // Demo 모드면 Demo API 사용
            if (isDemo) {
                placeDemoOrder('SELL');
                return;
            }
            
            showToast('Processing...', '');
            try {
                let result;
                if (currentMode === 'martin' && martinEnabled) {
                    result = await apiCall(`/mt5/martin/sell?symbol=${currentSymbol}`, 'POST');
                } else {
                    const lot = calculateLot();
                    result = await apiCall(`/mt5/order?symbol=${currentSymbol}&order_type=SELL&volume=${lot}&target=${targetAmount}`, 'POST');
                }
                showToast(result?.message || 'Error', result?.success ? 'success' : 'error');
                if (result?.success) playSound('sell');
            } catch (e) { showToast('Network error', 'error'); }
        }
        
        async function closePosition() {
            // Demo 모드면 Demo API 사용
            if (isDemo) {
                closeDemoPosition();
                return;
            }
            
            showToast('Closing...', '');
            try {
                const result = await apiCall(`/mt5/close?symbol=${currentSymbol}`, 'POST');
                
                if (result?.success) {
                    playSound('close');
                    const profit = result.profit || 0;
                    
                    // 마틴 모드 처리
                    if (currentMode === 'martin' && martinEnabled) {
                        const baseTarget = 50;  // 1단계 기본 타겟
                        const currentDisplayTarget = baseTarget * Math.pow(2, martinStep - 1) + martinAccumulatedLoss;
                        
                        // Case 1: 수익으로 청산
                        if (profit > 0) {
                            if (profit >= martinAccumulatedLoss && martinAccumulatedLoss > 0) {
                                // Case 1-A: 전액 회복 → 마틴 성공!
                                await apiCall('/mt5/martin/reset-full', 'POST');
                                
                                martinStep = 1;
                                martinAccumulatedLoss = 0;
                                martinHistory = [];
                                updateMartinUI();
                                updateTodayPL(profit);
                                showMartinSuccessPopup(profit);
                            } else if (profit < martinAccumulatedLoss || martinAccumulatedLoss === 0) {
                                // Case 1-B: 일부 회복 → 단계 유지, 타겟만 조정
                                const remainingLoss = Math.max(0, martinAccumulatedLoss - profit);
                                
                                await apiCall(`/mt5/martin/update-state?step=${martinStep}&accumulated_loss=${remainingLoss}`, 'POST');
                                
                                martinAccumulatedLoss = remainingLoss;
                                updateMartinUI();
                                updateTodayPL(profit);
                                
                                if (remainingLoss > 0) {
                                    showToast(`💰 일부 회복! +$${profit.toFixed(2)} (남은 손실: $${remainingLoss.toFixed(2)})`, 'success');
                                } else {
                                    showMartinSuccessPopup(profit);
                                }
                            }
                        }
                        // Case 2: 손실로 청산 (Close 버튼)
                        else if (profit < 0) {
                            const lossAmount = Math.abs(profit);
                            const halfTarget = currentDisplayTarget / 2;
                            
                            if (lossAmount >= halfTarget) {
                                // Case 2-A: 손실 >= 50% → 다음 단계로
                                const newStep = Math.min(martinStep + 1, martinLevel);
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                if (newStep > martinLevel) {
                                    // 최대 단계 초과 → 강제 리셋
                                    await apiCall('/mt5/martin/reset-full', 'POST');
                                    
                                    showMaxPopup(newAccumulatedLoss);
                                    martinStep = 1;
                                    martinAccumulatedLoss = 0;
                                    martinHistory = [];
                                } else {
                                    await apiCall(`/mt5/martin/update-state?step=${newStep}&accumulated_loss=${newAccumulatedLoss}`, 'POST');
                                    
                                    martinStep = newStep;
                                    martinAccumulatedLoss = newAccumulatedLoss;
                                    showToast(`📈 Step ${newStep}로 진행! 손실: -$${lossAmount.toFixed(2)}`, 'error');
                                }
                            } else {
                                // Case 2-B: 손실 < 50% → 단계 유지, 타겟만 조정
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                await apiCall(`/mt5/martin/update-state?step=${martinStep}&accumulated_loss=${newAccumulatedLoss}`, 'POST');
                                
                                martinAccumulatedLoss = newAccumulatedLoss;
                                showToast(`📊 단계 유지! 손실: -$${lossAmount.toFixed(2)} (누적: $${newAccumulatedLoss.toFixed(2)})`, 'error');
                            }
                            
                            updateTodayPL(profit);
                            updateMartinUI();
                        }
                        // Case 3: 손익 0 (Break-even)
                        else {
                            showToast('청산 완료 (손익 없음)', 'success');
                        }
                    } else {
                        // Basic/NoLimit 모드
                        updateTodayPL(profit);
                        showToast(result.message, 'success');
                    }
                } else {
                    showToast(result?.message || 'Error', 'error');
                }
            } catch (e) { showToast('Network error', 'error'); }
        }
        
        // ========== Demo 모드 주문 ==========
        async function placeDemoOrder(orderType) {
            showToast('Processing...', '');
            try {
                let response;
                
                // 마틴 모드면 마틴 API 사용
                if (currentMode === 'martin' && martinEnabled) {
                    response = await fetch(`${API_URL}/demo/martin/order?symbol=${currentSymbol}&order_type=${orderType}&target=${targetAmount}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } else {
                    const lot = calculateLot();
                    response = await fetch(`${API_URL}/demo/order?symbol=${currentSymbol}&order_type=${orderType}&volume=${lot}&target=${targetAmount}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
                
                const result = await response.json();
                
                showToast(result?.message || 'Error', result?.success ? 'success' : 'error');
                if (result?.success) {
                    playSound(orderType.toLowerCase());
                    
                    // 마틴 모드면 단계 정보 업데이트
                    if (result.martin_step) {
                        martinStep = result.martin_step;
                        updateMartinUI();
                    }
                    
                    fetchDemoData();
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // ========== Demo 모드 청산 ==========
        async function closeDemoPosition() {
            showToast('Closing...', '');
            try {
                const response = await fetch(`${API_URL}/demo/close`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result?.success) {
                    playSound('close');
                    const profit = result.profit || 0;
                    
                    // 마틴 모드 처리
                    if (currentMode === 'martin' && martinEnabled) {
                        const baseTarget = 50;  // 1단계 기본 타겟
                        const currentDisplayTarget = baseTarget * Math.pow(2, martinStep - 1) + martinAccumulatedLoss;
                        
                        // Case 1: 수익으로 청산
                        if (profit > 0) {
                            if (profit >= martinAccumulatedLoss && martinAccumulatedLoss > 0) {
                                // Case 1-A: 전액 회복 → 마틴 성공!
                                await fetch(`${API_URL}/demo/martin/reset-full`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                martinStep = 1;
                                martinAccumulatedLoss = 0;
                                martinHistory = [];
                                updateMartinUI();
                                updateTodayPL(profit);
                                showMartinSuccessPopup(profit);
                            } else if (profit < martinAccumulatedLoss || martinAccumulatedLoss === 0) {
                                // Case 1-B: 일부 회복 → 단계 유지, 타겟만 조정
                                const remainingLoss = Math.max(0, martinAccumulatedLoss - profit);
                                
                                await fetch(`${API_URL}/demo/martin/update-state?step=${martinStep}&accumulated_loss=${remainingLoss}`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                martinAccumulatedLoss = remainingLoss;
                                updateMartinUI();
                                updateTodayPL(profit);
                                
                                if (remainingLoss > 0) {
                                    showToast(`💰 일부 회복! +$${profit.toFixed(2)} (남은 손실: $${remainingLoss.toFixed(2)})`, 'success');
                                } else {
                                    showMartinSuccessPopup(profit);
                                }
                            }
                        }
                        // Case 2: 손실로 청산 (Close 버튼)
                        else if (profit < 0) {
                            const lossAmount = Math.abs(profit);
                            const halfTarget = currentDisplayTarget / 2;
                            
                            if (lossAmount >= halfTarget) {
                                // Case 2-A: 손실 >= 50% → 다음 단계로
                                const newStep = Math.min(martinStep + 1, martinLevel);
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                if (newStep > martinLevel) {
                                    // 최대 단계 초과 → 강제 리셋
                                    await fetch(`${API_URL}/demo/martin/reset-full`, {
                                        method: 'POST',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    
                                    showMaxPopup(newAccumulatedLoss);
                                    martinStep = 1;
                                    martinAccumulatedLoss = 0;
                                    martinHistory = [];
                                } else {
                                    await fetch(`${API_URL}/demo/martin/update-state?step=${newStep}&accumulated_loss=${newAccumulatedLoss}`, {
                                        method: 'POST',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    
                                    martinStep = newStep;
                                    martinAccumulatedLoss = newAccumulatedLoss;
                                    showToast(`📈 Step ${newStep}로 진행! 손실: -$${lossAmount.toFixed(2)}`, 'error');
                                }
                            } else {
                                // Case 2-B: 손실 < 50% → 단계 유지, 타겟만 조정
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                await fetch(`${API_URL}/demo/martin/update-state?step=${martinStep}&accumulated_loss=${newAccumulatedLoss}`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                martinAccumulatedLoss = newAccumulatedLoss;
                                showToast(`📊 단계 유지! 손실: -$${lossAmount.toFixed(2)} (누적: $${newAccumulatedLoss.toFixed(2)})`, 'error');
                            }
                            
                            updateTodayPL(profit);
                            updateMartinUI();
                        }
                        // Case 3: 손익 0 (Break-even)
                        else {
                            showToast('청산 완료 (손익 없음)', 'success');
                        }
                    } else {
                        // Basic/NoLimit 모드
                        updateTodayPL(profit);
                        showToast(result?.message || 'Closed!', 'success');
                    }
                    
                    fetchDemoData();
                } else {
                    showToast(result?.message || 'Error', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            } finally {
                isClosing = false;
            }
        }

        // ========== Demo 충전 ==========
        async function topupDemo() {
            try {
                const response = await fetch(`${API_URL}/demo/topup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchDemoData();
            } catch (e) {
                showToast('충전 실패', 'error');
            }
        }
        
        // ========== Demo 리셋 ==========
        async function resetDemo() {
            if (!confirm('정말 잔고를 $10,000로 초기화하시겠습니까?\n모든 포지션과 거래 기록이 삭제됩니다.')) return;
            
            try {
                const response = await fetch(`${API_URL}/demo/reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchDemoData();
            } catch (e) {
                showToast('리셋 실패', 'error');
            }
        }

        // ========== 거래 내역 ==========
        async function loadHistory() {
            // Demo 모드면 Demo API 사용
            const endpoint = isDemo ? '/demo/history' : '/mt5/history';
            const data = await apiCall(endpoint);
            const container = document.getElementById('historyList');
            
            if (data?.history?.length > 0) {
                let html = '';
                data.history.forEach(h => {
                    const profitClass = h.profit >= 0 ? 'positive' : 'negative';
                    const profitSign = h.profit >= 0 ? '+' : '';
                    html += `<div class="history-item">
                        <div style="display:flex;flex-direction:column;gap:3px;">
                            <span class="history-symbol">${h.symbol} ${h.type}</span>
                            <span class="history-time">${h.time} | ${h.volume} lot</span>
                        </div>
                        <span class="history-profit ${profitClass}">${profitSign}$${h.profit.toFixed(2)}</span>
                    </div>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No trade history</p>';
            }
        }
        
        // ========== Toast ==========
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
        
        // ========== Logout ==========
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            window.location.href = 'login.html';
        }
        
        // ========== 게스트 모드 함수 ==========
        function showGuestPopup() {
            document.getElementById('guestPopup').classList.add('show');
        }
        
        function closeGuestPopup() {
            document.getElementById('guestPopup').classList.remove('show');
        }
        
        function goToRegister() {
            sessionStorage.removeItem('guest_mode');
            window.location.href = 'login.html?mode=register';
        }
        
        function goToLoginPage() {
            sessionStorage.removeItem('guest_mode');
            window.location.href = 'login.html';
        }
        
        function checkGuestAction(action) {
            if (isGuest) {
                showGuestPopup();
                return false;
            }
            return true;
        }
        
        // ========== WebSocket ==========
        let ws = null;
        let wsRetryCount = 0;
        const maxRetries = 5;
        
        function connectWebSocket() {
            const wsUrl = getWsUrl('/api/mt5/ws');
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('statusDot').classList.remove('disconnected');
                document.getElementById('headerStatus').textContent = 'Connected';
                wsRetryCount = 0;
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Demo 모드면 차트/시세만 업데이트하고 계정 정보는 건너뛰기
                if (isDemo) {
                    // Chart prices만 업데이트
                    if (data.all_prices && data.all_prices[chartSymbol]) {
                        const symbolPrice = data.all_prices[chartSymbol];
                        const decimals = getDecimalsForSymbol(chartSymbol);
                        document.getElementById('chartBid').textContent = symbolPrice.bid.toFixed(decimals);
                        document.getElementById('chartAsk').textContent = symbolPrice.ask.toFixed(decimals);
                    }
                    
                    // Realtime candle update + indicators
                    if (candleSeries && data.all_candles && data.all_candles[chartSymbol]) {
                        candleSeries.update(data.all_candles[chartSymbol]);
                        
                        if (!window.lastIndicatorUpdate || Date.now() - window.lastIndicatorUpdate > 30000) {
                            window.lastIndicatorUpdate = Date.now();
                            loadCandles();
                        }
                    }
                    
                    // Signal score
                    if (data.base_score !== undefined) {
                        baseScore = data.base_score;
                    }
                    
                    document.getElementById('indSell').textContent = data.sell_count;
                    document.getElementById('indNeutral').textContent = data.neutral_count;
                    document.getElementById('indBuy').textContent = data.buy_count;
                    
                    document.getElementById('chartIndSell').textContent = data.sell_count;
                    document.getElementById('chartIndNeutral').textContent = data.neutral_count;
                    document.getElementById('chartIndBuy').textContent = data.buy_count;
                    
                    return;  // 여기서 종료
                }
                
                balance = data.balance;
                
                // Home
                document.getElementById('homeBalance').textContent = '$' + data.balance.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('homeBroker').textContent = data.broker;
                document.getElementById('homeAccount').textContent = data.account;
                document.getElementById('homeLeverage').textContent = '1:' + data.leverage;
                document.getElementById('homeEquity').textContent = '$' + data.equity.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('homeFreeMargin').textContent = '$' + data.free_margin.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('homePositions').textContent = data.positions_count;
                
                // Chart prices
                if (data.all_prices && data.all_prices[chartSymbol]) {
                    const symbolPrice = data.all_prices[chartSymbol];
                    const decimals = getDecimalsForSymbol(chartSymbol);
                    document.getElementById('chartBid').textContent = symbolPrice.bid.toFixed(decimals);
                    document.getElementById('chartAsk').textContent = symbolPrice.ask.toFixed(decimals);
                }
                
                // Realtime candle update + indicators
                if (candleSeries && data.all_candles && data.all_candles[chartSymbol]) {
                    candleSeries.update(data.all_candles[chartSymbol]);
                    
                    // 보조지표도 함께 업데이트 (30초마다)
                    if (!window.lastIndicatorUpdate || Date.now() - window.lastIndicatorUpdate > 30000) {
                        window.lastIndicatorUpdate = Date.now();
                        loadCandles();
                    }
                }
                
                // Trade tab
                document.getElementById('tradeBalance').textContent = '$' + Math.round(data.balance).toLocaleString();
                
                // Signal score
                if (data.base_score !== undefined) {
                    baseScore = data.base_score;
                }
                
                document.getElementById('indSell').textContent = data.sell_count;
                document.getElementById('indNeutral').textContent = data.neutral_count;
                document.getElementById('indBuy').textContent = data.buy_count;
                
                chartTargetScore = targetScore;
                document.getElementById('chartIndSell').textContent = data.sell_count;
                document.getElementById('chartIndNeutral').textContent = data.neutral_count;
                document.getElementById('chartIndBuy').textContent = data.buy_count;
                
                // 포지션 정보
                    if (data.position) {
                        updatePositionUI(true, data.position);
                        
                        // 프론트엔드에서도 목표 도달 체크 (백엔드 보완)
                        const pos = data.position;
                        console.log(`[FRONTEND] Position - Profit: ${pos.profit}, Target: ${pos.target}, Should close: ${pos.profit >= pos.target}`);
                        
                        if (pos.target > 0 && pos.profit >= pos.target && !isClosing) {
                            console.log('[FRONTEND] Target reached! Triggering close...');
                            isClosing = true;  // 중복 방지
                            closeDemoPosition();
                        }
                    } else {
                        updatePositionUI(false, null);
                    }
                
                // Account tab
                document.getElementById('accBalance').textContent = '$' + Math.round(data.balance).toLocaleString();
                document.getElementById('accEquity').textContent = '$' + Math.round(data.equity).toLocaleString();
                document.getElementById('accMargin').textContent = '$' + Math.round(data.margin).toLocaleString();
                document.getElementById('accFree').textContent = '$' + Math.round(data.free_margin).toLocaleString();
                
                // Martin state
                if (data.martin) {
                    martinEnabled = data.martin.enabled;
                    martinLevel = data.martin.max_steps;
                    martinStep = data.martin.step;
                    martinAccumulatedLoss = data.martin.accumulated_loss;
                    
                    if (currentMode === 'martin' && martinEnabled) {
                        if (martinAccumulatedLoss > 0) {
                            targetAmount = Math.ceil((martinAccumulatedLoss + 11 + data.martin.target_amount) / 10) * 10;
                        } else {
                            targetAmount = data.martin.target_amount;
                        }
                        
                        document.getElementById('tradeLotSize').textContent = data.martin.current_lot.toFixed(2);
                        updateMartinUI();
                    }
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('statusDot').classList.add('disconnected');
                document.getElementById('headerStatus').textContent = 'Disconnected';
                
                if (wsRetryCount < maxRetries) {
                    wsRetryCount++;
                    setTimeout(connectWebSocket, 3000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        // Fallback polling
        async function fetchAccountData() {
            // Demo 모드면 실행 안 함
            if (isDemo) return;
            
            try {
                const data = await apiCall('/mt5/account-info');
                if (data) {
                    balance = data.balance;
                    
                    document.getElementById('homeBalance').textContent = '$' + (data.balance || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeBroker').textContent = data.broker || '-';
                    document.getElementById('homeAccount').textContent = data.account || '-';
                    document.getElementById('homeLeverage').textContent = '1:' + (data.leverage || 0);
                    document.getElementById('homeServer').textContent = data.server || '-';
                    document.getElementById('homeEquity').textContent = '$' + (data.equity || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeFreeMargin').textContent = '$' + (data.free_margin || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homePositions').textContent = data.positions_count || 0;
                    
                    document.getElementById('tradeBalance').textContent = '$' + Math.round(data.balance || 0).toLocaleString();
                    
                    document.getElementById('accBalance').textContent = '$' + Math.round(data.balance || 0).toLocaleString();
                    document.getElementById('accEquity').textContent = '$' + Math.round(data.equity || 0).toLocaleString();
                    document.getElementById('accMargin').textContent = '$' + Math.round(data.margin || 0).toLocaleString();
                    document.getElementById('accFree').textContent = '$' + Math.round(data.free_margin || 0).toLocaleString();
                    
                    if (data.buy_count !== undefined) {
                        document.getElementById('indSell').textContent = data.sell_count;
                        document.getElementById('indNeutral').textContent = data.neutral_count;
                        document.getElementById('indBuy').textContent = data.buy_count;
                        document.getElementById('chartIndSell').textContent = data.sell_count;
                        document.getElementById('chartIndNeutral').textContent = data.neutral_count;
                        document.getElementById('chartIndBuy').textContent = data.buy_count;
                        
                        baseScore = data.base_score || 50;
                    }
                    
                    if (data.prices && data.prices[chartSymbol]) {
                        const price = data.prices[chartSymbol];
                        const decimals = getDecimalsForSymbol(chartSymbol);
                        document.getElementById('chartBid').textContent = price.bid.toFixed(decimals);
                        document.getElementById('chartAsk').textContent = price.ask.toFixed(decimals);
                    }
                    
                    if (data.position) {
                        updatePositionUI(true, data.position);
                    } else {
                        updatePositionUI(false, null);
                    }
                    
                    document.getElementById('statusDot').classList.remove('disconnected');
                    document.getElementById('headerStatus').textContent = 'Connected';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('statusDot').classList.add('disconnected');
                document.getElementById('headerStatus').textContent = 'Disconnected';
            }
        }
        
        // ========== Demo/Live 모드 확인 ==========
        async function checkUserMode() {
            try {
                // 먼저 Demo 계정 정보 조회
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                // [TEMP DISABLED] MT5 자동 연결 - 나중에 복구 필요
                // if (data.has_mt5) {
                //     // MT5 계정 연결됨 → Live 모드
                //     isDemo = false;
                //     document.getElementById('headerStatus').textContent = 'Connected';
                //     document.getElementById('statusDot').style.background = '#00ff88';
                //
                //     // Live 배지 표시
                //     const badge = document.getElementById('modeBadge');
                //     badge.textContent = 'LIVE';
                //     badge.className = 'mode-badge-live';
                //     badge.style.display = 'inline';
                //     connectWebSocket();
                //     fetchAccountData();
                //     setInterval(fetchAccountData, 2000);
                // } else {
                // [TEMP DISABLED] 위 코드 복구 시 아래 if문을 else로 변경
                if (true) {
                    // MT5 없음 → Demo 모드
                    isDemo = true;
                    document.getElementById('headerStatus').textContent = 'Connected';
                    document.getElementById('demoControlCard').style.display = 'block';
                    document.getElementById('statusDot').style.background = '#00d4ff';
                    
                    // Demo 배지 표시
                    const badge = document.getElementById('modeBadge');
                    badge.textContent = 'DEMO';
                    badge.className = 'mode-badge-demo';
                    badge.style.display = 'inline';
                    connectWebSocket();  // 차트 데이터용 WebSocket 연결
                    fetchDemoData();
                    setInterval(fetchDemoData, 500);  // 500ms로 단축 (빠른 청산)
                    
                    setTimeout(() => {
                        showToast('📊 Demo 모드로 접속했습니다', '가상 $10,000로 연습하세요!');
                    }, 1000);
                }
            } catch (error) {
                console.error('Mode check error:', error);
                // 에러 시 Demo 모드로 기본 설정
                isDemo = true;
                fetchDemoData();
            }
        }
        
        // ========== Demo 데이터 조회 ==========
        async function fetchDemoData() {
            // Demo 모드가 아니면 실행 안 함
            if (!isDemo) return;
            
            try {
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data) {
                    // 백엔드에서 자동 청산된 경우
                    if (data.auto_closed) {
                        playSound('close');
                        
                        const profit = data.closed_profit || 0;
                        const isWin = data.is_win !== false && profit >= 0;
                        
                        // 마틴 모드인 경우
                        if (currentMode === 'martin' && martinEnabled) {
                            if (data.martin_reset || isWin) {
                                // 마틴 성공! 리셋 또는 성공 확인 팝업
                                martinStep = 1;
                                martinAccumulatedLoss = 0;
                                martinHistory = [];
                                updateMartinUI();
                                showMartinSuccessPopup(profit);
                            } else if (data.martin_step_up) {
                                // 마틴 손실 → 다음 단계로
                                showMartinPopup(profit);
                            } else {
                                showToast(data.message || `💔 손절! ${profit.toFixed(2)}`, 'error');
                            }
                        } else {
                            // Basic/NoLimit 모드
                            if (isWin) {
                                showToast(data.message || `🎯 목표 도달! +$${profit.toFixed(2)}`, 'success');
                            } else {
                                showToast(data.message || `💔 손절! $${profit.toFixed(2)}`, 'error');
                            }
                        }
                        
                        // Today P/L 업데이트
                        updateTodayPL(profit);
                        
                        // 포지션 UI 업데이트
                        updatePositionUI(false, null);
                    }
                    
                    document.getElementById('homeBalance').textContent = '$' + (data.balance || 10000).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeBroker').textContent = data.broker || 'Demo';
                    document.getElementById('homeAccount').textContent = data.account || 'DEMO';
                    document.getElementById('homeLeverage').textContent = '1:' + (data.leverage || 500);
                    document.getElementById('homeServer').textContent = data.server || 'Demo';
                    document.getElementById('homeEquity').textContent = '$' + (data.equity || 10000).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeFreeMargin').textContent = '$' + (data.balance || 10000).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homePositions').textContent = data.positions_count || 0;
                    document.getElementById('tradeBalance').textContent = '$' + Math.round(data.balance || 10000).toLocaleString();
                    
                    // Account 탭 업데이트
                    document.getElementById('accBalance').textContent = '$' + Math.round(data.balance || 10000).toLocaleString();
                    document.getElementById('accEquity').textContent = '$' + Math.round(data.equity || 10000).toLocaleString();
                    document.getElementById('accMargin').textContent = '$0';
                    document.getElementById('accFree').textContent = '$' + Math.round(data.balance || 10000).toLocaleString();
                    
                    // 포지션 정보
                    if (data.position) {
                        updatePositionUI(true, data.position);
                        
                        // 프론트엔드에서도 목표 도달 체크 (빠른 청산)
                        const pos = data.position;
                        const currentTarget = pos.target || targetAmount;
                        
                        // WIN 또는 LOSE 조건 체크
                        if (currentTarget > 0 && !isClosing) {
                            if (pos.profit >= currentTarget) {
                                // WIN 조건
                                console.log('[FRONTEND] WIN Target reached! Profit:', pos.profit, '>=', currentTarget);
                                isClosing = true;
                                closeDemoPosition();
                            } else if (pos.profit <= -currentTarget) {
                                // LOSE 조건
                                console.log('[FRONTEND] LOSE Target reached! Profit:', pos.profit, '<=', -currentTarget);
                                isClosing = true;
                                closeDemoPosition();
                            }
                        }
                    } else {
                        updatePositionUI(false, null);
                        isClosing = false;  // 포지션 없으면 플래그 해제
                    }
                    
                    // Quick 패널 업데이트 (Quick 패널이 활성화된 경우)
                    const quickPanel = document.getElementById('quickPanel');
                    if (quickPanel && quickPanel.classList.contains('active')) {
                        updateQuickPanelFromData(data);
                    }
                    
                    // Demo 마틴 상태 조회 (변경된 경우에만 업데이트)
                    if (currentMode === 'martin' && martinEnabled) {
                        try {
                            const martinRes = await fetch(`${API_URL}/demo/martin/state`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const martinData = await martinRes.json();
                            
                            if (martinData) {
                                // 값이 변경된 경우에만 업데이트 (깜빡임 방지)
                                const newStep = martinData.step || 1;
                                const newLoss = martinData.accumulated_loss || 0;
                                
                                if (martinStep !== newStep || martinAccumulatedLoss !== newLoss) {
                                    martinStep = newStep;
                                    martinAccumulatedLoss = newLoss;
                                    martinLevel = martinData.max_steps || 5;
                                    lotSize = martinData.base_lot || 0.01;
                                    
                                    document.getElementById('tradeLotSize').textContent = martinData.current_lot?.toFixed(2) || lotSize.toFixed(2);
                                    updateMartinUI();
                                }
                            }
                        } catch (e) {
                            console.log('Martin state error:', e);
                        }
                    }
                }
            } catch (error) {
                console.error('Demo fetch error:', error);
            }
        }

        // Initialize
        if (!isGuest && token) {
            // 로그인 사용자 - Demo인지 Live인지 확인
            checkUserMode();
        } else if (isGuest) {
            // 게스트 모드 - 데모 데이터 표시
            document.getElementById('homeBalance').textContent = '$10,000.00';
            document.getElementById('homeBroker').textContent = 'Demo Broker';
            document.getElementById('homeAccount').textContent = 'GUEST';
            document.getElementById('homeLeverage').textContent = '1:500';
            document.getElementById('homeServer').textContent = 'Demo Server';
            document.getElementById('homeEquity').textContent = '$10,000.00';
            document.getElementById('homeFreeMargin').textContent = '$10,000.00';
            document.getElementById('homePositions').textContent = '0';
            document.getElementById('tradeBalance').textContent = '$10,000';
            document.getElementById('headerStatus').textContent = 'Guest Mode';
            document.getElementById('statusDot').style.background = '#ffa500';
            
            // 게스트 모드 인디케이터 업데이트
            async function fetchGuestIndicators() {
                try {
                    const response = await fetch(`${API_URL}/mt5/indicators/BTCUSD`);
                    const data = await response.json();
                    if (data) {
                        document.getElementById('indSell').textContent = data.sell || 0;
                        document.getElementById('indNeutral').textContent = data.neutral || 0;
                        document.getElementById('indBuy').textContent = data.buy || 0;
                        document.getElementById('chartIndSell').textContent = data.sell || 0;
                        document.getElementById('chartIndNeutral').textContent = data.neutral || 0;
                        document.getElementById('chartIndBuy').textContent = data.buy || 0;
                        baseScore = data.score || 50;
                    }
                } catch (e) {
                    console.log('Guest indicator error:', e);
                }
            }
            
            fetchGuestIndicators();
            setInterval(fetchGuestIndicators, 3000);
            
            // 게스트 안내 토스트
            setTimeout(() => {
                showToast('👋 게스트 모드로 둘러보는 중입니다', '');
            }, 1000);
        }
        
        // Profile name
        const userEmail = localStorage.getItem('user_email');
        if (userEmail) {
            document.getElementById('profileName').textContent = userEmail.split('@')[0];
        }
        
        // ========== 시간대별 인사 ==========
        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingText = document.getElementById('greetingText');
            const greetingSub = document.getElementById('greetingSub');
            
            const userName = localStorage.getItem('user_email')?.split('@')[0] || 'Trader';
            
            let greeting, sub;
            
            if (hour >= 5 && hour < 12) {
                greeting = `Good Morning, ${userName}! ☀️`;
                sub = '오늘도 좋은 거래 되세요!';
            } else if (hour >= 12 && hour < 18) {
                greeting = `Good Afternoon, ${userName}! 🌤️`;
                sub = '오후도 화이팅!';
            } else if (hour >= 18 && hour < 22) {
                greeting = `Good Evening, ${userName}! 🌙`;
                sub = '오늘 하루 수고하셨어요!';
            } else {
                greeting = `Still Trading, ${userName}? 🦉`;
                sub = '늦은 시간까지 화이팅!';
            }
            
            if (greetingText) greetingText.textContent = greeting;
            if (greetingSub) greetingSub.textContent = sub;
        }
        
        // 페이지 로드 시 인사 업데이트
        updateGreeting();
        // 1분마다 업데이트 (시간 변경 대응)
        setInterval(updateGreeting, 60000);
        
        // ========== 프로모션 슬라이더 ==========
        function scrollToPromo(index) {
            const slider = document.getElementById('promoSlider');
            const cards = slider.querySelectorAll('.promo-card');
            if (cards[index]) {
                cards[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                updatePromoDots(index);
            }
        }
        
        function updatePromoDots(activeIndex) {
            const dots = document.querySelectorAll('.promo-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === activeIndex);
            });
        }
        
        // 슬라이드 스크롤 감지
        document.getElementById('promoSlider')?.addEventListener('scroll', function() {
            const slider = this;
            const scrollLeft = slider.scrollLeft;
            const cardWidth = slider.querySelector('.promo-card')?.offsetWidth || 0;
            const gap = 12;
            const index = Math.round(scrollLeft / (cardWidth + gap));
            updatePromoDots(index);
        });
        
        // ========== Trading Mode 전환 ==========
        function switchTradingMode(mode) {
            const demoBtn = document.getElementById('modeDemoBtn');
            const liveBtn = document.getElementById('modeLiveBtn');
            const demoCheck = document.getElementById('demoCheck');
            const liveCheck = document.getElementById('liveCheck');
            const modeStatus = document.getElementById('modeStatus');
            const modeBadge = document.getElementById('modeBadge');
            
            if (mode === 'demo') {
                // Demo 모드로 전환
                demoBtn.classList.add('active');
                demoBtn.classList.remove('live-active');
                liveBtn.classList.remove('active', 'live-active');
                demoCheck.style.display = 'flex';
                liveCheck.style.display = 'none';
                
                modeStatus.className = 'mode-status';
                modeStatus.innerHTML = '<span class="mode-status-dot demo"></span><span>Currently in <strong>Demo Mode</strong> - Practice with virtual $10,000</span>';
                
                // 배지 업데이트
                if (modeBadge) {
                    modeBadge.textContent = 'DEMO';
                    modeBadge.className = 'mode-badge-demo';
                    modeBadge.style.display = 'inline';
                }
                
                // Demo Control 표시
                const demoControl = document.getElementById('demoControlCard');
                if (demoControl) demoControl.style.display = 'block';
                
                isDemo = true;
                showToast('🎮 Demo 모드로 전환되었습니다', 'success');
                fetchDemoData();
                
            } else if (mode === 'live') {
                // Live 모드 전환 시도
                // MT5 계정 연결 확인 필요
                if (!token) {
                    showToast('로그인이 필요합니다', 'error');
                    return;
                }
                
                // MT5 연결 확인 API 호출
                checkMT5Connection().then(hasMT5 => {
                    if (hasMT5) {
                        // Live 모드로 전환
                        liveBtn.classList.add('active', 'live-active');
                        demoBtn.classList.remove('active');
                        liveCheck.style.display = 'flex';
                        demoCheck.style.display = 'none';
                        
                        modeStatus.className = 'mode-status live';
                        modeStatus.innerHTML = '<span class="mode-status-dot live"></span><span>Currently in <strong>Live Mode</strong> - Real trading active</span>';
                        
                        // 배지 업데이트
                        if (modeBadge) {
                            modeBadge.textContent = 'LIVE';
                            modeBadge.className = 'mode-badge-live';
                            modeBadge.style.display = 'inline';
                        }
                        
                        // Demo Control 숨기기
                        const demoControl = document.getElementById('demoControlCard');
                        if (demoControl) demoControl.style.display = 'none';
                        
                        isDemo = false;
                        showToast('💎 Live 모드로 전환되었습니다', 'success');
                        fetchAccountData();
                        
                    } else {
                        showToast('MT5 계정을 먼저 연결해주세요', 'error');
                        // MT5 연결 섹션으로 스크롤
                        document.getElementById('mt5AccountSection')?.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }
        }
        
        async function checkMT5Connection() {
            try {
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                return data.has_mt5 || false;
            } catch (e) {
                return false;
            }
        }
        
        // 초기 모드 상태 반영
        function initTradingModeUI() {
            if (isDemo) {
                switchTradingMode('demo');
            } else {
                const liveBtn = document.getElementById('modeLiveBtn');
                const demoBtn = document.getElementById('modeDemoBtn');
                const liveCheck = document.getElementById('liveCheck');
                const demoCheck = document.getElementById('demoCheck');
                const modeStatus = document.getElementById('modeStatus');
                
                if (liveBtn && demoBtn) {
                    liveBtn.classList.add('active', 'live-active');
                    demoBtn.classList.remove('active');
                    liveCheck.style.display = 'flex';
                    demoCheck.style.display = 'none';
                    
                    modeStatus.className = 'mode-status live';
                    modeStatus.innerHTML = '<span class="mode-status-dot live"></span><span>Currently in <strong>Live Mode</strong> - Real trading active</span>';
                }
            }
        }
        
        // ========== MT5 Account 관리 ==========
        function updateMT5AccountUI(hasMT5, mt5Data = null) {
            const notConnected = document.getElementById('mt5NotConnected');
            const connected = document.getElementById('mt5Connected');
            
            if (hasMT5 && mt5Data) {
                // 연결됨 상태 표시
                notConnected.style.display = 'none';
                connected.style.display = 'block';
                
                document.getElementById('mt5Broker').textContent = mt5Data.broker || '-';
                document.getElementById('mt5Account').textContent = mt5Data.account || '-';
                document.getElementById('mt5Server').textContent = mt5Data.server || '-';
                document.getElementById('mt5Leverage').textContent = mt5Data.leverage ? `1:${mt5Data.leverage}` : '-';
            } else {
                // 연결 안 됨 상태 표시
                notConnected.style.display = 'block';
                connected.style.display = 'none';
            }
        }
        
        async function disconnectMT5() {
            if (!confirm('MT5 계좌 연결을 해제하시겠습니까?')) return;
            
            try {
                // 연결 해제 API 호출 (추후 구현)
                // await apiCall('/mt5/disconnect', 'POST');
                
                updateMT5AccountUI(false);
                switchTradingMode('demo');
                showToast('MT5 계좌 연결이 해제되었습니다', 'success');
            } catch (e) {
                showToast('연결 해제 실패', 'error');
            }
        }
        
        // MT5 상태 확인 및 UI 업데이트
        async function checkAndUpdateMT5Status() {
            try {
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.has_mt5) {
                    // MT5 정보 조회
                    const mt5Response = await fetch(`${API_URL}/mt5/account-info`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const mt5Data = await mt5Response.json();
                    
                    updateMT5AccountUI(true, {
                        broker: mt5Data.broker,
                        account: mt5Data.account,
                        server: mt5Data.server,
                        leverage: mt5Data.leverage
                    });
                } else {
                    updateMT5AccountUI(false);
                }
            } catch (e) {
                updateMT5AccountUI(false);
            }
        }
        
        // 페이지 로드 시 MT5 상태 확인
        if (token && !isGuest) {
            checkAndUpdateMT5Status();
        }
        
        // ========== 공지 배너 ==========
        function showNoticeBanner(message) {
            const banner = document.getElementById('noticeBanner');
            const text = document.getElementById('noticeText');
            text.textContent = message;
            banner.style.display = 'flex';
        }
        
        function closeNoticeBanner() {
            const banner = document.getElementById('noticeBanner');
            banner.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => {
                banner.style.display = 'none';
                banner.style.animation = 'slideDown 0.3s ease';
            }, 300);
            // 24시간 동안 다시 안 보이게 (선택사항)
            localStorage.setItem('noticeClosed', Date.now());
        }
        
        // 공지 표시 (예시 - 필요시 활성화)
        // showNoticeBanner('서버 점검 안내 (1/20 02:00~04:00)');
    
        // ========== MT5 연결 모달 ==========
        function openMT5ConnectModal() {
            document.getElementById('mt5ConnectModal').classList.add('show');
            showMT5Step1();
        }
        
        function closeMT5ConnectModal() {
            document.getElementById('mt5ConnectModal').classList.remove('show');
        }
        
        function showMT5Step1() {
            document.getElementById('mt5Step1').style.display = 'block';
            document.getElementById('mt5Step2Existing').style.display = 'none';
            document.getElementById('mt5Step2New').style.display = 'none';
        }
        
        function showMT5Step2(type) {
            document.getElementById('mt5Step1').style.display = 'none';
            if (type === 'existing') {
                document.getElementById('mt5Step2Existing').style.display = 'block';
                document.getElementById('mt5Step2New').style.display = 'none';
            } else {
                document.getElementById('mt5Step2Existing').style.display = 'none';
                document.getElementById('mt5Step2New').style.display = 'block';
            }
        }
        
        function openMT5GuideModal() {
            openMT5ConnectModal();
            showMT5Step2('new');
        }
        
        async function connectMT5Account() {
            const server = document.getElementById('mt5Server').value;
            const account = document.getElementById('mt5AccountNumber').value;
            const password = document.getElementById('mt5Password').value;
            
            if (!account || !password) {
                showToast('계좌번호와 비밀번호를 입력하세요', 'error');
                return;
            }
            
            showToast('연결 중...', '');
            
            try {
                // 실제 API 호출 (추후 구현)
                // const result = await apiCall('/mt5/connect', 'POST', { server, account, password });
                
                // 임시: 성공 처리
                setTimeout(() => {
                    closeMT5ConnectModal();
                    
                    // 성공 모달 표시
                    document.getElementById('successAccount').textContent = account;
                    document.getElementById('successServer').textContent = server;
                    document.getElementById('mt5SuccessModal').classList.add('show');
                    
                    // MT5 연결 상태 업데이트
                    updateMT5AccountUI(true, {
                        broker: 'HedgeHood',
                        account: account,
                        server: server,
                        leverage: 500
                    });
                    
                    // Live 모드로 전환
                    isDemo = false;
                    switchTradingMode('live');
                    
                    // Hero 배지 업데이트
                    const heroBadge = document.getElementById('heroModeBadge');
                    if (heroBadge) {
                        heroBadge.textContent = 'Trading-X Live';
                        heroBadge.style.background = 'linear-gradient(135deg, rgba(0, 255, 136, 0.2) 0%, rgba(0, 255, 136, 0.05) 100%)';
                        heroBadge.style.borderColor = 'rgba(0, 255, 136, 0.4)';
                        heroBadge.style.color = '#00ff88';
                    }
                }, 1500);
                
            } catch (error) {
                showToast('연결 실패: ' + error.message, 'error');
            }
        }
        
        function closeMT5SuccessModal() {
            document.getElementById('mt5SuccessModal').classList.remove('show');
        }
        
        // ========== 서브메뉴 (차트 탭) ==========
        let submenuLongPressTimer = null;
        let submenuCurrentItem = null;
        const LONG_PRESS_DURATION = 500; // 0.5초
        
        // 서브메뉴 열기
        function openChartSubmenu() {
            const defaultView = localStorage.getItem('chart_default_view') || null;
            
            // 배지 업데이트
            const watchlistBadge = document.getElementById('submenuWatchlistBadge');
            const chartBadge = document.getElementById('submenuChartBadge');
            
            if (defaultView === 'watchlist') {
                watchlistBadge.style.display = 'block';
                chartBadge.style.display = 'none';
            } else if (defaultView === 'chart') {
                watchlistBadge.style.display = 'none';
                chartBadge.style.display = 'block';
            } else {
                watchlistBadge.style.display = 'none';
                chartBadge.style.display = 'none';
            }
            
            document.getElementById('chartSubmenuOverlay').classList.add('show');
        }
        
        // 서브메뉴 닫기
        function closeChartSubmenu() {
            document.getElementById('chartSubmenuOverlay').classList.remove('show');
        }
        
        // 서브메뉴 항목 클릭
        function selectSubmenuItem(view) {
            closeChartSubmenu();
            
            // 페이지 전환
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item[data-page="chart"]').classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-chart').classList.add('active');
            
            if (view === 'watchlist') {
                showWatchlist();
                renderWatchlist();
            } else if (view === 'chart') {
                // 마지막 본 종목 또는 기본 종목으로 차트 열기
                const lastSymbol = localStorage.getItem('last_chart_symbol') || 'BTCUSD';
                const symbolInfo = getSymbolInfo(lastSymbol);
                
                chartSymbol = lastSymbol;
                document.getElementById('chartSymbolIcon').textContent = symbolInfo.icon;
                document.getElementById('chartSymbolIcon').style.color = symbolInfo.color;
                document.getElementById('chartSymbolName').textContent = symbolInfo.name;
                document.getElementById('chartSymbolId').textContent = lastSymbol;
                
                showChartDetail();
                
                if (chart) {
                    chart.remove();
                    chart = null;
                }
                initChart();
                loadCandles();
            }
        }
        
        // 심볼 정보 가져오기
        function getSymbolInfo(symbol) {
            const defaultInfo = { name: symbol, icon: '📈', color: '#00d4ff' };
            
            const symbolMap = {
                'BTCUSD': { name: 'Bitcoin', icon: '₿', color: '#f7931a' },
                'EURUSD.r': { name: 'Euro/Dollar', icon: '€', color: '#0052cc' },
                'USDJPY.r': { name: 'Dollar/Yen', icon: '¥', color: '#dc143c' },
                'XAUUSD.r': { name: 'Gold', icon: '✦', color: '#ffd700' },
                'US100.': { name: 'NASDAQ', icon: '⬡', color: '#00b450' },
                'GBPUSD.r': { name: 'Pound/Dollar', icon: '£', color: '#9c27b0' },
                'ETHUSD': { name: 'Ethereum', icon: 'Ξ', color: '#627eea' }
            };
            
            return symbolMap[symbol] || defaultInfo;
        }
        
        // 서브메뉴 항목 길게 누르기 시작
        function submenuItemPressStart(view, element) {
            submenuCurrentItem = element;
            element.classList.add('pressing');
            
            submenuLongPressTimer = setTimeout(() => {
                // 길게 누르기 완료 - 기본 화면으로 등록
                registerDefaultView(view);
                element.classList.remove('pressing');
            }, LONG_PRESS_DURATION);
        }
        
        // 서브메뉴 항목 길게 누르기 종료
        function submenuItemPressEnd() {
            if (submenuLongPressTimer) {
                clearTimeout(submenuLongPressTimer);
                submenuLongPressTimer = null;
            }
            if (submenuCurrentItem) {
                submenuCurrentItem.classList.remove('pressing');
                submenuCurrentItem = null;
            }
        }
        
        // 기본 화면 등록
        function registerDefaultView(view) {
            localStorage.setItem('chart_default_view', view);
            
            // 배지 업데이트
            const watchlistBadge = document.getElementById('submenuWatchlistBadge');
            const chartBadge = document.getElementById('submenuChartBadge');
            
            if (view === 'watchlist') {
                watchlistBadge.style.display = 'block';
                chartBadge.style.display = 'none';
            } else {
                watchlistBadge.style.display = 'none';
                chartBadge.style.display = 'block';
            }
            
            // 토스트 표시
            const viewName = view === 'watchlist' ? '종목 목록' : '차트 보기';
            showSubmenuToast(viewName);
            
            // 햅틱 피드백 (모바일)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // 등록 완료 토스트
        function showSubmenuToast(viewName) {
            const toast = document.getElementById('submenuToast');
            document.getElementById('submenuToastViewName').textContent = viewName;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }
        
        // ========== 네비게이션 길게 누르기 ==========
        let navLongPressTimer = null;
        let navPressedItem = null;
        
        function setupNavLongPress() {
            // Chart 탭 설정
            const chartNavItem = document.querySelector('.nav-item[data-page="chart"]');
            if (chartNavItem) {
                chartNavItem.removeAttribute('onclick');
                chartNavItem.addEventListener('touchstart', (e) => navTouchStart(e, 'chart'), { passive: true });
                chartNavItem.addEventListener('touchend', (e) => navTouchEnd(e, 'chart'));
                chartNavItem.addEventListener('touchcancel', (e) => navTouchEnd(e, 'chart'));
                chartNavItem.addEventListener('mousedown', (e) => navMouseDown(e, 'chart'));
                chartNavItem.addEventListener('mouseup', (e) => navMouseUp(e, 'chart'));
                chartNavItem.addEventListener('mouseleave', (e) => navMouseUp(e, 'chart'));
            }
            
            // Trade 탭 설정
            const tradeNavItem = document.querySelector('.nav-item[data-page="trade"]');
            if (tradeNavItem) {
                tradeNavItem.removeAttribute('onclick');
                tradeNavItem.addEventListener('touchstart', (e) => navTouchStart(e, 'trade'), { passive: true });
                tradeNavItem.addEventListener('touchend', (e) => navTouchEnd(e, 'trade'));
                tradeNavItem.addEventListener('touchcancel', (e) => navTouchEnd(e, 'trade'));
                tradeNavItem.addEventListener('mousedown', (e) => navMouseDown(e, 'trade'));
                tradeNavItem.addEventListener('mouseup', (e) => navMouseUp(e, 'trade'));
                tradeNavItem.addEventListener('mouseleave', (e) => navMouseUp(e, 'trade'));
            }
        }
        
        let currentNavTab = 'chart'; // 현재 처리 중인 탭
        
        function navTouchStart(e, tab) {
            currentNavTab = tab;
            navPressedItem = e.currentTarget;
            navPressedItem.classList.add('long-pressing');
            
            navLongPressTimer = setTimeout(() => {
                navLongPressAction(tab);
            }, LONG_PRESS_DURATION);
        }
        
        function navTouchEnd(e, tab) {
            const wasLongPress = navLongPressTimer === null;
            
            if (navLongPressTimer) {
                clearTimeout(navLongPressTimer);
                navLongPressTimer = null;
            }
            
            if (navPressedItem) {
                navPressedItem.classList.remove('long-pressing');
            }
            
            // 짧은 클릭이면 서브메뉴 열기
            if (!wasLongPress) {
                e.preventDefault();
                if (tab === 'chart') {
                    openChartSubmenu();
                } else if (tab === 'trade') {
                    openTradeSubmenu();
                }
            }
            
            navPressedItem = null;
        }
        
        function navMouseDown(e, tab) {
            currentNavTab = tab;
            navPressedItem = e.currentTarget;
            navPressedItem.classList.add('long-pressing');
            
            navLongPressTimer = setTimeout(() => {
                navLongPressAction(tab);
            }, LONG_PRESS_DURATION);
        }
        
        function navMouseUp(e, tab) {
            const wasLongPress = navLongPressTimer === null;
            
            if (navLongPressTimer) {
                clearTimeout(navLongPressTimer);
                navLongPressTimer = null;
            }
            
            if (navPressedItem) {
                navPressedItem.classList.remove('long-pressing');
            }
            
            // 짧은 클릭이면 서브메뉴 열기
            if (!wasLongPress && e.type === 'mouseup') {
                if (tab === 'chart') {
                    openChartSubmenu();
                } else if (tab === 'trade') {
                    openTradeSubmenu();
                }
            }
            
            navPressedItem = null;
        }
        
        // 길게 누르기 액션 - 등록된 화면으로 바로 이동
        function navLongPressAction(tab) {
            navLongPressTimer = null;
            
            if (navPressedItem) {
                navPressedItem.classList.remove('long-pressing');
            }
            
            if (tab === 'chart') {
                const defaultView = localStorage.getItem('chart_default_view');
                
                if (defaultView) {
                    selectSubmenuItem(defaultView);
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    showToast('🚀 ' + (defaultView === 'watchlist' ? '종목 목록' : '차트') + '으로 이동!', 'success');
                } else {
                    openChartSubmenu();
                    showToast('💡 화면을 길게 눌러 기본 화면으로 등록하세요', '');
                }
            } else if (tab === 'trade') {
                const defaultView = localStorage.getItem('trade_default_view');
                
                if (defaultView) {
                    selectTradeSubmenuItem(defaultView);
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    showToast('🚀 ' + (defaultView === 'buysell' ? 'Buy/Sell 패널' : 'Quick & Easy 패널') + '으로 이동!', 'success');
                } else {
                    openTradeSubmenu();
                    showToast('💡 화면을 길게 눌러 기본 화면으로 등록하세요', '');
                }
            }
        }
        
        // 차트에서 종목 열 때 마지막 종목 저장
        const originalOpenChartFromWatchlist = openChartFromWatchlist;
        openChartFromWatchlist = function(symbol, name, icon, color) {
            localStorage.setItem('last_chart_symbol', symbol);
            originalOpenChartFromWatchlist(symbol, name, icon, color);
        };
        
        // 페이지 로드 시 네비 길게 누르기 설정
        document.addEventListener('DOMContentLoaded', setupNavLongPress);
        
        // 이미 로드된 경우 바로 실행
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setupNavLongPress();
        }
        
        // ========== Trade 서브메뉴 ==========
        let tradeSubmenuLongPressTimer = null;
        let tradeSubmenuCurrentItem = null;
        
        // Trade 서브메뉴 열기
        function openTradeSubmenu() {
            const defaultView = localStorage.getItem('trade_default_view') || null;
            
            // 배지 업데이트
            const buysellBadge = document.getElementById('submenuBuysellBadge');
            const quickBadge = document.getElementById('submenuQuickBadge');
            
            if (defaultView === 'buysell') {
                buysellBadge.style.display = 'block';
                quickBadge.style.display = 'none';
            } else if (defaultView === 'quick') {
                buysellBadge.style.display = 'none';
                quickBadge.style.display = 'block';
            } else {
                buysellBadge.style.display = 'none';
                quickBadge.style.display = 'none';
            }
            
            document.getElementById('tradeSubmenuOverlay').classList.add('show');
        }
        
        // Trade 서브메뉴 닫기
        function closeTradeSubmenu() {
            document.getElementById('tradeSubmenuOverlay').classList.remove('show');
        }
        
        // Trade 서브메뉴 항목 클릭
        function selectTradeSubmenuItem(view) {
            closeTradeSubmenu();
            
            // 페이지 전환
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item[data-page="trade"]').classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-trade').classList.add('active');
            
            // 패널 전환
            showTradePanel(view);
        }
        
        // Trade 패널 표시
        function showTradePanel(panel) {
            const buysellPanel = document.getElementById('buysellPanel');
            const quickPanel = document.getElementById('quickPanel');
            
            if (panel === 'buysell') {
                buysellPanel.style.display = 'block';
                quickPanel.classList.remove('active');
                quickPanel.style.display = 'none';
            } else if (panel === 'quick') {
                buysellPanel.style.display = 'none';
                quickPanel.classList.add('active');
                quickPanel.style.display = 'block';
                updateQuickPanel();
            }
        }
        
        // Trade 서브메뉴 항목 길게 누르기 시작
        function tradeSubmenuItemPressStart(view, element) {
            tradeSubmenuCurrentItem = element;
            element.classList.add('pressing');
            
            tradeSubmenuLongPressTimer = setTimeout(() => {
                registerTradeDefaultView(view);
                element.classList.remove('pressing');
            }, LONG_PRESS_DURATION);
        }
        
        // Trade 서브메뉴 항목 길게 누르기 종료
        function tradeSubmenuItemPressEnd() {
            if (tradeSubmenuLongPressTimer) {
                clearTimeout(tradeSubmenuLongPressTimer);
                tradeSubmenuLongPressTimer = null;
            }
            if (tradeSubmenuCurrentItem) {
                tradeSubmenuCurrentItem.classList.remove('pressing');
                tradeSubmenuCurrentItem = null;
            }
        }
        
        // Trade 기본 화면 등록
        function registerTradeDefaultView(view) {
            localStorage.setItem('trade_default_view', view);
            
            // 배지 업데이트
            const buysellBadge = document.getElementById('submenuBuysellBadge');
            const quickBadge = document.getElementById('submenuQuickBadge');
            
            if (view === 'buysell') {
                buysellBadge.style.display = 'block';
                quickBadge.style.display = 'none';
            } else {
                buysellBadge.style.display = 'none';
                quickBadge.style.display = 'block';
            }
            
            // 토스트 표시
            const viewName = view === 'buysell' ? 'Buy/Sell 패널' : 'Quick & Easy 패널';
            showSubmenuToast(viewName);
            
            // 햅틱 피드백 (모바일)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // ========== Quick & Easy 패널 함수 ==========
        
        // Quick 패널 전용 변수
        let quickSymbol = 'BTCUSD';
        let quickLot = 0.01;
        let quickPositions = []; // 다중 포지션 배열
        
        // Quick 패널 업데이트
        function updateQuickPanel() {
            // 현재 심볼 정보 반영
            const symbolInfo = getSymbolInfo(quickSymbol);
            document.getElementById('quickSymbolIcon').textContent = symbolInfo.icon;
            document.getElementById('quickSymbolIcon').style.color = symbolInfo.color;
            document.getElementById('quickSymbolName').textContent = symbolInfo.name;
            document.getElementById('quickSymbolId').textContent = quickSymbol;
            
            // 계좌 정보 업데이트
            updateQuickAccountInfo();
            
            // 스프레드 업데이트
            updateQuickSpread();
            
            // 포지션 리스트 업데이트
            updateQuickPositionList();
            
            // 가격 업데이트
            updateQuickPrices();
        }
        
        // Quick 계좌 정보 업데이트
        function updateQuickAccountInfo() {
            const quickBalance = document.getElementById('quickBalance');
            const quickEquity = document.getElementById('quickEquity');
            const quickMargin = document.getElementById('quickMargin');
            const quickTodayPL = document.getElementById('quickTodayPL');
            
            if (quickBalance) quickBalance.textContent = '$' + Math.round(balance).toLocaleString();
            if (quickEquity) quickEquity.textContent = '$' + Math.round(balance).toLocaleString();
            if (quickMargin) quickMargin.textContent = '$0';
            
            if (quickTodayPL) {
                if (todayPL >= 0) {
                    quickTodayPL.textContent = '+$' + Math.abs(todayPL).toFixed(0);
                    quickTodayPL.style.color = 'var(--buy-color)';
                } else {
                    quickTodayPL.textContent = '-$' + Math.abs(todayPL).toFixed(0);
                    quickTodayPL.style.color = 'var(--sell-color)';
                }
            }
        }
        
        // Quick 스프레드 업데이트
        function updateQuickSpread() {
            const spreadEl = document.getElementById('quickSpreadValue');
            if (!spreadEl) return;
            
            const spreads = {
                'BTCUSD': '$15.00',
                'EURUSD.r': '0.00020',
                'USDJPY.r': '0.030',
                'XAUUSD.r': '$0.50',
                'US100.': '$1.50'
            };
            
            spreadEl.textContent = spreads[quickSymbol] || '-';
        }
        
        // Quick 가격 업데이트
        function updateQuickPrices() {
            const bidEl = document.getElementById('quickBidPrice');
            const askEl = document.getElementById('quickAskPrice');
            
            if (!bidEl || !askEl) return;
            
            const prices = watchlistPrices[quickSymbol] || demoQuotes[quickSymbol];
            if (prices) {
                const decimals = getDecimalsForSymbol(quickSymbol);
                bidEl.textContent = prices.bid.toFixed(decimals);
                askEl.textContent = prices.ask.toFixed(decimals);
            }
        }
        
        // 종목 드롭다운 토글
        function toggleQuickSymbolDropdown() {
            const dropdown = document.getElementById('quickSymbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        // 종목 선택
        function selectQuickSymbol(symbol) {
            quickSymbol = symbol;
            
            const symbolInfo = getSymbolInfo(symbol);
            document.getElementById('quickSymbolIcon').textContent = symbolInfo.icon;
            document.getElementById('quickSymbolIcon').style.color = symbolInfo.color;
            document.getElementById('quickSymbolName').textContent = symbolInfo.name;
            document.getElementById('quickSymbolId').textContent = symbol;
            
            // 드롭다운 닫기
            document.getElementById('quickSymbolDropdown').style.display = 'none';
            
            // 스프레드 및 가격 업데이트
            updateQuickSpread();
            updateQuickPrices();
            
            showToast(`📊 ${symbolInfo.name} 선택됨`, 'success');
        }
        
        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('quickSymbolDropdown');
            const selector = document.getElementById('quickSymbolSelector');
            if (dropdown && selector && !selector.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // 랏수 조절
        function adjustQuickLot(delta) {
            const input = document.getElementById('quickLotInput');
            let value = parseFloat(input.value) || 0.01;
            value = Math.max(0.01, Math.min(10, value + delta));
            value = Math.round(value * 100) / 100;
            input.value = value.toFixed(2);
            quickLot = value;
        }
        
        // 랏수 유효성 검사
        function validateQuickLot(input) {
            let value = parseFloat(input.value);
            if (isNaN(value) || value < 0.01) {
                value = 0.01;
            } else if (value > 10) {
                value = 10;
            }
            value = Math.round(value * 100) / 100;
            input.value = value.toFixed(2);
            quickLot = value;
        }
        
        // Quick 매수
        async function quickBuy() {
            if (!checkGuestAction('trade')) return;
            
            showToast('⚡ Quick BUY 실행!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/order?symbol=${quickSymbol}&order_type=BUY&volume=${quickLot}&target=0`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    
                    if (result?.success) {
                        playSound('buy');
                        fetchDemoData();
                    } else {
                        showToast(result?.message || 'Error', 'error');
                    }
                } else {
                    const result = await apiCall(`/mt5/order?symbol=${quickSymbol}&order_type=BUY&volume=${quickLot}&target=0`, 'POST');
                    if (result?.success) playSound('buy');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Quick 매도
        async function quickSell() {
            if (!checkGuestAction('trade')) return;
            
            showToast('⚡ Quick SELL 실행!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/order?symbol=${quickSymbol}&order_type=SELL&volume=${quickLot}&target=0`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    
                    if (result?.success) {
                        playSound('sell');
                        fetchDemoData();
                    } else {
                        showToast(result?.message || 'Error', 'error');
                    }
                } else {
                    const result = await apiCall(`/mt5/order?symbol=${quickSymbol}&order_type=SELL&volume=${quickLot}&target=0`, 'POST');
                    if (result?.success) playSound('sell');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 일괄 청산 (전종목)
        async function quickCloseAll() {
            if (!checkGuestAction('trade')) return;
            if (!confirm('모든 포지션을 청산하시겠습니까?')) return;
            
            showToast('🔴 일괄 청산 실행!', 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-all`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-all', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 현종목 청산
        async function quickCloseSymbol() {
            if (!checkGuestAction('trade')) return;
            
            showToast(`🟠 ${quickSymbol} 청산 실행!`, 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close?symbol=${quickSymbol}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall(`/mt5/close?symbol=${quickSymbol}`, 'POST');
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                    }
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 개별 포지션 청산 (티켓 번호로)
        async function quickClosePosition(ticket) {
            if (!checkGuestAction('trade')) return;
            
            showToast(`🔴 포지션 #${ticket} 청산!`, 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close?ticket=${ticket}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall(`/mt5/close?ticket=${ticket}`, 'POST');
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                    }
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 매수만 청산
        async function quickCloseBuy() {
            if (!checkGuestAction('trade')) return;
            
            showToast('🟢 매수 포지션 청산!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-type?type=BUY`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-type?type=BUY', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 매도만 청산
        async function quickCloseSell() {
            if (!checkGuestAction('trade')) return;
            
            showToast('🔴 매도 포지션 청산!', 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-type?type=SELL`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-type?type=SELL', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 수익만 청산
        async function quickCloseProfit() {
            if (!checkGuestAction('trade')) return;
            
            showToast('💰 수익 포지션 청산!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-profit?profit_type=positive`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-profit?profit_type=positive', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // 손실만 청산
        async function quickCloseLoss() {
            if (!checkGuestAction('trade')) return;
            
            showToast('💔 손실 포지션 청산!', 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-profit?profit_type=negative`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-profit?profit_type=negative', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // SL/TP 적용
        async function applyQuickSLTP() {
            if (!checkGuestAction('trade')) return;
            const sl = document.getElementById('quickSLInput').value;
            const tp = document.getElementById('quickTPInput').value;
            
            if (!sl && !tp) {
                showToast('SL 또는 TP 값을 입력하세요', 'error');
                return;
            }
            
            showToast(`✅ SL: ${sl || '-'} / TP: ${tp || '-'} 적용!`, 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/set-sltp?symbol=${quickSymbol}&sl=${sl || 0}&tp=${tp || 0}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) fetchDemoData();
                } else {
                    await apiCall(`/mt5/set-sltp?symbol=${quickSymbol}&sl=${sl || 0}&tp=${tp || 0}`, 'POST');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Quick 포지션 리스트 업데이트 (다중 포지션 지원)
        function updateQuickPositionList() {
            const container = document.getElementById('quickPositionList');
            if (!container) return;
            
            // quickPositions 배열에 데이터가 있으면 표시
            if (quickPositions && quickPositions.length > 0) {
                // 총 손익 계산
                let totalProfit = 0;
                quickPositions.forEach(pos => {
                    totalProfit += pos.profit || 0;
                });
                
                const totalProfitClass = totalProfit >= 0 ? 'positive' : 'negative';
                const totalProfitSign = totalProfit >= 0 ? '+' : '';
                
                let html = `
                    <div class="quick-total-pl">
                        <span class="quick-total-pl-label">📊 총 ${quickPositions.length}개 포지션</span>
                        <span class="quick-total-pl-value ${totalProfitClass}">${totalProfitSign}$${totalProfit.toFixed(2)}</span>
                    </div>
                `;
                
                quickPositions.forEach((pos, index) => {
                    const isBuy = pos.type === 'BUY';
                    const profitClass = pos.profit >= 0 ? 'positive' : 'negative';
                    const profitSign = pos.profit >= 0 ? '+' : '';
                    const positionClass = isBuy ? 'buy-position' : 'sell-position';
                    const symbolInfo = getSymbolInfo(pos.symbol);
                    const decimals = getDecimalsForSymbol(pos.symbol);
                    
                    html += `
                        <div class="quick-position-item ${positionClass}">
                            <div class="quick-position-symbol">
                                <div class="quick-position-symbol-name" style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 16px; color: ${symbolInfo.color};">${symbolInfo.icon}</span>
                                    ${pos.symbol}
                                </div>
                                <div class="quick-position-symbol-info">${pos.volume?.toFixed(2) || '0.01'} lot • ${pos.entry?.toFixed(decimals) || '-'}</div>
                            </div>
                            <span class="quick-position-type ${isBuy ? 'buy' : 'sell'}">${pos.type}</span>
                            <div class="quick-position-profit ${profitClass}">${profitSign}$${pos.profit?.toFixed(2) || '0.00'}</div>
                            <button class="quick-position-close" onclick="quickClosePosition(${pos.ticket || index})">
                                <span class="material-icons-round">close</span>
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } 
            // 기존 단일 포지션 호환
            else if (positionData && hasPosition) {
                const isBuy = positionData.type === 'BUY';
                const profitClass = positionData.profit >= 0 ? 'positive' : 'negative';
                const profitSign = positionData.profit >= 0 ? '+' : '';
                const positionClass = isBuy ? 'buy-position' : 'sell-position';
                const symbolInfo = getSymbolInfo(currentSymbol);
                const decimals = getDecimalsForSymbol(currentSymbol);
                
                container.innerHTML = `
                    <div class="quick-total-pl">
                        <span class="quick-total-pl-label">📊 총 1개 포지션</span>
                        <span class="quick-total-pl-value ${profitClass}">${profitSign}$${positionData.profit?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="quick-position-item ${positionClass}">
                        <div class="quick-position-symbol">
                            <div class="quick-position-symbol-name" style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px; color: ${symbolInfo.color};">${symbolInfo.icon}</span>
                                ${currentSymbol}
                            </div>
                            <div class="quick-position-symbol-info">${positionData.volume?.toFixed(2) || lotSize.toFixed(2)} lot • ${positionData.entry?.toFixed(decimals) || '-'}</div>
                        </div>
                        <span class="quick-position-type ${isBuy ? 'buy' : 'sell'}">${positionData.type}</span>
                        <div class="quick-position-profit ${profitClass}">${profitSign}$${positionData.profit?.toFixed(2) || '0.00'}</div>
                        <button class="quick-position-close" onclick="quickCloseSymbol()">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                `;
            } 
            else {
                container.innerHTML = `
                    <div class="quick-position-empty">
                        <span class="material-icons-round">inbox</span>
                        <div>열린 포지션이 없습니다</div>
                    </div>
                `;
            }
        }
        
        // Quick 패널 실시간 업데이트 (fetchDemoData에서 호출)
        function updateQuickPanelFromData(data) {
            if (!data) return;
            
            // 계좌 정보 업데이트
            balance = data.balance || balance;
            updateQuickAccountInfo();
            
            // 다중 포지션 업데이트
            if (data.positions && Array.isArray(data.positions)) {
                quickPositions = data.positions;
            } else if (data.position) {
                quickPositions = [data.position];
            } else {
                quickPositions = [];
            }
            
            // 포지션 리스트 업데이트
            updateQuickPositionList();
            
            // 가격 업데이트
            updateQuickPrices();
        }
    </script>
</body>
</html>
