<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading-X</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app">
        <!-- Ìó§Îçî -->
        <div class="header">
            <div class="header-title" style="font-size: 23px; font-weight: 700; display: flex; align-items: center; color: #ffffff;">
                <svg width="32" height="23" viewBox="0 0 32 23" style="margin-right: 10px; vertical-align: middle;">
                    <rect x="1" y="1" width="30" height="21" rx="3" fill="none" stroke="#00d4ff" stroke-width="2"/>
                    <text x="16" y="16.5" font-size="14" font-weight="900" fill="#00d4ff" font-family="Arial" text-anchor="middle">TX</text>
                </svg>
                Trading-X
            </div>
            <div class="header-status">
                <span id="modeBadge" style="display: none; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 8px; letter-spacing: 0.5px;"></span>
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="headerStatus">Connecting...</span>
            </div>
        </div>
        
        <!-- Ïª®ÌÖêÏ∏† -->
        <div class="content">
            <!-- ========== Ìôà ÌÉ≠ ========== -->
            <div class="page active" id="page-home">
                
                <!-- Í∏¥Í∏â Í≥µÏßÄ Î∞∞ÎÑà -->
                <div class="notice-banner" id="noticeBanner" style="display: none;">
                    <div class="notice-content">
                        <span class="notice-icon">üì¢</span>
                        <span class="notice-text" id="noticeText">ÏÑúÎ≤Ñ Ï†êÍ≤Ä ÏïàÎÇ¥ (1/20 02:00~04:00)</span>
                    </div>
                    <button class="notice-close" onclick="closeNoticeBanner()">‚úï</button>
                </div>
                
                <div class="welcome-banner">
                    <!-- ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïù∏ÏÇ¨ -->
                    <div class="greeting-section">
                        <div style="text-align: center;">
                            <span class="greeting-text" id="greetingText" style="font-size: 24px; font-weight: 600; white-space: nowrap;">Good Evening, Trader! üåô</span>
                        </div>
                        <span class="greeting-sub" id="greetingSub" style="font-size: 13px; font-weight: 600;">Ïò§Îäò ÌïòÎ£® ÏàòÍ≥†ÌïòÏÖ®Ïñ¥Ïöî!</span>
                    </div>
                    
                    <!-- Î™®Îìú ÌëúÏãú -->
                    <div id="heroModeBadge" style="margin-top: 18px; font-size: 26px; font-weight: 700; color: #e0e0e0; letter-spacing: 3px;">
                        Trading-X Demo
                    </div>
                </div>
                
                <!-- ÌîÑÎ°úÎ™®ÏÖò Î∞∞ÎÑà (Ïã¨Ìîå) -->
                <div class="promo-slider-container">
                    <div class="promo-slider" id="promoSlider">
                        <!-- Ïπ¥Îìú 1: ÏπúÍµ¨ Ï¥àÎåÄ -->
                        <div class="promo-card" style="background: linear-gradient(135deg, #1e2530 0%, #151a22 100%); border-color: var(--border-color);">
                            <div class="promo-content" style="flex: 1;">
                                <div class="promo-title" style="font-size: 16px; font-weight: 700;">ÏπúÍµ¨ Ï¥àÎåÄÌïòÍ≥† $50 Î∞õÍ∏∞!</div>
                                <div class="promo-desc" style="font-size: 12px;">Ï∂îÏ≤úÏù∏ ÏΩîÎìúÎ•º Í≥µÏú†ÌïòÍ≥† Î≥¥ÎÑàÏä§Î•º Î∞õÏúºÏÑ∏Ïöî</div>
                            </div>
                            <div class="promo-action">
                                <button class="promo-btn" style="background: linear-gradient(135deg, #00b450 0%, #008040 100%); color: #fff; font-size: 13px; font-weight: 600; padding: 8px 14px;" onclick="showToast('Ï∂îÏ≤ú ÏΩîÎìú: TRADEX2024', 'success')">ÏΩîÎìú Î≥µÏÇ¨</button>
                            </div>
                        </div>
                        
                        <!-- Ïπ¥Îìú 2: Ïã†Í∑ú Í∞ÄÏûÖ Ïù¥Î≤§Ìä∏ -->
                        <div class="promo-card" style="background: linear-gradient(135deg, #1e2530 0%, #151a22 100%); border-color: var(--border-color);">
                            <div class="promo-content" style="flex: 1;">
                                <div class="promo-title" style="font-size: 16px; font-weight: 700;">Ïã†Í∑ú Í∞ÄÏûÖ Ïù¥Î≤§Ìä∏!</div>
                                <div class="promo-desc" style="font-size: 12px;">Ï≤´ ÏûÖÍ∏à Ïãú 100% Î≥¥ÎÑàÏä§ ÏßÄÍ∏â</div>
                            </div>
                            <div class="promo-action">
                                <button class="promo-btn" style="background: linear-gradient(135deg, #8a2be2 0%, #6a1bb2 100%); color: #fff; font-size: 13px; font-weight: 600; padding: 8px 14px;">ÏûêÏÑ∏Ìûà ‚Üí</button>
                            </div>
                        </div>
                        
                        <!-- Ïπ¥Îìú 3: VIP ÌîÑÎ°úÍ∑∏Îû® -->
                        <div class="promo-card" style="background: linear-gradient(135deg, #1e2530 0%, #151a22 100%); border-color: var(--border-color);">
                            <div class="promo-content" style="flex: 1;">
                                <div class="promo-title" style="font-size: 16px; font-weight: 700;">VIP ÌîÑÎ°úÍ∑∏Îû®</div>
                                <div class="promo-desc" style="font-size: 12px;">Í±∞ÎûòÎüâÏóê Îî∞Î•∏ ÌäπÎ≥Ñ ÌòúÌÉùÏùÑ ÎàÑÎ¶¨ÏÑ∏Ïöî</div>
                            </div>
                            <div class="promo-action">
                                <button class="promo-btn" style="background: linear-gradient(135deg, #ffa500 0%, #cc8400 100%); color: #fff; font-size: 13px; font-weight: 600; padding: 8px 14px;">Í∞ÄÏûÖÌïòÍ∏∞</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ïä¨ÎùºÏù¥Îìú Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
                    <div class="promo-indicators">
                        <span class="promo-dot active" onclick="scrollToPromo(0)"></span>
                        <span class="promo-dot" onclick="scrollToPromo(1)"></span>
                        <span class="promo-dot" onclick="scrollToPromo(2)"></span>
                    </div>
                </div>
                
                <!-- Trading Mode Ï†ÑÌôò -->
                <div class="card">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">sync_alt</span>
                        <span style="position: relative; top: -3px;">Trading Mode</span>
                    </div>
                    <div class="trading-mode-selector">
                        <button class="mode-select-btn active" id="modeDemoBtn" onclick="switchTradingMode('demo')">
                            <div class="mode-select-info" style="text-align: center; width: 100%;">
                                <div class="mode-select-name">DEMO</div>
                                <div class="mode-select-desc">Practice Trading</div>
                            </div>
                            <div class="mode-select-check" id="demoCheck">‚úì</div>
                        </button>
                        <button class="mode-select-btn" id="modeLiveBtn" onclick="switchTradingMode('live')">
                            <div class="mode-select-info" style="text-align: center; width: 100%;">
                                <div class="mode-select-name">LIVE</div>
                                <div class="mode-select-desc">Real Trading</div>
                            </div>
                            <div class="mode-select-check" id="liveCheck" style="display: none;">‚úì</div>
                        </button>
                    </div>
                    <div class="mode-status" id="modeStatus">
                        <span class="mode-status-dot demo"></span>
                        <span>Currently in <strong>Demo Mode</strong> - Practice with virtual $10,000</span>
                    </div>
                </div>
                
                <!-- MT5 Account Ïó∞Í≤∞ -->
                <div class="card" id="mt5AccountSection">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">link</span>
                        <span style="position: relative; top: -3px;">MT5 Account</span>
                    </div>
                    
                    <!-- Ïó∞Í≤∞ Ïïà Îê® ÏÉÅÌÉú -->
                    <div class="mt5-not-connected" id="mt5NotConnected" style="padding: 15px 10px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px;">
                            <div style="font-size: 36px; opacity: 0.7;">üîó</div>
                            <div style="text-align: left;">
                                <div class="mt5-empty-text" style="font-size: 16px; font-weight: 600; margin-bottom: 2px;">ÏïÑÏßÅ Ïó∞Í≤∞Îêú MT5 Í≥ÑÏ¢åÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                                <div class="mt5-empty-sub" style="font-size: 12px; margin: 0;">Live Í±∞ÎûòÎ•º ÏúÑÌï¥ MT5 Í≥ÑÏ¢åÎ•º Ïó∞Í≤∞ÌïòÏÑ∏Ïöî</div>
                            </div>
                        </div>
                        <div class="mt5-buttons">
                            <button class="mt5-connect-btn" onclick="openMT5ConnectModal()">
                                <span class="material-icons-round" style="font-size: 18px;">link</span>
                                MT5 Í≥ÑÏ¢å Ïó∞Í≤∞ÌïòÍ∏∞
                            </button>
                            <button class="mt5-guide-btn" onclick="openMT5GuideModal()">
                                <span class="material-icons-round" style="font-size: 18px;">help_outline</span>
                                Ïã†Í∑ú Í≥ÑÏ¢å Í∞úÏÑ§ ÏïàÎÇ¥
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ïó∞Í≤∞Îê® ÏÉÅÌÉú -->
                    <div class="mt5-connected" id="mt5Connected" style="display: none;">
                        <div class="mt5-status-badge">
                            <span class="mt5-status-dot"></span>
                            Connected
                        </div>
                        <div class="mt5-info-grid">
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Broker</span>
                                <span class="mt5-info-value" id="mt5Broker">-</span>
                            </div>
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Account</span>
                                <span class="mt5-info-value" id="mt5Account">-</span>
                            </div>
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Server</span>
                                <span class="mt5-info-value" id="mt5Server">-</span>
                            </div>
                            <div class="mt5-info-item">
                                <span class="mt5-info-label">Leverage</span>
                                <span class="mt5-info-value" id="mt5Leverage">-</span>
                            </div>
                        </div>
                        <button class="mt5-disconnect-btn" onclick="disconnectMT5()">
                            <span class="material-icons-round" style="font-size: 16px;">link_off</span>
                            Ïó∞Í≤∞ Ìï¥Ï†ú
                        </button>
                    </div>
                </div>
                
                <!-- Account Overview (ÌÜµÌï©) -->
                <div class="card">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">account_balance</span>
                        <span style="position: relative; top: -3px;">Account Overview</span>
                    </div>
                    
                    <!-- Í≥ÑÏ†ï Ï†ïÎ≥¥ Î∞ïÏä§ -->
                    <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px 15px; margin-bottom: 10px;">
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Broker</span><span class="info-value" id="homeBroker">-</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Account</span><span class="info-value" id="homeAccount">-</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Leverage</span><span class="info-value" id="homeLeverage">-</span></div>
                        <div class="info-row" style="border-bottom: none;"><span class="info-label">Server</span><span class="info-value" id="homeServer">-</span></div>
                    </div>
                    
                    <!-- ÏûêÏÇ∞ Ï†ïÎ≥¥ Î∞ïÏä§ -->
                    <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 12px 15px;">
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Balance</span><span class="info-value" id="homeBalance">$0.00</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Equity</span><span class="info-value" id="homeEquity">$0.00</span></div>
                        <div class="info-row" style="border-bottom: 1px solid var(--border-color);"><span class="info-label">Free Margin</span><span class="info-value" id="homeFreeMargin">$0.00</span></div>
                        <div class="info-row" style="border-bottom: none;"><span class="info-label">Open Positions</span><span class="info-value" id="homePositions">0</span></div>
                    </div>
                </div>
                
                <!-- Demo Ï∂©Ï†Ñ Î≤ÑÌäº (Demo Î™®ÎìúÏóêÏÑúÎßå ÌëúÏãú) -->
                <div class="card" id="demoControlCard" style="display: none;">
                    <div class="card-title" style="font-size: 16px; font-weight: 700;">
                        <span class="material-icons-round" style="color: #00d4ff; margin-right: 8px; font-size: 18px;">monetization_on</span><span style="position: relative; top: -3px;">Demo Control</span>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="topupDemo()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #00b450, #00d46a); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <span class="material-icons-round" style="font-size: 18px;">add_card</span> $10,000 Ï∂©Ï†Ñ
                        </button>
                        <button onclick="resetDemo()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #ff6b35, #ff8c42); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <span class="material-icons-round" style="font-size: 18px;">restart_alt</span> ÏûîÍ≥† Î¶¨ÏÖã
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #6b7280; margin-top: 10px; text-align: center;">üíé ÏµúÎåÄ ÏûîÍ≥†: $100,000</p>
                </div>
            </div>
            
            <!-- ========== Ï∞®Ìä∏ ÌÉ≠ ========== -->
            <div class="page" id="page-chart">
                
                <!-- Ï¢ÖÎ™© Î™©Î°ù (Watchlist) -->
                <div class="watchlist-container" id="watchlistContainer">
                    <div class="watchlist-header">
                        <button class="watchlist-search" onclick="openSymbolSearch()">
                            <span class="material-icons-round" style="font-size: 20px;">search</span>
                        </button>
                        <div class="watchlist-tabs" id="watchlistTabs">
                            <button class="watchlist-tab active" onclick="switchWatchlistTab('popular')" data-tab="popular">Popular</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('favorites')" data-tab="favorites">‚≠ê Favorites</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('forex')" data-tab="forex">Forex</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('crypto')" data-tab="crypto">Crypto</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('indices')" data-tab="indices">Indices</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('metals')" data-tab="metals">Metals</button>
                            <button class="watchlist-tab" onclick="switchWatchlistTab('energy')" data-tab="energy">Energy</button>
                        </div>
                    </div>
                    <div class="watchlist-content" id="watchlistContent">
                        <!-- Ï¢ÖÎ™©Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
                    </div>
                </div>
                
                <!-- Ï∞®Ìä∏ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ -->
                <div class="chart-detail-container" id="chartDetailContainer">
                
                <!-- Symbol Row -->
                <div class="chart-symbol-row">
                    <div class="chart-symbol-info" onclick="toggleChartSymbolDropdown()">
                        <span class="chart-symbol-icon" id="chartSymbolIcon" style="color: #f7931a;">‚Çø</span>
                        <div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span class="chart-symbol-name" id="chartSymbolName">Bitcoin</span>
                                <span style="color: var(--text-muted); font-size: 12px;">‚ñº</span>
                            </div>
                            <div class="chart-symbol-id" id="chartSymbolId">BTCUSD</div>
                        </div>
                    </div>
                    <div class="timeframe-buttons">
                        <button class="tf-btn active" data-tf="M1">1m</button>
                        <button class="tf-btn" data-tf="M5">5m</button>
                        <button class="tf-btn" data-tf="M15">15m</button>
                        <button class="tf-btn" data-tf="H1">1H</button>
                    </div>
                    
                    <!-- Symbol Dropdown -->
                    <div class="chart-symbol-dropdown" id="chartSymbolDropdown">
                        <div style="padding: 10px 15px; font-size: 11px; color: var(--accent-cyan); border-bottom: 1px solid var(--border-color);">‚≠ê Ï¶êÍ≤®Ï∞æÍ∏∞</div>
                        <div class="chart-symbol-option favorite" data-symbol="BTCUSD" data-name="Bitcoin" data-icon="‚Çø" data-color="#f7931a" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #f7931a;">‚Çø</span>
                            <div><div style="font-weight: bold;">Bitcoin</div><div style="font-size:11px;color:var(--text-muted);">BTCUSD</div></div>
                            <span class="favorite-star">‚≠ê</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="EURUSD.r" data-name="Euro/Dollar" data-icon="‚Ç¨" data-color="#0052cc" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #0052cc;">‚Ç¨</span>
                            <div><div style="font-weight: bold;">Euro/Dollar</div><div style="font-size:11px;color:var(--text-muted);">EURUSD.r</div></div>
                            <span class="favorite-star">‚≠ê</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="USDJPY.r" data-name="Dollar/Yen" data-icon="¬•" data-color="#dc143c" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #dc143c;">¬•</span>
                            <div><div style="font-weight: bold;">Dollar/Yen</div><div style="font-size:11px;color:var(--text-muted);">USDJPY.r</div></div>
                            <span class="favorite-star">‚≠ê</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="XAUUSD.r" data-name="Gold" data-icon="‚ú¶" data-color="#ffd700" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #ffd700;">‚ú¶</span>
                            <div><div style="font-weight: bold;">Gold</div><div style="font-size:11px;color:var(--text-muted);">XAUUSD.r</div></div>
                            <span class="favorite-star">‚≠ê</span>
                        </div>
                        <div class="chart-symbol-option favorite" data-symbol="US100." data-name="NASDAQ" data-icon="‚¨°" data-color="#00b450" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #00b450;">‚¨°</span>
                            <div><div style="font-weight: bold;">NASDAQ</div><div style="font-size:11px;color:var(--text-muted);">US100.</div></div>
                            <span class="favorite-star">‚≠ê</span>
                        </div>
                        <div style="padding: 10px 15px; font-size: 11px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color);">Í∏∞ÌÉÄ Ï¢ÖÎ™©</div>
                        <div class="chart-symbol-option" data-symbol="GBPUSD.r" data-name="Pound/Dollar" data-icon="¬£" data-color="#9c27b0" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #9c27b0;">¬£</span>
                            <div><div style="font-weight: bold;">Pound/Dollar</div><div style="font-size:11px;color:var(--text-muted);">GBPUSD.r</div></div>
                        </div>
                        <div class="chart-symbol-option" data-symbol="ETHUSD" data-name="Ethereum" data-icon="Œû" data-color="#627eea" onclick="selectChartSymbol(this)">
                            <span style="font-size: 20px; color: #627eea;">Œû</span>
                            <div><div style="font-weight: bold;">Ethereum</div><div style="font-size:11px;color:var(--text-muted);">ETHUSD</div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart -->
                <div id="chart-container"></div>
                
                <!-- Price Bar -->
                <div class="price-bar">
                    <div class="price-box sell">
                        <div class="price-label">SELL (Bid)</div>
                        <div class="price-value" id="chartBid">-</div>
                    </div>
                    <div class="price-box buy">
                        <div class="price-label">BUY (Ask)</div>
                        <div class="price-value" id="chartAsk">-</div>
                    </div>
                </div>
                
                <!-- Signal Section -->
                <div class="chart-signal-section">
                    <div class="chart-signal-title">Technical Analysis</div>
                    
                    <!-- Signal Gauge -->
                    <div class="chart-gauge-container">
                        <svg width="280" height="130" viewBox="0 0 280 130">
                            <path id="chartSellArc" d="" fill="none" stroke="#dc3246" stroke-width="8" stroke-linecap="round"/>
                            <path id="chartBuyArc" d="" fill="none" stroke="#00b450" stroke-width="8" stroke-linecap="round"/>
                            <text x="140" y="14" text-anchor="middle" fill="#9ca3af" font-size="13" font-weight="600">Neutral</text>
                            <text x="40" y="45" text-anchor="middle" fill="#dc3246" font-size="16" font-weight="700">Sell</text>
                            <text x="240" y="45" text-anchor="middle" fill="#00b450" font-size="16" font-weight="700">Buy</text>
                            <text x="5" y="100" text-anchor="start" fill="#6b7280" font-size="11">Strong Sell</text>
                            <text x="275" y="100" text-anchor="end" fill="#6b7280" font-size="11">Strong Buy</text>
                            <line id="chartNeedleShadow" x1="141" y1="101" x2="141" y2="46" stroke="rgba(0,0,0,0.3)" stroke-width="5" stroke-linecap="round"/>
                            <line id="chartGaugeNeedle" x1="140" y1="100" x2="140" y2="45" stroke="#00d4ff" stroke-width="4" stroke-linecap="round"/>
                            <circle cx="140" cy="100" r="12" fill="#0a3040" stroke="#00d4ff" stroke-width="2"/>
                            <circle cx="140" cy="100" r="6" fill="#00d4ff"/>
                        </svg>
                        <div class="chart-gauge-status title-font" id="chartGaugeStatus" style="color: #646473;">Neutral</div>
                    </div>
                    
                    <!-- Indicator Summary -->
                    <div class="chart-indicator-summary">
                        <div class="chart-indicator-item">
                            <div class="chart-indicator-count title-font" id="chartIndSell" style="color: #dc3246;">0</div>
                            <div class="chart-indicator-label">Sell</div>
                        </div>
                        <div class="chart-indicator-item">
                            <div class="chart-indicator-count title-font" id="chartIndNeutral" style="color: #646473;">0</div>
                            <div class="chart-indicator-label">Neutral</div>
                        </div>
                        <div class="chart-indicator-item">
                            <div class="chart-indicator-count title-font" id="chartIndBuy" style="color: #00b450;">0</div>
                            <div class="chart-indicator-label">Buy</div>
                        </div>
                    </div>
                </div>
                
                </div><!-- chartDetailContainer Îã´Í∏∞ -->
            </div>
            
            <!-- ========== Trade ÌÉ≠ ========== -->
            <div class="page" id="page-trade">
                
                <!-- Buy/Sell Ìå®ÎÑê (Í∏∞Î≥∏) -->
                <div class="buysell-panel" id="buysellPanel">
                <div class="ea-panel">
                    <!-- EA Header -->
                    <div class="ea-header">
                        <div class="ea-title title-font">FUMA Buy/Sell v3.2</div>
                    </div>
                    
                    <div class="ea-content">
                        <!-- Symbol Row -->
                        <div class="symbol-row">
                            <div class="symbol-info" onclick="toggleSymbolDropdown()">
                                <span class="symbol-icon" id="tradeSymbolIcon" style="color: #f7931a;">‚Çø</span>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span class="symbol-text" id="tradeSymbolName">Bitcoin</span>
                                        <span style="color: var(--text-muted); font-size: 12px;">‚ñº</span>
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted);" id="tradeSymbolId">BTCUSD</div>
                                </div>
                            </div>
                            <button class="settings-btn" onclick="openSettings()">
                                <svg width="20" height="16" viewBox="0 0 20 16" fill="currentColor">
                                    <rect y="0" width="20" height="2" rx="1"/>
                                    <rect y="7" width="20" height="2" rx="1"/>
                                    <rect y="14" width="20" height="2" rx="1"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Symbol Dropdown -->
                        <div class="symbol-dropdown" id="symbolDropdown">
                            <div class="symbol-option selected" data-symbol="BTCUSD" data-name="Bitcoin" data-icon="‚Çø" data-color="#f7931a" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #f7931a;">‚Çø</span>
                                <div><div class="symbol-option-name">Bitcoin</div><div style="font-size:11px;color:var(--text-muted);">BTCUSD</div></div>
                                <span class="symbol-option-check">‚úì</span>
                            </div>
                            <div class="symbol-option" data-symbol="EURUSD.r" data-name="Euro/Dollar" data-icon="‚Ç¨" data-color="#0052cc" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #0052cc;">‚Ç¨</span>
                                <div><div class="symbol-option-name">Euro/Dollar</div><div style="font-size:11px;color:var(--text-muted);">EURUSD.r</div></div>
                                <span class="symbol-option-check" style="display:none;">‚úì</span>
                            </div>
                            <div class="symbol-option" data-symbol="USDJPY.r" data-name="Dollar/Yen" data-icon="¬•" data-color="#dc143c" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #dc143c;">¬•</span>
                                <div><div class="symbol-option-name">Dollar/Yen</div><div style="font-size:11px;color:var(--text-muted);">USDJPY.r</div></div>
                                <span class="symbol-option-check" style="display:none;">‚úì</span>
                            </div>
                            <div class="symbol-option" data-symbol="XAUUSD.r" data-name="Gold" data-icon="‚ú¶" data-color="#ffd700" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #ffd700;">‚ú¶</span>
                                <div><div class="symbol-option-name">Gold</div><div style="font-size:11px;color:var(--text-muted);">XAUUSD.r</div></div>
                                <span class="symbol-option-check" style="display:none;">‚úì</span>
                            </div>
                            <div class="symbol-option" data-symbol="US100." data-name="NASDAQ" data-icon="‚¨°" data-color="#00b450" onclick="selectSymbol(this)">
                                <span class="symbol-option-icon" style="color: #00b450;">‚¨°</span>
                                <div><div class="symbol-option-name">NASDAQ</div><div style="font-size:11px;color:var(--text-muted);">US100.</div></div>
                                <span class="symbol-option-check" style="display:none;">‚úì</span>
                            </div>
                        </div>
                        
                        <!-- Stats Bar -->
                        <div class="stats-bar">
                            <div class="stat-item">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="tradeBalance">$0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Lot Size</div>
                                <div class="stat-value" id="tradeLotSize">0.01</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Today</div>
                                <div class="stat-value" id="tradeTodayPL" style="color: var(--buy-color);">+$0</div>
                            </div>
                        </div>
                        
                        <!-- Signal Gauge -->
                        <div class="gauge-container">
                            <svg width="300" height="140" viewBox="0 0 300 140">
                                <path id="sellArc" d="" fill="none" stroke="#dc3246" stroke-width="8" stroke-linecap="round"/>
                                <path id="buyArc" d="" fill="none" stroke="#00b450" stroke-width="8" stroke-linecap="round"/>
                                <text x="150" y="14" text-anchor="middle" fill="#9ca3af" font-size="15" font-weight="600">Neutral</text>
                                <text x="45" y="48" text-anchor="middle" fill="#dc3246" font-size="19" font-weight="700">Sell</text>
                                <text x="255" y="48" text-anchor="middle" fill="#00b450" font-size="19" font-weight="700">Buy</text>
                                <text x="0" y="110" text-anchor="start" fill="#6b7280" font-size="13" font-weight="700">Strong sell</text>
                                <text x="300" y="110" text-anchor="end" fill="#6b7280" font-size="13" font-weight="700">Strong buy</text>
                                <line id="needleShadow" x1="151" y1="111" x2="151" y2="51" stroke="rgba(0,0,0,0.3)" stroke-width="5" stroke-linecap="round"/>
                                <line id="gaugeNeedle" x1="150" y1="110" x2="150" y2="50" stroke="#00d4ff" stroke-width="4" stroke-linecap="round"/>
                                <circle cx="150" cy="110" r="14" fill="#0a3040" stroke="#00d4ff" stroke-width="2"/>
                                <circle cx="150" cy="110" r="8" fill="#00d4ff"/>
                                <circle cx="148" cy="108" r="3" fill="rgba(255,255,255,0.5)"/>
                            </svg>
                            <div class="gauge-status title-font" id="gaugeStatusText" style="color: var(--neutral-color);">Neutral</div>
                        </div>
                        
                        <!-- Indicator Summary -->
                        <div class="indicator-summary">
                            <div class="indicator-item">
                                <div class="indicator-count sell title-font" id="indSell">0</div>
                                <div class="indicator-label">Sell</div>
                            </div>
                            <div class="indicator-item">
                                <div class="indicator-count neutral title-font" id="indNeutral">0</div>
                                <div class="indicator-label">Neutral</div>
                            </div>
                            <div class="indicator-item">
                                <div class="indicator-count buy title-font" id="indBuy">0</div>
                                <div class="indicator-label">Buy</div>
                            </div>
                        </div>
                        
                        <!-- Target Section (Ìè¨ÏßÄÏÖò ÏóÜÏùÑ Îïå) -->
                        <div class="target-section" id="targetSection">
                            <!-- ÎßàÌã¥ Î™®Îìú UI -->
                            <div id="martinModeUI" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span class="target-label" style="margin: 0;">MARTIN MODE</span>
                                    <span id="martinStepBadge" style="display: none; font-size: 11px; font-weight: bold; padding: 2px 8px; border-radius: 4px; background-color: rgba(220,50,70,0.3); color: #dc3246;"></span>
                                </div>
                                
                                <div class="target-display">
                                    <button class="target-btn" style="opacity: 0.4; cursor: not-allowed;" disabled>‚àí</button>
                                    <div class="target-value title-font" id="martinTargetDisplay">$50</div>
                                    <button class="target-btn" style="opacity: 0.4; cursor: not-allowed;" disabled>+</button>
                                </div>
                                <div class="lot-display" id="martinLotDisplay">0.01 lot</div>
                                
                                <!-- 8Îã®Í≥Ñ ÌëúÏãú Ï†ê -->
                                <div id="martinDotsContainer" style="display: flex; justify-content: center; align-items: center; gap: 6px; padding: 10px 0;"></div>
                                
                                <div id="martinStepInfo" style="text-align: center; font-size: 12px; color: var(--text-muted);">
                                    Step <span id="martinCurrentStep" style="color: var(--accent-cyan);">1</span> / <span id="martinMaxStepsDisplay">7</span> | Target: $<span id="martinTargetInfo">50</span>
                                </div>
                            </div>
                            
                            <!-- Í∏∞Î≥∏/Î¨¥Ï†úÌïú Î™®Îìú UI -->
                            <div id="normalModeUI">
                                <div class="target-label">Profit Target</div>
                                <div class="target-display">
                                    <button class="target-btn" onclick="adjustTarget(-10)">‚àí</button>
                                    <div class="target-value title-font" id="targetValue">$100</div>
                                    <button class="target-btn" onclick="adjustTarget(10)">+</button>
                                </div>
                                <div class="lot-display" id="lotDisplay">0.50 lot (x5)</div>
                                
                                <div class="slider-container">
                                    <input type="range" id="targetSlider" min="0" max="200" value="100" oninput="updateTargetFromSlider(this.value)">
                                    <div class="slider-labels">
                                        <span>$0</span><span>$50</span><span>$100</span><span>$150</span><span>$200</span>
                                    </div>
                                </div>
                                
                                <div class="target-label" style="margin-top: 15px;">Leverage<span style="float:right;color:var(--accent-cyan);font-weight:bold;" id="leverageDisplay">x5</span></div>
                                <div class="slider-container">
                                    <input type="range" id="leverageSlider" min="1" max="20" value="5" oninput="updateLeverageFromSlider(this.value)">
                                    <div class="slider-labels">
                                        <span>x0</span><span>x5</span><span>x10</span><span>x15</span><span>x20</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Position Section (Ìè¨ÏßÄÏÖò ÏûàÏùÑ Îïå) -->
                        <div id="positionSection" style="display: none;">
                            <div class="position-card" id="positionCard">
                                <div class="position-row">
                                    <div class="position-item">
                                        <div class="position-label">Type</div>
                                        <div class="position-value title-font" id="posType" style="color: var(--buy-color);">BUY</div>
                                    </div>
                                    <div class="position-item">
                                        <div class="position-label">Entry</div>
                                        <div class="position-value" id="posEntry">0.00</div>
                                    </div>
                                    <div class="position-item">
                                        <div class="position-label">Time</div>
                                        <div class="position-value title-font" id="posTime">00:00</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- P/L Gauge -->
                            <div class="pl-gauge">
                                <div class="pl-labels">
                                    <span style="color: var(--sell-color);">&lt;&lt; LOSE</span>
                                    <span style="color: var(--buy-color);">WIN &gt;&gt;</span>
                                </div>
                                <div class="pl-bar-container">
                                    <div class="pl-bar-center"></div>
                                    <div class="pl-bar-fill" id="plBarFill"></div>
                                    <div class="pl-diamond" id="plDiamond"></div>
                                </div>
                                <div class="pl-bottom">
                                    <span style="font-size: 11px; color: var(--text-muted);" id="plMin">-$100</span>
                                    <span class="pl-percent title-font" id="plPercent" style="color: var(--neutral-color);">0%</span>
                                    <span style="font-size: 11px; color: var(--text-muted);" id="plMax">+$100</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trade Buttons -->
                        <div id="tradeButtonsNoPos">
                            <div class="trade-buttons">
                                <button class="trade-btn sell-btn title-font" onclick="placeSell()">SELL</button>
                                <button class="trade-btn buy-btn title-font" onclick="placeBuy()">BUY</button>
                            </div>
                        </div>
                        <div id="tradeButtonsHasPos" style="display: none;">
                            <button class="trade-btn close-btn title-font" onclick="closePosition()">CLOSE TRADE</button>
                        </div>
                    </div>
                    
                    <div class="ea-footer">FUMA Buy/Sell ‚Ä¢ v3.2</div>
                </div>
                </div><!-- buysellPanel Îã´Í∏∞ -->
                
                <!-- Quick & Easy Ìå®ÎÑê -->
                <div class="quick-panel" id="quickPanel">
                    <div class="quick-header">
                        <div class="quick-title-bar">
                            <div class="quick-title">‚ö° QUICK & EASY</div>
                        </div>
                        
                        <div class="quick-content">
                            <!-- Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏÉÅÎã® Î∞î -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Balance</div>
                                    <div id="quickBalance" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">$0</div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Equity</div>
                                    <div id="quickEquity" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">$0</div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Margin</div>
                                    <div id="quickMargin" style="font-size: 13px; font-weight: 700; color: var(--text-primary);">$0</div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 3px;">Today</div>
                                    <div id="quickTodayPL" style="font-size: 13px; font-weight: 700; color: var(--buy-color);">+$0</div>
                                </div>
                            </div>
                            
                            <!-- Ï¢ÖÎ™© + ÎûèÏàò ÏÑ†ÌÉù -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">currency_exchange</span>
                                    Ï¢ÖÎ™© & ÎûèÏàò ÏÑ†ÌÉù
                                </div>
                                <div style="display: flex; gap: 10px; align-items: stretch;">
                                    <!-- Ï¢ÖÎ™© ÏÑ†ÌÉù -->
                                    <div style="flex: 1; position: relative;">
                                        <div id="quickSymbolSelector" onclick="toggleQuickSymbolDropdown()" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                            <span id="quickSymbolIcon" style="font-size: 24px; color: #f7931a;">‚Çø</span>
                                            <div style="flex: 1;">
                                                <div id="quickSymbolName" style="font-size: 15px; font-weight: 700;">Bitcoin</div>
                                                <div id="quickSymbolId" style="font-size: 11px; color: var(--text-muted);">BTCUSD</div>
                                            </div>
                                            <span class="material-icons-round" style="color: var(--text-muted); font-size: 20px;">expand_more</span>
                                        </div>
                                        <!-- Ï¢ÖÎ™© ÎìúÎ°≠Îã§Ïö¥ -->
                                        <div id="quickSymbolDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 10px; margin-top: 5px; z-index: 60; max-height: 250px; overflow-y: auto;">
                                            <div class="quick-symbol-option" data-symbol="BTCUSD" onclick="selectQuickSymbol('BTCUSD')">
                                                <span style="font-size: 20px; color: #f7931a;">‚Çø</span>
                                                <div><div style="font-weight: 600;">Bitcoin</div><div style="font-size: 11px; color: var(--text-muted);">BTCUSD</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="EURUSD.r" onclick="selectQuickSymbol('EURUSD.r')">
                                                <span style="font-size: 20px; color: #0052cc;">‚Ç¨</span>
                                                <div><div style="font-weight: 600;">Euro/Dollar</div><div style="font-size: 11px; color: var(--text-muted);">EURUSD.r</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="USDJPY.r" onclick="selectQuickSymbol('USDJPY.r')">
                                                <span style="font-size: 20px; color: #dc143c;">¬•</span>
                                                <div><div style="font-weight: 600;">Dollar/Yen</div><div style="font-size: 11px; color: var(--text-muted);">USDJPY.r</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="XAUUSD.r" onclick="selectQuickSymbol('XAUUSD.r')">
                                                <span style="font-size: 20px; color: #ffd700;">‚ú¶</span>
                                                <div><div style="font-weight: 600;">Gold</div><div style="font-size: 11px; color: var(--text-muted);">XAUUSD.r</div></div>
                                            </div>
                                            <div class="quick-symbol-option" data-symbol="US100." onclick="selectQuickSymbol('US100.')">
                                                <span style="font-size: 20px; color: #00b450;">‚¨°</span>
                                                <div><div style="font-weight: 600;">NASDAQ</div><div style="font-size: 11px; color: var(--text-muted);">US100.</div></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ÎûèÏàò ÏÑ†ÌÉù -->
                                    <div style="width: 110px;">
                                        <div style="display: flex; align-items: center; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; height: 100%;">
                                            <button onclick="adjustQuickLot(-0.01)" style="width: 32px; height: 100%; background: transparent; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer;">‚àí</button>
                                            <input type="text" id="quickLotInput" value="0.01" onclick="this.select()" onchange="validateQuickLot(this)" style="flex: 1; background: transparent; border: none; color: var(--text-primary); text-align: center; font-size: 15px; font-weight: 700; width: 100%;">
                                            <button onclick="adjustQuickLot(0.01)" style="width: 32px; height: 100%; background: transparent; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer;">+</button>
                                        </div>
                                        <div style="text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 4px;">LOT</div>
                                    </div>
                                </div>
                                
                                <!-- Ïä§ÌîÑÎ†àÎìú ÌëúÏãú -->
                                <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 8px 12px; background: rgba(0, 212, 255, 0.1); border-radius: 8px;">
                                    <span style="font-size: 12px; color: var(--text-muted);">Spread</span>
                                    <span id="quickSpreadValue" style="font-size: 12px; font-weight: 600; color: var(--accent-cyan);">$15.00</span>
                                </div>
                            </div>
                            
                            <!-- Ï£ºÎ¨∏ Î≤ÑÌäº -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">swap_vert</span>
                                    Îπ†Î•∏ Ï£ºÎ¨∏
                                </div>
                                <div class="quick-order-buttons">
                                    <button class="quick-order-btn sell" onclick="quickSell()">
                                        SELL
                                        <span class="quick-order-price" id="quickBidPrice">104,250.50</span>
                                    </button>
                                    <button class="quick-order-btn buy" onclick="quickBuy()">
                                        BUY
                                        <span class="quick-order-price" id="quickAskPrice">104,265.50</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Ï≤≠ÏÇ∞ Î≤ÑÌäº -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">close</span>
                                    Ï≤≠ÏÇ∞
                                </div>
                                <div class="quick-close-grid">
                                    <button class="quick-close-btn all-close" onclick="quickCloseAll()">
                                        <span class="material-icons-round">close_fullscreen</span>
                                        ÏùºÍ¥ÑÏ≤≠ÏÇ∞
                                    </button>
                                    <button class="quick-close-btn symbol-close" onclick="quickCloseSymbol()">
                                        <span class="material-icons-round">cancel</span>
                                        ÌòÑÏ¢ÖÎ™© Ï≤≠ÏÇ∞
                                    </button>
                                    <button class="quick-close-btn buy-close" onclick="quickCloseBuy()">
                                        <span class="material-icons-round">arrow_upward</span>
                                        Îß§ÏàòÎßå Ï≤≠ÏÇ∞
                                    </button>
                                    <button class="quick-close-btn sell-close" onclick="quickCloseSell()">
                                        <span class="material-icons-round">arrow_downward</span>
                                        Îß§ÎèÑÎßå Ï≤≠ÏÇ∞
                                    </button>
                                    <button class="quick-close-btn profit-close" onclick="quickCloseProfit()">
                                        <span class="material-icons-round">trending_up</span>
                                        ÏàòÏùµÎßå Ï≤≠ÏÇ∞
                                    </button>
                                    <button class="quick-close-btn loss-close" onclick="quickCloseLoss()">
                                        <span class="material-icons-round">trending_down</span>
                                        ÏÜêÏã§Îßå Ï≤≠ÏÇ∞
                                    </button>
                                </div>
                            </div>
                            
                            <!-- SL/TP ÏÑ§Ï†ï -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">security</span>
                                    SL / TP ÏÑ§Ï†ï
                                </div>
                                <div class="quick-sltp-row">
                                    <span class="quick-sltp-label sl">Stop Loss</span>
                                    <input type="number" class="quick-sltp-input" id="quickSLInput" placeholder="0" value="">
                                    <span class="quick-sltp-unit">pips</span>
                                </div>
                                <div class="quick-sltp-row">
                                    <span class="quick-sltp-label tp">Take Profit</span>
                                    <input type="number" class="quick-sltp-input" id="quickTPInput" placeholder="0" value="">
                                    <span class="quick-sltp-unit">pips</span>
                                </div>
                                <button class="quick-sltp-apply" onclick="applyQuickSLTP()">
                                    <span class="material-icons-round" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">check_circle</span>
                                    SL/TP Ï†ÅÏö©
                                </button>
                            </div>
                            
                            <!-- Ìè¨ÏßÄÏÖò Î¶¨Ïä§Ìä∏ -->
                            <div class="quick-section">
                                <div class="quick-section-title">
                                    <span class="material-icons-round">list_alt</span>
                                    Ìè¨ÏßÄÏÖò Î¶¨Ïä§Ìä∏
                                </div>
                                <div class="quick-position-list" id="quickPositionList">
                                    <div class="quick-position-empty">
                                        <span class="material-icons-round">inbox</span>
                                        <div>Ïó¥Î¶∞ Ìè¨ÏßÄÏÖòÏù¥ ÏóÜÏäµÎãàÎã§</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="quick-footer">Quick & Easy Panel ‚Ä¢ v1.0</div>
                    </div>
                </div><!-- quickPanel Îã´Í∏∞ -->
                
            </div>
            
            <!-- ========== Account ÌÉ≠ ========== -->
            <div class="page" id="page-account">
                <div class="account-summary">
                    <div class="summary-box"><div class="value" id="accBalance">$0</div><div class="label">Balance</div></div>
                    <div class="summary-box"><div class="value" id="accEquity">$0</div><div class="label">Equity</div></div>
                    <div class="summary-box"><div class="value" id="accMargin">$0</div><div class="label">Margin</div></div>
                    <div class="summary-box"><div class="value" id="accFree">$0</div><div class="label">Free Margin</div></div>
                </div>
                <div class="card">
                    <div class="card-title">
                        <span class="material-icons-round" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">history</span>
                        Trade History
                    </div>
                    <div id="historyList"><p style="color: var(--text-muted); text-align: center; padding: 20px;">Loading...</p></div>
                </div>
            </div>
            
            <!-- ========== My ÌÉ≠ ========== -->
            <div class="page" id="page-my">
                <div class="profile-header">
                    <div class="profile-avatar"><span class="material-icons-round" style="font-size: 48px;">account_circle</span></div>
                    <div class="profile-name" id="profileName">Trader</div>
                    <div class="profile-level">Standard Member</div>
                </div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">person</span></span><span>My Account</span></div><span class="menu-arrow">‚Ä∫</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">account_balance</span></span><span>Deposit / Withdraw</span></div><span class="menu-arrow">‚Ä∫</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">tune</span></span><span>Trading Settings</span></div><span class="menu-arrow">‚Ä∫</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">security</span></span><span>Security</span></div><span class="menu-arrow">‚Ä∫</span></div>
                <div class="menu-item"><div class="menu-left"><span class="menu-icon"><span class="material-icons-round">help_outline</span></span><span>Help & Support</span></div><span class="menu-arrow">‚Ä∫</span></div>
                <div class="menu-item" onclick="logout()" style="margin-top: 20px; border-color: var(--sell-color);">
                    <div class="menu-left">
                        <span class="menu-icon"><span class="material-icons-round" style="color: var(--sell-color);">logout</span></span>
                        <span style="color: var(--sell-color);">Logout</span>
                    </div>
                    <span class="menu-arrow" style="color: var(--sell-color);">‚Ä∫</span>
                </div>
            </div>
        </div>

        <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="home"><span class="nav-icon"><span class="material-icons-round">home</span></span><span class="nav-label">Home</span></div>
            <div class="nav-item" data-page="chart"><span class="nav-icon"><span class="material-icons-round">candlestick_chart</span></span><span class="nav-label">Chart</span></div>
            <div class="nav-item" data-page="trade"><span class="nav-icon"><span class="material-icons-round">swap_vert</span></span><span class="nav-label">Trade</span></div>
            <div class="nav-item" data-page="account"><span class="nav-icon"><span class="material-icons-round">account_balance_wallet</span></span><span class="nav-label">Account</span></div>
            <div class="nav-item" data-page="my"><span class="nav-icon"><span class="material-icons-round">person</span></span><span class="nav-label">My</span></div>
        </div>
        
        <!-- ÎßàÌã¥ ÏÜêÏã§ ÌåùÏóÖ -->
        <div id="martinPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 20px; margin: 16px; max-width: 360px; width: 100%;">
                <div style="text-align: center;">
                    <div style="margin-bottom: 12px;">
                        <div style="width: 56px; height: 56px; margin: 0 auto; background: linear-gradient(135deg, #1e3a5f 0%, #0d1f33 100%); border: 2px solid rgba(0,212,255,0.4); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,212,255,0.3);">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M8 22L14 12L20 16L26 8" stroke="#00d4ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 8H26V12" stroke="#00d4ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <rect x="6" y="20" width="4" height="6" rx="1" fill="#dc3246" opacity="0.9"/>
                                <rect x="14" y="17" width="4" height="9" rx="1" fill="#ffa500" opacity="0.9"/>
                                <rect x="22" y="14" width="4" height="12" rx="1" fill="#00b450" opacity="0.9"/>
                            </svg>
                        </div>
                    </div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--accent-cyan); margin-bottom: 4px;">
                        Martin Step <span id="popupCurrentStep">1</span> Loss
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: white; margin-bottom: 16px;">
                        ÎßàÌã¥ <span id="popupCurrentStepKr">1</span>Îã®Í≥Ñ ÏÜêÏã§ Î∞úÏÉù
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Current Loss / ÌòÑÏû¨ ÏÜêÏã§</span>
                            <span id="popupCurrentLoss" style="font-size: 14px; font-weight: bold; color: #dc3246;">-$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Accumulated / ÎàÑÏ†Å ÏÜêÏã§</span>
                            <span id="popupAccumulatedLoss" style="font-size: 14px; font-weight: bold; color: #dc3246;">-$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Next Lot Size / Îã§Ïùå ÎûèÏàò</span>
                            <span id="popupNextLot" style="font-size: 14px; font-weight: bold; color: white;">0.02 lot</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--text-muted);">Recovery Target / ÌöåÎ≥µ Î™©Ìëú</span>
                            <span id="popupRecoveryTarget" style="font-size: 14px; font-weight: bold; color: #00b450;">+$0</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: white; margin-bottom: 4px;">
                        Proceed to next step (<span id="popupNextStep">2</span>)?
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">
                        Îã§Ïùå Îã®Í≥Ñ (<span id="popupNextStepKr">2</span>Îã®Í≥Ñ)Î°ú ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="martinPopupSettings()" style="flex: 1; padding: 10px; border-radius: 8px; font-weight: bold; color: white; background: var(--bg-tertiary); border: 1px solid var(--text-muted); cursor: pointer;">
                            ÏÑ§Ï†ï / Settings
                        </button>
                        <button onclick="martinPopupContinue()" style="flex: 1; padding: 10px; border-radius: 8px; font-weight: bold; color: white; background: #00b450; border: none; cursor: pointer;">
                            Í≥ÑÏÜç / Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÎßàÌã¥ ÏÑ±Í≥µ ÌåùÏóÖ -->
        <div id="martinSuccessPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); border: 2px solid #00b450; border-radius: 12px; padding: 20px; margin: 16px; max-width: 360px; width: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üéâ</div>
                    <div style="font-size: 18px; font-weight: bold; color: #00b450; margin-bottom: 4px;">
                        Martin Success!
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: white; margin-bottom: 16px;">
                        ÎßàÌã¥ Î™®Îìú ÏÑ±Í≥µ!
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Total Profit / Ï¥ù ÏàòÏùµ</span>
                            <span id="successPopupProfit" style="font-size: 14px; font-weight: bold; color: #00b450;">+$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--text-muted);">Recovered Loss / ÌöåÎ≥µ ÏÜêÏã§</span>
                            <span id="successPopupRecovered" style="font-size: 14px; font-weight: bold; color: #00d4ff;">$0</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: white; margin-bottom: 4px;">
                        What would you like to do next?
                    </div>
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
                        Îã§ÏùåÏóê Î¨¥ÏóáÏùÑ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="martinSuccessToSettings()" style="flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; color: white; background: var(--bg-tertiary); border: 1px solid var(--text-muted); cursor: pointer;">
                            ‚öôÔ∏è ÏÑ§Ï†ïÏúºÎ°ú
                        </button>
                        <button onclick="martinSuccessContinue()" style="flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; color: white; background: #00b450; border: none; cursor: pointer;">
                            üîÑ 1Îã®Í≥Ñ ÏãúÏûë
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÎßàÌã¥ ÏµúÎåÄ Îã®Í≥Ñ ÎèÑÎã¨ ÌåùÏóÖ -->
        <div id="martinMaxPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;">
            <div style="background: var(--bg-secondary); border: 2px solid #dc3246; border-radius: 12px; padding: 20px; margin: 16px; max-width: 360px; width: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">‚ö†Ô∏è</div>
                    <div style="font-size: 18px; font-weight: bold; color: #dc3246; margin-bottom: 4px;">
                        Maximum Steps Reached!
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: white; margin-bottom: 16px;">
                        ÏµúÎåÄ Îã®Í≥ÑÏóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: var(--text-muted);">Total Loss / Ï¥ù ÏÜêÏã§</span>
                            <span id="maxPopupTotalLoss" style="font-size: 14px; font-weight: bold; color: #dc3246;">-$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: var(--text-muted);">Steps Used / ÏÇ¨Ïö© Îã®Í≥Ñ</span>
                            <span id="maxPopupStepsUsed" style="font-size: 14px; font-weight: bold; color: white;">7 / 7</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">
                        Martin will reset to Step 1.<br>ÎßàÌã¥Ïù¥ 1Îã®Í≥ÑÎ°ú Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.
                    </div>
                    <button onclick="closeMaxPopup()" style="width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; color: white; background: #dc3246; border: none; cursor: pointer;">
                        ÌôïÏù∏ / OK
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ï¢ÖÎ™© Í≤ÄÏÉâ Î™®Îã¨ -->
        <div class="modal-overlay" id="symbolSearchModal">
            <div style="background: var(--bg-secondary); border-radius: 16px; margin: 15px; max-width: 450px; width: 100%; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Í≤ÄÏÉâ Ìó§Îçî -->
                <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons-round" style="color: var(--text-muted);">search</span>
                        <input type="text" id="symbolSearchInput" placeholder="Ï¢ÖÎ™©Î™Ö ÎòêÎäî Ïã¨Î≥º Í≤ÄÏÉâ..." 
                            style="flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none;"
                            oninput="onSymbolSearch(this.value)" autocomplete="off">
                        <button onclick="closeSymbolSearch()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">‚úï</button>
                    </div>
                </div>
                
                <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ -->
                <div style="display: flex; gap: 8px; padding: 10px 15px; border-bottom: 1px solid var(--border-color); overflow-x: auto;">
                    <button class="search-category-btn active" data-category="all" onclick="filterSearchCategory('all')">Ï†ÑÏ≤¥</button>
                    <button class="search-category-btn" data-category="forex" onclick="filterSearchCategory('forex')">Forex</button>
                    <button class="search-category-btn" data-category="crypto" onclick="filterSearchCategory('crypto')">Crypto</button>
                    <button class="search-category-btn" data-category="indices" onclick="filterSearchCategory('indices')">Indices</button>
                    <button class="search-category-btn" data-category="metals" onclick="filterSearchCategory('metals')">Metals</button>
                </div>
                
                <!-- Í≤ÄÏÉâ Í≤∞Í≥º -->
                <div id="symbolSearchResults" style="flex: 1; overflow-y: auto; padding: 10px 0;">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search</span>
                        <p style="margin-top: 10px;">Ï¢ÖÎ™©Î™Ö ÎòêÎäî Ïã¨Î≥ºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                    </div>
                </div>
                
                <!-- Î°úÎî© ÌëúÏãú -->
                <div id="symbolSearchLoading" style="display: none; text-align: center; padding: 20px;">
                    <div style="color: var(--accent-cyan);">Í≤ÄÏÉâ Ï§ë...</div>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div class="toast" id="toast"></div>
        
        <!-- Í≤åÏä§Ìä∏ Î™®Îìú Í∞ÄÏûÖ Ïú†ÎèÑ ÌåùÏóÖ -->
        <div class="modal-overlay" id="guestPopup">
            <div style="background: linear-gradient(180deg, #1e2127 0%, #15171c 100%); border: 2px solid #00d4ff; border-radius: 16px; padding: 30px 25px; margin: 20px; max-width: 360px; width: 100%; text-align: center; box-shadow: 0 0 60px rgba(0,212,255,0.3);">
                <div style="font-size: 50px; margin-bottom: 15px;">üöÄ</div>
                <div style="font-size: 22px; font-weight: bold; color: #00d4ff; margin-bottom: 8px; letter-spacing: 1px;">Ready to Trade?</div>
                <div style="font-size: 15px; color: #9ca3af; margin-bottom: 25px; line-height: 1.6;">
                    Ïã§Ï†ú Í±∞ÎûòÎ•º ÏãúÏûëÌïòÎ†§Î©¥<br>Í≥ÑÏ†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 15px;">
                    <button onclick="goToRegister()" style="flex: 1; padding: 14px; font-size: 15px; font-weight: bold; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); border: none; border-radius: 10px; color: #000; cursor: pointer;">
                        ÌöåÏõêÍ∞ÄÏûÖ
                    </button>
                    <button onclick="goToLoginPage()" style="flex: 1; padding: 14px; font-size: 15px; font-weight: bold; background: transparent; border: 2px solid #00d4ff; border-radius: 10px; color: #00d4ff; cursor: pointer;">
                        Î°úÍ∑∏Ïù∏
                    </button>
                </div>
                <button onclick="closeGuestPopup()" style="padding: 10px 30px; font-size: 13px; background: transparent; border: none; color: #6b7280; cursor: pointer;">
                    Í≥ÑÏÜç ÎëòÎü¨Î≥¥Í∏∞
                </button>
            </div>
        </div>
        
        <!-- MT5 Ïó∞Í≤∞ Î™®Îã¨ -->
        <div class="modal-overlay" id="mt5ConnectModal">
            <div style="background: linear-gradient(180deg, #1e2127 0%, #15171c 100%); border: 2px solid var(--accent-cyan); border-radius: 16px; padding: 0; margin: 15px; max-width: 420px; width: 100%; box-shadow: 0 0 60px rgba(0,212,255,0.2); overflow: hidden;">
                <!-- Ìó§Îçî -->
                <div style="background: #000; padding: 15px 18px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 9px;">
                        <span class="material-icons-round" style="color: var(--accent-cyan); font-size: 26px;">link</span>
                        <span style="font-size: 18px; font-weight: bold;">MT5 Í≥ÑÏ¢å Ïó∞Í≤∞</span>
                    </div>
                    <button onclick="closeMT5ConnectModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">‚úï</button>
                </div>
                
                <!-- ÏÑ†ÌÉù ÌôîÎ©¥ -->
                <div id="mt5Step1" style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 15px; color: var(--text-muted);">Í≥ÑÏ¢å Î≥¥Ïú† Ïó¨Î∂ÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="showMT5Step2('existing')" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left;">
                            <span class="material-icons-round" style="font-size: 28px; color: var(--accent-cyan);">account_circle</span>
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: white;">Ïù¥ÎØ∏ HedgeHood Í≥ÑÏ¢åÍ∞Ä ÏûàÏäµÎãàÎã§</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Í∏∞Ï°¥ Í≥ÑÏ¢å Ïó∞Í≤∞ÌïòÍ∏∞</div>
                            </div>
                            <span class="material-icons-round" style="margin-left: auto; color: var(--text-muted);">chevron_right</span>
                        </button>
                        
                        <button onclick="showMT5Step2('new')" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left;">
                            <span class="material-icons-round" style="font-size: 28px; color: var(--buy-color);">person_add</span>
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: white;">Ïã†Í∑úÎ°ú Í≥ÑÏ¢åÎ•º Í∞úÏÑ§ÌïòÍ≥† Ïã∂ÏäµÎãàÎã§</div>
                                <div style="font-size: 13px; color: var(--text-muted);">HedgeHood Í∞ÄÏûÖ ÏïàÎÇ¥</div>
                            </div>
                            <span class="material-icons-round" style="margin-left: auto; color: var(--text-muted);">chevron_right</span>
                        </button>
                    </div>
                </div>
                
                <!-- Í∏∞Ï°¥ Í≥ÑÏ¢å Ïó∞Í≤∞ Ìèº -->
                <div id="mt5Step2Existing" style="display: none; padding: 18px 20px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: white; margin-bottom: 6px;">Server (ÏÑúÎ≤Ñ)</label>
                        <select id="mt5Server" style="width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 15px;">
                            <option value="HedgeHood-MT5" selected>HedgeHood-MT5</option>
                            <option value="HedgeHood-Live">HedgeHood-Live</option>
                            <option value="HedgeHood-Demo">HedgeHood-Demo</option>
                        </select>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                            <span class="material-icons-round" style="font-size: 16px;">info</span>
                            MT5 ÏÉÅÎã® ÌÉÄÏù¥ÌãÄÎ∞îÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: white; margin-bottom: 6px;">Account Number (Í≥ÑÏ¢åÎ≤àÌò∏)</label>
                        <input type="text" id="mt5AccountNumber" placeholder="Ïòà: 930000024" style="width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 15px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 14px; color: white; margin-bottom: 6px;">Password (Í±∞ÎûòÍ≥ÑÏ¢å ÏïîÌò∏)</label>
                        <input type="password" id="mt5Password" placeholder="Í±∞ÎûòÍ≥ÑÏ¢å ÏïîÌò∏ ÏûÖÎ†•" style="width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 15px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                            <span class="material-icons-round" style="font-size: 16px;">warning</span>
                            MT5 Î°úÍ∑∏Ïù∏ Ïãú ÏÇ¨Ïö©ÌïòÎäî ÏïîÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="showMT5Step1()" style="flex: 1; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer;">
                            Ïù¥Ï†Ñ
                        </button>
                        <button onclick="connectMT5Account()" style="flex: 2; padding: 16px; background: linear-gradient(135deg, var(--accent-cyan) 0%, #0099cc 100%); border: none; border-radius: 10px; color: #000; font-size: 15px; font-weight: 700; cursor: pointer;">
                            Ïó∞Í≤∞ÌïòÍ∏∞
                        </button>
                    </div>
                </div>
                
                <!-- Ïã†Í∑ú Í≥ÑÏ¢å Í∞úÏÑ§ ÏïàÎÇ¥ -->
                <div id="mt5Step2New" style="display: none; padding: 25px;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="width: 70px; height: 70px; margin: 0 auto 15px; background: linear-gradient(135deg, rgba(0, 180, 80, 0.2) 0%, rgba(0, 180, 80, 0.05) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons-round" style="font-size: 36px; color: var(--buy-color);">rocket_launch</span>
                        </div>
                        <div style="font-size: 18px; font-weight: 600; color: white; margin-bottom: 5px;">HedgeHood Í≥ÑÏ¢å Í∞úÏÑ§</div>
                        <div style="font-size: 14px; color: var(--text-muted);">Í∞ÑÎã®Ìïú Ï†àÏ∞®Î°ú Í±∞ÎûòÎ•º ÏãúÏûëÌïòÏÑ∏Ïöî</div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 18px; margin-bottom: 22px;">
                        <div style="display: flex; align-items: flex-start; gap: 14px; margin-bottom: 16px;">
                            <div style="width: 28px; height: 28px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #000; flex-shrink: 0;">1</div>
                            <div>
                                <div style="font-size: 15px; font-weight: 600; color: white;">HedgeHood ÌôàÌéòÏù¥ÏßÄ Ï†ëÏÜç</div>
                                <div style="font-size: 13px; color: var(--text-muted);">hedgehood.com</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 14px; margin-bottom: 16px;">
                            <div style="width: 28px; height: 28px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #000; flex-shrink: 0;">2</div>
                            <div>
                                <div style="font-size: 15px; font-weight: 600; color: white;">ÌöåÏõêÍ∞ÄÏûÖ Î∞è Î≥∏Ïù∏Ïù∏Ï¶ù</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Ïù¥Î©îÏùº, Ïã†Î∂ÑÏ¶ù Ïù∏Ï¶ù</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 14px;">
                            <div style="width: 28px; height: 28px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #000; flex-shrink: 0;">3</div>
                            <div>
                                <div style="font-size: 15px; font-weight: 600; color: white;">Í≥ÑÏ¢å Í∞úÏÑ§ Ïã†Ï≤≠</div>
                                <div style="font-size: 13px; color: var(--text-muted);">ÏïΩ 5~10Î∂Ñ ÏÜåÏöî</div>
                            </div>
                        </div>
                    </div>
                    
                    <a href="https://hedgehood.com" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 16px; background: linear-gradient(135deg, var(--buy-color) 0%, #008040 100%); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; text-decoration: none; margin-bottom: 15px;">
                        <span class="material-icons-round" style="font-size: 20px;">open_in_new</span>
                        HedgeHood.com Î∞îÎ°úÍ∞ÄÍ∏∞
                    </a>
                    
                    <div style="text-align: center; font-size: 13px; color: var(--text-muted); padding: 12px; background: rgba(0, 212, 255, 0.1); border-radius: 10px;">
                        <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">lightbulb</span>
                        Í≥ÑÏ¢å Í∞úÏÑ§ ÌõÑ Ïù¥ ÌôîÎ©¥ÏóêÏÑú MT5 Í≥ÑÏ¢åÎ•º Ïó∞Í≤∞ÌïòÏÑ∏Ïöî!
                    </div>
                    
                    <button onclick="showMT5Step1()" style="width: 100%; margin-top: 18px; padding: 14px; background: transparent; border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-muted); font-size: 15px; font-weight: 600; cursor: pointer;">
                        Ïù¥Ï†ÑÏúºÎ°ú
                    </button>
                </div>
            </div>
        </div>

        <!-- MT5 Ïó∞Í≤∞ ÏÑ±Í≥µ Î™®Îã¨ -->
        <div class="modal-overlay" id="mt5SuccessModal">
            <div style="background: linear-gradient(180deg, #1e2127 0%, #15171c 100%); border: 2px solid var(--buy-color); border-radius: 16px; padding: 25px; margin: 20px; max-width: 340px; width: 100%; text-align: center; box-shadow: 0 0 60px rgba(0, 180, 80, 0.3);">
                <div style="width: 70px; height: 70px; margin: 0 auto 15px; background: linear-gradient(135deg, rgba(0, 180, 80, 0.2) 0%, rgba(0, 180, 80, 0.05) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span class="material-icons-round" style="font-size: 36px; color: var(--buy-color);">check_circle</span>
                </div>
                <div style="font-size: 18px; font-weight: bold; color: var(--buy-color); margin-bottom: 5px;">Ïó∞Í≤∞ ÏôÑÎ£å!</div>
                <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">MT5 Í≥ÑÏ¢åÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§</div>
                
                <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: left;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted); font-size: 13px;">Broker</span><span style="font-weight: 600; font-size: 13px;" id="successBroker">HedgeHood</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted); font-size: 13px;">Account</span><span style="font-weight: 600; font-size: 13px;" id="successAccount">-</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted); font-size: 13px;">Server</span><span style="font-weight: 600; font-size: 13px;" id="successServer">-</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;"><span style="color: var(--text-muted); font-size: 13px;">Leverage</span><span style="font-weight: 600; font-size: 13px;" id="successLeverage">1:500</span></div>
                </div>
                
                <div style="font-size: 13px; color: var(--accent-cyan); margin-bottom: 15px;">üíé Ïù¥Ï†ú Live Í±∞ÎûòÎ•º ÏãúÏûëÌïòÏÑ∏Ïöî!</div>
                
                <button onclick="closeMT5SuccessModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--buy-color) 0%, #008040 100%); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer;">
                    ÌôïÏù∏
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="settings-panel">
                <div class="settings-header">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>‚öôÔ∏è</span>
                        <span class="settings-title">Trading Settings</span>
                    </div>
                    <button class="settings-close" onclick="closeSettings()">‚úï</button>
                </div>
                
                <div class="settings-content">
                    <!-- Strategy Mode -->
                    <div class="settings-section">
                        <div class="settings-label">STRATEGY MODE</div>
                        
                        <div class="mode-option selected" data-mode="basic" onclick="selectMode(this)">
                            <div class="mode-option-header">
                                <span class="mode-radio">‚óè</span>
                                <span class="mode-name" style="width: 80px;">Basic</span>
                                <span class="mode-desc">- Safe & Steady</span>
                            </div>
                        </div>
                        
                        <div class="mode-option" data-mode="noLimit" onclick="selectMode(this)">
                            <div class="mode-option-header">
                                <span class="mode-radio">‚óã</span>
                                <span class="mode-name" style="width: 80px;">No Limit</span>
                                <span class="mode-desc">- Up to 50%</span>
                            </div>
                        </div>
                        
                        <div class="mode-option" data-mode="martin" onclick="selectMode(this)">
                            <div class="mode-option-header">
                                <span class="mode-radio">‚óã</span>
                                <span class="mode-name" style="width: 80px;">Martin</span>
                                <span class="mode-desc">- High Risk</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trading Settings -->
                    <div class="settings-section">
                        <div class="settings-label">TRADING SETTINGS</div>
                        
                        <!-- Symbol Selector -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 12px; color: white; margin-bottom: 6px;">Select Symbol</div>
                            <div style="position: relative;">
                                <div id="settingsSymbolBtn" style="padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleSettingsSymbol()">
                                    <span id="settingsSymbolText" style="font-weight: bold;">BTCUSD</span>
                                    <span>‚ñº</span>
                                </div>
                                <div id="settingsSymbolDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--accent-cyan); border-radius: 6px; margin-top: 4px; z-index: 10;">
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('BTCUSD')">BTCUSD</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('EURUSD.r')">EURUSD.r</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('USDJPY.r')">USDJPY.r</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('XAUUSD.r')">XAUUSD.r</div>
                                    <div style="padding: 10px 12px; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''" onclick="setSettingsSymbol('US100.')">US100.</div>
                                </div>
                            </div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;" id="settingsSymbolDesc">Bitcoin | Spread: ~$11</div>
                        </div>
                        
                        <!-- Profit Target -->
                        <div class="input-row">
                            <div>
                                <span class="input-label">Profit Target</span>
                                <span class="input-hint" id="targetHint">(Range: $10 ~ $200)</span>
                            </div>
                            <div class="input-controls">
                                <button class="input-btn" onclick="adjustSettingsTarget(-10)">‚ñº</button>
                                <div class="input-value" id="settingsTargetValue">$100</div>
                                <button class="input-btn" onclick="adjustSettingsTarget(10)">‚ñ≤</button>
                            </div>
                        </div>
                        
                        <!-- Leverage / Lot Size -->
                        <div class="input-row">
                            <div>
                                <span class="input-label" id="leverageLotLabel">Leverage</span>
                                <span class="input-hint" id="leverageLotHint">(Range: x1 ~ x20)</span>
                            </div>
                            <div class="input-controls">
                                <button class="input-btn" onclick="adjustSettingsLeverage(-1)">‚ñº</button>
                                <input type="text" class="input-value" id="settingsLeverageValue" value="x5" 
                                onclick="this.select();" 
                                onchange="updateSettingsLeverageFromInput(this.value);"
                                style="cursor: text;">
                                <button class="input-btn" onclick="adjustSettingsLeverage(1)">‚ñ≤</button>
                            </div>
                        </div>
                        
                        <div class="settings-divider"></div>
                        
                        <!-- Martin Level -->
                        <div class="input-row" id="martinLevelRow" style="opacity: 0.4;">
                            <div class="martin-row">
                                <input type="checkbox" class="martin-checkbox" id="martinCheckbox" disabled onchange="toggleMartinLevel()">
                                <span class="input-label">Martin Level</span>
                                <span class="input-hint">(Step: ~ 20)</span>
                            </div>
                            <div class="input-controls">
                                <button class="input-btn" id="martinDownBtn" disabled onclick="adjustMartinLevel(-1)">‚ñº</button>
                                <div class="input-value" id="martinLevelValue">3</div>
                                <button class="input-btn" id="martinUpBtn" disabled onclick="adjustMartinLevel(1)">‚ñ≤</button>
                            </div>
                        </div>
                        
                        <div class="martin-max" id="martinMaxInfo" style="display: none;">
                            <span>Available</span>
                            <button class="martin-max-btn" onclick="setMartinMax()">Max</button>
                            <span>: Step [<span id="martinMaxStep">7</span>] | Required [<span id="martinRequired">$12,700+</span>]</span>
                        </div>
                        
                        <div class="martin-info">Martin Level: Max recovery steps for Martingale mode</div>
                    </div>
                </div>
                
                <div class="settings-footer">
                    <button class="settings-footer-btn apply" onclick="applySettings()">Apply</button>
                    <button class="settings-footer-btn reset" onclick="resetSettings()">Reset</button>
                </div>
            </div>
        </div>
        
        <!-- Ï∞®Ìä∏ ÏÑúÎ∏åÎ©îÎâ¥ (Î∞îÌÖÄÏãúÌä∏) -->
        <div class="submenu-overlay" id="chartSubmenuOverlay" onclick="closeChartSubmenu()">
            <div class="submenu-sheet" onclick="event.stopPropagation()">
                <div class="submenu-handle"></div>
                <div class="submenu-title">Chart Î©îÎâ¥ ÏÑ†ÌÉù</div>
                
                <!-- Ï¢ÖÎ™© Î™©Î°ù -->
                <div class="submenu-item" 
                     onclick="selectSubmenuItem('watchlist')"
                     onmousedown="submenuItemPressStart('watchlist', this)"
                     onmouseup="submenuItemPressEnd()"
                     onmouseleave="submenuItemPressEnd()"
                     ontouchstart="submenuItemPressStart('watchlist', this)"
                     ontouchend="submenuItemPressEnd()"
                     ontouchcancel="submenuItemPressEnd()">
                    <div class="submenu-item-icon">üìã</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">Ï¢ÖÎ™© Î™©Î°ù</div>
                        <div class="submenu-item-hint">Í∏∏Í≤å ÎàåÎü¨ Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ù</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuWatchlistBadge" style="display: none;">Í∏∞Î≥∏</div>
                    <div class="submenu-item-progress"></div>
                </div>
                
                <!-- Ï∞®Ìä∏ Î≥¥Í∏∞ -->
                <div class="submenu-item" 
                     onclick="selectSubmenuItem('chart')"
                     onmousedown="submenuItemPressStart('chart', this)"
                     onmouseup="submenuItemPressEnd()"
                     onmouseleave="submenuItemPressEnd()"
                     ontouchstart="submenuItemPressStart('chart', this)"
                     ontouchend="submenuItemPressEnd()"
                     ontouchcancel="submenuItemPressEnd()">
                    <div class="submenu-item-icon">üìà</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">Ï∞®Ìä∏ Î≥¥Í∏∞</div>
                        <div class="submenu-item-hint">Í∏∏Í≤å ÎàåÎü¨ Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ù</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuChartBadge" style="display: none;">Í∏∞Î≥∏</div>
                    <div class="submenu-item-progress"></div>
                </div>
            </div>
        </div>
        
        <!-- ÏÑúÎ∏åÎ©îÎâ¥ Îì±Î°ù ÌÜ†Ïä§Ìä∏ -->
        <div class="submenu-toast" id="submenuToast">
            <div class="submenu-toast-icon">‚úÖ</div>
            <div class="submenu-toast-title">"<span id="submenuToastViewName">Ï∞®Ìä∏ Î≥¥Í∏∞</span>" Îì±Î°ù ÏôÑÎ£å!</div>
            <div class="submenu-toast-desc">ÏïûÏúºÎ°ú Ìï¥Îãπ ÌÉ≠ÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Î©¥<br>Î∞îÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§ üöÄ</div>
        </div>
        
        <!-- Trade ÏÑúÎ∏åÎ©îÎâ¥ (Î∞îÌÖÄÏãúÌä∏) -->
        <div class="submenu-overlay" id="tradeSubmenuOverlay" onclick="closeTradeSubmenu()">
            <div class="submenu-sheet" onclick="event.stopPropagation()">
                <div class="submenu-handle"></div>
                <div class="submenu-title">Trade Î©îÎâ¥ ÏÑ†ÌÉù</div>
                
                <!-- Buy/Sell Ìå®ÎÑê -->
                <div class="submenu-item" 
                     onclick="selectTradeSubmenuItem('buysell')"
                     onmousedown="tradeSubmenuItemPressStart('buysell', this)"
                     onmouseup="tradeSubmenuItemPressEnd()"
                     onmouseleave="tradeSubmenuItemPressEnd()"
                     ontouchstart="tradeSubmenuItemPressStart('buysell', this)"
                     ontouchend="tradeSubmenuItemPressEnd()"
                     ontouchcancel="tradeSubmenuItemPressEnd()">
                    <div class="submenu-item-icon">üìä</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">Buy/Sell Ìå®ÎÑê</div>
                        <div class="submenu-item-hint">Í∏∏Í≤å ÎàåÎü¨ Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ù</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuBuysellBadge" style="display: none;">Í∏∞Î≥∏</div>
                    <div class="submenu-item-progress"></div>
                </div>
                
                <!-- Quick & Easy Ìå®ÎÑê -->
                <div class="submenu-item" 
                     onclick="selectTradeSubmenuItem('quick')"
                     onmousedown="tradeSubmenuItemPressStart('quick', this)"
                     onmouseup="tradeSubmenuItemPressEnd()"
                     onmouseleave="tradeSubmenuItemPressEnd()"
                     ontouchstart="tradeSubmenuItemPressStart('quick', this)"
                     ontouchend="tradeSubmenuItemPressEnd()"
                     ontouchcancel="tradeSubmenuItemPressEnd()">
                    <div class="submenu-item-icon">‚ö°</div>
                    <div class="submenu-item-content">
                        <div class="submenu-item-title">Quick & Easy Ìå®ÎÑê</div>
                        <div class="submenu-item-hint">Í∏∏Í≤å ÎàåÎü¨ Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ù</div>
                    </div>
                    <div class="submenu-item-badge" id="submenuQuickBadge" style="display: none;">Í∏∞Î≥∏</div>
                    <div class="submenu-item-progress"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Configuration ==========
        const API_URL = 'http://localhost:8000/api';
        
        // ========== Auth Check ==========
        const token = localStorage.getItem('access_token');
        const isGuest = sessionStorage.getItem('guest_mode') === 'true';
        let isDemo = false;  // Demo Î™®Îìú Ïó¨Î∂Ä (Î°úÍ∑∏Ïù∏ ÌõÑ ÌôïÏù∏)
        
        if (!token && !isGuest) {
            window.location.href = 'login.html';
        }
        
        // ========== Ï†ÑÏó≠ Î≥ÄÏàò ==========
        let chart = null;
        let candleSeries = null;
        let bbUpperSeries = null;
        let bbMiddleSeries = null;
        let bbLowerSeries = null;
        let lwmaSeries = null;
        let currentTimeframe = 'M1';
        let currentSymbol = 'BTCUSD';
        let chartSymbol = 'BTCUSD';
        let currentMode = 'basic';
        let targetAmount = 100;
        let leverage = 5;
        let lotSize = 0.10;
        let martinLevel = 3;
        let martinEnabled = false;
        let martinStep = 1;
        let martinAccumulatedLoss = 0;
        let hasPosition = false;
        let positionData = null;
        let positionStartTime = null;
        let positionTimer = null;
        let balance = 10000;
        let todayPL = 0;
        let martinHistory = [];
        let pendingLoss = 0;
        let isClosing = false;  // Ï≤≠ÏÇ∞ Ï§ëÎ≥µ Î∞©ÏßÄ ÌîåÎûòÍ∑∏
        
        // Í≤åÏù¥ÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò Î≥ÄÏàò
        let displayScore = 50;
        let targetScore = 50;
        let baseScore = 50;
        let velocity = 0;
        
        // Ï∞®Ìä∏ Í≤åÏù¥ÏßÄ Î≥ÄÏàò
        let chartDisplayScore = 50;
        let chartTargetScore = 50;
        let chartVelocity = 0;
        
        const symbolData = {
            'BTCUSD': { name: 'Bitcoin', icon: '‚Çø', color: '#f7931a', desc: 'Bitcoin | Spread: ~$11' },
            'EURUSD.r': { name: 'Euro/Dollar', icon: '‚Ç¨', color: '#0052cc', desc: 'Euro/Dollar | Spread: ~$2' },
            'USDJPY.r': { name: 'Dollar/Yen', icon: '¬•', color: '#dc143c', desc: 'Dollar/Yen | Spread: ~$3' },
            'XAUUSD.r': { name: 'Gold', icon: '‚ú¶', color: '#ffd700', desc: 'Gold | Spread: ~$8' },
            'US100.': { name: 'NASDAQ', icon: '‚¨°', color: '#00b450', desc: 'NASDAQ | Spread: ~$5' }
        };
        
        // ========== API Helper ==========
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }
        
        // ========== ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const page = item.dataset.page;
                
                // Ï∞®Ìä∏ ÌÉ≠ÏùÄ ÏÑúÎ∏åÎ©îÎâ¥Î°ú Ï≤òÎ¶¨ (Î≥ÑÎèÑ Ïù¥Î≤§Ìä∏ÏóêÏÑú Ìï∏Îì§ÎßÅ)
                if (page === 'chart') {
                    return; // setupNavLongPress()ÏóêÏÑú Ï≤òÎ¶¨
                }
                
                // Trade ÌÉ≠ÎèÑ ÏÑúÎ∏åÎ©îÎâ¥Î°ú Ï≤òÎ¶¨ (Î≥ÑÎèÑ Ïù¥Î≤§Ìä∏ÏóêÏÑú Ìï∏Îì§ÎßÅ)
                if (page === 'trade') {
                    return; // setupNavLongPress()ÏóêÏÑú Ï≤òÎ¶¨
                }
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-' + page).classList.add('active');
                
                // Í≤åÏä§Ìä∏ Î™®ÎìúÏóêÏÑú Account/My ÌÉ≠ Ï†úÌïú
                if (isGuest && (page === 'account' || page === 'my')) {
                    showGuestPopup();
                    return;
                }
                
                if (page === 'account') loadHistory();
            });
        });
        
        // ========== ÏôìÏπòÎ¶¨Ïä§Ìä∏ ==========
        let watchlistPrices = {};
        let currentWatchlistTab = 'popular';
        
        // Ï¶êÍ≤®Ï∞æÍ∏∞ localStorageÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞ (Ï¢ÖÎ™© Ï†ïÎ≥¥ Ï†ÑÏ≤¥ Ï†ÄÏû•)
        function loadFavorites() {
            const saved = localStorage.getItem('watchlist_favorites_v2');
            if (saved) {
                return JSON.parse(saved);
            }
            // Í∏∞Î≥∏ Ï¶êÍ≤®Ï∞æÍ∏∞
            return [
                { symbol: 'BTCUSD', name: 'BTCUSD', fullName: 'Bitcoin vs US Dollar', icon: '‚Çø', color: '#f7931a' },
                { symbol: 'XAUUSD.r', name: 'XAUUSD', fullName: 'Gold vs US Dollar', icon: '‚ú¶', color: '#ffd700' }
            ];
        }
        
        function saveFavorites(favorites) {
            localStorage.setItem('watchlist_favorites_v2', JSON.stringify(favorites));
        }
        
        let favoriteSymbols = loadFavorites();
        
        // Ï¶êÍ≤®Ï∞æÍ∏∞ Ïó¨Î∂Ä ÌôïÏù∏
        function isFavorite(symbol) {
            return favoriteSymbols.some(item => item.symbol === symbol);
        }
        
        const watchlistSymbols = {
            popular: [
                { symbol: 'BTCUSD', name: 'BTCUSD', fullName: 'Bitcoin vs US Dollar', icon: '‚Çø', color: '#f7931a' },
                { symbol: 'EURUSD.r', name: 'EURUSD', fullName: 'Euro vs US Dollar', icon: '‚Ç¨', color: '#0052cc' },
                { symbol: 'USDJPY.r', name: 'USDJPY', fullName: 'Dollar vs Japanese Yen', icon: '¬•', color: '#dc143c' },
                { symbol: 'XAUUSD.r', name: 'XAUUSD', fullName: 'Gold vs US Dollar', icon: '‚ú¶', color: '#ffd700' },
                { symbol: 'US100.', name: 'US100', fullName: 'Nasdaq 100 Index', icon: '‚¨°', color: '#00b450' }
            ],
            forex: [
                { symbol: 'EURUSD.r', name: 'EURUSD', fullName: 'Euro vs US Dollar', icon: '‚Ç¨', color: '#0052cc' },
                { symbol: 'USDJPY.r', name: 'USDJPY', fullName: 'Dollar vs Japanese Yen', icon: '¬•', color: '#dc143c' },
                { symbol: 'GBPUSD.r', name: 'GBPUSD', fullName: 'Pound vs US Dollar', icon: '¬£', color: '#9c27b0' },
                { symbol: 'AUDUSD.r', name: 'AUDUSD', fullName: 'Australian vs US Dollar', icon: 'A$', color: '#00875a' },
                { symbol: 'USDCAD.r', name: 'USDCAD', fullName: 'US Dollar vs Canadian', icon: 'C$', color: '#ff5722' }
            ],
            crypto: [
                { symbol: 'BTCUSD', name: 'BTCUSD', fullName: 'Bitcoin vs US Dollar', icon: '‚Çø', color: '#f7931a' },
                { symbol: 'ETHUSD', name: 'ETHUSD', fullName: 'Ethereum vs US Dollar', icon: 'Œû', color: '#627eea' }
            ],
            indices: [
                { symbol: 'US100.', name: 'US100', fullName: 'Nasdaq 100 Index', icon: '‚¨°', color: '#00b450' },
                { symbol: 'US500.', name: 'US500', fullName: 'S&P 500 Index', icon: '‚óÜ', color: '#1976d2' },
                { symbol: 'US30.', name: 'US30', fullName: 'Dow Jones Index', icon: '‚óà', color: '#ff9800' }
            ],
            metals: [
                { symbol: 'XAUUSD.r', name: 'XAUUSD', fullName: 'Gold vs US Dollar', icon: '‚ú¶', color: '#ffd700' },
                { symbol: 'XAGUSD.r', name: 'XAGUSD', fullName: 'Silver vs US Dollar', icon: '‚ú¶', color: '#c0c0c0' }
            ],
            energy: [
                { symbol: 'XBRUSD', name: 'BRENT', fullName: 'Brent Crude Oil', icon: 'üõ¢', color: '#795548' },
                { symbol: 'XTIUSD', name: 'WTI', fullName: 'WTI Crude Oil', icon: 'üõ¢', color: '#5d4037' }
            ]
        };
        
        // Ï¶êÍ≤®Ï∞æÍ∏∞ Î™©Î°ù - Ï†ÄÏû•Îêú Ï†ÑÏ≤¥ Ï†ïÎ≥¥ Î∞òÌôò
        function getFavoritesWatchlist() {
            return favoriteSymbols;
        }
        
        // Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä (ÏôìÏπòÎ¶¨Ïä§Ìä∏ÏóêÏÑú)
        function toggleFavorite(symbol, event) {
            event.stopPropagation();
            
            const index = favoriteSymbols.findIndex(item => item.symbol === symbol);
            if (index > -1) {
                // Ï†úÍ±∞
                favoriteSymbols.splice(index, 1);
                showToast(`${symbol} Ï¶êÍ≤®Ï∞æÍ∏∞ÏóêÏÑú Ï†úÍ±∞Îê®`, '');
            } else {
                // Ï∂îÍ∞Ä - watchlistSymbolsÏóêÏÑú Ï†ïÎ≥¥ Ï∞æÍ∏∞
                const allSymbols = [
                    ...watchlistSymbols.popular,
                    ...watchlistSymbols.forex,
                    ...watchlistSymbols.crypto,
                    ...watchlistSymbols.indices,
                    ...watchlistSymbols.metals,
                    ...watchlistSymbols.energy
                ];
                const found = allSymbols.find(item => item.symbol === symbol);
                if (found) {
                    favoriteSymbols.push(found);
                    showToast(`‚≠ê ${symbol} Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä!`, 'success');
                }
            }
            
            saveFavorites(favoriteSymbols);
            renderWatchlist();
        }
        
        // Í≤ÄÏÉâÏóêÏÑú Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä (Ï¢ÖÎ™© Ï†ïÎ≥¥ Ï†ÑÏ≤¥ Ï†ÄÏû•)
        function addToFavorites(symbol, name, icon, color, event) {
            event.stopPropagation();
            
            if (!isFavorite(symbol)) {
                // Ï¢ÖÎ™© Ï†ïÎ≥¥ Ï†ÑÏ≤¥ Ï†ÄÏû•
                favoriteSymbols.push({
                    symbol: symbol,
                    name: symbol.replace('.r', '').replace('.', ''),
                    fullName: name,
                    icon: icon,
                    color: color
                });
                saveFavorites(favoriteSymbols);
                showToast(`‚≠ê ${symbol} Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä!`, 'success');
                
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                const btn = event.target.closest('.search-add-btn');
                if (btn) {
                    btn.classList.add('added');
                    btn.textContent = '‚úì';
                }
            } else {
                showToast(`${symbol}ÏùÄ(Îäî) Ïù¥ÎØ∏ Ï¶êÍ≤®Ï∞æÍ∏∞Ïóê ÏûàÏäµÎãàÎã§`, '');
            }
        }
        
        // ÏûÑÏãú ÏãúÏÑ∏ Îç∞Ïù¥ÌÑ∞ (API Ïó∞Îèô Ï†Ñ)
        const demoQuotes = {
            'BTCUSD': { bid: 104250.50, ask: 104265.50, change: 2.35 },
            'EURUSD.r': { bid: 1.08542, ask: 1.08562, change: -0.12 },
            'USDJPY.r': { bid: 157.852, ask: 157.872, change: 0.45 },
            'XAUUSD.r': { bid: 2658.50, ask: 2659.00, change: 1.28 },
            'US100.': { bid: 21542.50, ask: 21545.50, change: 0.85 }
        };
        
        function showWatchlist() {
            document.getElementById('watchlistContainer').style.display = 'flex';
            document.getElementById('chartDetailContainer').style.display = 'none';
        }
        
        function showChartDetail() {
            document.getElementById('watchlistContainer').style.display = 'none';
            document.getElementById('chartDetailContainer').style.display = 'block';
        }
        
        function switchWatchlistTab(tab) {
            currentWatchlistTab = tab;
            
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî ÌõÑ ÏÑ†ÌÉùÎêú ÌÉ≠Îßå ÌôúÏÑ±Ìôî
            document.querySelectorAll('.watchlist-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            
            renderWatchlist();
        }
        
        function renderWatchlist() {
            const container = document.getElementById('watchlistContent');
            if (!container) return;
            
            // favorites ÌÉ≠ÏùÄ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
            const symbols = currentWatchlistTab === 'favorites' 
                ? getFavoritesWatchlist() 
                : (watchlistSymbols[currentWatchlistTab] || []);
            
            if (symbols.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">star_border</span>
                        <p style="margin-top: 10px;">${currentWatchlistTab === 'favorites' ? 'Ï¶êÍ≤®Ï∞æÍ∏∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§' : 'Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§'}</p>
                        <p style="font-size: 12px; margin-top: 5px;">üîç Í≤ÄÏÉâÏóêÏÑú Ï¢ÖÎ™©ÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            symbols.forEach(item => {
                const prices = watchlistPrices[item.symbol] || demoQuotes[item.symbol] || { bid: 0, ask: 0, change: 0 };
                const decimals = getDecimalsForSymbol(item.symbol);
                const changeClass = prices.change >= 0 ? 'up' : 'down';
                const changeSign = prices.change >= 0 ? '+' : '';
                const isFav = isFavorite(item.symbol);
                const starClass = isFav ? 'active' : '';
                const starIcon = isFav ? '‚≠ê' : '‚òÜ';
                
                html += `
                    <div class="watchlist-item" onclick="openChartFromWatchlist('${item.symbol}', '${item.name}', '${item.icon}', '${item.color}')">
                        <div class="watchlist-icon" style="color: ${item.color};">${item.icon}</div>
                        <div class="watchlist-info">
                            <div class="watchlist-symbol">${item.name}</div>
                            <div class="watchlist-name">${item.fullName}</div>
                        </div>
                        <button class="watchlist-favorite ${starClass}" onclick="toggleFavorite('${item.symbol}', event)">${starIcon}</button>
                        <div class="watchlist-price-row">
                            <div class="watchlist-bid-box">
                                <span class="watchlist-box-label">Îß§ÎèÑ</span>
                                <span class="watchlist-box-price">${prices.bid.toFixed(decimals)}</span>
                            </div>
                            <span class="watchlist-change-center ${changeClass}">${changeSign}${prices.change.toFixed(2)}%</span>
                            <div class="watchlist-ask-box">
                                <span class="watchlist-box-label">Îß§Ïàò</span>
                                <span class="watchlist-box-price">${prices.ask.toFixed(decimals)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function openChartFromWatchlist(symbol, name, icon, color) {
            chartSymbol = symbol;
            
            document.getElementById('chartSymbolIcon').textContent = icon;
            document.getElementById('chartSymbolIcon').style.color = color;
            document.getElementById('chartSymbolName').textContent = name;
            document.getElementById('chartSymbolId').textContent = symbol;
            
            showChartDetail();
            
            // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÏÉÅÌÉú Ï∂îÍ∞Ä (Î∏åÎùºÏö∞Ï†Ä Îí§Î°úÍ∞ÄÍ∏∞ ÏßÄÏõê)
            history.pushState({ view: 'chart-detail', symbol: symbol }, '', `#chart/${symbol}`);
            
            if (chart) {
                chart.remove();
                chart = null;
            }
            initChart();
            loadCandles();
        }
        
        function backToWatchlist() {
            showWatchlist();
            renderWatchlist();
        }
        
        // Î∏åÎùºÏö∞Ï†Ä Îí§Î°úÍ∞ÄÍ∏∞ ÏßÄÏõê
        window.addEventListener('popstate', function(event) {
            const chartDetail = document.getElementById('chartDetailContainer');
            if (chartDetail && chartDetail.style.display !== 'none') {
                backToWatchlist();
            }
        });
        
        // ========== Ï¢ÖÎ™© Í≤ÄÏÉâ ==========
        let searchResults = [];
        let searchCategory = 'all';
        let searchTimeout = null;
        
        function openSymbolSearch() {
            document.getElementById('symbolSearchModal').classList.add('show');
            document.getElementById('symbolSearchInput').value = '';
            document.getElementById('symbolSearchInput').focus();
            
            // Ï¥àÍ∏∞ ÏÉÅÌÉú ÌëúÏãú
            document.getElementById('symbolSearchResults').innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search</span>
                    <p style="margin-top: 10px;">Ï¢ÖÎ™©Î™Ö ÎòêÎäî Ïã¨Î≥ºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                </div>
            `;
        }
        
        function closeSymbolSearch() {
            document.getElementById('symbolSearchModal').classList.remove('show');
        }
        
        function onSymbolSearch(query) {
            // ÎîîÎ∞îÏö¥Ïä§ Ï≤òÎ¶¨ (300ms)
            clearTimeout(searchTimeout);
            
            if (query.length < 1) {
                document.getElementById('symbolSearchResults').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search</span>
                        <p style="margin-top: 10px;">Ï¢ÖÎ™©Î™Ö ÎòêÎäî Ïã¨Î≥ºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                    </div>
                `;
                return;
            }
            
            searchTimeout = setTimeout(() => {
                performSymbolSearch(query);
            }, 300);
        }
        
        async function performSymbolSearch(query) {
            document.getElementById('symbolSearchLoading').style.display = 'block';
            document.getElementById('symbolSearchResults').innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/mt5/symbols/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                document.getElementById('symbolSearchLoading').style.display = 'none';
                
                if (data.success && data.symbols.length > 0) {
                    searchResults = data.symbols;
                    renderSearchResults();
                } else {
                    document.getElementById('symbolSearchResults').innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                            <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">search_off</span>
                            <p style="margin-top: 10px;">"${query}"Ïóê ÎåÄÌïú Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('symbolSearchLoading').style.display = 'none';
                document.getElementById('symbolSearchResults').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--sell-color);">
                        <span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">error</span>
                        <p style="margin-top: 10px;">Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>
                    </div>
                `;
            }
        }
        
        function filterSearchCategory(category) {
            searchCategory = category;
            
            // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.search-category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            
            renderSearchResults();
        }
        
        function renderSearchResults() {
            const container = document.getElementById('symbolSearchResults');
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ
            let filtered = searchResults;
            if (searchCategory !== 'all') {
                filtered = searchResults.filter(item => item.category === searchCategory);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <p>Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filtered.forEach(item => {
                const isFav = isFavorite(item.symbol);
                const btnClass = isFav ? 'added' : '';
                const btnText = isFav ? '‚úì' : '+';
                
                html += `
                    <div class="search-result-item" onclick="selectSearchSymbol('${item.symbol}', '${item.name}', '${item.icon}', '${item.color}')">
                        <div class="search-result-icon" style="color: ${item.color};">${item.icon}</div>
                        <div class="search-result-info">
                            <div class="search-result-symbol">${item.symbol}</div>
                            <div class="search-result-name">${item.name}</div>
                        </div>
                        <span class="search-result-category">${item.category}</span>
                        <button class="search-add-btn ${btnClass}" onclick="addToFavorites('${item.symbol}', '${item.name}', '${item.icon}', '${item.color}', event)">${btnText}</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function selectSearchSymbol(symbol, name, icon, color) {
            // Í≤ÄÏÉâ Î™®Îã¨ Îã´Í∏∞
            closeSymbolSearch();
            
            // Ïã¨Î≥º Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            chartSymbol = symbol;
            document.getElementById('chartSymbolIcon').textContent = icon;
            document.getElementById('chartSymbolIcon').style.color = color;
            document.getElementById('chartSymbolName').textContent = name.split(' ')[0] || symbol;
            document.getElementById('chartSymbolId').textContent = symbol;
            
            // Ï∞®Ìä∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
            showChartDetail();
            
            // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÏÉÅÌÉú Ï∂îÍ∞Ä
            history.pushState({ view: 'chart-detail', symbol: symbol }, '', `#chart/${symbol}`);
            
            // Ï∞®Ìä∏ Î°úÎìú
            if (chart) {
                chart.remove();
                chart = null;
            }
            initChart();
            loadCandles();
            
            showToast(`${symbol} Ï∞®Ìä∏Î•º Î°úÎìúÌï©ÎãàÎã§`, 'success');
        }
        
        // ÏôìÏπòÎ¶¨Ïä§Ìä∏ Ïã§ÏãúÍ∞Ñ ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateWatchlistPricesFromData(allPrices) {
            if (!allPrices) return;
            
            Object.keys(allPrices).forEach(symbol => {
                const price = allPrices[symbol];
                if (price) {
                    const prevPrice = watchlistPrices[symbol]?.bid || price.bid;
                    const change = prevPrice > 0 ? ((price.bid - prevPrice) / prevPrice) * 100 : 0;
                    watchlistPrices[symbol] = {
                        bid: price.bid,
                        ask: price.ask,
                        change: change
                    };
                }
            });
            
            // ÏôìÏπòÎ¶¨Ïä§Ìä∏Í∞Ä Î≥¥Ïù¥Î©¥ Îã§Ïãú Î†åÎçîÎßÅ
            const watchlistContainer = document.getElementById('watchlistContainer');
            if (watchlistContainer && watchlistContainer.style.display !== 'none') {
                renderWatchlist();
            }
        }
        
        // 10Ï¥àÎßàÎã§ ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏
        setInterval(() => {
            const watchlistContainer = document.getElementById('watchlistContainer');
            if (watchlistContainer && watchlistContainer.style.display !== 'none') {
                // ÎûúÎç§ Î≥ÄÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖò (Ïã§Ï†ú API Ïó∞Îèô Ï†Ñ)
                Object.keys(demoQuotes).forEach(symbol => {
                    const quote = demoQuotes[symbol];
                    const variation = (Math.random() - 0.5) * 0.001;
                    quote.bid = quote.bid * (1 + variation);
                    quote.ask = quote.bid + (quote.ask - quote.bid);
                    quote.change = quote.change + (Math.random() - 0.5) * 0.1;
                });
                renderWatchlist();
            }
        }, 10000);

        // ========== Ï∞®Ìä∏ ==========
        function initChart() {
            const container = document.getElementById('chart-container');
            const decimals = getDecimalsForSymbol(chartSymbol);
            
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 720,
                layout: { background: { color: '#0d1421' }, textColor: '#8899a6' },
                grid: { vertLines: { color: '#1e2d3d' }, horzLines: { color: '#1e2d3d' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { 
                    borderColor: '#2d3f50', 
                    autoScale: true,
                    visible: true,
                    scaleMargins: { top: 0.1, bottom: 0.1 },
                },
                timeScale: { borderColor: '#2d3f50', timeVisible: true },
                localization: {
                    priceFormatter: (price) => price.toFixed(getDecimalsForSymbol(chartSymbol)),
                },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#00c853', downColor: '#ff5252',
                borderUpColor: '#00c853', borderDownColor: '#ff5252',
                wickUpColor: '#00c853', wickDownColor: '#ff5252',
                priceFormat: {
                    type: 'price',
                    precision: decimals,
                    minMove: decimals === 5 ? 0.00001 : decimals === 3 ? 0.001 : 0.01,
                },
            });
            
            bbUpperSeries = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
            bbMiddleSeries = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, lineStyle: 2, priceLineVisible: false, lastValueVisible: false });
            bbLowerSeries = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, priceLineVisible: false, lastValueVisible: false });
            lwmaSeries = chart.addLineSeries({ color: '#ffff00', lineWidth: 2, priceLineVisible: false, lastValueVisible: false });
            
            window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth }));
        }
        
        async function loadCandles() {
            try {
                const data = await apiCall(`/mt5/candles/${chartSymbol}?timeframe=${currentTimeframe}&count=200`);
                
                if (candleSeries && data && data.candles && data.candles.length > 0) {
                    candleSeries.setData(data.candles);
                    
                    if (data.indicators) {
                        if (data.indicators.bb_upper) bbUpperSeries.setData(data.indicators.bb_upper);
                        if (data.indicators.bb_middle) bbMiddleSeries.setData(data.indicators.bb_middle);
                        if (data.indicators.bb_lower) bbLowerSeries.setData(data.indicators.bb_lower);
                        if (data.indicators.lwma) lwmaSeries.setData(data.indicators.lwma);
                    }
                    
                    const visibleBars = 50;
                    if (data.candles.length > visibleBars) {
                        const from = data.candles[data.candles.length - visibleBars].time;
                        const to = data.candles[data.candles.length - 1].time;
                        chart.timeScale().setVisibleRange({ from, to });
                    }
                    
                    if (data.candles.length > 0) {
                        updateChartPrice(data.candles[data.candles.length - 1].close);
                    }
                }
            } catch (e) { console.error('Ï∫îÎì§ Î°úÎìú Ïã§Ìå®:', e); }
        }
        
        function getDecimalsForSymbol(symbol) {
            if (symbol === 'BTCUSD' || symbol === 'ETHUSD') return 2;
            if (symbol === 'XAUUSD.r') return 2;
            if (symbol === 'US100.') return 2;
            if (symbol.includes('JPY')) return 3;
            if (symbol === 'EURUSD.r' || symbol === 'GBPUSD.r' || symbol === 'AUDUSD.r' || symbol === 'USDCAD.r') return 5;
            return 2;
        }
        
        function updateChartPrice(price) {
            let decimals = getDecimalsForSymbol(chartSymbol);
            let spread = chartSymbol === 'BTCUSD' ? 15 : chartSymbol === 'XAUUSD.r' ? 0.50 : 0.00020;
            
            document.getElementById('chartBid').textContent = price.toFixed(decimals);
            document.getElementById('chartAsk').textContent = (price + spread).toFixed(decimals);
        }
        
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTimeframe = btn.dataset.tf;
                loadCandles();
            });
        });
        
        // ========== Í≤åÏù¥ÏßÄ Arc ==========
        function createArcPath(centerX, centerY, radius, startAngle, endAngle) {
            const startX = centerX + Math.cos(startAngle) * radius;
            const startY = centerY - Math.sin(startAngle) * radius;
            const endX = centerX + Math.cos(endAngle) * radius;
            const endY = centerY - Math.sin(endAngle) * radius;
            const largeArc = Math.abs(endAngle - startAngle) > Math.PI ? 1 : 0;
            return `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`;
        }
        
        function initGaugeArcs() {
            const centerX = 150, centerY = 110, radius = 80;
            document.getElementById('sellArc').setAttribute('d', createArcPath(centerX, centerY, radius, Math.PI, Math.PI * 0.5));
            document.getElementById('buyArc').setAttribute('d', createArcPath(centerX, centerY, radius, Math.PI * 0.5, 0));
        }
        
        function initChartGaugeArcs() {
            const centerX = 140, centerY = 100, radius = 70;
            const sellArc = createArcPath(centerX, centerY, radius, Math.PI, Math.PI * 0.5);
            const buyArc = createArcPath(centerX, centerY, radius, Math.PI * 0.5, 0);
            
            const chartSellArc = document.getElementById('chartSellArc');
            const chartBuyArc = document.getElementById('chartBuyArc');
            if (chartSellArc) chartSellArc.setAttribute('d', sellArc);
            if (chartBuyArc) chartBuyArc.setAttribute('d', buyArc);
        }
        
        initGaugeArcs();
        initChartGaugeArcs();
        
        // ========== ÎûúÎç§ ÏõåÌÅ¨ ==========
        function calcRandomWalk() {
            const currentDiff = baseScore - targetScore;
            const pullStrength = 0.4;
            const noiseScale = 30.0;
            
            const pullToBase = currentDiff * pullStrength;
            const noise = (Math.random() - 0.5) * noiseScale;
            
            let extraNoise = 0;
            if (Math.random() < 0.15) {
                extraNoise = (Math.random() - 0.5) * 20.0;
            }
            
            targetScore = targetScore + pullToBase + noise + extraNoise;
            targetScore = Math.max(5, Math.min(95, targetScore));
        }
        
        setInterval(() => calcRandomWalk(), 2000 + Math.random() * 1000);
        
        // ========== Í≤åÏù¥ÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò ==========
        function updateGauge() {
            if (Math.abs(baseScore - targetScore) > 30) {
                targetScore = baseScore;
            }
            
            const diff = targetScore - displayScore;
            if (Math.abs(diff) < 0.3 && Math.abs(velocity) < 0.1) {
                displayScore = targetScore;
                velocity = 0;
            } else {
                const springK = 0.1;
                const dampingK = 0.25;
                const springForce = diff * springK;
                velocity = velocity * (1 - dampingK) + springForce;
                displayScore = Math.max(0, Math.min(100, displayScore + velocity));
            }
            
            const angleRad = Math.PI - (displayScore / 100) * Math.PI;
            const needleLength = 60;
            const cx = 150, cy = 110;
            const nx = cx + Math.cos(angleRad) * needleLength;
            const ny = cy - Math.sin(angleRad) * needleLength;
            
            const needle = document.getElementById('gaugeNeedle');
            const shadow = document.getElementById('needleShadow');
            if (needle) { needle.setAttribute('x2', nx); needle.setAttribute('y2', ny); }
            if (shadow) { shadow.setAttribute('x2', nx + 1); shadow.setAttribute('y2', ny + 1); }
            
            const statusEl = document.getElementById('gaugeStatusText');
            let statusText = 'Neutral';
            let statusColor = '#646473';
            
            if (displayScore < 20) { statusText = 'Strong Sell'; statusColor = '#dc3246'; }
            else if (displayScore < 40) { statusText = 'Sell'; statusColor = '#dc3246'; }
            else if (displayScore < 60) { statusText = 'Neutral'; statusColor = '#646473'; }
            else if (displayScore < 80) { statusText = 'Buy'; statusColor = '#00b450'; }
            else { statusText = 'Strong Buy'; statusColor = '#00b450'; }
            
            if (statusEl) {
                statusEl.textContent = statusText;
                statusEl.style.color = statusColor;
                statusEl.style.textShadow = '0 0 15px ' + statusColor;
            }
            
            requestAnimationFrame(updateGauge);
        }
        updateGauge();
        
        function updateChartGauge() {
            const diff = chartTargetScore - chartDisplayScore;
            if (Math.abs(diff) < 0.3 && Math.abs(chartVelocity) < 0.1) {
                chartDisplayScore = chartTargetScore;
                chartVelocity = 0;
            } else {
                const springK = 0.1;
                const dampingK = 0.25;
                const springForce = diff * springK;
                chartVelocity = chartVelocity * (1 - dampingK) + springForce;
                chartDisplayScore = Math.max(0, Math.min(100, chartDisplayScore + chartVelocity));
            }
            
            const angleRad = Math.PI - (chartDisplayScore / 100) * Math.PI;
            const needleLength = 55;
            const cx = 140, cy = 100;
            const nx = cx + Math.cos(angleRad) * needleLength;
            const ny = cy - Math.sin(angleRad) * needleLength;
            
            const needle = document.getElementById('chartGaugeNeedle');
            const shadow = document.getElementById('chartNeedleShadow');
            if (needle) { needle.setAttribute('x2', nx); needle.setAttribute('y2', ny); }
            if (shadow) { shadow.setAttribute('x2', nx + 1); shadow.setAttribute('y2', ny + 1); }
            
            const statusEl = document.getElementById('chartGaugeStatus');
            let statusText = 'Neutral';
            let statusColor = '#646473';
            
            if (chartDisplayScore < 20) { statusText = 'Strong Sell'; statusColor = '#dc3246'; }
            else if (chartDisplayScore < 40) { statusText = 'Sell'; statusColor = '#dc3246'; }
            else if (chartDisplayScore < 60) { statusText = 'Neutral'; statusColor = '#646473'; }
            else if (chartDisplayScore < 80) { statusText = 'Buy'; statusColor = '#00b450'; }
            else { statusText = 'Strong Buy'; statusColor = '#00b450'; }
            
            if (statusEl) {
                statusEl.textContent = statusText;
                statusEl.style.color = statusColor;
                statusEl.style.textShadow = '0 0 15px ' + statusColor;
            }
            
            requestAnimationFrame(updateChartGauge);
        }
        updateChartGauge();
        
        // ========== Ïä¨ÎùºÏù¥Îçî ==========
        function updateSliderBackground(slider, value, max) {
            const percent = (value / max) * 100;
            slider.style.background = `linear-gradient(to right, #00d4ff 0%, #00d4ff ${percent}%, #2d3139 ${percent}%, #2d3139 100%)`;
        }
        
        function updateTargetUI() {
            const targetSlider = document.getElementById('targetSlider');
            const leverageSlider = document.getElementById('leverageSlider');
            
            let targetMax = 200;
            let leverageMax = 20;
            
            if (currentMode === 'noLimit') {
                targetMax = Math.floor(balance * 0.5);
                leverageMax = 50;
            }
            
            // Ïä¨ÎùºÏù¥Îçî max Í∞í ÏóÖÎç∞Ïù¥Ìä∏
            targetSlider.max = targetMax;
            leverageSlider.max = leverageMax;
            
            document.getElementById('targetValue').textContent = '$' + targetAmount;
            targetSlider.value = targetAmount;
            updateSliderBackground(targetSlider, targetAmount, targetMax);
            
            document.getElementById('leverageDisplay').textContent = 'x' + leverage;
            leverageSlider.value = leverage;
            updateSliderBackground(leverageSlider, leverage, leverageMax);
            
            let calculatedLot = currentMode === 'martin' ? lotSize : leverage * 0.1;
            calculatedLot = Math.round(calculatedLot * 100) / 100;
            document.getElementById('lotDisplay').textContent = calculatedLot.toFixed(2) + ' lot (x' + leverage + ')';
            document.getElementById('tradeLotSize').textContent = calculatedLot.toFixed(2);
        }
        
        function adjustTarget(delta) {
            targetAmount = Math.max(0, Math.min(200, targetAmount + delta));
            updateTargetUI();
        }
        
        function updateTargetFromSlider(value) {
            targetAmount = parseInt(value);
            updateTargetUI();
        }
        
        function updateLeverageFromSlider(value) {
            leverage = parseInt(value);
            updateTargetUI();
        }
        
        updateTargetUI();
        
        // ========== Symbol ÏÑ†ÌÉù ==========
        function toggleSymbolDropdown() {
            const dropdown = document.getElementById('symbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function selectSymbol(el) {
            currentSymbol = el.dataset.symbol;
            document.getElementById('tradeSymbolIcon').textContent = el.dataset.icon;
            document.getElementById('tradeSymbolIcon').style.color = el.dataset.color;
            document.getElementById('tradeSymbolName').textContent = el.dataset.name;
            document.getElementById('tradeSymbolId').textContent = el.dataset.symbol;
            
            document.querySelectorAll('#symbolDropdown .symbol-option').forEach(opt => {
                opt.classList.remove('selected');
                const check = opt.querySelector('.symbol-option-check');
                if (check) check.style.display = 'none';
            });
            el.classList.add('selected');
            const check = el.querySelector('.symbol-option-check');
            if (check) check.style.display = 'block';
            document.getElementById('symbolDropdown').style.display = 'none';
        }
        
        function toggleChartSymbolDropdown() {
            const dropdown = document.getElementById('chartSymbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function selectChartSymbol(el) {
            chartSymbol = el.dataset.symbol;
            document.getElementById('chartSymbolIcon').textContent = el.dataset.icon;
            document.getElementById('chartSymbolIcon').style.color = el.dataset.color;
            document.getElementById('chartSymbolName').textContent = el.dataset.name;
            document.getElementById('chartSymbolId').textContent = el.dataset.symbol;
            document.getElementById('chartSymbolDropdown').style.display = 'none';
            
            if (chart) {
                chart.remove();
                chart = null;
                initChart();
                loadCandles();
            }
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.symbol-row')) {
                document.getElementById('symbolDropdown').style.display = 'none';
            }
            if (!e.target.closest('.chart-symbol-row')) {
                document.getElementById('chartSymbolDropdown').style.display = 'none';
            }
        });
        
        // ========== Settings Modal ==========
        let settingsSymbol = 'BTCUSD';
        let settingsTarget = 100;
        let settingsLeverage = 5;
        let settingsLotSize = 0.10;
        let settingsMode = 'basic';
        let settingsMartinLevel = 3;
        let settingsMartinEnabled = false;
        
        function openSettings() {
            settingsSymbol = currentSymbol;
            settingsTarget = targetAmount;
            settingsLeverage = leverage;
            settingsLotSize = lotSize;
            settingsMode = currentMode;
            settingsMartinLevel = martinLevel;
            settingsMartinEnabled = martinEnabled;
            
            updateSettingsUI();
            document.getElementById('settingsModal').classList.add('show');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        function updateSettingsUI() {
            document.getElementById('settingsSymbolText').textContent = settingsSymbol;
            document.getElementById('settingsSymbolDesc').textContent = symbolData[settingsSymbol]?.desc || '';
            
            document.querySelectorAll('.mode-option').forEach(opt => {
                const isSelected = opt.dataset.mode === settingsMode;
                opt.classList.toggle('selected', isSelected);
                opt.querySelector('.mode-radio').textContent = isSelected ? '‚óè' : '‚óã';
            });
            
            if (settingsMode === 'martin') {
                document.getElementById('settingsTargetValue').textContent = '$' + settingsTarget;
                document.getElementById('leverageLotLabel').textContent = 'Lot Size';
                document.getElementById('leverageLotHint').textContent = '(Range: 0.01 ~ 10.00)';
                document.getElementById('settingsLeverageValue').value = settingsLotSize.toFixed(2);
            } else if (settingsMode === 'noLimit') {
                const percent = Math.round((settingsTarget / balance) * 100);
                document.getElementById('settingsTargetValue').textContent = percent + '%';
                document.getElementById('targetHint').textContent = '(Range: 1% ~ 50%)';
                document.getElementById('leverageLotLabel').textContent = 'Leverage';
                document.getElementById('leverageLotHint').textContent = '(Range: x1 ~ x50)';
                document.getElementById('settingsLeverageValue').value = 'x' + settingsLeverage;
            } else {
                document.getElementById('settingsTargetValue').textContent = '$' + settingsTarget;
                document.getElementById('targetHint').textContent = '(Range: $10 ~ $200)';
                document.getElementById('leverageLotLabel').textContent = 'Leverage';
                document.getElementById('leverageLotHint').textContent = '(Range: x1 ~ x20)';
                document.getElementById('settingsLeverageValue').value = 'x' + settingsLeverage;
            }
            
            const martinRow = document.getElementById('martinLevelRow');
            const martinCheckbox = document.getElementById('martinCheckbox');
            const martinMaxInfo = document.getElementById('martinMaxInfo');
            
            if (settingsMode === 'martin') {
                martinRow.style.opacity = '1';
                martinCheckbox.disabled = false;
                martinCheckbox.checked = settingsMartinEnabled;
                
                if (settingsMartinEnabled) {
                    document.getElementById('martinDownBtn').disabled = false;
                    document.getElementById('martinUpBtn').disabled = false;
                    martinMaxInfo.style.display = 'flex';
                    updateMartinMaxInfo();
                } else {
                    document.getElementById('martinDownBtn').disabled = true;
                    document.getElementById('martinUpBtn').disabled = true;
                    martinMaxInfo.style.display = 'none';
                }
            } else {
                martinRow.style.opacity = '0.4';
                martinCheckbox.disabled = true;
                martinCheckbox.checked = false;
                document.getElementById('martinDownBtn').disabled = true;
                document.getElementById('martinUpBtn').disabled = true;
                martinMaxInfo.style.display = 'none';
            }
            
            document.getElementById('martinLevelValue').textContent = settingsMartinLevel;
        }
        
        function selectMode(el) {
            settingsMode = el.dataset.mode;
            
            if (settingsMode === 'basic') {
                settingsTarget = 100;
                settingsLeverage = 5;
            } else if (settingsMode === 'noLimit') {
                settingsTarget = Math.floor(balance * 0.1);
                settingsLeverage = 5;
            } else if (settingsMode === 'martin') {
                // Martin Î™®Îìú Í∏∞Î≥∏Í∞í
                settingsTarget = 50;
                settingsLotSize = 0.01;
                settingsMartinLevel = 5;
                settingsMartinEnabled = false;
            }
            
            updateSettingsUI();
        }
        
        function toggleSettingsSymbol() {
            const dropdown = document.getElementById('settingsSymbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function setSettingsSymbol(symbol) {
            settingsSymbol = symbol;
            document.getElementById('settingsSymbolText').textContent = symbol;
            document.getElementById('settingsSymbolDesc').textContent = symbolData[symbol]?.desc || '';
            document.getElementById('settingsSymbolDropdown').style.display = 'none';
        }
        
        function adjustSettingsTarget(delta) {
            if (settingsMode === 'noLimit') {
                const onePercent = balance * 0.01;
                settingsTarget = Math.max(onePercent, Math.min(balance * 0.5, settingsTarget + (delta > 0 ? onePercent : -onePercent)));
            } else {
                settingsTarget = Math.max(10, Math.min(200, settingsTarget + delta));
            }
            updateSettingsUI();
        }
        
        // ÎßàÌã¥ Î™®Îìú ÎûèÏàò ÏßÅÏ†ë ÏûÖÎ†•
        function updateSettingsLotFromInput(value) {
            const num = parseFloat(value);
            if (!isNaN(num) && num >= 0.01 && num <= 10) {
                settingsLotSize = Math.round(num * 100) / 100;
                updateSettingsUI();
            } else {
                showToast('0.01 ~ 10 Î≤îÏúÑÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                updateSettingsUI();
            }
        }
        
        // Î†àÎ≤ÑÎ¶¨ÏßÄ/ÎûèÏàò ÏßÅÏ†ë ÏûÖÎ†• (ÌÜµÌï©)
        function updateSettingsLeverageFromInput(value) {
            if (settingsMode === 'martin') {
                // ÎßàÌã¥ Î™®Îìú: ÎûèÏàò ÏûÖÎ†•
                updateSettingsLotFromInput(value);
            } else {
                // Basic/NoLimit Î™®Îìú: Î†àÎ≤ÑÎ¶¨ÏßÄ ÏûÖÎ†•
                const num = parseInt(value.replace(/[^0-9]/g, ''));
                const max = settingsMode === 'noLimit' ? 50 : 20;
                
                if (!isNaN(num) && num >= 1 && num <= max) {
                    settingsLeverage = num;
                    updateSettingsUI();
                } else {
                    showToast(`1 ~ ${max} Î≤îÏúÑÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî`, 'error');
                    updateSettingsUI();
                }
            }
        }

        // ============ Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä ============
        // Î†àÎ≤ÑÎ¶¨ÏßÄ/ÎûèÏàò Î≤ÑÌäº Ï°∞Ï†à
        function adjustSettingsLeverage(delta) {
            if (settingsMode === 'martin') {
                // ÎßàÌã¥ Î™®Îìú: ÎûèÏàò Ï°∞Ï†à (0.01 Îã®ÏúÑ)
                settingsLotSize = Math.max(0.01, Math.min(10, Math.round((settingsLotSize + delta * 0.01) * 100) / 100));
            } else {
                // Basic/NoLimit Î™®Îìú: Î†àÎ≤ÑÎ¶¨ÏßÄ Ï°∞Ï†à
                const max = settingsMode === 'noLimit' ? 50 : 20;
                settingsLeverage = Math.max(1, Math.min(max, settingsLeverage + delta));
            }
            updateSettingsUI();
        }
        // ============ Ïó¨Í∏∞ÍπåÏßÄ ============
        

        function toggleMartinLevel() {
            settingsMartinEnabled = document.getElementById('martinCheckbox').checked;
            updateSettingsUI();
        }
        
        function adjustMartinLevel(delta) {
            const maxAvailable = calculateMartinMax();
            settingsMartinLevel = Math.max(1, Math.min(Math.min(20, maxAvailable), settingsMartinLevel + delta));
            updateSettingsUI();
        }
        
        function calculateMartinMax() {
            for (let n = 20; n >= 1; n--) {
                const required = settingsLotSize * settingsTarget * (Math.pow(2, n) - 1);
                if (balance >= required) return n;
            }
            return 1;
        }
        
        function updateMartinMaxInfo() {
            const maxStep = calculateMartinMax();
            const required = settingsLotSize * settingsTarget * (Math.pow(2, maxStep) - 1);
            document.getElementById('martinMaxStep').textContent = maxStep;
            document.getElementById('martinRequired').textContent = '$' + Math.round(required).toLocaleString() + '+';
        }
        
        function setMartinMax() {
            settingsMartinLevel = calculateMartinMax();
            updateSettingsUI();
        }
        
        async function applySettings() {
            if (settingsMode === 'martin' && !settingsMartinEnabled) {
                showToast('Martin Level Ï≤¥ÌÅ¨Î∞ïÏä§Î•º ÌôúÏÑ±ÌôîÌïòÏÑ∏Ïöî!', 'error');
                return;
            }
            
            currentSymbol = settingsSymbol;
            currentMode = settingsMode;
            targetAmount = settingsTarget;
            leverage = settingsLeverage;
            lotSize = settingsLotSize;
            martinLevel = settingsMartinLevel;
            martinEnabled = settingsMartinEnabled;
            
            if (currentMode === 'martin' && martinEnabled) {
                if (isDemo) {
                    await apiCall(`/demo/martin/enable?base_lot=${lotSize}&max_steps=${martinLevel}`, 'POST');
                } else {
                    await apiCall(`/mt5/martin/enable?base_lot=${lotSize}&target=${targetAmount}&max_steps=${martinLevel}`, 'POST');
                }
            } else {
                if (isDemo) {
                    await apiCall('/demo/martin/disable', 'POST');
                } else {
                    await apiCall('/mt5/martin/disable', 'POST');
                }
            }
            
            const sData = symbolData[currentSymbol];
            document.getElementById('tradeSymbolIcon').textContent = sData.icon;
            document.getElementById('tradeSymbolIcon').style.color = sData.color;
            document.getElementById('tradeSymbolName').textContent = sData.name;
            document.getElementById('tradeSymbolId').textContent = currentSymbol;
            
            updateMainPanelForMode();
            updateTargetUI();
            closeSettings();
            showToast('Settings applied!', 'success');
        }
        
        function resetSettings() {
            if (settingsMode === 'basic') {
                // Basic Î™®Îìú Í∏∞Î≥∏Í∞í
                settingsTarget = 100;
                settingsLeverage = 5;
            } else if (settingsMode === 'noLimit') {
                // No Limit Î™®Îìú Í∏∞Î≥∏Í∞í
                settingsTarget = Math.floor(balance * 0.1);
                settingsLeverage = 5;
            } else if (settingsMode === 'martin') {
                settingsTarget = 50;
                settingsLotSize = 0.01;
                settingsMartinLevel = 5;
                settingsMartinEnabled = false;
            }
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateSettingsUI();
            showToast('Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎê®', 'success');
        }
        
        // ========== Î™®ÎìúÎ≥Ñ Ìå®ÎÑê UI ==========
        function updateMainPanelForMode() {
            const martinModeUI = document.getElementById('martinModeUI');
            const normalModeUI = document.getElementById('normalModeUI');
            const targetSlider = document.getElementById('targetSlider');
            const leverageSlider = document.getElementById('leverageSlider');
            const targetLabelsDiv = targetSlider.parentElement.querySelector('.slider-labels');
            const levLabelsDiv = leverageSlider.parentElement.querySelector('.slider-labels');
            
            if (currentMode === 'martin' && martinEnabled) {
                martinModeUI.style.display = 'block';
                normalModeUI.style.display = 'none';
                updateMartinUI();
            } else {
                martinModeUI.style.display = 'none';
                normalModeUI.style.display = 'block';
                
                if (currentMode === 'basic') {
                    targetSlider.max = 200;
                    targetSlider.min = 0;
                    leverageSlider.max = 20;
                    leverageSlider.min = 0;
                    
                    if (targetLabelsDiv) {
                        targetLabelsDiv.innerHTML = '<span>$0</span><span>$50</span><span>$100</span><span>$150</span><span>$200</span>';
                    }
                    if (levLabelsDiv) {
                        levLabelsDiv.innerHTML = '<span>x0</span><span>x5</span><span>x10</span><span>x15</span><span>x20</span>';
                    }
                } else if (currentMode === 'noLimit') {
                    const maxTarget = Math.floor(balance * 0.5);
                    targetSlider.max = maxTarget;
                    targetSlider.min = 0;
                    leverageSlider.max = 50;
                    leverageSlider.min = 0;
                    
                    if (targetLabelsDiv) {
                        targetLabelsDiv.innerHTML = '<span>0%</span><span>10%</span><span>25%</span><span>40%</span><span>50%</span>';
                    }
                    if (levLabelsDiv) {
                        levLabelsDiv.innerHTML = '<span>x0</span><span>x10</span><span>x25</span><span>x40</span><span>x50</span>';
                    }
                }
                
                targetSlider.value = targetAmount;
                leverageSlider.value = leverage;
            }
        }
        
        function updateMartinUI() {
            // ÎßàÌã¥ ÌÉÄÍ≤ü Í≥ÑÏÇ∞: Îã®Í≥ÑÎ≥Ñ 2Î∞∞ + ÎàÑÏ†ÅÏÜêÏã§ ÌöåÎ≥µ
            let displayTarget = targetAmount;  // Í∏∞Î≥∏ Î™©Ìëú
            
            if (martinStep > 1) {
                // Îã®Í≥Ñ ÏßÑÌñâ Ïãú: Í∏∞Î≥∏Î™©Ìëú √ó 2^(step-1) + ÎàÑÏ†ÅÏÜêÏã§
                displayTarget = targetAmount * Math.pow(2, martinStep - 1) + martinAccumulatedLoss;
            } else if (martinAccumulatedLoss > 0) {
                // 1Îã®Í≥ÑÏù∏Îç∞ ÎàÑÏ†ÅÏÜêÏã§Ïù¥ ÏûàÎäî Í≤ΩÏö∞ (Ï§ëÍ∞Ñ Ï≤≠ÏÇ∞ ÌõÑ)
                displayTarget = targetAmount + martinAccumulatedLoss;
            }
            
            displayTarget = Math.ceil(displayTarget);
            
            document.getElementById('martinTargetDisplay').textContent = '$' + displayTarget;
            document.getElementById('martinTargetInfo').textContent = displayTarget;
            
            const currentLot = lotSize * Math.pow(2, martinStep - 1);
            let lotText = currentLot.toFixed(2) + ' lot';
            if (martinStep > 1) {
                lotText += ' <span style="color: var(--accent-cyan);">(x' + Math.pow(2, martinStep - 1) + ')</span>';
            }
            document.getElementById('martinLotDisplay').innerHTML = lotText;
            
            document.getElementById('martinCurrentStep').textContent = martinStep;
            document.getElementById('martinMaxStepsDisplay').textContent = martinLevel;
            
            const badge = document.getElementById('martinStepBadge');
            if (martinStep > 1) {
                badge.style.display = 'inline';
                badge.textContent = 'Step ' + martinStep + ' / ÎàÑÏ†ÅÏÜêÏã§: -$' + martinAccumulatedLoss.toFixed(0);
            } else {
                badge.style.display = 'none';
            }
            
            renderMartinDots();
        }
        
        function renderMartinDots() {
            const container = document.getElementById('martinDotsContainer');
            const displaySteps = 8;
            const hasMoreSteps = martinLevel > displaySteps;
            
            let html = '';
            
            for (let i = 0; i < displaySteps; i++) {
                const stepNum = i + 1;
                const isCurrent = stepNum === martinStep;
                const isPast = stepNum < martinStep;
                const isActive = stepNum <= martinLevel;
                
                let bgColor = '#2d3139';
                let content = '';
                let opacity = isActive ? 1 : 0.25;
                let boxShadow = 'none';
                
                if (isActive) {
                    if (isPast) {
                    // ÎßàÌã¥ÏùÄ ÏÜêÏã§ ÌõÑ Îã§Ïùå Îã®Í≥ÑÎ°ú Í∞ÄÎãàÍπå, Ïù¥Ï†Ñ Îã®Í≥ÑÎäî Î™®Îëê ÏÜêÏã§!
                    bgColor = '#dc3246';
                    content = '‚úó';
                    boxShadow = '0 0 8px #dc3246';
                    } else if (isCurrent) {
                        bgColor = '#00d4ff';
                        content = stepNum;
                        boxShadow = '0 0 10px #00d4ff';
                    } else {
                        bgColor = '#646473';
                    }
                }
                
                html += `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">`;
                html += `<div style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; background-color: ${bgColor}; opacity: ${opacity}; box-shadow: ${boxShadow};">${content}</div>`;
                html += isActive ? `<span style="font-size: 8px; color: #9ca3af;">L${stepNum}</span>` : `<span style="font-size: 8px; color: transparent;">L${stepNum}</span>`;
                html += '</div>';
            }
            
            if (hasMoreSteps) {
                html += `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px; margin-left: 4px;">`;
                html += `<div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #00d4ff; font-size: 14px;">‚ñ∂</div>`;
                html += `<span style="font-size: 8px; color: #9ca3af;">+${martinLevel - displaySteps}</span>`;
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        

        // ========== ÎßàÌã¥ ÌåùÏóÖ ==========
        function showMartinPopup(currentLoss) {
            pendingLoss = Math.abs(currentLoss);
            const nextStep = martinStep + 1;
            const nextLot = lotSize * Math.pow(2, martinStep);
            const accumulated = martinAccumulatedLoss + pendingLoss;
            const recoveryTarget = Math.ceil((accumulated + 11 + targetAmount) / 10) * 10;
            
            document.getElementById('popupCurrentStep').textContent = martinStep;
            document.getElementById('popupCurrentStepKr').textContent = martinStep;
            document.getElementById('popupCurrentLoss').textContent = '-$' + pendingLoss.toFixed(2);
            document.getElementById('popupAccumulatedLoss').textContent = '-$' + accumulated.toFixed(2);
            document.getElementById('popupNextLot').textContent = nextLot.toFixed(2) + ' lot';
            document.getElementById('popupRecoveryTarget').textContent = '+$' + recoveryTarget;
            document.getElementById('popupNextStep').textContent = nextStep;
            document.getElementById('popupNextStepKr').textContent = nextStep;
            
            document.getElementById('martinPopup').style.display = 'flex';
        }
        
        function hideMartinPopup() {
            document.getElementById('martinPopup').style.display = 'none';
        }
        
        function martinPopupSettings() {
            document.getElementById('martinPopup').style.display = 'none';
            martinStep = 1;
            martinAccumulatedLoss = 0;
            martinHistory = [];
            openSettings();
        }
        
        async function martinPopupContinue() {
            martinHistory[martinStep - 1] = -1;
            
            const result = await apiCall(`/mt5/martin/update?profit=${-pendingLoss}`, 'POST');
            
            if (result && result.success && result.action === 'next_step') {
                martinStep = result.state.step;
                martinAccumulatedLoss = result.state.accumulated_loss;
                
                const newTarget = Math.ceil((martinAccumulatedLoss + 11 + 50) / 10) * 10;
                targetAmount = newTarget;
                
                updateMartinUI();
                showToast('Step ' + martinStep + 'ÏúºÎ°ú Ïù¥Îèô (Lot: ' + (lotSize * Math.pow(2, martinStep - 1)).toFixed(2) + ')', 'error');
            }
            
            hideMartinPopup();
        }
        
        function showMaxPopup(totalLoss) {
            document.getElementById('maxPopupTotalLoss').textContent = '-$' + totalLoss.toFixed(2);
            document.getElementById('maxPopupStepsUsed').textContent = martinLevel + ' / ' + martinLevel;
            document.getElementById('martinMaxPopup').style.display = 'flex';
        }
        
        function closeMaxPopup() {
            document.getElementById('martinMaxPopup').style.display = 'none';
            
            // ÎßàÌã¥ Î¶¨ÏÖã
            martinStep = 1;
            martinAccumulatedLoss = 0;
            martinHistory = [];
            updateMartinUI();
            
            showToast('ÎßàÌã¥Ïù¥ 1Îã®Í≥ÑÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', '');
        }
        
        // ========== ÎßàÌã¥ ÏÑ±Í≥µ ÌåùÏóÖ ==========
        function showMartinSuccessPopup(profit) {
            const recovered = martinAccumulatedLoss;
            
            document.getElementById('successPopupProfit').textContent = '+$' + profit.toFixed(2);
            document.getElementById('successPopupRecovered').textContent = '$' + recovered.toFixed(2);
            
            document.getElementById('martinSuccessPopup').style.display = 'flex';
        }
        
        function martinSuccessToSettings() {
            document.getElementById('martinSuccessPopup').style.display = 'none';
            openSettings();
        }
        
        function martinSuccessContinue() {
            document.getElementById('martinSuccessPopup').style.display = 'none';
            
            // 1Îã®Í≥ÑÎ°ú Î¶¨ÏÖã (Ïù¥ÎØ∏ Î∞±ÏóîÎìúÏóêÏÑú Ï≤òÎ¶¨Îê®)
            martinStep = 1;
            martinAccumulatedLoss = 0;
            martinHistory = [];
            targetAmount = 50;  // Í∏∞Î≥∏ Î™©ÌëúÎ°ú Î¶¨ÏÖã
            
            updateMartinUI();
            showToast('üöÄ 1Îã®Í≥ÑÎ°ú Îã§Ïãú ÏãúÏûëÌï©ÎãàÎã§!', 'success');
        }
        
        // ========== Today P/L ==========
        function updateTodayPL(profit) {
            todayPL += profit;
            const el = document.getElementById('tradeTodayPL');
            if (todayPL >= 0) {
                el.textContent = '+$' + Math.abs(todayPL).toFixed(0);
                el.style.color = 'var(--buy-color)';
            } else {
                el.textContent = '-$' + Math.abs(todayPL).toFixed(0);
                el.style.color = 'var(--sell-color)';
            }
        }
        
        // ========== P/L Gauge ==========
        function updatePLGauge(currentPL, target = null) {
            const actualTarget = target || targetAmount;
            const plPercent = Math.min(1, Math.max(-1, currentPL / actualTarget));
            const plPercentDisplay = Math.round(Math.abs(plPercent) * 100);
            
            const fill = document.getElementById('plBarFill');
            const diamond = document.getElementById('plDiamond');
            const percentText = document.getElementById('plPercent');
            
            const isProfit = currentPL >= 0;
            const color = isProfit ? '#00b450' : '#dc3246';
            
            if (fill) {
                fill.style.background = isProfit 
                    ? 'linear-gradient(to right, rgba(0,180,80,0.5), #00b450)'
                    : 'linear-gradient(to left, rgba(220,50,70,0.5), #dc3246)';
                fill.style.left = isProfit ? '50%' : (50 + plPercent * 50) + '%';
                fill.style.width = Math.abs(plPercent) * 50 + '%';
                fill.style.borderRadius = isProfit ? '0 6px 6px 0' : '6px 0 0 6px';
                fill.style.boxShadow = '0 0 10px ' + color + '80';
            }
            
            if (diamond) {
                diamond.style.left = (50 + plPercent * 50) + '%';
                diamond.style.background = color;
                diamond.style.boxShadow = '0 0 8px ' + color;
            }
            
            if (percentText) {
                percentText.textContent = plPercentDisplay + '%';
                percentText.style.color = color;
            }
        }
        
        // ========== Ìè¨ÏßÄÏÖò UI ==========
        function updatePositionUI(hasPos, posData) {
            hasPosition = hasPos;
            positionData = posData;
            
            if (hasPos && posData) {
                document.getElementById('targetSection').style.display = 'none';
                document.getElementById('positionSection').style.display = 'block';
                document.getElementById('tradeButtonsNoPos').style.display = 'none';
                document.getElementById('tradeButtonsHasPos').style.display = 'block';
                
                const isBuy = posData.type === 'BUY';
                const posCard = document.getElementById('positionCard');
                posCard.className = isBuy ? 'position-card buy-pos' : 'position-card sell-pos';
                
                document.getElementById('posType').textContent = posData.type;
                document.getElementById('posType').style.color = isBuy ? '#00b450' : '#dc3246';
                document.getElementById('posType').style.textShadow = '0 0 10px ' + (isBuy ? 'rgba(0,180,80,0.5)' : 'rgba(220,50,70,0.5)');
                document.getElementById('posEntry').textContent = posData.entry.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                if (!positionStartTime) {
                    positionStartTime = Date.now();
                    startPositionTimer();
                }
                
                const actualTarget = posData.target || targetAmount;
                updatePLGauge(posData.profit, actualTarget);
                
                document.getElementById('plMin').textContent = '-$' + actualTarget;
                document.getElementById('plMax').textContent = '+$' + actualTarget;
            } else {
                document.getElementById('targetSection').style.display = 'block';
                document.getElementById('positionSection').style.display = 'none';
                document.getElementById('tradeButtonsNoPos').style.display = 'block';
                document.getElementById('tradeButtonsHasPos').style.display = 'none';
                
                stopPositionTimer();
            }
        }
        
        function startPositionTimer() {
            if (positionTimer) return;
            
            positionTimer = setInterval(() => {
                if (!positionStartTime) return;
                
                const elapsed = Math.floor((Date.now() - positionStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const mins = Math.floor((elapsed % 3600) / 60);
                const secs = elapsed % 60;
                
                if (hours > 0) {
                    document.getElementById('posTime').textContent = hours + ':' + mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
                } else {
                    document.getElementById('posTime').textContent = mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
                }
            }, 1000);
        }
        
        function stopPositionTimer() {
            if (positionTimer) {
                clearInterval(positionTimer);
                positionTimer = null;
            }
            positionStartTime = null;
            document.getElementById('posTime').textContent = '00:00';
        }
        
        // ========== ÏÇ¨Ïö¥Îìú ==========
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'buy') { oscillator.frequency.value = 880; oscillator.type = 'sine'; }
                else if (type === 'sell') { oscillator.frequency.value = 660; oscillator.type = 'sine'; }
                else if (type === 'close') { oscillator.frequency.value = 440; oscillator.type = 'triangle'; }
                else { oscillator.frequency.value = 220; oscillator.type = 'sawtooth'; }
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }
        
        // ========== Í±∞Îûò Ìï®Ïàò ==========
        function calculateLot() {
            if (currentMode === 'martin') return lotSize;
            let lot = leverage * 0.1;
            return Math.round(lot * 100) / 100;  // 0.01 Îã®ÏúÑÎ°ú Î∞òÏò¨Î¶º
        }
        
        async function placeBuy() {
            if (!checkGuestAction('trade')) return;
            
            // Demo Î™®ÎìúÎ©¥ Demo API ÏÇ¨Ïö©
            if (isDemo) {
                placeDemoOrder('BUY');
                return;
            }
            
            showToast('Processing...', '');
            try {
                let result;
                if (currentMode === 'martin' && martinEnabled) {
                    result = await apiCall(`/mt5/martin/buy?symbol=${currentSymbol}`, 'POST');
                } else {
                    const lot = calculateLot();
                    result = await apiCall(`/mt5/order?symbol=${currentSymbol}&order_type=BUY&volume=${lot}&target=${targetAmount}`, 'POST');
                }
                showToast(result?.message || 'Error', result?.success ? 'success' : 'error');
                if (result?.success) playSound('buy');
            } catch (e) { showToast('Network error', 'error'); }
        }
        
        async function placeSell() {
            if (!checkGuestAction('trade')) return;
            
            // Demo Î™®ÎìúÎ©¥ Demo API ÏÇ¨Ïö©
            if (isDemo) {
                placeDemoOrder('SELL');
                return;
            }
            
            showToast('Processing...', '');
            try {
                let result;
                if (currentMode === 'martin' && martinEnabled) {
                    result = await apiCall(`/mt5/martin/sell?symbol=${currentSymbol}`, 'POST');
                } else {
                    const lot = calculateLot();
                    result = await apiCall(`/mt5/order?symbol=${currentSymbol}&order_type=SELL&volume=${lot}&target=${targetAmount}`, 'POST');
                }
                showToast(result?.message || 'Error', result?.success ? 'success' : 'error');
                if (result?.success) playSound('sell');
            } catch (e) { showToast('Network error', 'error'); }
        }
        
        async function closePosition() {
            // Demo Î™®ÎìúÎ©¥ Demo API ÏÇ¨Ïö©
            if (isDemo) {
                closeDemoPosition();
                return;
            }
            
            showToast('Closing...', '');
            try {
                const result = await apiCall(`/mt5/close?symbol=${currentSymbol}`, 'POST');
                
                if (result?.success) {
                    playSound('close');
                    const profit = result.profit || 0;
                    
                    // ÎßàÌã¥ Î™®Îìú Ï≤òÎ¶¨
                    if (currentMode === 'martin' && martinEnabled) {
                        const baseTarget = 50;  // 1Îã®Í≥Ñ Í∏∞Î≥∏ ÌÉÄÍ≤ü
                        const currentDisplayTarget = baseTarget * Math.pow(2, martinStep - 1) + martinAccumulatedLoss;
                        
                        // Case 1: ÏàòÏùµÏúºÎ°ú Ï≤≠ÏÇ∞
                        if (profit > 0) {
                            if (profit >= martinAccumulatedLoss && martinAccumulatedLoss > 0) {
                                // Case 1-A: Ï†ÑÏï° ÌöåÎ≥µ ‚Üí ÎßàÌã¥ ÏÑ±Í≥µ!
                                await apiCall('/mt5/martin/reset-full', 'POST');
                                
                                martinStep = 1;
                                martinAccumulatedLoss = 0;
                                martinHistory = [];
                                updateMartinUI();
                                updateTodayPL(profit);
                                showMartinSuccessPopup(profit);
                            } else if (profit < martinAccumulatedLoss || martinAccumulatedLoss === 0) {
                                // Case 1-B: ÏùºÎ∂Ä ÌöåÎ≥µ ‚Üí Îã®Í≥Ñ Ïú†ÏßÄ, ÌÉÄÍ≤üÎßå Ï°∞Ï†ï
                                const remainingLoss = Math.max(0, martinAccumulatedLoss - profit);
                                
                                await apiCall(`/mt5/martin/update-state?step=${martinStep}&accumulated_loss=${remainingLoss}`, 'POST');
                                
                                martinAccumulatedLoss = remainingLoss;
                                updateMartinUI();
                                updateTodayPL(profit);
                                
                                if (remainingLoss > 0) {
                                    showToast(`üí∞ ÏùºÎ∂Ä ÌöåÎ≥µ! +$${profit.toFixed(2)} (ÎÇ®ÏùÄ ÏÜêÏã§: $${remainingLoss.toFixed(2)})`, 'success');
                                } else {
                                    showMartinSuccessPopup(profit);
                                }
                            }
                        }
                        // Case 2: ÏÜêÏã§Î°ú Ï≤≠ÏÇ∞ (Close Î≤ÑÌäº)
                        else if (profit < 0) {
                            const lossAmount = Math.abs(profit);
                            const halfTarget = currentDisplayTarget / 2;
                            
                            if (lossAmount >= halfTarget) {
                                // Case 2-A: ÏÜêÏã§ >= 50% ‚Üí Îã§Ïùå Îã®Í≥ÑÎ°ú
                                const newStep = Math.min(martinStep + 1, martinLevel);
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                if (newStep > martinLevel) {
                                    // ÏµúÎåÄ Îã®Í≥Ñ Ï¥àÍ≥º ‚Üí Í∞ïÏ†ú Î¶¨ÏÖã
                                    await apiCall('/mt5/martin/reset-full', 'POST');
                                    
                                    showMaxPopup(newAccumulatedLoss);
                                    martinStep = 1;
                                    martinAccumulatedLoss = 0;
                                    martinHistory = [];
                                } else {
                                    await apiCall(`/mt5/martin/update-state?step=${newStep}&accumulated_loss=${newAccumulatedLoss}`, 'POST');
                                    
                                    martinStep = newStep;
                                    martinAccumulatedLoss = newAccumulatedLoss;
                                    showToast(`üìà Step ${newStep}Î°ú ÏßÑÌñâ! ÏÜêÏã§: -$${lossAmount.toFixed(2)}`, 'error');
                                }
                            } else {
                                // Case 2-B: ÏÜêÏã§ < 50% ‚Üí Îã®Í≥Ñ Ïú†ÏßÄ, ÌÉÄÍ≤üÎßå Ï°∞Ï†ï
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                await apiCall(`/mt5/martin/update-state?step=${martinStep}&accumulated_loss=${newAccumulatedLoss}`, 'POST');
                                
                                martinAccumulatedLoss = newAccumulatedLoss;
                                showToast(`üìä Îã®Í≥Ñ Ïú†ÏßÄ! ÏÜêÏã§: -$${lossAmount.toFixed(2)} (ÎàÑÏ†Å: $${newAccumulatedLoss.toFixed(2)})`, 'error');
                            }
                            
                            updateTodayPL(profit);
                            updateMartinUI();
                        }
                        // Case 3: ÏÜêÏùµ 0 (Break-even)
                        else {
                            showToast('Ï≤≠ÏÇ∞ ÏôÑÎ£å (ÏÜêÏùµ ÏóÜÏùå)', 'success');
                        }
                    } else {
                        // Basic/NoLimit Î™®Îìú
                        updateTodayPL(profit);
                        showToast(result.message, 'success');
                    }
                } else {
                    showToast(result?.message || 'Error', 'error');
                }
            } catch (e) { showToast('Network error', 'error'); }
        }
        
        // ========== Demo Î™®Îìú Ï£ºÎ¨∏ ==========
        async function placeDemoOrder(orderType) {
            showToast('Processing...', '');
            try {
                let response;
                
                // ÎßàÌã¥ Î™®ÎìúÎ©¥ ÎßàÌã¥ API ÏÇ¨Ïö©
                if (currentMode === 'martin' && martinEnabled) {
                    response = await fetch(`${API_URL}/demo/martin/order?symbol=${currentSymbol}&order_type=${orderType}&target=${targetAmount}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } else {
                    const lot = calculateLot();
                    response = await fetch(`${API_URL}/demo/order?symbol=${currentSymbol}&order_type=${orderType}&volume=${lot}&target=${targetAmount}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
                
                const result = await response.json();
                
                showToast(result?.message || 'Error', result?.success ? 'success' : 'error');
                if (result?.success) {
                    playSound(orderType.toLowerCase());
                    
                    // ÎßàÌã¥ Î™®ÎìúÎ©¥ Îã®Í≥Ñ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    if (result.martin_step) {
                        martinStep = result.martin_step;
                        updateMartinUI();
                    }
                    
                    fetchDemoData();
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // ========== Demo Î™®Îìú Ï≤≠ÏÇ∞ ==========
        async function closeDemoPosition() {
            showToast('Closing...', '');
            try {
                const response = await fetch(`${API_URL}/demo/close`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result?.success) {
                    playSound('close');
                    const profit = result.profit || 0;
                    
                    // ÎßàÌã¥ Î™®Îìú Ï≤òÎ¶¨
                    if (currentMode === 'martin' && martinEnabled) {
                        const baseTarget = 50;  // 1Îã®Í≥Ñ Í∏∞Î≥∏ ÌÉÄÍ≤ü
                        const currentDisplayTarget = baseTarget * Math.pow(2, martinStep - 1) + martinAccumulatedLoss;
                        
                        // Case 1: ÏàòÏùµÏúºÎ°ú Ï≤≠ÏÇ∞
                        if (profit > 0) {
                            if (profit >= martinAccumulatedLoss && martinAccumulatedLoss > 0) {
                                // Case 1-A: Ï†ÑÏï° ÌöåÎ≥µ ‚Üí ÎßàÌã¥ ÏÑ±Í≥µ!
                                await fetch(`${API_URL}/demo/martin/reset-full`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                martinStep = 1;
                                martinAccumulatedLoss = 0;
                                martinHistory = [];
                                updateMartinUI();
                                updateTodayPL(profit);
                                showMartinSuccessPopup(profit);
                            } else if (profit < martinAccumulatedLoss || martinAccumulatedLoss === 0) {
                                // Case 1-B: ÏùºÎ∂Ä ÌöåÎ≥µ ‚Üí Îã®Í≥Ñ Ïú†ÏßÄ, ÌÉÄÍ≤üÎßå Ï°∞Ï†ï
                                const remainingLoss = Math.max(0, martinAccumulatedLoss - profit);
                                
                                await fetch(`${API_URL}/demo/martin/update-state?step=${martinStep}&accumulated_loss=${remainingLoss}`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                martinAccumulatedLoss = remainingLoss;
                                updateMartinUI();
                                updateTodayPL(profit);
                                
                                if (remainingLoss > 0) {
                                    showToast(`üí∞ ÏùºÎ∂Ä ÌöåÎ≥µ! +$${profit.toFixed(2)} (ÎÇ®ÏùÄ ÏÜêÏã§: $${remainingLoss.toFixed(2)})`, 'success');
                                } else {
                                    showMartinSuccessPopup(profit);
                                }
                            }
                        }
                        // Case 2: ÏÜêÏã§Î°ú Ï≤≠ÏÇ∞ (Close Î≤ÑÌäº)
                        else if (profit < 0) {
                            const lossAmount = Math.abs(profit);
                            const halfTarget = currentDisplayTarget / 2;
                            
                            if (lossAmount >= halfTarget) {
                                // Case 2-A: ÏÜêÏã§ >= 50% ‚Üí Îã§Ïùå Îã®Í≥ÑÎ°ú
                                const newStep = Math.min(martinStep + 1, martinLevel);
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                if (newStep > martinLevel) {
                                    // ÏµúÎåÄ Îã®Í≥Ñ Ï¥àÍ≥º ‚Üí Í∞ïÏ†ú Î¶¨ÏÖã
                                    await fetch(`${API_URL}/demo/martin/reset-full`, {
                                        method: 'POST',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    
                                    showMaxPopup(newAccumulatedLoss);
                                    martinStep = 1;
                                    martinAccumulatedLoss = 0;
                                    martinHistory = [];
                                } else {
                                    await fetch(`${API_URL}/demo/martin/update-state?step=${newStep}&accumulated_loss=${newAccumulatedLoss}`, {
                                        method: 'POST',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    
                                    martinStep = newStep;
                                    martinAccumulatedLoss = newAccumulatedLoss;
                                    showToast(`üìà Step ${newStep}Î°ú ÏßÑÌñâ! ÏÜêÏã§: -$${lossAmount.toFixed(2)}`, 'error');
                                }
                            } else {
                                // Case 2-B: ÏÜêÏã§ < 50% ‚Üí Îã®Í≥Ñ Ïú†ÏßÄ, ÌÉÄÍ≤üÎßå Ï°∞Ï†ï
                                const newAccumulatedLoss = martinAccumulatedLoss + lossAmount;
                                
                                await fetch(`${API_URL}/demo/martin/update-state?step=${martinStep}&accumulated_loss=${newAccumulatedLoss}`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                martinAccumulatedLoss = newAccumulatedLoss;
                                showToast(`üìä Îã®Í≥Ñ Ïú†ÏßÄ! ÏÜêÏã§: -$${lossAmount.toFixed(2)} (ÎàÑÏ†Å: $${newAccumulatedLoss.toFixed(2)})`, 'error');
                            }
                            
                            updateTodayPL(profit);
                            updateMartinUI();
                        }
                        // Case 3: ÏÜêÏùµ 0 (Break-even)
                        else {
                            showToast('Ï≤≠ÏÇ∞ ÏôÑÎ£å (ÏÜêÏùµ ÏóÜÏùå)', 'success');
                        }
                    } else {
                        // Basic/NoLimit Î™®Îìú
                        updateTodayPL(profit);
                        showToast(result?.message || 'Closed!', 'success');
                    }
                    
                    fetchDemoData();
                } else {
                    showToast(result?.message || 'Error', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            } finally {
                isClosing = false;
            }
        }

        // ========== Demo Ï∂©Ï†Ñ ==========
        async function topupDemo() {
            try {
                const response = await fetch(`${API_URL}/demo/topup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchDemoData();
            } catch (e) {
                showToast('Ï∂©Ï†Ñ Ïã§Ìå®', 'error');
            }
        }
        
        // ========== Demo Î¶¨ÏÖã ==========
        async function resetDemo() {
            if (!confirm('Ï†ïÎßê ÏûîÍ≥†Î•º $10,000Î°ú Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎ™®Îì† Ìè¨ÏßÄÏÖòÍ≥º Í±∞Îûò Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.')) return;
            
            try {
                const response = await fetch(`${API_URL}/demo/reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchDemoData();
            } catch (e) {
                showToast('Î¶¨ÏÖã Ïã§Ìå®', 'error');
            }
        }

        // ========== Í±∞Îûò ÎÇ¥Ïó≠ ==========
        async function loadHistory() {
            // Demo Î™®ÎìúÎ©¥ Demo API ÏÇ¨Ïö©
            const endpoint = isDemo ? '/demo/history' : '/mt5/history';
            const data = await apiCall(endpoint);
            const container = document.getElementById('historyList');
            
            if (data?.history?.length > 0) {
                let html = '';
                data.history.forEach(h => {
                    const profitClass = h.profit >= 0 ? 'positive' : 'negative';
                    const profitSign = h.profit >= 0 ? '+' : '';
                    html += `<div class="history-item">
                        <div style="display:flex;flex-direction:column;gap:3px;">
                            <span class="history-symbol">${h.symbol} ${h.type}</span>
                            <span class="history-time">${h.time} | ${h.volume} lot</span>
                        </div>
                        <span class="history-profit ${profitClass}">${profitSign}$${h.profit.toFixed(2)}</span>
                    </div>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No trade history</p>';
            }
        }
        
        // ========== Toast ==========
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
        
        // ========== Logout ==========
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            window.location.href = 'login.html';
        }
        
        // ========== Í≤åÏä§Ìä∏ Î™®Îìú Ìï®Ïàò ==========
        function showGuestPopup() {
            document.getElementById('guestPopup').classList.add('show');
        }
        
        function closeGuestPopup() {
            document.getElementById('guestPopup').classList.remove('show');
        }
        
        function goToRegister() {
            sessionStorage.removeItem('guest_mode');
            window.location.href = 'login.html?mode=register';
        }
        
        function goToLoginPage() {
            sessionStorage.removeItem('guest_mode');
            window.location.href = 'login.html';
        }
        
        function checkGuestAction(action) {
            if (isGuest) {
                showGuestPopup();
                return false;
            }
            return true;
        }
        
        // ========== WebSocket ==========
        let ws = null;
        let wsRetryCount = 0;
        const maxRetries = 5;
        
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:8000/api/mt5/ws';
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('statusDot').classList.remove('disconnected');
                document.getElementById('headerStatus').textContent = 'Connected';
                wsRetryCount = 0;
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Demo Î™®ÎìúÎ©¥ Ï∞®Ìä∏/ÏãúÏÑ∏Îßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ≥† Í≥ÑÏ†ï Ï†ïÎ≥¥Îäî Í±¥ÎÑàÎõ∞Í∏∞
                if (isDemo) {
                    // Chart pricesÎßå ÏóÖÎç∞Ïù¥Ìä∏
                    if (data.all_prices && data.all_prices[chartSymbol]) {
                        const symbolPrice = data.all_prices[chartSymbol];
                        const decimals = getDecimalsForSymbol(chartSymbol);
                        document.getElementById('chartBid').textContent = symbolPrice.bid.toFixed(decimals);
                        document.getElementById('chartAsk').textContent = symbolPrice.ask.toFixed(decimals);
                    }
                    
                    // Realtime candle update + indicators
                    if (candleSeries && data.all_candles && data.all_candles[chartSymbol]) {
                        candleSeries.update(data.all_candles[chartSymbol]);
                        
                        if (!window.lastIndicatorUpdate || Date.now() - window.lastIndicatorUpdate > 30000) {
                            window.lastIndicatorUpdate = Date.now();
                            loadCandles();
                        }
                    }
                    
                    // Signal score
                    if (data.base_score !== undefined) {
                        baseScore = data.base_score;
                    }
                    
                    document.getElementById('indSell').textContent = data.sell_count;
                    document.getElementById('indNeutral').textContent = data.neutral_count;
                    document.getElementById('indBuy').textContent = data.buy_count;
                    
                    document.getElementById('chartIndSell').textContent = data.sell_count;
                    document.getElementById('chartIndNeutral').textContent = data.neutral_count;
                    document.getElementById('chartIndBuy').textContent = data.buy_count;
                    
                    return;  // Ïó¨Í∏∞ÏÑú Ï¢ÖÎ£å
                }
                
                balance = data.balance;
                
                // Home
                document.getElementById('homeBalance').textContent = '$' + data.balance.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('homeBroker').textContent = data.broker;
                document.getElementById('homeAccount').textContent = data.account;
                document.getElementById('homeLeverage').textContent = '1:' + data.leverage;
                document.getElementById('homeEquity').textContent = '$' + data.equity.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('homeFreeMargin').textContent = '$' + data.free_margin.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('homePositions').textContent = data.positions_count;
                
                // Chart prices
                if (data.all_prices && data.all_prices[chartSymbol]) {
                    const symbolPrice = data.all_prices[chartSymbol];
                    const decimals = getDecimalsForSymbol(chartSymbol);
                    document.getElementById('chartBid').textContent = symbolPrice.bid.toFixed(decimals);
                    document.getElementById('chartAsk').textContent = symbolPrice.ask.toFixed(decimals);
                }
                
                // Realtime candle update + indicators
                if (candleSeries && data.all_candles && data.all_candles[chartSymbol]) {
                    candleSeries.update(data.all_candles[chartSymbol]);
                    
                    // Î≥¥Ï°∞ÏßÄÌëúÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏ (30Ï¥àÎßàÎã§)
                    if (!window.lastIndicatorUpdate || Date.now() - window.lastIndicatorUpdate > 30000) {
                        window.lastIndicatorUpdate = Date.now();
                        loadCandles();
                    }
                }
                
                // Trade tab
                document.getElementById('tradeBalance').textContent = '$' + Math.round(data.balance).toLocaleString();
                
                // Signal score
                if (data.base_score !== undefined) {
                    baseScore = data.base_score;
                }
                
                document.getElementById('indSell').textContent = data.sell_count;
                document.getElementById('indNeutral').textContent = data.neutral_count;
                document.getElementById('indBuy').textContent = data.buy_count;
                
                chartTargetScore = targetScore;
                document.getElementById('chartIndSell').textContent = data.sell_count;
                document.getElementById('chartIndNeutral').textContent = data.neutral_count;
                document.getElementById('chartIndBuy').textContent = data.buy_count;
                
                // Ìè¨ÏßÄÏÖò Ï†ïÎ≥¥
                    if (data.position) {
                        updatePositionUI(true, data.position);
                        
                        // ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑúÎèÑ Î™©Ìëú ÎèÑÎã¨ Ï≤¥ÌÅ¨ (Î∞±ÏóîÎìú Î≥¥ÏôÑ)
                        const pos = data.position;
                        console.log(`[FRONTEND] Position - Profit: ${pos.profit}, Target: ${pos.target}, Should close: ${pos.profit >= pos.target}`);
                        
                        if (pos.target > 0 && pos.profit >= pos.target && !isClosing) {
                            console.log('[FRONTEND] Target reached! Triggering close...');
                            isClosing = true;  // Ï§ëÎ≥µ Î∞©ÏßÄ
                            closeDemoPosition();
                        }
                    } else {
                        updatePositionUI(false, null);
                    }
                
                // Account tab
                document.getElementById('accBalance').textContent = '$' + Math.round(data.balance).toLocaleString();
                document.getElementById('accEquity').textContent = '$' + Math.round(data.equity).toLocaleString();
                document.getElementById('accMargin').textContent = '$' + Math.round(data.margin).toLocaleString();
                document.getElementById('accFree').textContent = '$' + Math.round(data.free_margin).toLocaleString();
                
                // Martin state
                if (data.martin) {
                    martinEnabled = data.martin.enabled;
                    martinLevel = data.martin.max_steps;
                    martinStep = data.martin.step;
                    martinAccumulatedLoss = data.martin.accumulated_loss;
                    
                    if (currentMode === 'martin' && martinEnabled) {
                        if (martinAccumulatedLoss > 0) {
                            targetAmount = Math.ceil((martinAccumulatedLoss + 11 + data.martin.target_amount) / 10) * 10;
                        } else {
                            targetAmount = data.martin.target_amount;
                        }
                        
                        document.getElementById('tradeLotSize').textContent = data.martin.current_lot.toFixed(2);
                        updateMartinUI();
                    }
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('statusDot').classList.add('disconnected');
                document.getElementById('headerStatus').textContent = 'Disconnected';
                
                if (wsRetryCount < maxRetries) {
                    wsRetryCount++;
                    setTimeout(connectWebSocket, 3000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        // Fallback polling
        async function fetchAccountData() {
            // Demo Î™®ÎìúÎ©¥ Ïã§Ìñâ Ïïà Ìï®
            if (isDemo) return;
            
            try {
                const data = await apiCall('/mt5/account-info');
                if (data) {
                    balance = data.balance;
                    
                    document.getElementById('homeBalance').textContent = '$' + (data.balance || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeBroker').textContent = data.broker || '-';
                    document.getElementById('homeAccount').textContent = data.account || '-';
                    document.getElementById('homeLeverage').textContent = '1:' + (data.leverage || 0);
                    document.getElementById('homeServer').textContent = data.server || '-';
                    document.getElementById('homeEquity').textContent = '$' + (data.equity || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeFreeMargin').textContent = '$' + (data.free_margin || 0).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homePositions').textContent = data.positions_count || 0;
                    
                    document.getElementById('tradeBalance').textContent = '$' + Math.round(data.balance || 0).toLocaleString();
                    
                    document.getElementById('accBalance').textContent = '$' + Math.round(data.balance || 0).toLocaleString();
                    document.getElementById('accEquity').textContent = '$' + Math.round(data.equity || 0).toLocaleString();
                    document.getElementById('accMargin').textContent = '$' + Math.round(data.margin || 0).toLocaleString();
                    document.getElementById('accFree').textContent = '$' + Math.round(data.free_margin || 0).toLocaleString();
                    
                    if (data.buy_count !== undefined) {
                        document.getElementById('indSell').textContent = data.sell_count;
                        document.getElementById('indNeutral').textContent = data.neutral_count;
                        document.getElementById('indBuy').textContent = data.buy_count;
                        document.getElementById('chartIndSell').textContent = data.sell_count;
                        document.getElementById('chartIndNeutral').textContent = data.neutral_count;
                        document.getElementById('chartIndBuy').textContent = data.buy_count;
                        
                        baseScore = data.base_score || 50;
                    }
                    
                    if (data.prices && data.prices[chartSymbol]) {
                        const price = data.prices[chartSymbol];
                        const decimals = getDecimalsForSymbol(chartSymbol);
                        document.getElementById('chartBid').textContent = price.bid.toFixed(decimals);
                        document.getElementById('chartAsk').textContent = price.ask.toFixed(decimals);
                    }
                    
                    if (data.position) {
                        updatePositionUI(true, data.position);
                    } else {
                        updatePositionUI(false, null);
                    }
                    
                    document.getElementById('statusDot').classList.remove('disconnected');
                    document.getElementById('headerStatus').textContent = 'Connected';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('statusDot').classList.add('disconnected');
                document.getElementById('headerStatus').textContent = 'Disconnected';
            }
        }
        
        // ========== Demo/Live Î™®Îìú ÌôïÏù∏ ==========
        async function checkUserMode() {
            try {
                // Î®ºÏ†Ä Demo Í≥ÑÏ†ï Ï†ïÎ≥¥ Ï°∞Ìöå
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.has_mt5) {
                    // MT5 Í≥ÑÏ†ï Ïó∞Í≤∞Îê® ‚Üí Live Î™®Îìú
                    isDemo = false;
                    document.getElementById('headerStatus').textContent = 'Connected';
                    document.getElementById('statusDot').style.background = '#00ff88';
                    
                    // Live Î∞∞ÏßÄ ÌëúÏãú
                    const badge = document.getElementById('modeBadge');
                    badge.textContent = 'LIVE';
                    badge.className = 'mode-badge-live';
                    badge.style.display = 'inline';
                    connectWebSocket();
                    fetchAccountData();
                    setInterval(fetchAccountData, 2000);
                } else {
                    // MT5 ÏóÜÏùå ‚Üí Demo Î™®Îìú
                    isDemo = true;
                    document.getElementById('headerStatus').textContent = 'Connected';
                    document.getElementById('demoControlCard').style.display = 'block';
                    document.getElementById('statusDot').style.background = '#00d4ff';
                    
                    // Demo Î∞∞ÏßÄ ÌëúÏãú
                    const badge = document.getElementById('modeBadge');
                    badge.textContent = 'DEMO';
                    badge.className = 'mode-badge-demo';
                    badge.style.display = 'inline';
                    connectWebSocket();  // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Ïö© WebSocket Ïó∞Í≤∞
                    fetchDemoData();
                    setInterval(fetchDemoData, 500);  // 500msÎ°ú Îã®Ï∂ï (Îπ†Î•∏ Ï≤≠ÏÇ∞)
                    
                    setTimeout(() => {
                        showToast('üìä Demo Î™®ÎìúÎ°ú Ï†ëÏÜçÌñàÏäµÎãàÎã§', 'Í∞ÄÏÉÅ $10,000Î°ú Ïó∞ÏäµÌïòÏÑ∏Ïöî!');
                    }, 1000);
                }
            } catch (error) {
                console.error('Mode check error:', error);
                // ÏóêÎü¨ Ïãú Demo Î™®ÎìúÎ°ú Í∏∞Î≥∏ ÏÑ§Ï†ï
                isDemo = true;
                fetchDemoData();
            }
        }
        
        // ========== Demo Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ==========
        async function fetchDemoData() {
            // Demo Î™®ÎìúÍ∞Ä ÏïÑÎãàÎ©¥ Ïã§Ìñâ Ïïà Ìï®
            if (!isDemo) return;
            
            try {
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data) {
                    // Î∞±ÏóîÎìúÏóêÏÑú ÏûêÎèô Ï≤≠ÏÇ∞Îêú Í≤ΩÏö∞
                    if (data.auto_closed) {
                        playSound('close');
                        
                        const profit = data.closed_profit || 0;
                        const isWin = data.is_win !== false && profit >= 0;
                        
                        // ÎßàÌã¥ Î™®ÎìúÏù∏ Í≤ΩÏö∞
                        if (currentMode === 'martin' && martinEnabled) {
                            if (data.martin_reset || isWin) {
                                // ÎßàÌã¥ ÏÑ±Í≥µ! Î¶¨ÏÖã ÎòêÎäî ÏÑ±Í≥µ ÌôïÏù∏ ÌåùÏóÖ
                                martinStep = 1;
                                martinAccumulatedLoss = 0;
                                martinHistory = [];
                                updateMartinUI();
                                showMartinSuccessPopup(profit);
                            } else if (data.martin_step_up) {
                                // ÎßàÌã¥ ÏÜêÏã§ ‚Üí Îã§Ïùå Îã®Í≥ÑÎ°ú
                                showMartinPopup(profit);
                            } else {
                                showToast(data.message || `üíî ÏÜêÏ†à! ${profit.toFixed(2)}`, 'error');
                            }
                        } else {
                            // Basic/NoLimit Î™®Îìú
                            if (isWin) {
                                showToast(data.message || `üéØ Î™©Ìëú ÎèÑÎã¨! +$${profit.toFixed(2)}`, 'success');
                            } else {
                                showToast(data.message || `üíî ÏÜêÏ†à! $${profit.toFixed(2)}`, 'error');
                            }
                        }
                        
                        // Today P/L ÏóÖÎç∞Ïù¥Ìä∏
                        updateTodayPL(profit);
                        
                        // Ìè¨ÏßÄÏÖò UI ÏóÖÎç∞Ïù¥Ìä∏
                        updatePositionUI(false, null);
                    }
                    
                    document.getElementById('homeBalance').textContent = '$' + (data.balance || 10000).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeBroker').textContent = data.broker || 'Demo';
                    document.getElementById('homeAccount').textContent = data.account || 'DEMO';
                    document.getElementById('homeLeverage').textContent = '1:' + (data.leverage || 500);
                    document.getElementById('homeServer').textContent = data.server || 'Demo';
                    document.getElementById('homeEquity').textContent = '$' + (data.equity || 10000).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homeFreeMargin').textContent = '$' + (data.balance || 10000).toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('homePositions').textContent = data.positions_count || 0;
                    document.getElementById('tradeBalance').textContent = '$' + Math.round(data.balance || 10000).toLocaleString();
                    
                    // Account ÌÉ≠ ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('accBalance').textContent = '$' + Math.round(data.balance || 10000).toLocaleString();
                    document.getElementById('accEquity').textContent = '$' + Math.round(data.equity || 10000).toLocaleString();
                    document.getElementById('accMargin').textContent = '$0';
                    document.getElementById('accFree').textContent = '$' + Math.round(data.balance || 10000).toLocaleString();
                    
                    // Ìè¨ÏßÄÏÖò Ï†ïÎ≥¥
                    if (data.position) {
                        updatePositionUI(true, data.position);
                        
                        // ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑúÎèÑ Î™©Ìëú ÎèÑÎã¨ Ï≤¥ÌÅ¨ (Îπ†Î•∏ Ï≤≠ÏÇ∞)
                        const pos = data.position;
                        const currentTarget = pos.target || targetAmount;
                        
                        // WIN ÎòêÎäî LOSE Ï°∞Í±¥ Ï≤¥ÌÅ¨
                        if (currentTarget > 0 && !isClosing) {
                            if (pos.profit >= currentTarget) {
                                // WIN Ï°∞Í±¥
                                console.log('[FRONTEND] WIN Target reached! Profit:', pos.profit, '>=', currentTarget);
                                isClosing = true;
                                closeDemoPosition();
                            } else if (pos.profit <= -currentTarget) {
                                // LOSE Ï°∞Í±¥
                                console.log('[FRONTEND] LOSE Target reached! Profit:', pos.profit, '<=', -currentTarget);
                                isClosing = true;
                                closeDemoPosition();
                            }
                        }
                    } else {
                        updatePositionUI(false, null);
                        isClosing = false;  // Ìè¨ÏßÄÏÖò ÏóÜÏúºÎ©¥ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                    }
                    
                    // Quick Ìå®ÎÑê ÏóÖÎç∞Ïù¥Ìä∏ (Quick Ìå®ÎÑêÏù¥ ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞)
                    const quickPanel = document.getElementById('quickPanel');
                    if (quickPanel && quickPanel.classList.contains('active')) {
                        updateQuickPanelFromData(data);
                    }
                    
                    // Demo ÎßàÌã¥ ÏÉÅÌÉú Ï°∞Ìöå (Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå ÏóÖÎç∞Ïù¥Ìä∏)
                    if (currentMode === 'martin' && martinEnabled) {
                        try {
                            const martinRes = await fetch(`${API_URL}/demo/martin/state`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const martinData = await martinRes.json();
                            
                            if (martinData) {
                                // Í∞íÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå ÏóÖÎç∞Ïù¥Ìä∏ (ÍπúÎπ°ÏûÑ Î∞©ÏßÄ)
                                const newStep = martinData.step || 1;
                                const newLoss = martinData.accumulated_loss || 0;
                                
                                if (martinStep !== newStep || martinAccumulatedLoss !== newLoss) {
                                    martinStep = newStep;
                                    martinAccumulatedLoss = newLoss;
                                    martinLevel = martinData.max_steps || 5;
                                    lotSize = martinData.base_lot || 0.01;
                                    
                                    document.getElementById('tradeLotSize').textContent = martinData.current_lot?.toFixed(2) || lotSize.toFixed(2);
                                    updateMartinUI();
                                }
                            }
                        } catch (e) {
                            console.log('Martin state error:', e);
                        }
                    }
                }
            } catch (error) {
                console.error('Demo fetch error:', error);
            }
        }

        // Initialize
        if (!isGuest && token) {
            // Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê - DemoÏù∏ÏßÄ LiveÏù∏ÏßÄ ÌôïÏù∏
            checkUserMode();
        } else if (isGuest) {
            // Í≤åÏä§Ìä∏ Î™®Îìú - Îç∞Î™® Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
            document.getElementById('homeBalance').textContent = '$10,000.00';
            document.getElementById('homeBroker').textContent = 'Demo Broker';
            document.getElementById('homeAccount').textContent = 'GUEST';
            document.getElementById('homeLeverage').textContent = '1:500';
            document.getElementById('homeServer').textContent = 'Demo Server';
            document.getElementById('homeEquity').textContent = '$10,000.00';
            document.getElementById('homeFreeMargin').textContent = '$10,000.00';
            document.getElementById('homePositions').textContent = '0';
            document.getElementById('tradeBalance').textContent = '$10,000';
            document.getElementById('headerStatus').textContent = 'Guest Mode';
            document.getElementById('statusDot').style.background = '#ffa500';
            
            // Í≤åÏä§Ìä∏ Î™®Îìú Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            async function fetchGuestIndicators() {
                try {
                    const response = await fetch(`${API_URL}/mt5/indicators/BTCUSD`);
                    const data = await response.json();
                    if (data) {
                        document.getElementById('indSell').textContent = data.sell || 0;
                        document.getElementById('indNeutral').textContent = data.neutral || 0;
                        document.getElementById('indBuy').textContent = data.buy || 0;
                        document.getElementById('chartIndSell').textContent = data.sell || 0;
                        document.getElementById('chartIndNeutral').textContent = data.neutral || 0;
                        document.getElementById('chartIndBuy').textContent = data.buy || 0;
                        baseScore = data.score || 50;
                    }
                } catch (e) {
                    console.log('Guest indicator error:', e);
                }
            }
            
            fetchGuestIndicators();
            setInterval(fetchGuestIndicators, 3000);
            
            // Í≤åÏä§Ìä∏ ÏïàÎÇ¥ ÌÜ†Ïä§Ìä∏
            setTimeout(() => {
                showToast('üëã Í≤åÏä§Ìä∏ Î™®ÎìúÎ°ú ÎëòÎü¨Î≥¥Îäî Ï§ëÏûÖÎãàÎã§', '');
            }, 1000);
        }
        
        // Profile name
        const userEmail = localStorage.getItem('user_email');
        if (userEmail) {
            document.getElementById('profileName').textContent = userEmail.split('@')[0];
        }
        
        // ========== ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïù∏ÏÇ¨ ==========
        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingText = document.getElementById('greetingText');
            const greetingSub = document.getElementById('greetingSub');
            
            const userName = localStorage.getItem('user_email')?.split('@')[0] || 'Trader';
            
            let greeting, sub;
            
            if (hour >= 5 && hour < 12) {
                greeting = `Good Morning, ${userName}! ‚òÄÔ∏è`;
                sub = 'Ïò§ÎäòÎèÑ Ï¢ãÏùÄ Í±∞Îûò ÎêòÏÑ∏Ïöî!';
            } else if (hour >= 12 && hour < 18) {
                greeting = `Good Afternoon, ${userName}! üå§Ô∏è`;
                sub = 'Ïò§ÌõÑÎèÑ ÌôîÏù¥ÌåÖ!';
            } else if (hour >= 18 && hour < 22) {
                greeting = `Good Evening, ${userName}! üåô`;
                sub = 'Ïò§Îäò ÌïòÎ£® ÏàòÍ≥†ÌïòÏÖ®Ïñ¥Ïöî!';
            } else {
                greeting = `Still Trading, ${userName}? ü¶â`;
                sub = 'Îä¶ÏùÄ ÏãúÍ∞ÑÍπåÏßÄ ÌôîÏù¥ÌåÖ!';
            }
            
            if (greetingText) greetingText.textContent = greeting;
            if (greetingSub) greetingSub.textContent = sub;
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïù∏ÏÇ¨ ÏóÖÎç∞Ïù¥Ìä∏
        updateGreeting();
        // 1Î∂ÑÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏ (ÏãúÍ∞Ñ Î≥ÄÍ≤Ω ÎåÄÏùë)
        setInterval(updateGreeting, 60000);
        
        // ========== ÌîÑÎ°úÎ™®ÏÖò Ïä¨ÎùºÏù¥Îçî ==========
        function scrollToPromo(index) {
            const slider = document.getElementById('promoSlider');
            const cards = slider.querySelectorAll('.promo-card');
            if (cards[index]) {
                cards[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                updatePromoDots(index);
            }
        }
        
        function updatePromoDots(activeIndex) {
            const dots = document.querySelectorAll('.promo-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === activeIndex);
            });
        }
        
        // Ïä¨ÎùºÏù¥Îìú Ïä§ÌÅ¨Î°§ Í∞êÏßÄ
        document.getElementById('promoSlider')?.addEventListener('scroll', function() {
            const slider = this;
            const scrollLeft = slider.scrollLeft;
            const cardWidth = slider.querySelector('.promo-card')?.offsetWidth || 0;
            const gap = 12;
            const index = Math.round(scrollLeft / (cardWidth + gap));
            updatePromoDots(index);
        });
        
        // ========== Trading Mode Ï†ÑÌôò ==========
        function switchTradingMode(mode) {
            const demoBtn = document.getElementById('modeDemoBtn');
            const liveBtn = document.getElementById('modeLiveBtn');
            const demoCheck = document.getElementById('demoCheck');
            const liveCheck = document.getElementById('liveCheck');
            const modeStatus = document.getElementById('modeStatus');
            const modeBadge = document.getElementById('modeBadge');
            
            if (mode === 'demo') {
                // Demo Î™®ÎìúÎ°ú Ï†ÑÌôò
                demoBtn.classList.add('active');
                demoBtn.classList.remove('live-active');
                liveBtn.classList.remove('active', 'live-active');
                demoCheck.style.display = 'flex';
                liveCheck.style.display = 'none';
                
                modeStatus.className = 'mode-status';
                modeStatus.innerHTML = '<span class="mode-status-dot demo"></span><span>Currently in <strong>Demo Mode</strong> - Practice with virtual $10,000</span>';
                
                // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                if (modeBadge) {
                    modeBadge.textContent = 'DEMO';
                    modeBadge.className = 'mode-badge-demo';
                    modeBadge.style.display = 'inline';
                }
                
                // Demo Control ÌëúÏãú
                const demoControl = document.getElementById('demoControlCard');
                if (demoControl) demoControl.style.display = 'block';
                
                isDemo = true;
                showToast('üéÆ Demo Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§', 'success');
                fetchDemoData();
                
            } else if (mode === 'live') {
                // Live Î™®Îìú Ï†ÑÌôò ÏãúÎèÑ
                // MT5 Í≥ÑÏ†ï Ïó∞Í≤∞ ÌôïÏù∏ ÌïÑÏöî
                if (!token) {
                    showToast('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§', 'error');
                    return;
                }
                
                // MT5 Ïó∞Í≤∞ ÌôïÏù∏ API Ìò∏Ï∂ú
                checkMT5Connection().then(hasMT5 => {
                    if (hasMT5) {
                        // Live Î™®ÎìúÎ°ú Ï†ÑÌôò
                        liveBtn.classList.add('active', 'live-active');
                        demoBtn.classList.remove('active');
                        liveCheck.style.display = 'flex';
                        demoCheck.style.display = 'none';
                        
                        modeStatus.className = 'mode-status live';
                        modeStatus.innerHTML = '<span class="mode-status-dot live"></span><span>Currently in <strong>Live Mode</strong> - Real trading active</span>';
                        
                        // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                        if (modeBadge) {
                            modeBadge.textContent = 'LIVE';
                            modeBadge.className = 'mode-badge-live';
                            modeBadge.style.display = 'inline';
                        }
                        
                        // Demo Control Ïà®Í∏∞Í∏∞
                        const demoControl = document.getElementById('demoControlCard');
                        if (demoControl) demoControl.style.display = 'none';
                        
                        isDemo = false;
                        showToast('üíé Live Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§', 'success');
                        fetchAccountData();
                        
                    } else {
                        showToast('MT5 Í≥ÑÏ†ïÏùÑ Î®ºÏ†Ä Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                        // MT5 Ïó∞Í≤∞ ÏÑπÏÖòÏúºÎ°ú Ïä§ÌÅ¨Î°§
                        document.getElementById('mt5AccountSection')?.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }
        }
        
        async function checkMT5Connection() {
            try {
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                return data.has_mt5 || false;
            } catch (e) {
                return false;
            }
        }
        
        // Ï¥àÍ∏∞ Î™®Îìú ÏÉÅÌÉú Î∞òÏòÅ
        function initTradingModeUI() {
            if (isDemo) {
                switchTradingMode('demo');
            } else {
                const liveBtn = document.getElementById('modeLiveBtn');
                const demoBtn = document.getElementById('modeDemoBtn');
                const liveCheck = document.getElementById('liveCheck');
                const demoCheck = document.getElementById('demoCheck');
                const modeStatus = document.getElementById('modeStatus');
                
                if (liveBtn && demoBtn) {
                    liveBtn.classList.add('active', 'live-active');
                    demoBtn.classList.remove('active');
                    liveCheck.style.display = 'flex';
                    demoCheck.style.display = 'none';
                    
                    modeStatus.className = 'mode-status live';
                    modeStatus.innerHTML = '<span class="mode-status-dot live"></span><span>Currently in <strong>Live Mode</strong> - Real trading active</span>';
                }
            }
        }
        
        // ========== MT5 Account Í¥ÄÎ¶¨ ==========
        function updateMT5AccountUI(hasMT5, mt5Data = null) {
            const notConnected = document.getElementById('mt5NotConnected');
            const connected = document.getElementById('mt5Connected');
            
            if (hasMT5 && mt5Data) {
                // Ïó∞Í≤∞Îê® ÏÉÅÌÉú ÌëúÏãú
                notConnected.style.display = 'none';
                connected.style.display = 'block';
                
                document.getElementById('mt5Broker').textContent = mt5Data.broker || '-';
                document.getElementById('mt5Account').textContent = mt5Data.account || '-';
                document.getElementById('mt5Server').textContent = mt5Data.server || '-';
                document.getElementById('mt5Leverage').textContent = mt5Data.leverage ? `1:${mt5Data.leverage}` : '-';
            } else {
                // Ïó∞Í≤∞ Ïïà Îê® ÏÉÅÌÉú ÌëúÏãú
                notConnected.style.display = 'block';
                connected.style.display = 'none';
            }
        }
        
        async function disconnectMT5() {
            if (!confirm('MT5 Í≥ÑÏ¢å Ïó∞Í≤∞ÏùÑ Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                // Ïó∞Í≤∞ Ìï¥Ï†ú API Ìò∏Ï∂ú (Ï∂îÌõÑ Íµ¨ÌòÑ)
                // await apiCall('/mt5/disconnect', 'POST');
                
                updateMT5AccountUI(false);
                switchTradingMode('demo');
                showToast('MT5 Í≥ÑÏ¢å Ïó∞Í≤∞Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch (e) {
                showToast('Ïó∞Í≤∞ Ìï¥Ï†ú Ïã§Ìå®', 'error');
            }
        }
        
        // MT5 ÏÉÅÌÉú ÌôïÏù∏ Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
        async function checkAndUpdateMT5Status() {
            try {
                const response = await fetch(`${API_URL}/demo/account-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.has_mt5) {
                    // MT5 Ï†ïÎ≥¥ Ï°∞Ìöå
                    const mt5Response = await fetch(`${API_URL}/mt5/account-info`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const mt5Data = await mt5Response.json();
                    
                    updateMT5AccountUI(true, {
                        broker: mt5Data.broker,
                        account: mt5Data.account,
                        server: mt5Data.server,
                        leverage: mt5Data.leverage
                    });
                } else {
                    updateMT5AccountUI(false);
                }
            } catch (e) {
                updateMT5AccountUI(false);
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú MT5 ÏÉÅÌÉú ÌôïÏù∏
        if (token && !isGuest) {
            checkAndUpdateMT5Status();
        }
        
        // ========== Í≥µÏßÄ Î∞∞ÎÑà ==========
        function showNoticeBanner(message) {
            const banner = document.getElementById('noticeBanner');
            const text = document.getElementById('noticeText');
            text.textContent = message;
            banner.style.display = 'flex';
        }
        
        function closeNoticeBanner() {
            const banner = document.getElementById('noticeBanner');
            banner.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => {
                banner.style.display = 'none';
                banner.style.animation = 'slideDown 0.3s ease';
            }, 300);
            // 24ÏãúÍ∞Ñ ÎèôÏïà Îã§Ïãú Ïïà Î≥¥Ïù¥Í≤å (ÏÑ†ÌÉùÏÇ¨Ìï≠)
            localStorage.setItem('noticeClosed', Date.now());
        }
        
        // Í≥µÏßÄ ÌëúÏãú (ÏòàÏãú - ÌïÑÏöîÏãú ÌôúÏÑ±Ìôî)
        // showNoticeBanner('ÏÑúÎ≤Ñ Ï†êÍ≤Ä ÏïàÎÇ¥ (1/20 02:00~04:00)');
    
        // ========== MT5 Ïó∞Í≤∞ Î™®Îã¨ ==========
        function openMT5ConnectModal() {
            document.getElementById('mt5ConnectModal').classList.add('show');
            showMT5Step1();
        }
        
        function closeMT5ConnectModal() {
            document.getElementById('mt5ConnectModal').classList.remove('show');
        }
        
        function showMT5Step1() {
            document.getElementById('mt5Step1').style.display = 'block';
            document.getElementById('mt5Step2Existing').style.display = 'none';
            document.getElementById('mt5Step2New').style.display = 'none';
        }
        
        function showMT5Step2(type) {
            document.getElementById('mt5Step1').style.display = 'none';
            if (type === 'existing') {
                document.getElementById('mt5Step2Existing').style.display = 'block';
                document.getElementById('mt5Step2New').style.display = 'none';
            } else {
                document.getElementById('mt5Step2Existing').style.display = 'none';
                document.getElementById('mt5Step2New').style.display = 'block';
            }
        }
        
        function openMT5GuideModal() {
            openMT5ConnectModal();
            showMT5Step2('new');
        }
        
        async function connectMT5Account() {
            const server = document.getElementById('mt5Server').value;
            const account = document.getElementById('mt5AccountNumber').value;
            const password = document.getElementById('mt5Password').value;
            
            if (!account || !password) {
                showToast('Í≥ÑÏ¢åÎ≤àÌò∏ÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }
            
            showToast('Ïó∞Í≤∞ Ï§ë...', '');
            
            try {
                // Ïã§Ï†ú API Ìò∏Ï∂ú (Ï∂îÌõÑ Íµ¨ÌòÑ)
                // const result = await apiCall('/mt5/connect', 'POST', { server, account, password });
                
                // ÏûÑÏãú: ÏÑ±Í≥µ Ï≤òÎ¶¨
                setTimeout(() => {
                    closeMT5ConnectModal();
                    
                    // ÏÑ±Í≥µ Î™®Îã¨ ÌëúÏãú
                    document.getElementById('successAccount').textContent = account;
                    document.getElementById('successServer').textContent = server;
                    document.getElementById('mt5SuccessModal').classList.add('show');
                    
                    // MT5 Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    updateMT5AccountUI(true, {
                        broker: 'HedgeHood',
                        account: account,
                        server: server,
                        leverage: 500
                    });
                    
                    // Live Î™®ÎìúÎ°ú Ï†ÑÌôò
                    isDemo = false;
                    switchTradingMode('live');
                    
                    // Hero Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                    const heroBadge = document.getElementById('heroModeBadge');
                    if (heroBadge) {
                        heroBadge.textContent = 'Trading-X Live';
                        heroBadge.style.background = 'linear-gradient(135deg, rgba(0, 255, 136, 0.2) 0%, rgba(0, 255, 136, 0.05) 100%)';
                        heroBadge.style.borderColor = 'rgba(0, 255, 136, 0.4)';
                        heroBadge.style.color = '#00ff88';
                    }
                }, 1500);
                
            } catch (error) {
                showToast('Ïó∞Í≤∞ Ïã§Ìå®: ' + error.message, 'error');
            }
        }
        
        function closeMT5SuccessModal() {
            document.getElementById('mt5SuccessModal').classList.remove('show');
        }
        
        // ========== ÏÑúÎ∏åÎ©îÎâ¥ (Ï∞®Ìä∏ ÌÉ≠) ==========
        let submenuLongPressTimer = null;
        let submenuCurrentItem = null;
        const LONG_PRESS_DURATION = 500; // 0.5Ï¥à
        
        // ÏÑúÎ∏åÎ©îÎâ¥ Ïó¥Í∏∞
        function openChartSubmenu() {
            const defaultView = localStorage.getItem('chart_default_view') || null;
            
            // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            const watchlistBadge = document.getElementById('submenuWatchlistBadge');
            const chartBadge = document.getElementById('submenuChartBadge');
            
            if (defaultView === 'watchlist') {
                watchlistBadge.style.display = 'block';
                chartBadge.style.display = 'none';
            } else if (defaultView === 'chart') {
                watchlistBadge.style.display = 'none';
                chartBadge.style.display = 'block';
            } else {
                watchlistBadge.style.display = 'none';
                chartBadge.style.display = 'none';
            }
            
            document.getElementById('chartSubmenuOverlay').classList.add('show');
        }
        
        // ÏÑúÎ∏åÎ©îÎâ¥ Îã´Í∏∞
        function closeChartSubmenu() {
            document.getElementById('chartSubmenuOverlay').classList.remove('show');
        }
        
        // ÏÑúÎ∏åÎ©îÎâ¥ Ìï≠Î™© ÌÅ¥Î¶≠
        function selectSubmenuItem(view) {
            closeChartSubmenu();
            
            // ÌéòÏù¥ÏßÄ Ï†ÑÌôò
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item[data-page="chart"]').classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-chart').classList.add('active');
            
            if (view === 'watchlist') {
                showWatchlist();
                renderWatchlist();
            } else if (view === 'chart') {
                // ÎßàÏßÄÎßâ Î≥∏ Ï¢ÖÎ™© ÎòêÎäî Í∏∞Î≥∏ Ï¢ÖÎ™©ÏúºÎ°ú Ï∞®Ìä∏ Ïó¥Í∏∞
                const lastSymbol = localStorage.getItem('last_chart_symbol') || 'BTCUSD';
                const symbolInfo = getSymbolInfo(lastSymbol);
                
                chartSymbol = lastSymbol;
                document.getElementById('chartSymbolIcon').textContent = symbolInfo.icon;
                document.getElementById('chartSymbolIcon').style.color = symbolInfo.color;
                document.getElementById('chartSymbolName').textContent = symbolInfo.name;
                document.getElementById('chartSymbolId').textContent = lastSymbol;
                
                showChartDetail();
                
                if (chart) {
                    chart.remove();
                    chart = null;
                }
                initChart();
                loadCandles();
            }
        }
        
        // Ïã¨Î≥º Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSymbolInfo(symbol) {
            const defaultInfo = { name: symbol, icon: 'üìà', color: '#00d4ff' };
            
            const symbolMap = {
                'BTCUSD': { name: 'Bitcoin', icon: '‚Çø', color: '#f7931a' },
                'EURUSD.r': { name: 'Euro/Dollar', icon: '‚Ç¨', color: '#0052cc' },
                'USDJPY.r': { name: 'Dollar/Yen', icon: '¬•', color: '#dc143c' },
                'XAUUSD.r': { name: 'Gold', icon: '‚ú¶', color: '#ffd700' },
                'US100.': { name: 'NASDAQ', icon: '‚¨°', color: '#00b450' },
                'GBPUSD.r': { name: 'Pound/Dollar', icon: '¬£', color: '#9c27b0' },
                'ETHUSD': { name: 'Ethereum', icon: 'Œû', color: '#627eea' }
            };
            
            return symbolMap[symbol] || defaultInfo;
        }
        
        // ÏÑúÎ∏åÎ©îÎâ¥ Ìï≠Î™© Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ ÏãúÏûë
        function submenuItemPressStart(view, element) {
            submenuCurrentItem = element;
            element.classList.add('pressing');
            
            submenuLongPressTimer = setTimeout(() => {
                // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ ÏôÑÎ£å - Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ù
                registerDefaultView(view);
                element.classList.remove('pressing');
            }, LONG_PRESS_DURATION);
        }
        
        // ÏÑúÎ∏åÎ©îÎâ¥ Ìï≠Î™© Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ï¢ÖÎ£å
        function submenuItemPressEnd() {
            if (submenuLongPressTimer) {
                clearTimeout(submenuLongPressTimer);
                submenuLongPressTimer = null;
            }
            if (submenuCurrentItem) {
                submenuCurrentItem.classList.remove('pressing');
                submenuCurrentItem = null;
            }
        }
        
        // Í∏∞Î≥∏ ÌôîÎ©¥ Îì±Î°ù
        function registerDefaultView(view) {
            localStorage.setItem('chart_default_view', view);
            
            // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            const watchlistBadge = document.getElementById('submenuWatchlistBadge');
            const chartBadge = document.getElementById('submenuChartBadge');
            
            if (view === 'watchlist') {
                watchlistBadge.style.display = 'block';
                chartBadge.style.display = 'none';
            } else {
                watchlistBadge.style.display = 'none';
                chartBadge.style.display = 'block';
            }
            
            // ÌÜ†Ïä§Ìä∏ ÌëúÏãú
            const viewName = view === 'watchlist' ? 'Ï¢ÖÎ™© Î™©Î°ù' : 'Ï∞®Ìä∏ Î≥¥Í∏∞';
            showSubmenuToast(viewName);
            
            // ÌñÖÌã± ÌîºÎìúÎ∞± (Î™®Î∞îÏùº)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // Îì±Î°ù ÏôÑÎ£å ÌÜ†Ïä§Ìä∏
        function showSubmenuToast(viewName) {
            const toast = document.getElementById('submenuToast');
            document.getElementById('submenuToastViewName').textContent = viewName;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }
        
        // ========== ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ ==========
        let navLongPressTimer = null;
        let navPressedItem = null;
        
        function setupNavLongPress() {
            // Chart ÌÉ≠ ÏÑ§Ï†ï
            const chartNavItem = document.querySelector('.nav-item[data-page="chart"]');
            if (chartNavItem) {
                chartNavItem.removeAttribute('onclick');
                chartNavItem.addEventListener('touchstart', (e) => navTouchStart(e, 'chart'), { passive: true });
                chartNavItem.addEventListener('touchend', (e) => navTouchEnd(e, 'chart'));
                chartNavItem.addEventListener('touchcancel', (e) => navTouchEnd(e, 'chart'));
                chartNavItem.addEventListener('mousedown', (e) => navMouseDown(e, 'chart'));
                chartNavItem.addEventListener('mouseup', (e) => navMouseUp(e, 'chart'));
                chartNavItem.addEventListener('mouseleave', (e) => navMouseUp(e, 'chart'));
            }
            
            // Trade ÌÉ≠ ÏÑ§Ï†ï
            const tradeNavItem = document.querySelector('.nav-item[data-page="trade"]');
            if (tradeNavItem) {
                tradeNavItem.removeAttribute('onclick');
                tradeNavItem.addEventListener('touchstart', (e) => navTouchStart(e, 'trade'), { passive: true });
                tradeNavItem.addEventListener('touchend', (e) => navTouchEnd(e, 'trade'));
                tradeNavItem.addEventListener('touchcancel', (e) => navTouchEnd(e, 'trade'));
                tradeNavItem.addEventListener('mousedown', (e) => navMouseDown(e, 'trade'));
                tradeNavItem.addEventListener('mouseup', (e) => navMouseUp(e, 'trade'));
                tradeNavItem.addEventListener('mouseleave', (e) => navMouseUp(e, 'trade'));
            }
        }
        
        let currentNavTab = 'chart'; // ÌòÑÏû¨ Ï≤òÎ¶¨ Ï§ëÏù∏ ÌÉ≠
        
        function navTouchStart(e, tab) {
            currentNavTab = tab;
            navPressedItem = e.currentTarget;
            navPressedItem.classList.add('long-pressing');
            
            navLongPressTimer = setTimeout(() => {
                navLongPressAction(tab);
            }, LONG_PRESS_DURATION);
        }
        
        function navTouchEnd(e, tab) {
            const wasLongPress = navLongPressTimer === null;
            
            if (navLongPressTimer) {
                clearTimeout(navLongPressTimer);
                navLongPressTimer = null;
            }
            
            if (navPressedItem) {
                navPressedItem.classList.remove('long-pressing');
            }
            
            // ÏßßÏùÄ ÌÅ¥Î¶≠Ïù¥Î©¥ ÏÑúÎ∏åÎ©îÎâ¥ Ïó¥Í∏∞
            if (!wasLongPress) {
                e.preventDefault();
                if (tab === 'chart') {
                    openChartSubmenu();
                } else if (tab === 'trade') {
                    openTradeSubmenu();
                }
            }
            
            navPressedItem = null;
        }
        
        function navMouseDown(e, tab) {
            currentNavTab = tab;
            navPressedItem = e.currentTarget;
            navPressedItem.classList.add('long-pressing');
            
            navLongPressTimer = setTimeout(() => {
                navLongPressAction(tab);
            }, LONG_PRESS_DURATION);
        }
        
        function navMouseUp(e, tab) {
            const wasLongPress = navLongPressTimer === null;
            
            if (navLongPressTimer) {
                clearTimeout(navLongPressTimer);
                navLongPressTimer = null;
            }
            
            if (navPressedItem) {
                navPressedItem.classList.remove('long-pressing');
            }
            
            // ÏßßÏùÄ ÌÅ¥Î¶≠Ïù¥Î©¥ ÏÑúÎ∏åÎ©îÎâ¥ Ïó¥Í∏∞
            if (!wasLongPress && e.type === 'mouseup') {
                if (tab === 'chart') {
                    openChartSubmenu();
                } else if (tab === 'trade') {
                    openTradeSubmenu();
                }
            }
            
            navPressedItem = null;
        }
        
        // Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ïï°ÏÖò - Îì±Î°ùÎêú ÌôîÎ©¥ÏúºÎ°ú Î∞îÎ°ú Ïù¥Îèô
        function navLongPressAction(tab) {
            navLongPressTimer = null;
            
            if (navPressedItem) {
                navPressedItem.classList.remove('long-pressing');
            }
            
            if (tab === 'chart') {
                const defaultView = localStorage.getItem('chart_default_view');
                
                if (defaultView) {
                    selectSubmenuItem(defaultView);
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    showToast('üöÄ ' + (defaultView === 'watchlist' ? 'Ï¢ÖÎ™© Î™©Î°ù' : 'Ï∞®Ìä∏') + 'ÏúºÎ°ú Ïù¥Îèô!', 'success');
                } else {
                    openChartSubmenu();
                    showToast('üí° ÌôîÎ©¥ÏùÑ Í∏∏Í≤å ÎàåÎü¨ Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ùÌïòÏÑ∏Ïöî', '');
                }
            } else if (tab === 'trade') {
                const defaultView = localStorage.getItem('trade_default_view');
                
                if (defaultView) {
                    selectTradeSubmenuItem(defaultView);
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    showToast('üöÄ ' + (defaultView === 'buysell' ? 'Buy/Sell Ìå®ÎÑê' : 'Quick & Easy Ìå®ÎÑê') + 'ÏúºÎ°ú Ïù¥Îèô!', 'success');
                } else {
                    openTradeSubmenu();
                    showToast('üí° ÌôîÎ©¥ÏùÑ Í∏∏Í≤å ÎàåÎü¨ Í∏∞Î≥∏ ÌôîÎ©¥ÏúºÎ°ú Îì±Î°ùÌïòÏÑ∏Ïöî', '');
                }
            }
        }
        
        // Ï∞®Ìä∏ÏóêÏÑú Ï¢ÖÎ™© Ïó¥ Îïå ÎßàÏßÄÎßâ Ï¢ÖÎ™© Ï†ÄÏû•
        const originalOpenChartFromWatchlist = openChartFromWatchlist;
        openChartFromWatchlist = function(symbol, name, icon, color) {
            localStorage.setItem('last_chart_symbol', symbol);
            originalOpenChartFromWatchlist(symbol, name, icon, color);
        };
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎÑ§ÎπÑ Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ ÏÑ§Ï†ï
        document.addEventListener('DOMContentLoaded', setupNavLongPress);
        
        // Ïù¥ÎØ∏ Î°úÎìúÎêú Í≤ΩÏö∞ Î∞îÎ°ú Ïã§Ìñâ
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setupNavLongPress();
        }
        
        // ========== Trade ÏÑúÎ∏åÎ©îÎâ¥ ==========
        let tradeSubmenuLongPressTimer = null;
        let tradeSubmenuCurrentItem = null;
        
        // Trade ÏÑúÎ∏åÎ©îÎâ¥ Ïó¥Í∏∞
        function openTradeSubmenu() {
            const defaultView = localStorage.getItem('trade_default_view') || null;
            
            // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            const buysellBadge = document.getElementById('submenuBuysellBadge');
            const quickBadge = document.getElementById('submenuQuickBadge');
            
            if (defaultView === 'buysell') {
                buysellBadge.style.display = 'block';
                quickBadge.style.display = 'none';
            } else if (defaultView === 'quick') {
                buysellBadge.style.display = 'none';
                quickBadge.style.display = 'block';
            } else {
                buysellBadge.style.display = 'none';
                quickBadge.style.display = 'none';
            }
            
            document.getElementById('tradeSubmenuOverlay').classList.add('show');
        }
        
        // Trade ÏÑúÎ∏åÎ©îÎâ¥ Îã´Í∏∞
        function closeTradeSubmenu() {
            document.getElementById('tradeSubmenuOverlay').classList.remove('show');
        }
        
        // Trade ÏÑúÎ∏åÎ©îÎâ¥ Ìï≠Î™© ÌÅ¥Î¶≠
        function selectTradeSubmenuItem(view) {
            closeTradeSubmenu();
            
            // ÌéòÏù¥ÏßÄ Ï†ÑÌôò
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item[data-page="trade"]').classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-trade').classList.add('active');
            
            // Ìå®ÎÑê Ï†ÑÌôò
            showTradePanel(view);
        }
        
        // Trade Ìå®ÎÑê ÌëúÏãú
        function showTradePanel(panel) {
            const buysellPanel = document.getElementById('buysellPanel');
            const quickPanel = document.getElementById('quickPanel');
            
            if (panel === 'buysell') {
                buysellPanel.style.display = 'block';
                quickPanel.classList.remove('active');
                quickPanel.style.display = 'none';
            } else if (panel === 'quick') {
                buysellPanel.style.display = 'none';
                quickPanel.classList.add('active');
                quickPanel.style.display = 'block';
                updateQuickPanel();
            }
        }
        
        // Trade ÏÑúÎ∏åÎ©îÎâ¥ Ìï≠Î™© Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ ÏãúÏûë
        function tradeSubmenuItemPressStart(view, element) {
            tradeSubmenuCurrentItem = element;
            element.classList.add('pressing');
            
            tradeSubmenuLongPressTimer = setTimeout(() => {
                registerTradeDefaultView(view);
                element.classList.remove('pressing');
            }, LONG_PRESS_DURATION);
        }
        
        // Trade ÏÑúÎ∏åÎ©îÎâ¥ Ìï≠Î™© Í∏∏Í≤å ÎàÑÎ•¥Í∏∞ Ï¢ÖÎ£å
        function tradeSubmenuItemPressEnd() {
            if (tradeSubmenuLongPressTimer) {
                clearTimeout(tradeSubmenuLongPressTimer);
                tradeSubmenuLongPressTimer = null;
            }
            if (tradeSubmenuCurrentItem) {
                tradeSubmenuCurrentItem.classList.remove('pressing');
                tradeSubmenuCurrentItem = null;
            }
        }
        
        // Trade Í∏∞Î≥∏ ÌôîÎ©¥ Îì±Î°ù
        function registerTradeDefaultView(view) {
            localStorage.setItem('trade_default_view', view);
            
            // Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            const buysellBadge = document.getElementById('submenuBuysellBadge');
            const quickBadge = document.getElementById('submenuQuickBadge');
            
            if (view === 'buysell') {
                buysellBadge.style.display = 'block';
                quickBadge.style.display = 'none';
            } else {
                buysellBadge.style.display = 'none';
                quickBadge.style.display = 'block';
            }
            
            // ÌÜ†Ïä§Ìä∏ ÌëúÏãú
            const viewName = view === 'buysell' ? 'Buy/Sell Ìå®ÎÑê' : 'Quick & Easy Ìå®ÎÑê';
            showSubmenuToast(viewName);
            
            // ÌñÖÌã± ÌîºÎìúÎ∞± (Î™®Î∞îÏùº)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
        
        // ========== Quick & Easy Ìå®ÎÑê Ìï®Ïàò ==========
        
        // Quick Ìå®ÎÑê Ï†ÑÏö© Î≥ÄÏàò
        let quickSymbol = 'BTCUSD';
        let quickLot = 0.01;
        let quickPositions = []; // Îã§Ï§ë Ìè¨ÏßÄÏÖò Î∞∞Ïó¥
        
        // Quick Ìå®ÎÑê ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuickPanel() {
            // ÌòÑÏû¨ Ïã¨Î≥º Ï†ïÎ≥¥ Î∞òÏòÅ
            const symbolInfo = getSymbolInfo(quickSymbol);
            document.getElementById('quickSymbolIcon').textContent = symbolInfo.icon;
            document.getElementById('quickSymbolIcon').style.color = symbolInfo.color;
            document.getElementById('quickSymbolName').textContent = symbolInfo.name;
            document.getElementById('quickSymbolId').textContent = quickSymbol;
            
            // Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickAccountInfo();
            
            // Ïä§ÌîÑÎ†àÎìú ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickSpread();
            
            // Ìè¨ÏßÄÏÖò Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickPositionList();
            
            // Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickPrices();
        }
        
        // Quick Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuickAccountInfo() {
            const quickBalance = document.getElementById('quickBalance');
            const quickEquity = document.getElementById('quickEquity');
            const quickMargin = document.getElementById('quickMargin');
            const quickTodayPL = document.getElementById('quickTodayPL');
            
            if (quickBalance) quickBalance.textContent = '$' + Math.round(balance).toLocaleString();
            if (quickEquity) quickEquity.textContent = '$' + Math.round(balance).toLocaleString();
            if (quickMargin) quickMargin.textContent = '$0';
            
            if (quickTodayPL) {
                if (todayPL >= 0) {
                    quickTodayPL.textContent = '+$' + Math.abs(todayPL).toFixed(0);
                    quickTodayPL.style.color = 'var(--buy-color)';
                } else {
                    quickTodayPL.textContent = '-$' + Math.abs(todayPL).toFixed(0);
                    quickTodayPL.style.color = 'var(--sell-color)';
                }
            }
        }
        
        // Quick Ïä§ÌîÑÎ†àÎìú ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuickSpread() {
            const spreadEl = document.getElementById('quickSpreadValue');
            if (!spreadEl) return;
            
            const spreads = {
                'BTCUSD': '$15.00',
                'EURUSD.r': '0.00020',
                'USDJPY.r': '0.030',
                'XAUUSD.r': '$0.50',
                'US100.': '$1.50'
            };
            
            spreadEl.textContent = spreads[quickSymbol] || '-';
        }
        
        // Quick Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuickPrices() {
            const bidEl = document.getElementById('quickBidPrice');
            const askEl = document.getElementById('quickAskPrice');
            
            if (!bidEl || !askEl) return;
            
            const prices = watchlistPrices[quickSymbol] || demoQuotes[quickSymbol];
            if (prices) {
                const decimals = getDecimalsForSymbol(quickSymbol);
                bidEl.textContent = prices.bid.toFixed(decimals);
                askEl.textContent = prices.ask.toFixed(decimals);
            }
        }
        
        // Ï¢ÖÎ™© ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä
        function toggleQuickSymbolDropdown() {
            const dropdown = document.getElementById('quickSymbolDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        // Ï¢ÖÎ™© ÏÑ†ÌÉù
        function selectQuickSymbol(symbol) {
            quickSymbol = symbol;
            
            const symbolInfo = getSymbolInfo(symbol);
            document.getElementById('quickSymbolIcon').textContent = symbolInfo.icon;
            document.getElementById('quickSymbolIcon').style.color = symbolInfo.color;
            document.getElementById('quickSymbolName').textContent = symbolInfo.name;
            document.getElementById('quickSymbolId').textContent = symbol;
            
            // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
            document.getElementById('quickSymbolDropdown').style.display = 'none';
            
            // Ïä§ÌîÑÎ†àÎìú Î∞è Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickSpread();
            updateQuickPrices();
            
            showToast(`üìä ${symbolInfo.name} ÏÑ†ÌÉùÎê®`, 'success');
        }
        
        // ÎìúÎ°≠Îã§Ïö¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('quickSymbolDropdown');
            const selector = document.getElementById('quickSymbolSelector');
            if (dropdown && selector && !selector.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // ÎûèÏàò Ï°∞Ï†à
        function adjustQuickLot(delta) {
            const input = document.getElementById('quickLotInput');
            let value = parseFloat(input.value) || 0.01;
            value = Math.max(0.01, Math.min(10, value + delta));
            value = Math.round(value * 100) / 100;
            input.value = value.toFixed(2);
            quickLot = value;
        }
        
        // ÎûèÏàò Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        function validateQuickLot(input) {
            let value = parseFloat(input.value);
            if (isNaN(value) || value < 0.01) {
                value = 0.01;
            } else if (value > 10) {
                value = 10;
            }
            value = Math.round(value * 100) / 100;
            input.value = value.toFixed(2);
            quickLot = value;
        }
        
        // Quick Îß§Ïàò
        async function quickBuy() {
            if (!checkGuestAction('trade')) return;
            
            showToast('‚ö° Quick BUY Ïã§Ìñâ!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/order?symbol=${quickSymbol}&order_type=BUY&volume=${quickLot}&target=0`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    
                    if (result?.success) {
                        playSound('buy');
                        fetchDemoData();
                    } else {
                        showToast(result?.message || 'Error', 'error');
                    }
                } else {
                    const result = await apiCall(`/mt5/order?symbol=${quickSymbol}&order_type=BUY&volume=${quickLot}&target=0`, 'POST');
                    if (result?.success) playSound('buy');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Quick Îß§ÎèÑ
        async function quickSell() {
            if (!checkGuestAction('trade')) return;
            
            showToast('‚ö° Quick SELL Ïã§Ìñâ!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/order?symbol=${quickSymbol}&order_type=SELL&volume=${quickLot}&target=0`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    
                    if (result?.success) {
                        playSound('sell');
                        fetchDemoData();
                    } else {
                        showToast(result?.message || 'Error', 'error');
                    }
                } else {
                    const result = await apiCall(`/mt5/order?symbol=${quickSymbol}&order_type=SELL&volume=${quickLot}&target=0`, 'POST');
                    if (result?.success) playSound('sell');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // ÏùºÍ¥Ñ Ï≤≠ÏÇ∞ (Ï†ÑÏ¢ÖÎ™©)
        async function quickCloseAll() {
            if (!checkGuestAction('trade')) return;
            if (!confirm('Î™®Îì† Ìè¨ÏßÄÏÖòÏùÑ Ï≤≠ÏÇ∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            showToast('üî¥ ÏùºÍ¥Ñ Ï≤≠ÏÇ∞ Ïã§Ìñâ!', 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-all`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-all', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // ÌòÑÏ¢ÖÎ™© Ï≤≠ÏÇ∞
        async function quickCloseSymbol() {
            if (!checkGuestAction('trade')) return;
            
            showToast(`üü† ${quickSymbol} Ï≤≠ÏÇ∞ Ïã§Ìñâ!`, 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close?symbol=${quickSymbol}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall(`/mt5/close?symbol=${quickSymbol}`, 'POST');
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                    }
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Í∞úÎ≥Ñ Ìè¨ÏßÄÏÖò Ï≤≠ÏÇ∞ (Ìã∞Ïºì Î≤àÌò∏Î°ú)
        async function quickClosePosition(ticket) {
            if (!checkGuestAction('trade')) return;
            
            showToast(`üî¥ Ìè¨ÏßÄÏÖò #${ticket} Ï≤≠ÏÇ∞!`, 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close?ticket=${ticket}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall(`/mt5/close?ticket=${ticket}`, 'POST');
                    if (result?.success) {
                        playSound('close');
                        if (result.profit) updateTodayPL(result.profit);
                    }
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Îß§ÏàòÎßå Ï≤≠ÏÇ∞
        async function quickCloseBuy() {
            if (!checkGuestAction('trade')) return;
            
            showToast('üü¢ Îß§Ïàò Ìè¨ÏßÄÏÖò Ï≤≠ÏÇ∞!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-type?type=BUY`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-type?type=BUY', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Îß§ÎèÑÎßå Ï≤≠ÏÇ∞
        async function quickCloseSell() {
            if (!checkGuestAction('trade')) return;
            
            showToast('üî¥ Îß§ÎèÑ Ìè¨ÏßÄÏÖò Ï≤≠ÏÇ∞!', 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-type?type=SELL`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-type?type=SELL', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // ÏàòÏùµÎßå Ï≤≠ÏÇ∞
        async function quickCloseProfit() {
            if (!checkGuestAction('trade')) return;
            
            showToast('üí∞ ÏàòÏùµ Ìè¨ÏßÄÏÖò Ï≤≠ÏÇ∞!', 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-profit?profit_type=positive`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-profit?profit_type=positive', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // ÏÜêÏã§Îßå Ï≤≠ÏÇ∞
        async function quickCloseLoss() {
            if (!checkGuestAction('trade')) return;
            
            showToast('üíî ÏÜêÏã§ Ìè¨ÏßÄÏÖò Ï≤≠ÏÇ∞!', 'error');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/close-by-profit?profit_type=negative`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) {
                        playSound('close');
                        fetchDemoData();
                    }
                } else {
                    const result = await apiCall('/mt5/close-by-profit?profit_type=negative', 'POST');
                    if (result?.success) playSound('close');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // SL/TP Ï†ÅÏö©
        async function applyQuickSLTP() {
            if (!checkGuestAction('trade')) return;
            const sl = document.getElementById('quickSLInput').value;
            const tp = document.getElementById('quickTPInput').value;
            
            if (!sl && !tp) {
                showToast('SL ÎòêÎäî TP Í∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }
            
            showToast(`‚úÖ SL: ${sl || '-'} / TP: ${tp || '-'} Ï†ÅÏö©!`, 'success');
            
            try {
                if (isDemo) {
                    const response = await fetch(`${API_URL}/demo/set-sltp?symbol=${quickSymbol}&sl=${sl || 0}&tp=${tp || 0}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result?.success) fetchDemoData();
                } else {
                    await apiCall(`/mt5/set-sltp?symbol=${quickSymbol}&sl=${sl || 0}&tp=${tp || 0}`, 'POST');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }
        
        // Quick Ìè¨ÏßÄÏÖò Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ (Îã§Ï§ë Ìè¨ÏßÄÏÖò ÏßÄÏõê)
        function updateQuickPositionList() {
            const container = document.getElementById('quickPositionList');
            if (!container) return;
            
            // quickPositions Î∞∞Ïó¥Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
            if (quickPositions && quickPositions.length > 0) {
                // Ï¥ù ÏÜêÏùµ Í≥ÑÏÇ∞
                let totalProfit = 0;
                quickPositions.forEach(pos => {
                    totalProfit += pos.profit || 0;
                });
                
                const totalProfitClass = totalProfit >= 0 ? 'positive' : 'negative';
                const totalProfitSign = totalProfit >= 0 ? '+' : '';
                
                let html = `
                    <div class="quick-total-pl">
                        <span class="quick-total-pl-label">üìä Ï¥ù ${quickPositions.length}Í∞ú Ìè¨ÏßÄÏÖò</span>
                        <span class="quick-total-pl-value ${totalProfitClass}">${totalProfitSign}$${totalProfit.toFixed(2)}</span>
                    </div>
                `;
                
                quickPositions.forEach((pos, index) => {
                    const isBuy = pos.type === 'BUY';
                    const profitClass = pos.profit >= 0 ? 'positive' : 'negative';
                    const profitSign = pos.profit >= 0 ? '+' : '';
                    const positionClass = isBuy ? 'buy-position' : 'sell-position';
                    const symbolInfo = getSymbolInfo(pos.symbol);
                    const decimals = getDecimalsForSymbol(pos.symbol);
                    
                    html += `
                        <div class="quick-position-item ${positionClass}">
                            <div class="quick-position-symbol">
                                <div class="quick-position-symbol-name" style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 16px; color: ${symbolInfo.color};">${symbolInfo.icon}</span>
                                    ${pos.symbol}
                                </div>
                                <div class="quick-position-symbol-info">${pos.volume?.toFixed(2) || '0.01'} lot ‚Ä¢ ${pos.entry?.toFixed(decimals) || '-'}</div>
                            </div>
                            <span class="quick-position-type ${isBuy ? 'buy' : 'sell'}">${pos.type}</span>
                            <div class="quick-position-profit ${profitClass}">${profitSign}$${pos.profit?.toFixed(2) || '0.00'}</div>
                            <button class="quick-position-close" onclick="quickClosePosition(${pos.ticket || index})">
                                <span class="material-icons-round">close</span>
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } 
            // Í∏∞Ï°¥ Îã®Ïùº Ìè¨ÏßÄÏÖò Ìò∏Ìôò
            else if (positionData && hasPosition) {
                const isBuy = positionData.type === 'BUY';
                const profitClass = positionData.profit >= 0 ? 'positive' : 'negative';
                const profitSign = positionData.profit >= 0 ? '+' : '';
                const positionClass = isBuy ? 'buy-position' : 'sell-position';
                const symbolInfo = getSymbolInfo(currentSymbol);
                const decimals = getDecimalsForSymbol(currentSymbol);
                
                container.innerHTML = `
                    <div class="quick-total-pl">
                        <span class="quick-total-pl-label">üìä Ï¥ù 1Í∞ú Ìè¨ÏßÄÏÖò</span>
                        <span class="quick-total-pl-value ${profitClass}">${profitSign}$${positionData.profit?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="quick-position-item ${positionClass}">
                        <div class="quick-position-symbol">
                            <div class="quick-position-symbol-name" style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px; color: ${symbolInfo.color};">${symbolInfo.icon}</span>
                                ${currentSymbol}
                            </div>
                            <div class="quick-position-symbol-info">${positionData.volume?.toFixed(2) || lotSize.toFixed(2)} lot ‚Ä¢ ${positionData.entry?.toFixed(decimals) || '-'}</div>
                        </div>
                        <span class="quick-position-type ${isBuy ? 'buy' : 'sell'}">${positionData.type}</span>
                        <div class="quick-position-profit ${profitClass}">${profitSign}$${positionData.profit?.toFixed(2) || '0.00'}</div>
                        <button class="quick-position-close" onclick="quickCloseSymbol()">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                `;
            } 
            else {
                container.innerHTML = `
                    <div class="quick-position-empty">
                        <span class="material-icons-round">inbox</span>
                        <div>Ïó¥Î¶∞ Ìè¨ÏßÄÏÖòÏù¥ ÏóÜÏäµÎãàÎã§</div>
                    </div>
                `;
            }
        }
        
        // Quick Ìå®ÎÑê Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ (fetchDemoDataÏóêÏÑú Ìò∏Ï∂ú)
        function updateQuickPanelFromData(data) {
            if (!data) return;
            
            // Í≥ÑÏ¢å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            balance = data.balance || balance;
            updateQuickAccountInfo();
            
            // Îã§Ï§ë Ìè¨ÏßÄÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            if (data.positions && Array.isArray(data.positions)) {
                quickPositions = data.positions;
            } else if (data.position) {
                quickPositions = [data.position];
            } else {
                quickPositions = [];
            }
            
            // Ìè¨ÏßÄÏÖò Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickPositionList();
            
            // Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
            updateQuickPrices();
        }
    </script>
</body>
</html>
